(function(){mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo.Button","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.SelectBox","mstrmojo.form","mstrmojo.array","mstrmojo.DocXtabModel","mstrmojo.Box","mstrmojo.gmaps._CanShowMapToolbar");function dojoRequires(){if(dojo){dojo.require("esri.tasks.geometry");dojo.require("dijit.Dialog");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.form.DropDownButton");dojo.require("dijit.TooltipDialog");dojo.require("esri.tasks.geometry");dojo.require("dojo.parser");dojo.require("dojox.charting.Chart2D");dojo.require("dojox.charting.themes.PlotKit.blue");dojo.require("dojox.charting.action2d.Highlight");dojo.require("dojox.charting.action2d.Magnify");dojo.require("dojox.charting.action2d.MoveSlice");dojo.require("dojox.charting.action2d.Shake");dojo.require("dojox.charting.action2d.Tooltip");dojo.require("dojox.charting.widget.Legend");dojo.require("dojo.colors");dojo.require("dojo.fx.easing");dojo.require("dojo.dnd.TimedMoveable");}else{window.setTimeout(dojoRequires,100);}}var SAME_PROMPT=1;var DO_NOT_ANSWER=2;var CLOSE=3;var DYNAMIC=4;var STATIC=5;var CURRENT_UNIT=6;var ALL_VALID_UNITS=7;var USE_DEFAULT_ANSWER=8;var DRILLING_ACTION=1;var SELECTOR_ACTION=2;var HYPERLINK_ACTION=4;var SORT_ACTION=8;mstrmap.ESRIMap=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._HasPopup,mstrmojo.gmaps._CanShowMapToolbar],{scriptClass:"mstrmap.ESRIMap",iconClass:"",title:"",height:"auto",width:"auto",DEFAULT_COLOR:"#FE766A",isDestroyed:false,markupString:'<div id="{@id}" class="tundra mstrmojo-ESRIMap {@cssClass} {@iconClass}" title="{@title}" sty="esrimap" style="{@cssText};width:{@width};height:{@height};"><div id="{@id}-toolbar" style="height:50px"></div><div id="{@id}-clearAllWindow"></div><div id="{@id}-merticSelectDiv"></div><div id="{@id}-clearAllPopupDiv"></div><div id="{@id}-singleSelectPopupDiv"></div></div>',markupSlots:{toolBarDiv:function(){return this.domNode.firstChild;},clearAllWindowDiv:function(){return this.domNode.childNodes[1];},merticSelectDiv:function(){return this.domNode.childNodes[2];},clearAllPopupDiv:function(){return this.domNode.childNodes[3];},singleSelectPopupDiv:function(){return this.domNode.childNodes[4];}},handleSingleSelection:function handleSingleSelection(apply){for(var i in this.gridDataViewer){if(!!this.gridDataViewer[i].previousState){var viewer=this.gridDataViewer[i];var columnIndex=viewer.previousState.columnIndex;if(apply){var currentSelections=viewer.getCurrentSelections(columnIndex);if(currentSelections.length>0){viewer.command.applySelection(viewer.savedSliceInfo);}}else{viewer.currentSelections[columnIndex]=viewer.previousState.currentSelections;viewer.selectedRowIndices[columnIndex]=viewer.previousState.selectedRowIndices;viewer.highlightedGraphics[columnIndex]=viewer.previousState.highlightedGraphics;var selectedObjList=viewer.previousState.mapObjectsState.selectedObj;var unselectedObjList=viewer.previousState.mapObjectsState.unselectedObj;for(var j in selectedObjList){var g=selectedObjList[j];if(g.geometry instanceof esri.geometry.Polyline){g.symbol.width=5;g.setSymbol(g.symbol);}else{if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(this.selectionStroke));}}}for(var k in unselectedObjList){var g=unselectedObjList[k];if(g.geometry instanceof esri.geometry.Polyline){g.symbol.width=1;g.setSymbol(g.symbol);}else{if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(this.regularStroke));}}}}viewer.previousState=null;viewer.savedSliceInfo=[];}}this.set("markerSelected",!this.noMarkerSelected());},clearSelections:function clearSelections(){for(var i=0;i<this.gridDataViewer.length;i++){var currentGridDataViewer=this.gridDataViewer[i];currentGridDataViewer.clearHighlight();currentGridDataViewer.currentSelections={};currentGridDataViewer.selectedRowIndices={};if(currentGridDataViewer.highlightedGraphics){currentGridDataViewer.highlightedGraphics={};}}},isSelectedDensity:function isSelectedDensity(){return false;},isToolbarPositionFixed:function isToolbarPositionFixed(){return true;},doClearRectangle:function doClearRectangle(forceClear){if(!forceClear&&!this.enableRectangleSelect){return ;}this.clearMap();},noMarkerSelected:function noMarkerSelected(){for(var i in this.gridDataViewer){var selections=this.gridDataViewer[i].currentSelections;if(!!selections){for(var j in selections){if(selections[j]&&selections[j].length>0){return false;}}}}return true;},noPolygonsPresentOnMap:function noPolygonsPresentOnMap(){return true;},onmarkerSelectedChange:function onmarkerSeletedChange(){this.setClearAllButtonEnable(this.markerSelected);if(this.drillable){this.setDrilLButtonEnable();}},isMapDrillEnabled:function isMapDrillEnabled(){for(var i=0;i<this.gridDataViewer.length;i++){if(this.gridDataViewer[i].isViewerDrillable()){return true;}}return false;},setClearAllButtonEnable:function setClearAllButtonEnable(enableFlag){this.setToolbarButtonState(this.EnumToolbarButtonType.CLEAR_ALL,"enabled",enableFlag);},isMapEnabledAffinityLine:function isMapEnabledAffinityLine(){for(var i=0;i<this.gridDataViewer.length;i++){if(this.gridDataViewer[i].isAffinityLinesEnabled()){return true;}}return false;},selectedMetricIndex:0,onselectedMetricIndexChange:function onselectedMetricIndexChange(gridIndex,metricIndex,metricId){this.gridDataViewer[gridIndex].selectedMetricIndexChange(metricIndex,metricId);},enableClickSelect:false,enableRectangleSelect:false,enableZoom:false,markerSelected:false,rectangleFillSymbol:null,toolBarActive:false,drillable:true,onenableRectangleSelectChange:function onenableRectangleSelectChange(){if(this.esriToolbar===undefined){return ;}if(this.enableRectangleSelect){this.esriToolbar.activate(esri.toolbars.Draw.EXTENT);}else{this.esriToolbar.deactivate(esri.toolbars.Draw.EXTENT);}for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].enableRectangleSelect=this.enableRectangleSelect;}},enablePopup:true,onenablePopupChange:function onenablePopupChange(evt){this.enablePopup=evt.value;},infoWindowVisible:true,oninfoWindowVisibleChange:function oninfoWindowVisibleChange(){var infoDiv=dojo.byId(this.domNode.id+"_infowindow");if(typeof infoDiv=="undefined"||!infoDiv){console.log("Error: did not find "+this.domNode.id+"_infowindow div.");return ;}if(this.infoWindowVisible){if(infoDiv.style.visibility=="hidden"){infoDiv.style.visibility="";}}else{infoDiv.style.visibility="hidden";}},infoWindowHTML:"",defaultInfoWindowHTML:"",_docModel:null,infoWindowUseGrid:true,enableDebug:true,enumDefault:-1,enumNumber:2,enumText:3,enumImage:4,enumUrl:5,enumQuickSymbol:10,baseMapUrl:"http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer",baseLayer:null,isBaseMapDynamic:false,esriMapping:{},gridDataViewer:null,gridKeysMap:null,gridNamesSelectorItems:null,_primaryGridIndex:0,registeredSDPKeys:null,initMultipleDataProviders:function initMultipleDataProviders(gridParams){this.loadWidgetPropsAndGridData();if(!this.grids){return ;}this.gridDataViewer=[];this.gridNamesSelectorItems=[];this.registeredSDPKeys=[];var beanPath,key,xtab,msgId;if(gridParams.isRW){this.gridBone=microstrategy.bone(gridParams.boneId);beanPath=this.gridBone&&this.gridBone.getDocViewer().beanPath;}else{beanPath=gridParams.beanPath;}if(typeof (microstrategy)!="undefined"&&!!microstrategy.getViewerBone()){msgId=microstrategy.getViewerBone().messageID;}else{if(!!this._docModel){msgId=this._docModel.mid;}}this.gridKeysMap={};for(i=0;i<this.grids.length;i++){key=this.grids[i]["grid1"].k;if(this.grids[i].isPrimary&&this.grids[i].isPrimary==true){this.createXTabModel(this.grids[i]["grid1"]);xtab=this;}else{xtab=this.newXtab(this.fnGetDocModel(),this.grids[i]["grid1"],key);var dm=this.fnGetDocModel();if(dm){dm.addSDP(key,{k:this.grids[this._primaryGridIndex]["grid1"].k,visName:this.grids[this._primaryGridIndex]["grid1"].visName});this.registeredSDPKeys.push(key);}}this.gridDataViewer[i]=new mstrmap.ESRIMapViewer({parent:this,data:this.grids[i].grid1,widgetProps:this.grids[i].widgetProps,key:key,beanPath:beanPath,msgID:msgId,isPrimary:(i==0)?true:false,_xTabModel:xtab&&xtab.model,layerIndex:i});this.gridKeysMap[key]=i;this.gridNamesSelectorItems.push({v:i,n:this.grids[i]["grid1"].n,id:key});}},fnGetWidget:function(_key){for(var i in mstrmojo.all){if(mstrmojo.all[i].k===_key){return mstrmojo.all[i];}}return null;},initDocModel:function initDocModel(key){var _w=this.fnGetWidget(key);if(!_w||!_w.model){return ;}this._docModel=_w.model;},fnGetDocModel:function fnGetDocModel(){return this._docModel;},createXTabModel:function createXTabModel(node){var docModel=this.fnGetDocModel();if(!docModel){return ;}this.model=new mstrmojo.DocXtabModel({xtab:this,controller:docModel.controller,docModel:docModel,data:node});},newXtab:function newXtab(docModel,node,key){if(!docModel){return ;}var xtab=new mstrmojo.DocXtab({id:node.id,node:node,controller:docModel.controller,k:key});xtab.setModel(new mstrmojo.DocXtabModel({xtab:xtab,controller:docModel.controller,docModel:docModel,data:node}));return xtab;},params:{},gridParams:null,grids:null,gridData:null,enableMarker:false,enablePolygon:false,debug:function debug(s){if(this.enableDebug){console.log(s);}},clearMap:function clearMap(){if(this.esriMap!==undefined){this.esriMap.graphics.clear();this.esriMap.infoWindow.hide();}},saveCustomInfo:function saveCustomInfo(){this.persistWidgetProps();this.closePopup();},replaceSpace:function replaceSpace(str,replaceStr){var replace=replaceStr;if(replace===undefined){replace="_";}return str.replace(/ /g,replace);},regularStroke:null,mouseoverStroke:null,selectionStroke:null,populateStrokes:function populateStrokes(){if(!this.regularStroke){this.regularStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,0.35]),1);this.mouseoverStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0.75]),2);this.selectionStroke=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,255,0.35]),2);}},isCtrl:false,processMapKeydown:function processMapKeydown(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}var intCtrlKey=winObj.ctrlKey;if(intCtrlKey){var oldValue=this.isCtrl;this.isCtrl=true;if(oldValue!=this.isCtrl){console.log("control key status changed to ?"+this.isCtrl);}}else{}},processMapKeyup:function processMapKeyup(_event_){var winObj;if(window.event){winObj=window.event;}else{winObj=_event_;}var intCtrlKey=winObj.ctrlKey;if(!intCtrlKey){this.isCtrl=false;}},widgetProps:null,gridBone:null,createWidgetPropsXML:function createWidgetPropsXML(){if(!this.widgetProps.sgProps){return this.createOldFormatWidgetPropsXML();}else{return this.createNewFormatWidgetPropsXML();}},createOldFormatWidgetPropsXML:function createOldFormatWidgetPropsXML(){var widgetPropsXml="<widgetProps><fmt>";var k;var wps=this.gridDataViewer[0].getWidgetProps();for(k in wps){widgetPropsXml+="<"+k+' value="'+this.encode(this.encode(wps[k]))+'" />';}widgetPropsXml+="</fmt></widgetProps>";return widgetPropsXml;},createNewFormatWidgetPropsXML:function createNewFormatWidgetPropsXML(){var widgetPropsXml="<widgetProps><fmt>";var k,wps=this.getPrimaryGridViewer().getWidgetProps();for(k in wps){if(k=="sgProps"){continue;}widgetPropsXml+="<"+k+' value="'+this.encode(this.encode(wps[k]))+'" />';}widgetPropsXml+='<sgProps value="';var gridsValue="<sgProps>";var wps;for(var i=0;i<this.gridDataViewer.length;i++){if(i==this._primaryGridIndex){continue;}wps=this.gridDataViewer[i].getWidgetProps();gridsValue+='<g k="'+this.gridDataViewer[i].data.k+'">';for(k in wps){gridsValue+="<"+k+' value="'+wps[k]+'" />';}gridsValue+="</g>";}gridsValue+="</sgProps>";widgetPropsXml+=this.encode(this.encode(gridsValue));widgetPropsXml+='"/>';widgetPropsXml+="</fmt></widgetProps>";return widgetPropsXml;},encode:function encode(oldStr,toServer){var sb=oldStr;if(toServer==null){toServer=false;}if((oldStr!=null)&&(oldStr.length>0)){sb="";for(var i=0,len=oldStr.length;i<len;i++){switch(oldStr.charAt(i)){case"&":if((oldStr.length!=(i+1))&&(oldStr.charAt(i+1)=="#")){sb+="&";}else{sb+="&amp;";}break;case"<":sb+="&lt;";break;case">":sb+="&gt;";break;case"'":sb+="&#039;";break;case"\n":if(!toServer){sb+="<br />";}else{sb+=oldStr.charAt(i);}break;case'"':sb+="&quot;";break;case" ":if(i==0||(i<oldStr.length-1&&oldStr.charAt(i+1)==" ")){sb+="&nbsp;";}else{sb+=oldStr.charAt(i);}break;default:sb+=oldStr.charAt(i);break;}}}return sb;},persistWidgetProps:function persistWidgetProps(){if(this.widgetProps){var widgetPropsXml=this.createWidgetPropsXML();var ac=[];this.gridBone.setVisualizationSettings(null,null,null,null,ac,widgetPropsXml);this.gridBone.um.add(ac);}},getVisProps:function(gridParams){var m=this.getPrimaryGrid();return m.vp;},onSecondaryDataSliced:function onSecondaryDataSliced(key,data){var ind=this.gridKeysMap[key];this.gridDataViewer[ind].resetData(data);this.gridDataViewer[ind].unrender();this.gridDataViewer[ind].render();},needResizeMap:function needResizeMap(){if(this.domNode.clientWidth==0||this.domNode.clientHeight==0){return false;}var originalWidth=parseInt(this.domNode.style.width),originalHeight=parseInt(this.domNode.style.height),newWidth=parseInt(this.width),newHeight=parseInt(this.height);if(originalWidth!==newWidth||originalHeight!==newHeight){return true;}return false;},resizeMap:function resizeMap(){var newWidth=parseInt(this.width),newHeight=parseInt(this.height);this.domNode.style.width=newWidth+"px";this.domNode.style.height=newHeight+"px";if(this.esriMap){this.esriMap.resize();this.esriMap.reposition();this.updateMapExtent(true);}},onShow:function onShow(){if(this.needResizeMap()){this.resizeMap();}},postBuildRendering:function postBuildRendering(){this.isDestroyed=false;this.populateStrokes();this.initMultipleDataProviders(this.gridParams);var that=this;document.onkeydown=function(evt){that.processMapKeydown(evt);};document.onkeyup=function(evt){that.processMapKeyup(evt);};mstrApp.docModel&&mstrApp.docModel.attachEventListener("panelSelected",this.id,function(evt){var isChildOfPanel=false;var panelDom=document.getElementById(evt.panelId);if(panelDom){isChildOfPanel=panelDom.contains(that.domNode);if(isChildOfPanel&&evt.panelVisible){that.onShow();}}});var baseUrl=this.gridParams.taskURL;var splitParams={taskId:"getESRIConfig",taskEnv:"xhr",taskContentType:"json"};var id=this.id;mstrmap[this.gridParams.boneId]=this.parent.id;var xhrCfg={success:function(res){if(!res){return ;}try{res=eval(res);that.loadESRIMap(res);}catch(e){mstrmojo.alert("esriconfig.xml error. "+e.message);}},failure:function(res){alert("Error loading Configuration: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("GET",baseUrl,xhrCfg,splitParams);},metricData:null,createSlidingToolbar:function createSlidingToolbar(){var toolbarPlaceholder=this.toolBarDiv.id,clearAllPlaceholder=this.clearAllWindowDiv.id,merticSelectPlaceholder=this.merticSelectDiv.id,clearAllPopupPlaceholder=this.clearAllPopupDiv.id,singleSelectPopupPlaceholder=this.singleSelectPopupDiv.id,toolbarButtonsFlag;toolbarButtonsFlag=this.EnumToolbarButtonType.SINGLE_SELECT|this.EnumToolbarButtonType.RECTANGLE_SELECT|this.EnumToolbarButtonType.CLEAR_ALL|this.EnumToolbarButtonType.AFFINITY|this.EnumToolbarButtonType.DRILL|this.EnumToolbarButtonType.EDIT_INFO_WINDOW|this.EnumToolbarButtonType.GRIDS_SELECT;this.initMapToolbar(this,this.metricData,toolbarButtonsFlag,toolbarPlaceholder,clearAllPlaceholder,merticSelectPlaceholder,clearAllPopupPlaceholder,singleSelectPopupPlaceholder);this.renderToolbar();},hideInfoWindow:function hideInfoWindow(evt){this.esriMap.graphics.clear();this.esriMap.infoWindow.hide();},refreshMap:function refreshMap(){this.hideInfoWindow();this.clearMap();if(this.polygonLayer){this.esriMap.removeLayer(this.polygonLayer);}if(this.markerLayer){this.esriMap.removeLayer(this.markerLayer);}this.viewCache=null;this.initESRIMap();},fullExtent:null,isAsp:function isAsp(){return(microstrategy.servletName.indexOf("aspx")!=-1);},translate:function translate(node){if(node===undefined){return ;}if(node.innerHTML==="Press down to start and let go to finish"){node.innerHTML=mstrmojo.desc(8268,"Press down to start and let go to finish");}},trimString:function trimString(s){return mstr.utils.String.trim(s);},loadESRIMap:function loadESRIMap(esriMapping){if(this.isDestroyed){return ;}var pj,attr;this.prepareDivs();var bm=null;if(!!esriMapping&&!!esriMapping.ec&&!!esriMapping.ec.bms){var bms=esriMapping.ec.bms;for(var i=0;i<bms.length;i++){if(!!bms[i].key&&bms[i].key=="default"){bm=bms[i];break;}}}if(!!bm&&!!bm.proxyURL&&this.trimString(bm.proxyURL).length>0){esri.config.defaults.io.alwaysUseProxy=true;esri.config.defaults.io.proxyUrl=bm.proxyURL;}else{esri.config.defaults.io.alwaysUseProxy=false;}this.removeDijit();this.esriMapping=esriMapping;if(!!bm){this.isBaseMapDynamic=(bm.isDyn=="1");this.baseMapUrl=bm.value;}else{this.baseMapUrl=null;this.isBaseMapDynamic=false;}if(!this.baseMapUrl||this.trimString(this.baseMapUrl).length==0){mstrmojo.alert("Basemap url is empty. Please provide a valid basemap url and try again.");return ;}var projects=esriMapping.ec.pjs;var attributeMapping={};for(pj in projects){if(!pj){continue;}if(projects.hasOwnProperty(pj)&&!!projects[pj].at){for(i=0;i<projects[pj].at.length;i++){attributeMapping[projects[pj].at[i].id]=projects[pj].at[i];}}}this.esriAttributeMapping=attributeMapping;var map=this.esriMap;if(map!==undefined){map.removeAllLayers();}try{if(this.domNode==null){return ;}var id=this.domNode&&this.domNode.id||null;if(id){var domElement=document.getElementById(id);if(domElement){map=new esri.Map(id,{wrapAround180:true,sliderStyle:"small"});}}}catch(e){mstrmojo.alert(e.stack);return ;}if(!map){return ;}dojo.connect(map,"onMouseMove",this,function(evt){var isIE6=mstrmojo.dom.isIE6;var position=mstrmojo.dom.position(this.domNode,true);this.esriMap.reposition();this.originalY=position.y;});translateEvent=dojo.connect(map,"onMouseOver",this,function(event){var tooltip=dojo.query("div.tooltip")[0];this.translate(tooltip);});this.esriToolbar=new esri.toolbars.Draw(map);this.rectangleFillSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT,new dojo.Color([0,0,0]),2),new dojo.Color([83,212,252,0.6]));this.esriToolbar.setFillSymbol(this.rectangleFillSymbol);dojo.connect(this.esriToolbar,"onDrawEnd",this,function(geometry){this.handleExtentDraw(geometry);});dojo.connect(map,"onLoad",this,this.initESRIMap);var layer;if(this.isBaseMapDynamic){layer=new esri.layers.ArcGISDynamicMapServiceLayer(this.baseMapUrl);}else{layer=new esri.layers.ArcGISTiledMapServiceLayer(this.baseMapUrl);}this.baseLayer=layer;map.addLayer(layer);this.esriMap=map;var me=this;mstrApp.docModel&&mstrApp.docModel.attachEventListener("secondaryDataSliced",this.id,function(evt){me.onSecondaryDataSliced(evt.key,evt.data);});},removeDijit:function removeDijit(){var ids=this.domNode.id;dijit.registry.forEach(function(w){if(w.id.indexOf(ids)>=0){w.destroyRecursive();}});},destroy:function destroy(ignoreDom){this.isDestroyed=true;var dm=this.fnGetDocModel();if(dm&&this.registeredSDPKeys){for(var key in this.registeredSDPKeys){dm.removeSDP(key);}}this._super(ignoreDom);},createEmptyGridInfoWindowTable:function createEmptyGridInfoWindowTable(){var table=document.createElement("table");var isIE=(navigator.appVersion.indexOf("MSIE")!=-1)?true:false;var gridTableFormat="gridInfoWindowTable";table.className=gridTableFormat;table.setAttribute("cellspacing","0");table.setAttribute("cellpadding","2");var tableHead=document.createElement("tHead");var tableBody=document.createElement("tBody");table.appendChild(tableHead);table.appendChild(tableBody);return table;},prepareDivs:function prepareDivs(){this.infoTabDiv=document.createElement("div");this.infoTabDiv.id="infoDiv";this.infoTabDiv.style.paddingTop="3px";this.infoTabDiv.style.overflow="auto";var table=this.createEmptyGridInfoWindowTable();this.infoTabDiv.appendChild(table);var cssStyle=this.createInfoTabDivCSSStyle();if(cssStyle!=null){this.infoTabDiv.appendChild(cssStyle);}},createInfoTabDivCSSStyle:function createInfoTabDivCSSStyle(cssString){var cssStyle=null,m=this.getPrimaryGrid(),cssString=m.cssString;if(cssString!==undefined){cssStyle=document.createElement("style");cssStyle.type="text/css";var node=cssStyle.styleSheet||cssStyle;if(mstrmojo.dom.isWK){if(node.firstChild){node.firstChild.nodeValue=cssString;}else{node.appendChild(document.createTextNode(cssString));}}else{node[mstrmojo.dom.isIE?"cssText":"innerHTML"]=cssString;}}return cssStyle;},minMaxMap:null,maxRadius:60,minRadius:3.5,bubbleMode:false,stripNumberFormat:function stripNumberFormat(numString){var newString=numString.replace(this.gridParams.currencySymbol,"");var oldString;do{oldString=newString;newString=newString.replace(this.gridParams.groupingSeparator,"");}while(oldString!=newString);var resultString=newString.replace(this.gridParams.decimalSeparator,".");return resultString;},handleTaskQueryError:function handleTaskQueryError(error){mstrmojo.alert("queryTask error:"+error.name+":"+error.description);},highlightedGraphics:null,currentSelections:null,selectedRowIndices:null,clearHighlight:function clearHighlight(){for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].clearHighlight();}},addGridLayer:function addGridLayer(layerIndex){this.gridDataViewer[layerIndex].render(false);},removeGridLayer:function removeGridLayer(layerIndex){this.gridDataViewer[layerIndex].unrender();if(this.gridDataViewer[layerIndex].currentSelections){this.gridDataViewer[layerIndex].currentSelections={};}if(this.gridDataViewer[layerIndex].selectedRowIndices){this.gridDataViewer[layerIndex].selectedRowIndices={};}if(this.gridDataViewer[layerIndex].highlightedGraphics){this.gridDataViewer[layerIndex].highlightedGraphics={};}},handleExtentDraw:function handleExtentDraw(geometry){for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].handleExtentDraw(geometry);}this.setDrilLButtonEnable();this.set("enableRectangleSelect",false);this.setToolbarState(0);this.setToolbarButtonState(this.EnumToolbarButtonType.CLEAR_ALL,"enabled",true);},geoPosition:-1,geoElements:{},mapLayers:[],originalX:-1,originalY:-1,populateOriginalPosition:function populateOrignalPosition(){var position=mstrmojo.dom.position(this.domNode,true);this.originalX=position.x;this.originalY=position.y;},idMarkerMap:null,wpDisPlayAffinityLines:false,wpLookupAttId:null,initESRIMap:function initESRIMap(){if(this.isDestroyed){return ;}this.enableMarker=false;this.enablePolygon=false;this.fullExtent=this.baseLayer.fullExtent;for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].render(true);}this.createSlidingToolbar();},loadWidgetPropsAndGridData:function loadWidgetPropsAndGridData(){var M,sdpKey,i,grid;M=this.getPrimaryGrid();this.initDocModel(M.k);this.grids=[];this.gridBone=microstrategy.bone(this.gridParams.boneId);this.widgetProps=this.getVisProps(this.gridParams);i=0;for(i=0;i<this.gridData.length;i++){grid=this.gridData[i];this.grids[i]={grid1:grid};if(i==this._primaryGridIndex){this.grids[i].widgetProps=M.vp;this.grids[i].isPrimary=true;}else{if(!M.vp.sgProps||!M.vp.sgProps[grid.k]){mstrmojo.alert("Can not render the grid. No widget properties found for the grid "+grid.n);continue;}this.grids[i].widgetProps=M.vp.sgProps[grid.k];}}},totalLayersRendered:0,updateMapExtent:function updateMapExtent(force){this.totalLayersRendered++;if(!this.gridDataViewer||!force&&this.totalLayersRendered!=this.gridDataViewer.length){return ;}var extent=null;for(var i=0;i<this.gridDataViewer.length;i++){if(extent==null){extent=this.gridDataViewer[i].getExtent();}else{extent=extent.union(this.gridDataViewer[i].getExtent());}}if(extent){this.esriMap.setExtent(extent,true);}},getPrimaryGrid:function getPrimaryGrid(){return this.gridData[this._primaryGridIndex];},getPrimaryGridViewer:function getPrimaryGridViewer(){return this.gridDataViewer[this._primaryGridIndex];},getGridViewer:function getGridViewer(viewerIndex){if(viewerIndex<0||viewerIndex>=this.gridDataViewer.length){return null;}return this.gridDataViewer[viewerIndex];},markerColumnIndices:{Lat:-1,Long:-1},latIndex:-1,longIndex:-1,findWrapperDom:function findWrapperDom(){return this.domNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;},isDrillable:function isDrillable(){for(var i=0;i<this.gridDataViewer.length;i++){if(this.gridDataViewer[i].getDrillStatus()){return true;}}return false;},setDrilLButtonEnable:function setDrillButtonEnable(){var enabled=this.isDrillable();this.setToolbarButtonState(this.EnumToolbarButtonType.DRILL,"enabled",enabled);},processDrill:function processDrillRequest(){for(var i=0;i<this.gridDataViewer.length;i++){this.gridDataViewer[i].processDrill();}},retrieveReport:function retrieveReport(res){var reportParams={taskId:"iPhoneGetReportResults",sessionState:this.gridParams.sessionstate,msgID:"A865DAF246A83FF83DB90B93FAD0B371",styleName:"MojoXtabStyleForceShowAttribute"};var xhrCfg={success:function(res){if(!res){return ;}},failure:function(res){alert("Error Retrieve Report: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("GET",this.gridParams.taskUrl,xhrCfg,reportParams);},getQuickSymbol:function getQuickSymbol(text){var result;switch(text){case"&#9679;":case'<font face="Wingdings">\u006c</font>':result="\u25CF";break;case"&#9632;":case'<font face="Wingdings">\u006e</font>':result="\u25a0";break;case"&#9830;":case'<font face="Wingdings">\u0074</font>':result="\u2666";break;case"&#9670;":case'<font face="Wingdings">\u0075</font>':result="\u25C6";break;case"&#10070;":case'<font face="Wingdings">\u0053</font>':result="\u2756";break;case"&#9784;":case'<font face="Wingdings">\u005D</font>':result="\u2638";break;case"&#10047;":case'<font face="Wingdings">\u007C</font>':result="\u273F";break;case"&#8984;":case'<font face="Wingdings">\u007a</font>':result="\u2318";break;case"&#10003;":case'<font face="Wingdings">\u0009</font>':result="\u2713";break;case"&#10007;":case'<font face="Wingdings">\u000a</font>':result="\u2717";break;case"&#8680;":case'<font face="Wingdings">\u00e8</font>':result="\u21E8";break;case"&#8679;":case'<font face="Wingdings">\u00e9</font>':result="\u21E7";break;case"&#8681;":case'<font face="Wingdings">\u00ea</font>':result="\u21E9";break;default:result=text;}return decodeURI(result);},_markerElementIDs:null,checkLookUpAttributeInSecondaryDP:function checkLookUpAttributeInSecondaryDP(){var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var numTemplateUnits=rowAttributes.length;for(i=0;i<numTemplateUnits;i++){if(rowAttributes[i].id==this.wpLookupAttId){return true;}}return false;},_affinityLines:null,affinityLineLayer:null,DEFAULT_LINE_COLOR:16711680,drawAffinityLinesUsingSecondaryDataProvider:function drawAffinityLinesUsingSecondaryDataProvider(){if(!this.secData){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()==-1){return ;}if(this.secData.gts.col.length==0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}this.affinityLineLayer=new esri.layers.GraphicsLayer();var secondMetricIndex;secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var rowHeaders=this.secData.ghs.rhs.items;var sourceAttrElementID,destAttrElementID;var lineColor,lineThickness;var maxLineThickness=this.wpMaxLineThickness;this._affinityLines=new Object();for(rowIndex=0;rowIndex<data.length;rowIndex++){var rowHeaderElements=rowHeaders[rowIndex].items;var firstAttrElementIndex=rowHeaderElements[this.secondaryDPFirstAttrColIndex];var secondAttrElementIndex=rowHeaderElements[this.secondaryDPSecondAttrColIndex];sourceAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPFirstAttrColIndex].es[firstAttrElementIndex.idx].id);destAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPSecondAttrColIndex].es[secondAttrElementIndex.idx].id);if(this._markerElementIDs[sourceAttrElementID]==null||this._markerElementIDs[destAttrElementID]==null){continue;}if(secondMetricIndex!=-1){lineColor=this.getThresoldString(rowIndex,"#FF0000",this.secData,secondMetricIndex);}else{lineColor="#FF0000";}var cell=data[rowIndex].items[0];if(cell.v){metricCellValue=parseFloat(this.stripNumberFormat(cell.v));lineThickness=(metricCellValue*maxLineThickness)/this.secondaryDPMetricMaxVal[0]["max"];}else{lineThickness=1;}var polyline=new esri.geometry.Polyline(this.esriMap.spatialReference);polyline.addPath([this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]]);var lineSymbol=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color(lineColor),lineThickness);polyline.setSymbol(lineSymbol);this.affinityLineLayer.add(polyline);this._affinityLines[sourceAttrElementID+destAttrElementID]=polyline;}this.esriMap.addLayer(this.affinityLineLayer);},_animationSourceMarkerLines:null,_animationMarkers:null,_affinityAnimationFinished:false,_currentAffinityInterval:0,NO_OF_POINTS:20,_affinityGlow:false,_selectedAffinityMarkers:null,startAffinityLinesAnimation:function startAffinityLinesAnimation(sourceMarkerIds){if(!this.secData){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()==-1){return ;}if(this.secData.gts.col.length==0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}var secondMetricIndex;secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var rowHeaders=this.secData.ghs.rhs.items;var sourceAttrElementID,destAttrElementID;var polyline,option;if(!this._animationSourceMarkerLines){this._animationSourceMarkerLines=[];}var i;for(i=this._animationSourceMarkerLines.length;i>0;i--){this._animationSourceMarkerLines.pop();}for(rowIndex=0;rowIndex<data.length;rowIndex++){var rowHeaderElements=rowHeaders[rowIndex].items;var firstAttrElementIndex=rowHeaderElements[this.secondaryDPFirstAttrColIndex];var secondAttrElementIndex=rowHeaderElements[this.secondaryDPSecondAttrColIndex];sourceAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPFirstAttrColIndex].es[firstAttrElementIndex.idx].id);destAttrElementID=this.getElementIdWithoutAttributeID(rowAttributes[this.secondaryDPSecondAttrColIndex].es[secondAttrElementIndex.idx].id);if(sourceMarkerIds[sourceAttrElementID]==null||this._markerElementIDs[destAttrElementID]==null){if(this._affinityLines[sourceAttrElementID+destAttrElementID]!=null){polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.setMap(null);}continue;}polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.strokeOpacity=1;polyline.setMap(this.map);if(this.wpDrawArcsLines=="Arcs"){this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.findPointsOnArc(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}else{this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.findPointsOnLine(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}}if(!this._animationMarkers){this._animationMarkers=[];}for(i=this._animationMarkers.length;i>0;i--){this._animationMarkers.pop();}this._affinityAnimationFinished=true;if(this._animationSourceMarkerLines.length==0){return ;}for(i=0;i<this._animationSourceMarkerLines.length;i++){var arr=this._animationSourceMarkerLines[i];var marker=this.createAffinityAnimationMarker(arr[0]);this._animationMarkers[i]=marker;}this._currentAffinityInterval=0;this.doAffinityAnimation();},clearAffinityAnimationObjects:function clearAffinityAnimationObjects(){if(this._animationMarkers){for(i=0;i<this._animationMarkers.length;i++){this._animationMarkers[i].setMap(null);}for(i=this._animationMarkers.length;i>0;i--){this._animationMarkers.pop();}}this._selectedAffinityMarkers=null;this._affinityAnimationFinished=false;},handleAffinityAnimationMouseClick:function handleAffinityAnimationMouseClick(marker,event){if(!marker){return ;}if(this._affinityAnimationFinished){this.clearAffinityAnimationObjects();}var ctrlKey=event.ctrlKey;if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}if(!ctrlKey){this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;this.handleAffinityAnimationKeyUp();}else{if(this._selectedAffinityMarkers.hasOwnProperty(marker.attributes.id)){marker.isSelected=false;id=marker.attributes.id;delete this._selectedAffinityMarkers[marker.attributes.id];}else{this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;}}},handleAffinityAnimationKeyUp:function handleAffinityAnimationKeyUp(){if(!this._affinityAnimationFinished&&this._affinityGlow){var sourceId=new Object();var id;var marker;for(id in this._selectedAffinityMarkers){sourceId[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceId);}},moveAffinityAnimationMarker:function moveAffinityAnimationMarker(){var i;for(i=0;i<this._animationSourceMarkerLines.length;i++){var arr=this._animationSourceMarkerLines[i];var marker=this._animationMarkers[i];if(this._currentAffinityInterval<this.NO_OF_POINTS){marker.setPosition(arr[this._currentAffinityInterval]);}if(this._currentAffinityInterval==0){marker.setMap(this.map);}}if(this._currentAffinityInterval==this.NO_OF_POINTS-1){for(i=0;i<this._animationMarkers.length;i++){this._animationMarkers[i].setMap(null);}clearTimeout(this._glowTimer);}else{this._currentAffinityInterval++;this.doAffinityAnimation();}},doAffinityAnimation:function doAffinityAnimation(){var that=this;this._glowTimer=setTimeout(function(){that.moveAffinityAnimationMarker();},50);},createAffinityAnimationMarker:function createAffinityAnimationMarker(latLng){var marker;var markerImage=new google.maps.MarkerImage("images/glow_marker.png",null,null,null,new google.maps.Size(10,8));marker=new google.maps.Marker({position:latLng,icon:markerImage,map:this.map});return marker;},findPointsOnArc:function findPointsOnArc(from,to){var nPoints=this.NO_OF_POINTS;var coords=[];var radToDeg=180/Math.PI;var lat1=from.lat()/radToDeg;var lng1=from.lng()/radToDeg;var lat2=to.lat()/radToDeg;var lng2=to.lng()/radToDeg;var degree=2*Math.asin(Math.sqrt(Math.pow((Math.sin(lat1-lat2)/2),2)+Math.cos(lat1)*Math.cos(lat2)*Math.pow((Math.sin(lng1-lng2)/2),2)));var i;for(i=0;i<=this.NO_OF_POINTS;i++){var f=Number(i/nPoints);var a=Math.sin((1-f)*degree)/Math.sin(degree);var b=Math.sin(f*degree)/Math.sin(degree);var x=a*Math.cos(lat1)*Math.cos(lng1)+b*Math.cos(lat2)*Math.cos(lng2);var y=a*Math.cos(lat1)*Math.sin(lng1)+b*Math.cos(lat2)*Math.sin(lng2);var z=a*Math.sin(lat1)+b*Math.sin(lat2);var rLat=Math.atan2(z,Math.sqrt(Math.pow(x,2)+Math.pow(y,2)));var rLng=Math.atan2(y,x);coords[i]=new google.maps.LatLng(rLat*radToDeg,rLng*radToDeg);}return coords;},findPointsOnLine:function findPointsOnLine(from,to){var m=Infinity;var c;var pts=[];var interval;var lat;var lng;var i;if(to.lng()-from.lng()!=0){m=(to.lat()-from.lat())/(to.lng()-from.lng());c=from.lat()-m*from.lng();interval=(to.lng()-from.lng())/this.NO_OF_POINTS;}else{interval=(to.lat()-from.lat())/this.NO_OF_POINTS;}for(i=0;i<=this.NO_OF_POINTS;i++){if(m==Infinity){lng=from.lng();lat=from.lat()+interval*i;}else{lng=from.lng()+interval*i;lat=m*lng+c;}pts[i]=new google.maps.LatLng(lat,lng);}return pts;},getElementIdWithoutAttributeID:function getElementIdWithoutAttributeID(elementID){var newElementID="";var pos=0;var i;for(i=0;i<elementID.length;i++){if(elementID.charAt(i)==":"){pos++;}if(pos==1){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;},secondaryDPFirstAttrColIndex:-1,secondaryDPSecondAttrColIndex:-1,findSecondaryDPAttrColIndexes:function findSecondaryDPAttrColIndexes(){var data=this.secData.gvs.items;var rowAttributes=this.secData.gts.row;var attrId=rowAttributes[0].id;this.secondaryDPFirstAttrColIndex=0;var i;for(i=1;i<rowAttributes.length;i++){if(rowAttributes[i].id!=attrId){this.secondaryDPSecondAttrColIndex=i;break;}}return this.secondaryDPSecondAttrColIndex;},findSecondaryDPSecondMetricIndex:function findSecondaryDPSecondMetricIndex(){var colAttributes=this.secData.gts.col[0].es;if(colAttributes.length>1){return 1;}else{return -1;}},secondaryDPMetricMaxVal:null,computeSecondaryDPMetricMax:function computeSecondaryDPMetricMax(metricColumnIndex){if(!this.secondaryDPMetricMaxVal){this.secondaryDPMetricMaxVal={};}if(this.secondaryDPMetricMaxVal.hasOwnProperty(metricColumnIndex)){return ;}var rowHeaders=this.secData.ghs.rhs.items;var data=this.secData.gvs.items;var rowIndex=0;var maxValue=-Infinity;for(rowIndex=0;rowIndex<data.length;rowIndex++){var values=data[rowIndex].items;var cell=values[metricColumnIndex];if(cell.v){var cellNumber=parseFloat(this.stripNumberFormat(cell.v));maxValue=(cellNumber>maxValue)?cellNumber:maxValue;}}this.secondaryDPMetricMaxVal[metricColumnIndex]={max:maxValue};},getExecutionScope:function(){return microstrategy.EXECUTION_SCOPE;},getMsgId:function(){return this.gridParams.msgID;}});mstrmap.ESRIMap.arrangeGridLayersVerticalOrderingOnMap=function arrangeGridLayersVerticalOrderingOnMap(grids){var tempGrid=[],widgetProps,primaryGridIndex;grids[0].isPrimary=true;for(var i=0;i<grids.length;i++){widgetProps=(i==0)?grids[0].vp:grids[0].vp.sgProps[grids[i].k];if(widgetProps.sa=="1"){tempGrid.unshift(grids[i]);}else{if(widgetProps.sm=="1"){tempGrid.push(grids[i]);}}}grids.splice(0,grids.length);for(var i=0;i<tempGrid.length;i++){grids.push(tempGrid[i]);if(tempGrid[i].isPrimary&&tempGrid[i].isPrimary==true){primaryGridIndex=i;}}return primaryGridIndex;};mstrmap.ESRIMap.newMapViewer=function newMapViewer(encodedUrl,placeholder,gridParams,scriptClass){var url=unescape(encodedUrl);var splitUrl=url.split("?");var baseUrl=splitUrl[0];mstrApp.taskURL=baseUrl;gridParams.taskURL=baseUrl;var params=splitUrl[1].split("&");var splitParams={};var p;for(p in params){if(params.hasOwnProperty(p)){var param=params[p].split("=");splitParams[param[0]]=param[1];gridParams[param[0]]=param[1];}}mstrApp.localeId=gridParams.localeId;splitParams.includeOptimizedDrillPathSetting="true";gridParams.includeOptimizedDrillPathSetting="true";scriptClass=scriptClass?scriptClass:"mstrmap.ESRIMap";var xhrCfg={success:function(res){if(!res){return ;}var map=mstrmap.ESRIMap.initMapViewer(res,scriptClass,placeholder,baseUrl,splitParams,gridParams);},failure:function(res){alert("Error loading grid data: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("GET",baseUrl,xhrCfg,splitParams);};mstrmap.ESRIMap.initMapViewer=function initMapViewer(data,scriptClass,placeholder,baseUrl,params,gridParams){var primaryData,grids,totalDataSets,layersList,primaryGridIndex;if(data.hasOwnProperty("grids")){grids=data.grids;primaryData=data.grids[0];}else{grids=[data];primaryData=data;}totalDataSets=1;if(!primaryData.vp||!primaryData.vp.hasOwnProperty("sm")||!primaryData.vp.hasOwnProperty("sa")){mstrmojo.alert("Can not find the visualization properties. Kindly set the visualization properties and run the visualization again.");return ;}if(!!primaryData.vp.sgProps){for(var key in primaryData.vp.sgProps){if(primaryData.sdp&&primaryData.sdp[key]&&!primaryData.sdp[key].eg){grids[totalDataSets]=primaryData.sdp[key];totalDataSets++;}}}primaryGridIndex=this.arrangeGridLayersVerticalOrderingOnMap(grids);var cols,col,i,j,ind;var metricData=[];var metricsString=mstrmojo.desc(1158,"Metrics");for(ind=0;ind<totalDataSets;ind++){if(grids[ind].eg){continue;}cols=grids[ind].gts.col;metricData[ind]={metrics:[],gridName:grids[ind].n};for(i=0;i<cols.length;i++){col=cols[i];if(col.n==metricsString){var es=col.es;for(j=0;j<es.length;j++){var o={v:j,n:es[j].n,id:es[j].id,gIdx:ind};metricData[ind].metrics.push(o);}break;}}}var oldId=mstrmap[gridParams.boneId];var oldContainer=mstrmojo.all[oldId];if(oldContainer){oldContainer.destroy();}var baseid=gridParams.boneId;var placeholderDiv=document.getElementById(placeholder);var placeholderClone=placeholder;if(placeholderDiv){placeholderClone=placeholderDiv.cloneNode(true);placeholderClone.id+="-clone";placeholderDiv.appendChild(placeholderClone);}var map=mstrmojo.insert({id:baseid+"-1",scriptClass:"mstrmojo.VBox",halign:"left",width:"100%",height:"100%",placeholder:placeholderClone,children:[{id:baseid+"-9",alias:"map",scriptClass:scriptClass,width:""+gridParams.width+"px",height:""+gridParams.height+"px",gridParams:gridParams,params:params,gridData:grids,_primaryGridIndex:primaryGridIndex,metricData:metricData}]});map.render();};})();