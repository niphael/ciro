if(typeof (mstrmojo.gmaps)=="undefined"){mstrmojo.gmaps={};}(function(){var HYPERLINK_ACTION=4;mstrmojo.requiresCls("mstrmojo.gmaps.MapDataViewer");mstrmap.ESRIMapViewer=mstrmojo.declare(mstrmojo.gmaps.MapDataViewer,null,{scriptClass:"mstrmap.ESRIMapViewer",bubbleMode:false,maxRadius:50,minRadius:4,wpMapSizingStyle:"0",wpApplyThreshold:true,columnIndices:{state:-1,zip:-1},enableRectangleSelect:false,enableMarker:false,enablePolygon:false,_extent:null,geoElements:{},geoPosition:-1,infoWindowUseGrid:true,infoWindowVisible:false,latIndex:-1,longIndex:-1,_markerElementIDs:null,markerLayer:null,polygonLayer:null,points:null,previousState:null,savedSliceInfo:null,validBubble:false,viewCache:null,wpDisPlayAffinityLines:false,init:function init(props){this._super(props);},handleMetricSelectionChange:function handleMetricSelectionChange(){if(this.enableMarker){this.adjustMarkerColor();}if(this.enablePolygon){this.adjustPolygonColor();}},adjustMarkerColor:function adjustMarkerColor(){var g;if(this.markerLayer===null){return ;}this.populateMinMax(this.selectedMetricIndex);this.populateBubbleVariables();var defaultSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,0.35]),1),new dojo.Color([125,125,125,0.35]));var graphics=this.markerLayer.graphics;var numGraphics=graphics.length;var symbol;for(g=0;g<numGraphics;g++){var graphic=graphics[g];symbol=graphic.symbol;var rowIndex=graphic.attributes.rowIndex;var rowValue=this.data.gvs.items[rowIndex].items;var rowCell;var type=this.parent.enumNumber;if(rowValue!=undefined&&rowValue instanceof Array){rowCell=rowValue[this.selectedMetricIndex];type=rowCell.ty;}var colorString,dojoColor;switch(type){case this.parent.enumImage:case this.parent.enumUrl:var imageString=this.getThresoldString(rowIndex,"no");if(imageString!="no"){if(symbol instanceof esri.symbol.PictureMarkerSymbol){symbol.setUrl(imageString);}else{symbol=new esri.symbol.PictureMarkerSymbol(imageString,20,20);}}break;case this.parent.enumText:case this.parent.enumQuickSymbol:colorString=this.getThresoldString(rowIndex,"#ffffff");dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;symbol=new esri.symbol.TextSymbol(this.parent.getQuickSymbol(rowCell.v)).setColor(dojoColor).setAlign(esri.symbol.Font.ALIGN_START).setFont(new esri.symbol.Font("12pt").setWeight(esri.symbol.Font.WEIGHT_BOLD));break;case this.parent.enumNumber:default:colorString=this.getThresoldString(rowIndex,this.DEFAULT_COLOR);dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;if(this.bubbleMode){symbol=new esri.symbol.SimpleMarkerSymbol();symbol.setColor(dojoColor);symbol.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE);var valueString=rowCell.rv?rowCell.rv:this.parent.stripNumberFormat(rowCell.v);var cellNumber=parseInt(valueString,10);if(this.validBubble){var size=this.calculateRadius(cellNumber);symbol.setSize(size);}else{symbol.setSize(20);}}else{if(symbol instanceof esri.symbol.SimpleMarkerSymbol){symbol=graphic.symbol.setColor(dojoColor);}else{symbol=new esri.symbol.SimpleMarkerSymbol();symbol.setColor(dojoColor);}symbol.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_DIAMOND);}symbol.setOutline(this.parent.regularStroke);break;}graphic.setSymbol(symbol);}this.markerLayer.refresh();},adjustPolygonColor:function adjustPolygonColor(){var g;if(this.polygonLayer===null){return ;}var graphics=this.queryFeatureSet.features;var numGraphics=graphics.length;for(g=0;g<numGraphics;g++){var graphic=graphics[g];var rowIndex=graphic.attributes.rowIndex;var colorString=this.getThresoldString(rowIndex,this.DEFAULT_COLOR);var dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;graphic.setSymbol(graphic.symbol.setColor(dojoColor));}this.polygonLayer.refresh();},calculateRadius:function calculateRadius(value){if(isNaN(value)){return this.minRadius;}if(value<=0){if(this.wpMapSizingStyle==="1"){return this.minRadius;}value=Math.abs(value);}return Math.max(this.maxRadius*Math.sqrt(value/this.maxValue),this.minRadius);},clearPoints:function clearPoints(){this.points=new esri.geometry.Multipoint(this.parent.esriMap.spatialReference);},clearHighlight:function clearHighlight(){var i,j;for(i in this.highlightedGraphics){if(this.highlightedGraphics[i] instanceof Array){var highlightedGraphics=this.highlightedGraphics[i];var hilightCount=highlightedGraphics.length;for(j=0;j<hilightCount;j++){var g=highlightedGraphics[j];if(g.geometry instanceof esri.geometry.Polyline){g.symbol.width=1;g.setSymbol(g.symbol);}else{if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(this.parent.regularStroke));}}}}}},createGridInfoWindow:function createGridInfoWindow(div,dataRows,geoColumnIndices){var isIE=(navigator.appVersion.indexOf("MSIE")!=-1)?true:false;var table=div.childNodes[0];var css;var cell;var header;var tui;var idx;var td;var titleSpan;var i,j,k;var tr;var cssStyle;if(!table){table=this.parent.createEmptyGridInfoWindowTable();div.appendChild(table);}cssStyle=this.parent.createInfoTabDivCSSStyle();if(cssStyle!=null){div.appendChild(cssStyle);}while(!!table&&table.rows.length>0){table.deleteRow(table.rows.length-1);}if(table.tHead){var thead=table.tHead;while(thead.rows.length>0){thead.deleteRow(thead.rows.length-1);}tr=thead.insertRow(thead.rows.length);var numRowAttributes=this.data.ghs.rhs.items[0].items.length;var numColAttributes=this.data.ghs.chs.items[0].items.length;for(i=0;i<numRowAttributes;i++){if(this.isIndexGeoPosition(i,geoColumnIndices)){continue;}td=tr.insertCell(tr.cells.length);header=this.data.gts.row[i];css=this.getCssClass(header.cni);td.className=css;titleSpan=document.createElement("span");titleSpan.innerHTML=header.n;td.appendChild(titleSpan);}for(i=0;i<numColAttributes;i++){td=tr.insertCell(tr.cells.length);cell=this.data.ghs.chs.items[0].items[i];tui=cell.tui;idx=cell.idx;header=this.data.gts.col[tui].es[idx];css=this.getCssClass(cell.cni);td.className=css;titleSpan=document.createElement("span");titleSpan.innerHTML=header.n;td.appendChild(titleSpan);}}var tbody=table.tBodies[0];var numRows=dataRows.length;var metricValues=this.data.gvs.items;var numMetrics=this.data.gvs.items[0].items.length;var numAttributes=this.data.ghs.rhs.items[0].items.length;for(i=0;i<numRows;i++){var rowIndex=dataRows[i];tr=tbody.insertRow(tbody.rows.length);var rowHeaders=this.data.ghs.rhs.items[rowIndex].items;for(j=0;j<numAttributes;j++){if(this.isIndexGeoPosition(j,geoColumnIndices)){continue;}cell=rowHeaders[j];if(!cell||cell.idx<0){td=tr.insertCell(tr.cells.length);td.innerHTML=" ";td.className=css;continue;}idx=cell.idx;css=this.getCssClass(cell.cni);var attributeName=this.data.gts.row[j].es[idx].n;td=tr.insertCell(tr.cells.length);td.className=css;if(j==this.geoPosition&&i>0){td.innerHTML="    ";}else{td.innerHTML="    "+attributeName+"    ";}}for(k=0;k<numMetrics;k++){var metricValue=metricValues[rowIndex].items[k].v;var thresholdType=metricValues[rowIndex].items[k].ty;css=this.getCssClass(metricValues[rowIndex].items[k].cni);td=tr.insertCell(tr.cells.length);td.className=css;if(thresholdType==this.parent.enumImage){td.innerHTML='    <img src="'+metricValue+'"/>    ';}else{td.innerHTML="    "+metricValue+"    ";}}}},createLookup:function createLookup(){var dataLookup={};var rowIndex;var rowHeader=this.data.ghs.rhs.items;for(rowIndex=0;rowIndex<rowHeader.length;rowIndex++){var rowGeoHeader=rowHeader[rowIndex].items[this.geoPosition];dataLookup[this.data.gts.row[this.geoPosition].es[rowGeoHeader.idx].n]={rowIndex:rowIndex,geoIndex:rowGeoHeader.idx};}return dataLookup;},getCssClass:function getCssClass(cssIndex){if(cssIndex<0||cssIndex>this.data.css.length){return"";}return this.data.css[cssIndex].n;},getDefaultInfoWindowTemplate:function getDefaultInfoWindowTemplate(skipIndices){var contentHTML="";var rowHeaders=this.data.ghs.rhs.items[0].items;var rowTitles=this.data.gts.row;var rowCell,rowCellTitle;var j,k;for(k=0;k<rowHeaders.length;k++){if(skipIndices&&mstrmojo.array.indexOf(skipIndices,k)==-1){rowCell=rowHeaders[k];rowCellTitle=rowTitles[k].n;contentHTML+="<b>"+rowCellTitle+"</b>: ${"+this.parent.replaceSpace(rowCellTitle)+"}<br />";}}var metricString=mstrmojo.desc(1158,"Metrics");if(this.data.gts.col.length==1&&this.data.gts.col[0].n==metricString){rowHeaders=this.data.gts.col[0].es;for(j=0;j<rowHeaders.length;j++){rowCellTitle=rowHeaders[j].n;contentHTML+="<b>"+rowCellTitle+"</b>: ${"+this.parent.replaceSpace(rowCellTitle)+"}<br />";}}return contentHTML;},getExtent:function getExtent(){return this._extent;},getGeoColumnIndex:function getGeoColumnIndex(){if(this.enablePolygon){return this.geoPosition;}if(this.enableMarker){return this.latIndex;}},getThresoldString:function getThresoldString(rowIndex,defaultValue){if(!this.wpApplyThreshold){return defaultValue;}var rowValue=this.data.gvs.items[rowIndex].items;if(rowValue!==undefined&&rowValue instanceof Array){var rowCell=rowValue[this.selectedMetricIndex];if(rowCell!==undefined&&rowCell.ti!==undefined){var thClrIndex=rowCell.ti;var colorArray=this.data.th;if(colorArray!==undefined&&colorArray[thClrIndex]!==undefined){return colorArray[thClrIndex].n;}}}return defaultValue;},handleClickEvent:function handleClickEvent(evt){if(this.parent.enablePopup){this.parent.set("infoWindowVisible",true);this.showInfoWindow(evt);this.infoWindowVisible=true;}else{if(this.parent.enableClickSelect){this.handleSelection(evt);}}dojo.stopEvent(evt);},handleExtentDraw:function handleExtentDraw(geometry){if(this.enableMarker){this.handleMarkerExtentDraw(geometry);}if(this.enablePolygon){this.handlePolygonExtentDraw(geometry);}},handleMarkerExtentDraw:function handleMarkerExtentDraw(geometry){var i;var map=this.parent.esriMap;var graphic=map.graphics.add(new esri.Graphic(geometry,this.parent.rectangleFillSymbol));var point;var columnIndex=this.latIndex;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);var graphics=this.markerLayer.graphics;var numGraphics=graphics.length;var g;for(i=0;i<numGraphics;i++){g=graphics[i];j=mstrmojo.array.indexOf(currentSelections,g.attributes.geoIndex);if(j==-1&&geometry.contains(g.geometry)){currentSelections.push(g.attributes.geoIndex);selectedRowIndices.push(g.attributes.rowIndex);if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(this.parent.selectionStroke));}highlightedGraphics.push(g);}}if(currentSelections.length>0&&this.enableRectangleSelect){var sliceInfo={pos:[this.latIndex,this.longIndex],elementIndex:currentSelections.sort(),setViewDataFlag:false,applyControl:true,beanPath:this.beanPath};this.command.applySelection(sliceInfo);}this.parent.markerSelected=((currentSelections.length>0)?true:false);this.parent.setDrilLButtonEnable();},handlePolygonExtentDraw:function handlePolygonExtentDraw(geometry){var i,j;var graphic;var map=this.parent.esriMap;var highlightOutline=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,255],0.35),2);var columnIndex=this.geoPosition;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);var graphics=this.polygonLayer.graphics;var numGraphics=graphics.length;for(i=0;i<numGraphics;i++){var g=graphics[i];j=mstrmojo.array.indexOf(currentSelections,g.attributes.geoIndex);if(j==-1&&geometry.intersects(g.geometry.getExtent())){currentSelections.push(g.attributes.geoIndex);selectedRowIndices.push(g.attributes.rowIndex);if(g.geometry instanceof esri.geometry.Polyline){g.symbol.width=5;g.setSymbol(g.symbol);}else{if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(highlightOutline));}}highlightedGraphics.push(g);}}if(currentSelections.length>0&&this.enableRectangleSelect){var sliceInfo={pos:[this.geoPosition],elementIndex:currentSelections.sort(),setViewDataFlag:false,applyControl:true,beanPath:this.beanPath};this.command.applySelection(sliceInfo);}this.parent.markerSelected=((currentSelections.length>0)?true:false);this.parent.setDrilLButtonEnable();},handleSelection:function handleSelection(evt){if(!this.parent.enableClickSelect){return ;}console.log("The selected index is "+evt.graphic.attributes.geoIndex);var geoIndex=evt.graphic.attributes.geoIndex;var rowIndex=evt.graphic.attributes.rowIndex;var columnIndices=evt.graphic.attributes.columnIndices;var columnIndex=columnIndices[0];var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);if(!this.previousState){this.previousState={};this.previousState.columnIndex=columnIndex;this.previousState.currentSelections=currentSelections.slice(0);this.previousState.selectedRowIndices=selectedRowIndices.slice(0);this.previousState.highlightedGraphics=highlightedGraphics.slice(0);this.previousState.mapObjectsState={selectedObj:[],unselectedObj:[]};this.previousState.stateChangedMarker=[];}var isAdd=true;var map=this.parent.esriMap;var i=mstrmojo.array.indexOf(currentSelections,geoIndex);if(i!=-1){currentSelections.splice(i,1);selectedRowIndices.splice(i,1);if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.selectedObj.push(evt.graphic);}var g=evt.graphic;var graphicIndex=mstrmojo.array.indexOf(highlightedGraphics,g);if(g.geometry instanceof esri.geometry.Polyline){evt.graphic.symbol.width=1;evt.graphic.setSymbol(evt.graphic.symbol);}else{if(g.symbol.setOutline){g.setSymbol(g.symbol.setOutline(this.parent.regularStroke));}}highlightedGraphics.splice(graphicIndex,1);}else{currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);highlightedGraphics.push(evt.graphic);if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.unselectedObj.push(evt.graphic);}if(evt.graphic.geometry instanceof esri.geometry.Polyline){evt.graphic.symbol.width=5;evt.graphic.setSymbol(evt.graphic.symbol);}else{if(evt.graphic.symbol.setOutline){evt.graphic.setSymbol(evt.graphic.symbol.setOutline(this.parent.selectionStroke));}}}if(currentSelections.length>0){var sliceInfo={pos:columnIndices,elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.beanPath};this.savedSliceInfo=sliceInfo;}},hideInfoWindow:function hideInfoWindow(evt){if(this.parent.enablePopup){this.parent.esriMap.graphics.clear();this.parent.esriMap.infoWindow.hide();this.infoWindowVisible=false;console.log("hideinfowindow viewer");}},initMarkerMap:function initMarkerMap(createMode){if(!createMode){this.markerLayer.show();return ;}var i,j,rowIndex,columnHeaderColumnIndex,columnHeaderRowIndex;this.clearPoints();this.idMarkerMap={};this._markerElementIDs={};this.parent.populateOriginalPosition();if(this.widgetProps){}this.populateBubbleVariables();this.longIndex=-1;this.latIndex=-1;var data=this.data.gvs.items;var rowAttributes=this.data.gts.row;var numTemplateUnits=rowAttributes.length;var latFormId=this.widgetProps.lat;var longFormId=this.widgetProps.lng;var attrId=this.widgetProps.ma;var props=this.widgetProps;if(props&&props.aff=="1"){this.wpDisPlayAffinityLines=true;}for(i=0;i<numTemplateUnits;i++){if(rowAttributes[i].id==attrId){var formId=rowAttributes[i].fid;if(formId==latFormId){this.latIndex=i;}else{if(formId==longFormId){this.longIndex=i;}}}}var symbol;if(this.longIndex<0||this.latIndex<0){mstrmojo.alert(mstrmojo.desc(8214,"No Mappable attributes present on the report."));return ;}var infoTemplate=new esri.InfoTemplate();infoTemplate.setTitle(" ");var s="";var templateUnitName;for(j=0;j<rowAttributes.length;j++){if(j==this.latIndex||j==this.longIndex){continue;}templateUnitName=rowAttributes[j].n;s+="<b>"+templateUnitName+"</b> :${"+this.parent.replaceSpace(templateUnitName)+"}<br />";}var markerLayer=this.markerLayer;if(markerLayer==undefined){markerLayer=new esri.layers.GraphicsLayer();markerLayer.id="marker";this.markerLayer=markerLayer;}var map=this.parent.esriMap;try{map.addLayer(markerLayer,this.layerIndex);}catch(e){console.log("error adding layer to map:"+e.name+":"+e.description);}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate([this.latIndex,this.longIndex]);if(this.infoWindowHTML==""){this.infoWindowHTML=this.defaultInfoWindowHTML;}var rowHeaders=this.data.ghs.rhs.items;var validSymbol;for(rowIndex=data.length-1;rowIndex>=0;rowIndex--){validSymbol=true;var rowHeaderElements=rowHeaders[rowIndex].items;var latitudeElement=rowHeaderElements[this.latIndex];if(!latitudeElement||latitudeElement.idx<0){continue;}var latitude=this.parent.stripNumberFormat(rowAttributes[this.latIndex].es[latitudeElement.idx].n);var latitudeId=rowAttributes[this.latIndex].es[latitudeElement.idx].id;if(latitudeId.indexOf("DB:")==0){continue;}var longitudeElement=rowHeaderElements[this.longIndex];if(!longitudeElement||longitudeElement.idx<0){continue;}var longitude=this.parent.stripNumberFormat(rowAttributes[this.longIndex].es[longitudeElement.idx].n);var longitudeId=rowAttributes[this.longIndex].es[longitudeElement.idx].id;if(longitudeId.indexOf("DB:")==0){continue;}var idkey;if(latitudeId==longitudeId){idkey=latitudeId;}else{idkey=latitudeId+"|"+longitudeId;}if(this.idMarkerMap[idkey]){continue;}var attributes={};var geoIndex;for(i=0;i<rowHeaderElements.length;i++){var rowHeaderElement=rowHeaderElements[i];if(rowHeaderElement.idx<0){continue;}var titleIndex=rowHeaderElement.tui;if(i==this.latIndex){geoIndex=rowHeaderElement.idx;}var elementValue=rowAttributes[i].es[rowHeaderElement.idx].n;attributes[this.parent.replaceSpace(rowAttributes[i].n)]=elementValue;}var values=data[rowIndex].items;var columnHeaders=this.data.ghs.chs.items;var columnHeaderName;var thresholdType;for(columnHeaderColumnIndex=0;columnHeaderColumnIndex<values.length;columnHeaderColumnIndex++){columnHeaderName=null;for(columnHeaderRowIndex=0;columnHeaderRowIndex<columnHeaders.length;columnHeaderRowIndex++){var cellElement=columnHeaders[columnHeaderRowIndex].items[columnHeaderColumnIndex];var cellName=this.data.gts.col[cellElement.tui].es[cellElement.idx].n;if(columnHeaderName===null){columnHeaderName=cellName;}else{columnHeaderName+=" "+cellName;}}thresholdType=values[columnHeaderColumnIndex].ty;if(!thresholdType||thresholdType==this.parent.enumNumber){attributes[this.parent.replaceSpace(columnHeaderName)]=values[columnHeaderColumnIndex].v;}else{attributes[this.parent.replaceSpace(columnHeaderName)]=values[columnHeaderColumnIndex].rv;}if(rowIndex==0){s+="<b>"+columnHeaderName+"</b> :${"+this.parent.replaceSpace(columnHeaderName)+"}<br />";}}attributes.rowIndex=rowIndex;attributes.geoIndex=geoIndex;attributes.columnIndices=[this.latIndex,this.longIndex];var cell=values[this.selectedMetricIndex];var type=this.wpApplyThreshold?cell.ty:this.parent.enumDefault;var colorString;var dojoColor;switch(type){case this.parent.enumText:case this.parent.enumQuickSymbol:colorString=this.getThresoldString(rowIndex,"#ffffff");dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;symbol=new esri.symbol.TextSymbol(this.parent.getQuickSymbol(cell.v)).setColor(dojoColor).setAlign(esri.symbol.Font.ALIGN_START).setFont(new esri.symbol.Font("12pt").setWeight(esri.symbol.Font.WEIGHT_BOLD));break;case this.parent.enumImage:case this.parent.enumUrl:var imageString=this.getThresoldString(rowIndex,"no");if(imageString!="no"){symbol=new esri.symbol.PictureMarkerSymbol(imageString,20,20);}else{validSymbol=false;}break;case this.parent.enumNumber:default:colorString=this.getThresoldString(rowIndex,this.parent.DEFAULT_COLOR);dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;symbol=new esri.symbol.SimpleMarkerSymbol();if(this.bubbleMode){symbol.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE);var valueString=cell.rv?cell.rv:this.parent.stripNumberFormat(cell.v);var cellNumber=parseInt(valueString,10);if(this.validBubble){var size=this.calculateRadius(cellNumber);symbol.setSize(size);}}else{symbol.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_DIAMOND);}symbol.setColor(dojoColor);symbol.setOutline(this.parent.regularStroke);break;}if(validSymbol){infoTemplate.setContent(s);var point=new esri.geometry.Point(longitude,latitude,this.parent.esriMap.spatialReference);if(this.parent.esriMap.spatialReference.wkid==102100||this.parent.esriMap.spatialReference.wkid==102113||this.parent.esriMap.spatialReference.wkid==3857||this.parent.esriMap.spatialReference.wkid==3785){point=esri.geometry.geographicToWebMercator(point);}var graphic=new esri.Graphic(point,symbol,attributes,infoTemplate);try{markerLayer.add(graphic);}catch(evt){console.log("error adding marker to layer:"+evt.name+":"+evt.description);}if(point!=undefined){this.points.addPoint(point);}this.idMarkerMap[idkey]=graphic;var strippedElementID=this.parent.getElementIdWithoutAttributeID(idkey);this._markerElementIDs[strippedElementID]=point;}}this.markerLayer=markerLayer;if(this.points!=undefined&&!!this.points.points&&this.points.points.length>0){if(this.parent.isBaseMapDynamic&&this.points.points.length==1){this._extent=this.getExtentForSingleMarker(latitude,longitude);}else{this._extent=this.points.getExtent();}if(createMode==true){this.parent.updateMapExtent();}}dojo.connect(markerLayer,"onClick",this,this.handleClickEvent);dojo.connect(map,"onClick",this,this.hideInfoWindow);},initPolygonMap:function initPolygonMap(createMode){if(!createMode){this.polygonLayer.show();return ;}var i,j,k;console.log("enter initPolygonMap");this.parent.populateOriginalPosition();this.initMapProperty();var map=this.parent.esriMap;var rowAttributes=this.data.gts.row;var numAttributes=rowAttributes.length;var geoAttributeName;var geoAttributeID,metricsStr=mstrmojo.desc(1158,"Metrics");for(i=0;i<numAttributes;i++){var attribute=rowAttributes[i];if(this.parent.esriAttributeMapping[attribute.id]&&this.geoPosition<0){this.geoPosition=i;geoAttributeName=attribute.n;geoAttributeID=attribute.id;this.geoElements=attribute.es;}}if(this.geoPosition<0){mstrmojo.alert(mstrmojo.desc(8214,"No Mappable attributes present on the report."));return ;}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate([this.geoPosition]);if(this.infoWindowHTML==""){this.infoWindowHTML=this.defaultInfoWindowHTML;}var mappedValue=this.parent.esriAttributeMapping[geoAttributeID];var queryTask;if(mappedValue!==undefined&&mappedValue.ml!==undefined){queryTask=new esri.tasks.QueryTask(""+mappedValue.ml);}else{return ;}this.esriField=mappedValue.ea;var query=new esri.tasks.Query();query.returnGeometry=true;query.outFields=eval(mappedValue.qf);query.outSpatialReference=this.parent.esriMap.spatialReference;console.log(mappedValue.qf.length+"->");var queryWhere=mappedValue.ea+" in ('"+this.geoElements[0].n+"'";for(i=1;i<this.geoElements.length;i++){queryWhere+=", '"+this.geoElements[i].n+"'";}queryWhere+=")";console.log("queryWhere "+queryWhere);query.where=queryWhere;var infoTemplate=new esri.InfoTemplate();infoTemplate.setTitle("${"+this.parent.replaceSpace(mappedValue.ea)+"}");dojo.connect(queryTask,"onComplete",this,function(featureSet){console.log("queryTask complete");var map=this.parent.esriMap;map.graphics.clear();var geoGraphicsLayer=new esri.layers.GraphicsLayer();map.addLayer(geoGraphicsLayer,this.layerIndex);this.polygonLayer=geoGraphicsLayer;console.log("featureSet size="+featureSet.features.length);var newExtent=null;var dataLookup=this.createLookup();this.queryFeatureSet=featureSet;var rowTitles=this.data.gts.row;for(i=0,il=featureSet.features.length;i<il;i++){var graphic=featureSet.features[i];var geoName=graphic.attributes[this.esriField]||graphic.attributes[this.esriField.toLowerCase()]||graphic.attributes[this.esriField.toUpperCase()];if(dataLookup){var attributes=graphic.attributes;var s="";var rowIndex=dataLookup[geoName].rowIndex;attributes.rowIndex=rowIndex;attributes.geoIndex=dataLookup[geoName].geoIndex;attributes.columnIndices=[this.geoPosition];var rowCell;var rowCellTitle;var rowCellValue;var thresholdType;var colorString,dojoColor;if(rowIndex!==undefined){colorString=this.getThresoldString(rowIndex,this.DEFAULT_COLOR);dojoColor=new dojo.Color(colorString);dojoColor.a=0.75;var symbol;if(graphic.geometry instanceof esri.geometry.Polyline){symbol=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,dojoColor,1);}else{if(graphic.geometry instanceof esri.geometry.Polygon){symbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255,0.35]),1),dojoColor);}}graphic.setSymbol(symbol);var rowHeaders=this.data.ghs.rhs.items[rowIndex].items;for(k=0;k<rowHeaders.length;k++){rowCell=rowHeaders[k];rowCellTitle=rowTitles[k].n;rowCellValue=rowTitles[k].es[rowCell.idx].n;attributes[this.parent.replaceSpace(rowCellTitle)]=rowCellValue;if(k==this.geoPosition){continue;}s+="<b>"+rowCellTitle+"</b>: ${"+this.parent.replaceSpace(rowCellTitle)+"}<br />";}if(this.data.gts.col.length==1&&this.data.gts.col[0].n==metricsStr){var dataRow=this.data.gvs.items[rowIndex].items;rowHeaders=this.data.gts.col[0].es;for(j=0;j<dataRow.length;j++){rowCell=dataRow[j];rowCellTitle=rowHeaders[j].n;rowCellValue=dataRow[j].v;thresholdType=dataRow[j].ty;if(!thresholdType||thresholdType==this.parent.enumNumber){attributes[this.parent.replaceSpace(rowCellTitle)]=rowCellValue;}else{attributes[this.parent.replaceSpace(rowCellTitle)]=dataRow[j].rv;}s+="<b>"+rowCellTitle+"</b>: ${"+this.parent.replaceSpace(rowCellTitle)+"}<br />";}}infoTemplate.setContent(s);graphic.setInfoTemplate(infoTemplate);try{geoGraphicsLayer.add(graphic);}catch(error){console.log("error added polygons to layer:"+error.name+":"+error.description);}if(newExtent===null){newExtent=graphic.geometry.getExtent();}else{newExtent=newExtent.union(graphic.geometry.getExtent());}}else{console.log("Missing..."+geoName);}}}this._extent=newExtent;if(createMode==true){this.parent.updateMapExtent();}map.graphics.enableMouseEvents();try{dojo.connect(geoGraphicsLayer,"onClick",this,this.handleClickEvent);dojo.connect(map,"onClick",this,this.hideInfoWindow);}catch(e){console.log(e.printStackTrace());}});dojo.connect(queryTask,"onError",this,this.parent.handleTaskQueryError);queryTask.execute(query);console.log("leaving initESRIMap");},isIndexGeoPosition:function isIndexGeoPosition(index,geoColumnIndices){var i;if(!(geoColumnIndices instanceof Array)){return false;}if(index<0){return false;}var results=false;for(i=0;i<geoColumnIndices.length;i++){if(index==geoColumnIndices[i]){results=true;break;}}return results;},populateMinMax:function populateMinMax(metricColumnIndex){if(!this.minMaxMap){this.minMaxMap={};}if(this.minMaxMap.hasOwnProperty(metricColumnIndex)){return ;}var rowHeaders=this.data.ghs.rhs.items;var data=this.data.gvs.items;var rowIndex=0;var minValue=Infinity;var maxValue=-Infinity;for(rowIndex=0;rowIndex<data.length;rowIndex++){var values=data[rowIndex].items;var cell=values[metricColumnIndex];var type=cell.ty;if(!type||type===this.parent.enumNumber){var cellNumber=parseInt(this.parent.stripNumberFormat(cell.v),10);maxValue=(cellNumber>maxValue)?cellNumber:maxValue;minValue=(cellNumber<minValue)?cellNumber:minValue;}}if(this.wpMapSizingStyle==="0"){this.minMaxMap[metricColumnIndex]={min:Math.min(Math.abs(minValue),Math.abs(maxValue)),max:Math.max(Math.abs(minValue),Math.abs(maxValue))};}else{this.minMaxMap[metricColumnIndex]={min:minValue,max:maxValue};}},processDrill:function processDrillRequest(){if(this.enablePolygon){this.performDrill(this.geoPosition);}if(this.enableMarker){this.performDrill(this.latIndex);}},loadMarkerWidgetProps:function loadMarkerWidgetProps(){var props=this.widgetProps;if(!props){return false;}property=props.mtp;if(property){this.bubbleMode=(property==="2");}if(this.bubbleMode){property=props.mbs;if(property){this.maxRadius=parseInt(property)/2;}property=props.mss;if(property){this.wpMapSizingStyle=property;}}property=props.at;if(property){this.wpApplyThreshold=(property==="1");}return true;},render:function renderGridLayer(createMode){if(this.data.eg){mstrmojo.alert(this.data.eg,null,this.data.n);return ;}var props=this.widgetProps;if(!props){this.widgetProps={sm:"0",sa:"1",cmt:this.parent.parent.hbox1.metricSelectorVBox.metricSelectorGridsVBox.children[0].children[1].selectedItem.id};}if(props&&props.iwd){this.infoWindowHTML=unescape(props.iwd);this.parseInfoWindowHTML();}if(props&&props.sm=="1"){this.enableMarker=this.loadMarkerWidgetProps();if(this.enableMarker){this.initMarkerMap(createMode);}}if(!props||props.sa=="1"){console.log("use shape");this.enablePolygon=true;this.initPolygonMap(createMode);}},resolveCustomizedInfoWindow:function resolveCustomizedInfoWindow(attributes){var input=this.infoWindowHTML;var result="";var baseIndex=0;var startIndex=input.indexOf("${",baseIndex);var endIndex=input.indexOf("}",startIndex+1);var macroName;var transformedMacroName;var replaceValue;while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);var colonIndex=macroName.indexOf(":");if(colonIndex>=0){transformedMacroName=macroName.substring(0,colonIndex)+" "+macroName.substring(colonIndex+1);}else{transformedMacroName=macroName;}transformedMacroName=this.parent.replaceSpace(transformedMacroName);if(attributes.hasOwnProperty(transformedMacroName)){result+=input.substring(baseIndex,startIndex)+attributes[transformedMacroName];}else{result+=input.substring(baseIndex,endIndex+1);}baseIndex=endIndex+1;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex,input.length);return result;},retrieveDataRows:function retrieveDataRows(sliceInfo){var dataRows=[];var k;if(sliceInfo){var geoElemIdx=parseInt(sliceInfo.elementIndex,10);var pos=parseInt(sliceInfo.pos,10);if(!this.viewCache){this.viewCache={};}if(this.viewCache[pos]===undefined||this.viewCache[pos]===null){this.viewCache[pos]={};}if(this.viewCache[pos]&&this.viewCache[pos][geoElemIdx]){dataRows=this.viewCache[pos][geoElemIdx];}else{var rowHeaders=this.data.ghs.rhs.items;var numRows=rowHeaders.length;for(k=0;k<numRows;k++){var rowHeader=rowHeaders[k].items;var cellHeader=rowHeader[pos];if(cellHeader&&cellHeader.idx==geoElemIdx){dataRows.push(k);}}this.viewCache[pos][geoElemIdx]=dataRows;}}return dataRows;},showInfoWindow:function showInfoWindow(evt){if(!this.parent.enablePopup){return ;}this.parent.esriMap.graphics.clear();var geoIndex=evt.graphic.attributes.geoIndex;var columnIndices=evt.graphic.attributes.columnIndices;var sliceInfo={pos:columnIndices[0],elementIndex:geoIndex,setViewDataFlag:false,applyControl:false};var dataRows=this.retrieveDataRows(sliceInfo);var map=this.parent.esriMap;var highlightSymbol;if(evt.graphic.geometry instanceof esri.geometry.Polyline){highlightSymbol=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0,0.25]),3);}else{highlightSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0]),3),new dojo.Color([125,125,125,0.35]));}var div,content,title,highlightGraphic,detail;var p=evt.screenPoint;map.infoWindow.resize(250,150);if(this.infoWindowHTML!==undefined&&(this.infoWindowHTML!=""&&this.infoWindowHTML!=this.defaultInfoWindowHTML)){detail=this.resolveCustomizedInfoWindow(evt.graphic.attributes);map.infoWindow.setContent(detail);title=evt.graphic.getTitle();highlightGraphic=new esri.Graphic(evt.graphic.geometry,highlightSymbol);map.graphics.add(highlightGraphic);map.infoWindow.setTitle(title);map.infoWindow.show(p,map.getInfoWindowAnchor(p));}else{if(dataRows.length==1){content=evt.graphic.getContent();map.infoWindow.setContent(content);title=evt.graphic.getTitle();map.infoWindow.setTitle(title);highlightGraphic=new esri.Graphic(evt.graphic.geometry,highlightSymbol);map.graphics.add(highlightGraphic);map.infoWindow.show(p,map.getInfoWindowAnchor(p));}else{if(this.infoWindowUseGrid){div=this.parent.infoTabDiv;this.createGridInfoWindow(div,dataRows,columnIndices);map.infoWindow.setContent(div);title=evt.graphic.getTitle();map.infoWindow.setTitle(title);highlightGraphic=new esri.Graphic(evt.graphic.geometry,highlightSymbol);map.graphics.add(highlightGraphic);map.infoWindow.show(p,map.getInfoWindowAnchor(p));map.infoWindow.resize(Math.min(480,div.children[0].scrollWidth+50),Math.min(300,div.children[0].scrollHeight+41));}else{div=this.chartDiv;map.infoWindow.setContent('<div id="chartDiv" style="width: 300px; height: 150px;" />');title=evt.graphic.getTitle();map.infoWindow.setTitle(title);highlightGraphic=new esri.Graphic(evt.graphic.geometry,highlightSymbol);map.graphics.add(highlightGraphic);map.infoWindow.show(p,map.getInfoWindowAnchor(p));this.prepareMapData("chartDiv",dataRows,columnIndices);}}}},getExtentForSingleMarker:function getExtentForSingleMarker(latitude,longitude){latitude=parseFloat(latitude);longitude=parseFloat(longitude);var minLat,maxLat,minLon,maxLon;minLat=Math.max(latitude-10,-90);maxLat=Math.min(latitude+10,90);minLon=longitude-10;maxLon=longitude+10;var bottomLeft=new esri.geometry.Point(minLon,minLat,this.parent.esriMap.spatialReference);var topRight=new esri.geometry.Point(maxLon,maxLat,this.parent.esriMap.spatialReference);if(this.parent.esriMap.spatialReference.wkid==102100||this.parent.esriMap.spatialReference.wkid==102113||this.parent.esriMap.spatialReference.wkid==3857||this.parent.esriMap.spatialReference.wkid==3785){bottomLeft=esri.geometry.geographicToWebMercator(bottomLeft);topRight=esri.geometry.geographicToWebMercator(topRight);}var points=new esri.geometry.Multipoint(this.parent.esriMap.spatialReference);points.addPoint(bottomLeft);points.addPoint(topRight);var extent=points.getExtent();return extent;},unrender:function unrender(){var props=this.widgetProps;if(props&&props.sm=="1"){try{if(!!this.markerLayer){this.markerLayer.hide();this.enableMarker=false;}}catch(e){console.log("error hiding the marker layer to map:"+e.name+":"+e.description);}}if(!props||props.sa=="1"){try{if(!!this.polygonLayer){this.polygonLayer.hide();this.enablePolygon=false;}}catch(e){console.log("error hiding the polygon layer to map:"+e.name+":"+e.description);}}if(this.infoWindowVisible){this.hideInfoWindow();}}});})();