usherProps={intervalCtr:0,qrLoaded:false,greyedOutOpacity:3,maxPollingAttempts:80,timeDelay:3,visibleOpacity:100};mstrmojo.requiresCls("mstrmojo.css");function checkForUsherScan(){try{var usherQRCode=document.getElementById("usherLogin");if(usherQRCode&&usherProps.qrLoaded){if(usherProps.intervalCtr>usherProps.maxPollingAttempts){disableQRCode();}else{setTimeout(function(){usherProps.intervalCtr=usherProps.intervalCtr+1;usherPollForScan();},usherProps.timeDelay*1000);}}}catch(e){}}function usherPollForScan(){var usherURL=mstrConfig.taskURL;var usherLoginForm=document.getElementById("usherLoginForm");var server=usherLoginForm.Server.value;var port=usherLoginForm.Port.value;var project=usherLoginForm.Project.value;var params={taskId:"usherLoginWeb",taskEnv:"xhr",taskContentType:"json",pollOnly:"true",server:server,port:port,project:project};var handleAjaxResponse={success:function(res){try{if(res.status=="invalid"){checkForUsherScan();}else{if(res.status=="success"){microstrategy.showWait();usherLoginForm.ConnMode.value="64";usherLoginForm.submit();disableQRCode();}}}catch(e){mstrmojo.alert("ups:\n "+e.messsage);}},failure:function(res){showAjaxError(res);}};mstrmojo.xhr.request("POST",usherURL,handleAjaxResponse,params);}function getQRCode(){var usherURL=mstrConfig.taskURL;var params={taskId:"usherQRWeb",taskEnv:"xhr",taskContentType:"json"};var handleAjaxResponse={success:function(res){try{var qrCode=document.getElementById("usherQRCodeImg");var usherQRCode=document.getElementById("usherLogin");qrCode.src="data:image/png;base64,"+res;mstrmojo.css.setOpacity(usherQRCode,usherProps.visibleOpacity);var refreshMsg=document.getElementById("usherRefresh");var refreshBtn=document.getElementById("usherRequestQRCode");mstrmojo.css.addClass(refreshMsg,"usherHidden");mstrmojo.css.addClass(refreshBtn,"usherHidden");usherProps.intervalCtr=0;usherProps.qrLoaded=true;checkForUsherScan();}catch(e){mstrmojo.alert("grc:\n "+e.messsage);}},failure:function(res){var qrCode=document.getElementById("usherQRCodeImg");qrCode.src="../style/mstr/images/msgError.gif";showAjaxError(res);}};mstrmojo.xhr.request("POST",usherURL,handleAjaxResponse,params);}function showAjaxError(res){if(res.getResponseHeader){disableQRCode();var errMsg=res.getResponseHeader("X-MSTR-TaskFailureMsg");var div=document.createElement("div");div.id="usherError";div.className="mstrAlert";div.appendChild(document.createTextNode(errMsg));var loc=document.getElementById("mstrWeb_error");if(loc){var usherErr=document.getElementById("usherError");if(usherErr){loc.replaceChild(div,usherErr);}else{loc.appendChild(div);}}}else{}}function disableQRCode(){var usherQRCode=document.getElementById("usherLogin");var refreshMsg=document.getElementById("usherRefresh");var refreshBtn=document.getElementById("usherRequestQRCode");mstrmojo.css.setOpacity(usherQRCode,usherProps.greyedOutOpacity);mstrmojo.css.removeClass(refreshMsg,"usherHidden");mstrmojo.css.removeClass(refreshBtn,"usherHidden");mstrmojo.css.addClass(refreshMsg,"usherRefreshMsg");usherProps.qrLoaded=false;}