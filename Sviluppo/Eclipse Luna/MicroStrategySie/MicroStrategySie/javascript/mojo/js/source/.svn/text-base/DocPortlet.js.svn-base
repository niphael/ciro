(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.ToolBar","mstrmojo.boxmodel","mstrmojo.array","mstrmojo.EnumRWUnitType","mstrmojo.dom","mstrmojo.css");var MOVE_FMTS=["background-color","border","border-color","border-left","border-style","border-top","border-width","filter","top","left","z-index","fx","normWidth","normHeight","normZIndex","normTop","normLeft","tbborder","lrborder","ttl"],COPY_FMTS=["width","height"],P_FMTS="p_fmts";var $PX="px";var ETS={getContentHeight:function(h,f){var th=f.ttl&&f.ttl.height;if(h&&th&&!this.floatingToolbar){return Math.max(parseInt(h,10)-parseInt(th,10),0)+$PX;}return"";},getPortletMinHeight:function(f){return f.ttl.height;},adjustTitleCss:function(ptlt){return ;}};var FTS={getContentHeight:function(h,f){return h;},getPortletMinHeight:function(){return 0;},adjustTitleCss:function(ptlt){ptlt.titlebarNodeClass+=" floating";return ;}};function passDirtyKey(method,key){var parent=this.parent,methodName=method+"DirtyKey";if(parent[methodName]){parent[methodName](key);}}function updateTitle(){var title=this.title;if(this.count){title+=" "+this.count;}this.toolbarTitleTextNode.innerHTML=title;}function retrieveFilterPanel(){var parent=this.parent,parentDefn=parent&&parent.defn;if(parentDefn&&parseInt(parentDefn.t,10)===mstrmojo.EnumRWUnitType.PANEL){var panelStack=parent.parent,panelStackDefn=panelStack.defn;if(panelStackDefn&&panelStackDefn.ifp){return panelStack;}}return null;}var $HASH=mstrmojo.hash,ITEM_SPA=2;mstrmojo.DocPortlet=mstrmojo.declare(mstrmojo.Container,[mstrmojo._Formattable],{scriptClass:"mstrmojo.DocPortlet",floatingTitle:false,floatingTitleHeight:30,buttonWidth:17,markupString:'<div class="mstrmojo-portlet {@borderCss}" style="{@portletNodeCssText}"><div class="mstrmojo-portlet-slot-shadow" style="{@shadowNodeCssText}"></div><div class="mstrmojo-portlet-container" style="{@portletContainerNodeCssText}"><div class="mstrmojo-portlet-titlebar {@titlebarNodeClass}" style="{@titlebarNodeCssText}"><table style="height:100%;width:100%" class="mstrmojo-portlet-titlebar-table" cellspacing="0" cellpadding="0"><tr><td class="mstrmojo-portlet-slot-toolbar-left {@leftToolbarNodeClass}" style="{@leftToolbarNodeCssText}"></td><td class="mstrmojo-portlet-title" style="{@titleNodeCssText}"><div style="overflow: hidden;">{@title} {@count}</div></td><td class="mstrmojo-portlet-slot-toolbar {@toolbarNodeClass}" style="{@rightToolbarNodeCssText}"></td></tr></table></div><div class="mstrmojo-portlet-buttonbar {@buttonbarNodeClass}" style="{@buttonbarNodeCssText}"></div><div class="mstrmojo-portlet-slot-content" style="{@contentNodeCssText}"></div></div></div>',rightToolbarNodeCssText:"",leftToolbarNodeCssText:"",titleNodeCssText:"",titlebarNodeClass:"",titlebarNodeCssText:"",contentNodeCssText:"",borderCss:"no-border",buttonbarNodeClass:"",buttonbarNodeCssText:"",markupSlots:{containerNode:function(){return this.domNode.lastChild;},portletNode:function(){return this.domNode;},portletContainerNode:function(){return this.domNode.lastChild;},dimNode:function(){return this.domNode.lastChild;},shadowNode:function(){return this.domNode.firstChild;},titleNode:function(){return this.domNode.lastChild.childNodes[0];},buttonbarNode:function(){return this.domNode.lastChild.childNodes[1];},toolbarNode:function(){return this.domNode.lastChild.firstChild.childNodes[0].rows[0].cells[2];},toolbarTitleTextNode:function(){return this.domNode.lastChild.firstChild.childNodes[0].rows[0].cells[1].firstChild;},leftToolbarNode:function(){return this.domNode.lastChild.firstChild.childNodes[0].rows[0].cells[0];},contentNode:function(){return this.domNode.lastChild.lastChild;}},markupMethods:{ontitleChange:function(){updateTitle.call(this);},oncountChange:function(){updateTitle.call(this);},onfcChange:function(){if(this.fc&&this.content){this.updateContentHeight();}}},formatHandlers:{portletContainerNode:["RW","B"],shadowNode:["RW","B","fx","background-color"],titlebarNode:{src:"ttl",props:["F","B","background-color","height","fx","text-align","vertical-align"]},titleNode:{src:"ttl",props:["vertical-align","P","text-decoration"]},buttonbarNode:{src:"ttl",props:["background-color"]}},fc:false,content:null,rightToolbar:null,leftToolbar:null,floatingToolbar:false,_ts:ETS,getCacheKey:function getCacheKey(w){return this._super(w)+"-portlet";},getFormats:function getFormats(){var c=this.content,f=c&&c.getFormats();return f&&f[P_FMTS];},updateContentHeight:function updateContentHeight(bHide){var pf=this.getFormats(),cnt=this.content,node=cnt.dimNode||cnt.domNode,h=((pf.ttl&&parseInt(pf.ttl.height,10))||0);if(node){if(!bHide){h+=((this.fc||this.isInFilterPanel())?node.offsetHeight:(pf.height?parseInt(pf.height,10):0));}this.containerNode.style.height=h+$PX;this.shadowNode.style.height=h+$PX;}},init:function init(props){this._super(props);var content=this.content;if(content&&content.getFormats()&&!this.getFormats()){this._createFormats();}},preBuildRendering:function preBuildRendering(){var ts=this._ts=(this.floatingTitle)?FTS:ETS;this._super();ts.adjustTitleCss(this);var displayNone="display:none;";if(this.isInFilterPanel()){var f=$HASH.clone(this.formatHandlers);f.portletContainerNode=["z-index","height","B","backgroud-color"];f.shadowNode=["z-index","height","B","fx","background-color"];this.formatHandlers=f;}if(!this.leftToolbar){this.leftToolbarNodeCssText+=displayNone;}if(!this.toolbar){this.toolbarNodeCssText+=displayNone;}var borderWidths=mstrmojo._Formattable.getBorderWidths(this);if(borderWidths.l||borderWidths.t||borderWidths.r){this.borderCss="has-border";}},postBuildRendering:function postBuildRendering(){var dom=mstrmojo.dom,css=mstrmojo.css,d=this.contentNode,t=this.titleNode,me=this;if(this.titleNode){if(this.floatingTitle){document.body.appendChild(this.titleNode);if(!this._onhover){this._onhovertt=function(){css.addClass(me.titleNode,["visible"]);me._onflt=true;return true;};this._onhoverofftt=function(){css.removeClass(me.titleNode,["visible"]);me._onflt=false;return true;};this._onhover=function(){var t=me.titleNode;css.addClass(t,["visible"]);var p=dom.position(me.contentNode,true);t.style.top=(p.y-t.clientHeight+2)+$PX;t.style.left=p.x+$PX;return true;};this._onhoveroff=function(){css.removeClass(me.titleNode,["visible"]);return true;};}dom.attachEvent(d,"mouseover",this._onhover);dom.attachEvent(d,"mouseout",this._onhoveroff);dom.attachEvent(t,"mouseover",this._onhovertt);dom.attachEvent(t,"mouseout",this._onhoverofftt);}if(this.attachContextMenuEvent){this._oncontextmenu=function(e,hWin){var btn=me.rightToolbar&&me.rightToolbar.btnMenu;if(btn){btn.cmPos=dom.getMousePosition(e,hWin);btn.openPopupMenu();btn.cmPos=null;dom.preventDefault(hWin,e);}};dom.attachEvent(t,"contextmenu",this._oncontextmenu);}}if(this._super){this._super();}var pf=this.getFormats();this.set("fc",pf&&!pf.height);if(this.isInFilterPanel()&&!this.isHorizFP()){var portletContainerNodeStyle=this.portletContainerNode.style,shadowNodeStyle=this.shadowNode.style,parent=this.parent;portletContainerNodeStyle.width=shadowNodeStyle.width="99%";portletContainerNodeStyle.top=shadowNodeStyle.top=parent.topStart+$PX;portletContainerNodeStyle.left=shadowNodeStyle.left=ITEM_SPA+$PX;}else{if(this.isInFilterPanel()&&this.isHorizFP()){ITEM_SPA=8;this.portletContainerNode.style.left=this.shadowNode.style.left=parseInt(pf.left)+ITEM_SPA*this.orgPos+$PX;}else{if(this.defn.ifp){this.adjustFPHeight2Fit();}}}},adjustFPHeight2Fit:function(){var dom=mstrmojo.dom,ttl=dom.position(this.titleNode),btn_h=dom.position(this.contentNode).y-ttl.y-ttl.h;this.content.domNode.style.height=parseInt(this.defn.fmts.height)-btn_h+"px";},unrender:function unrender(ignoreDom){if(this.floatingTitle&&this.titleNode){var d=this.domNode,t=this.titleNode,dom=mstrmojo.dom;if(d&&this._onhover){dom.detachEvent(d,"mouseover",this._onhover);}if(d&&this._onhoveroff){dom.detachEvent(d,"mouseout",this._onhoveroff);}if(t&&this._onhovertt){dom.detachEvent(t,"mouseover",this._onhovertt);}if(t&&this._onhoverofftt){dom.detachEvent(t,"mouseout",this._onhoverofftt);}if(t&&this._oncontextmenu){dom.detachEvent(t,"contextmenu",this._oncontextmenu);}if(t){document.body.removeChild(t);}}if(this._super){this._super(ignoreDom);}},updateStyle:function(h,w){var snStyle=this.shadowNode.style,cnStyle=this.containerNode.style;snStyle.height=cnStyle.height=h;snStyle.width=cnStyle.width=w;},_createFormats:function _createFormats(){var c_f=this.content&&this.content.getFormats(),f;f=c_f.p_fmts={};var i,p;for(i in MOVE_FMTS){p=MOVE_FMTS[i];if(p in c_f){f[p]=c_f[p];delete c_f[p];}}for(i in COPY_FMTS){p=COPY_FMTS[i];if(p in c_f){f[p]=c_f[p];}}c_f.height=this._ts.getContentHeight(c_f.height,f);if(mstrmojo.dom.isIE&&f.fx&&f.fx.ds&&!f["background-color"]){f["background-color"]="#ffffff";}},refresh:function refresh(){if(!this.hasRendered){return ;}var c=this.children,i;for(i=c.length-1;i>=0;i--){c[i].refresh();}},isInFilterPanel:function isInFilterPanel(){return(retrieveFilterPanel.call(this)!==null);},isHorizFP:function(){if(this.isInFilterPanel()){var fp=this.getFilterPanel();return fp&&fp.defn&&fp.defn.fds==2;}else{return false;}},getFilterPanel:function getFilterPanel(){return retrieveFilterPanel.call(this);},getContainerHeight:function getContainerHeight(){return this.containerNode.clientHeight;},relocate:function relocate(top,width){if(this.isInFilterPanel()&&!this.isHorizFP()){this.portletContainerNode.style.top=this.shadowNode.style.top=top+$PX;}},setInfoWindowDimensions:function setInfoWindowDimensions(d){var domNodeStyle=this.domNode.style,shadowStyle=this.shadowNode.style,containerStyle=this.portletContainerNode.style,borderWidths=mstrmojo._Formattable.getBorderWidths(this);d.h-=borderWidths.h;d.w-=borderWidths.w;shadowStyle.height=containerStyle.height=domNodeStyle.height=d.h+$PX;shadowStyle.width=containerStyle.width=domNodeStyle.width=d.w+$PX;d.h-=this.titleNode.offsetHeight;this.toolbarNode.style.display="none";},addDirtyKey:function addDirtyKey(key){passDirtyKey.call(this,"add",key);},removeDirtyKey:function removeDirtyKey(key){passDirtyKey.call(this,"remove",key);},setDirtyChildren:function setDirtyChildren(){var contentChild=this.content;if(contentChild&&contentChild.setDirtyChildren){contentChild.setDirtyChildren.apply(contentChild,arguments);}}});var ST_RESTORE=0,ST_MIN=1,ST_MAX=2;function updateWindowState(v,oh,ow,evt){var w=this.content,key=w.k,px=mstrmojo.boxmodel.px2Inches,m=w.model.docModel||w.model,f=this.getFormats(),callback={},me=this,fnUpdateDS=function(){var defn=me.content&&me.content.defn;if(defn){defn.set("ds",v);}},propValues={ZIndex:f["z-index"],WindowState:v},props={};props[key]=propValues;if(oh!==undefined&&ow!==undefined){$HASH.copy({OldHeight:px(m,oh),OldWidth:px(m,ow),Height:px(m,parseInt(f.height,10)),Width:px(m,parseInt(f.width,10))},propValues);callback.success=function(res){var data=res&&res.data;if(data){w.model.loadPartialData(data,key);}fnUpdateDS();var p=me.parent;if("adjustSectionSize" in p){p.adjustSectionSize();}};m.saveRWProps(key,props,1,this.loadDataOnResize,callback,true);}else{fnUpdateDS();if(!(evt&&evt.all)){m.saveRWProps(key,props,1,this.loadDataOnResize,callback,true);}}return props;}function onWindowStateChange(){var content=this.content;if(!content){return ;}var fnUpdateBtnState=function(children){mstrmojo.array.forEach(children,function(child){if("ds" in child){child.set("visible",(child.ds!==content.defn.ds));}});},toolbar;if(this.isInFilterPanel()){var isRestore=(parseInt(this.defn.ds,10)===ST_RESTORE);content.set("visible",isRestore);this.updateContentHeight(!isRestore);toolbar=this.leftToolbar;fnUpdateBtnState(toolbar&&toolbar.children);var p=this.parent;if(p.refreshFP){p.refreshFP();}}else{var c_f=content.getFormats(),p_f=this.getFormats(),ps=this.portletContainerNode.style,ss=this.shadowNode.style,cs=this.contentNode.firstChild.style;cs.height=c_f.height;cs.width=c_f.width;ss.height=ps.height=p_f.height;ss.width=ps.width=p_f.width;ss.top=ps.top=p_f.top;ss.left=ps.left=p_f.left;if("z-index" in p_f){ss.zIndex=ps.zIndex=p_f["z-index"];}toolbar=this.rightToolbar;fnUpdateBtnState(toolbar&&toolbar.children);if(content.resize){content.resize();}}}mstrmojo.DocResizablePortlet=mstrmojo.declare(mstrmojo.DocPortlet,null,{scriptClass:"mstrmojo.DocResizablePortlet",loadDataOnResize:false,_createFormats:function _createFormats(){this._super();var f=this.getFormats();var ds=parseInt(this.defn.ds,10);if(ds===ST_RESTORE){f.normHeight=f.height;f.normWidth=f.width;if(f["z-index"]!==null&&f["z-index"]!==undefined){f.normZIndex=f["z-index"];}}if(ds!==ST_MAX){f.normTop=f.top;f.normLeft=f.left;}},onmaximize:function onmaximize(){var p=this.parent,c=this.content,c_f=c&&c.getFormats(),f=this.getFormats(),oh=f.height,ow=f.width,bw=mstrmojo._Formattable.getBorderWidths(this);this.clearCache();c.clearCache();f.height=(parseInt(p.height(),10)-bw.h)+$PX;c_f.height=this._ts.getContentHeight(f.height,f);f.width=c_f.width=(p.width()-bw.w)+$PX;f.top=f.left=0;f["z-index"]=p.getMaxZIndex()+1;updateWindowState.call(this,ST_MAX,oh,ow);},onminimize:function onminimize(){var c=this.content,node=c.dimNode||c.domNode,c_f=c&&c.getFormats(),f=this.getFormats(),oh=f.height||node.offsetHeight,ow=f.width;this.clearCache();c.clearCache();f.width=c_f.width=f.normWidth;f.top=f.normTop;f.left=f.normLeft;if(f.normZIndex!==null&&f.normZIndex!==undefined){f["z-index"]=f.normZIndex;}c_f.height=0;f.height=this._ts.getPortletMinHeight(f);updateWindowState.call(this,ST_MIN,oh,ow);},onrestore:function onrestore(){var c=this.content,c_f=c&&c.getFormats(),f=this.getFormats(),oh=f.height,ow=f.width;this.clearCache();c.clearCache();f.height=f.normHeight;c_f.height=this._ts.getContentHeight(f.height,f);f.width=c_f.width=f.normWidth;f.top=f.normTop;f.left=f.normLeft;if(f.normZIndex!==null&&f.normZIndex!==undefined){f["z-index"]=f.normZIndex;}updateWindowState.call(this,ST_RESTORE,oh,ow);},oncollapse:function oncollapse(evt){return updateWindowState.call(this,ST_MIN,undefined,undefined,evt);},onexpand:function onexpand(evt){return updateWindowState.call(this,ST_RESTORE,undefined,undefined,evt);},postBuildRendering:function postBuildRendering(){if(!this._sub_dsChange){this._sub_dsChange=this.defn.attachEventListener("dsChange",this.id,onWindowStateChange);}this._super();if(this.isInFilterPanel()){var isRestore=(parseInt(this.defn.ds,10)===ST_RESTORE);this.updateContentHeight(!isRestore);}}});}());