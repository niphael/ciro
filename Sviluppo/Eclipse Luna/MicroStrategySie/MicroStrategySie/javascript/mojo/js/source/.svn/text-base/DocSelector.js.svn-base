(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._Formattable","mstrmojo.DocSelectorViewFactory","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.array","mstrmojo._IsSelectorTarget","mstrmojo.elementHelper");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$D=mstrmojo.dom,STYLES=mstrmojo.DocSelectorViewFactory.STYLES,ELEM_ALL_ID=mstrmojo.DocSelectorViewFactory.ELEM_ALL,_EH=mstrmojo.elementHelper;var _ST_UC_ON_DS=mstrmojo.DocSelectorViewFactory.UC_ON_DS;function getEvent(){return{type:parseInt(this.type,10),src:this.k,ck:this.ck,ctlKey:this.ckey,tks:this.tks,include:this.include,disablePU:(parseInt(this.defn.subTp,10)===_ST_UC_ON_DS)};}mstrmojo.DocSelector=mstrmojo.declare(mstrmojo.Container,[mstrmojo._Formattable,mstrmojo._IsSelectorTarget],{scriptClass:"mstrmojo.DocSelector",markupString:'<div id="{@id}" class="mstrmojo-DocSelector {@extCls}" title="{@tooltip}" style="{@domNodeCssText}"><div class="filter" style="{@filterNodeCssText}"></div><div class="wait" style="display:none;z-index:100; position:absolute; top:0px; left:0px; width:100%; height:100%"></div><div class="content" style="{@contentNodeCssText}"></div></div>',markupSlots:{filterNode:function(){return this.domNode.firstChild;},contentNode:function(){return this.domNode.lastChild;},dimNode:function(){return this.domNode.lastChild;},containerNode:function(){return this.domNode.lastChild;},scrollboxNode:function(){return this.domNode.lastChild;},wIconNode:function(){return this.domNode.childNodes[1];}},markupMethods:{onincludeChange:function(){mstrmojo.css.toggleClass(this.domNode,"strikeout",!this.include);},onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onwaitChange:function(){this.wIconNode.style.display=((this.wait)?"block":"none");}},formatHandlers:{domNode:["F","text-align","vertical-align","line-height","z-index","top","left"],contentNode:["width","B","P"],filterNode:["height","width","B","P","fx","background-color"],item:["color","font","text-decoration","text-align","line-height"]},ckey:null,ck:null,tks:null,style:0,selIdx:null,extCls:"",bGetElems:false,init:function init(props){this._super(props);var s=this.node.defn.style;this.spm=(s===STYLES.METRIC_QUAL||s===STYLES.METRIC_SLIDER);},initControlInfo:function initControlInfo(){var node=this.node,data=node.data,defn=node.defn,elements=data.elms,currentSelections=data.ces,style=defn.style;var defnProps=["include","ckey","ck","tks","style","multi","showall"];if(!this.bGetElems&&parseInt(defn.subTp,10)===_ST_UC_ON_DS&&style!==STYLES.SEARCH_BOX){this._fetchAllElems();elements=data.elms;}if(style===STYLES.METRIC_QUAL||style===STYLES.METRIC_SLIDER){defnProps=defnProps.concat(["srcid","srct"]);this.qua=data.qt;this.dt=data.dt;}this.type=defn.ct;var fmts=defn.fmts;if(fmts){var w=fmts.width;if(!w||parseInt(w,10)<=0){fmts.width="95px";}}$HASH.copyProps(defnProps,defn,this);var selectedIndices=this.selIdx={},multi=defn.multi;if(this.include&&multi&&$ARR.find(currentSelections,"v",ELEM_ALL_ID)>-1){currentSelections=elements;}if(currentSelections){$ARR.forEach(elements,function(el,idx){if($ARR.find(currentSelections,"v",el.v)>=0){selectedIndices[idx]=true;}});}},resetFormatHandlers:function resetFormatHandlers(){this.formatHandlers={contentNode:["RW"]};},selectorControlChange:function selectorControlChange(widget){var rEvt=getEvent.call(this),elementSeparator="\u001E",elementIDs=[],style=this.style,showElementCount=this.defn.sec,i;switch(style){case STYLES.PULLDOWN:var value=widget.value,n=null;if(widget.selectNode){var sn=widget.selectNode;n=sn.options[sn.selectedIndex].text;}rEvt.eid=value;if(parseInt(rEvt.type,10)===1&&n!==null){rEvt.eid=rEvt.eid+";"+n;}this.defn.set("cek",value);this.currSelValue=value;if(showElementCount){this.parent.set("count",_EH.buildElemsCountStr([value],this.node.data.elms));}break;case STYLES.SEARCH_BOX:$ARR.forEach(widget.items,function(item){elementIDs.push(item.v+";"+item.n);});if(!elementIDs.length&&this.showall){elementIDs.push("u;");}rEvt.eid=elementIDs.join(elementSeparator);if(showElementCount){this.parent.set("count",_EH.buildElemsCountStr(elementIDs,this.node.data.elms));}break;case STYLES.METRIC_QUAL:case STYLES.METRIC_SLIDER:if(this.srcid===undefined){return ;}var cs=[];$ARR.forEach(widget.cs,function(item){cs.push(item.v);if(rEvt.dtp===undefined){rEvt.dtp=item.dtp;}});if(cs.length){rEvt.cs=cs.join(elementSeparator);}var fInfo=mstrmojo.MCSUtil.getFuncInfo(widget.opId,widget.qua);rEvt.f=widget.f=fInfo.f;rEvt.ft=widget.ft=fInfo.ft;rEvt.include=widget.include=this.include;rEvt.ckey=this.ckey;rEvt.srcid=this.srcid;rEvt.srct=this.srct;rEvt.unset=widget.unSet;rEvt.onlyInclude=widget.onlyInclude;rEvt.changeQual=widget.changeQual;rEvt.qt=widget.qua;this.node.defn.set("cek",{id:this.id,f:widget.f,ft:widget.ft,cs:widget.cs,qua:widget.qua,include:widget.include});break;default:var node=this.node,elements=node.data.elms,indices=widget.selectedIndices,allIdx=widget.allIdx,isAll=!!indices[allIdx],eidts=[],inc=this.include;if(isAll){elementIDs=[elements[allIdx].v];eidts=[elements[allIdx].v];}else{if(indices[allIdx]){indices[allIdx]=false;}var keyArr=$HASH.keyarray(indices,true).sort($ARR.numSorter),sortedIndices={};for(i in keyArr){sortedIndices[keyArr[i]]=indices[keyArr[i]];}indices=sortedIndices;$HASH.forEach(indices,function(item,idx){if(item){elementIDs.push(elements[idx].v);eidts.push(elements[idx].v+";"+elements[idx].n);}});}rEvt.eid=((parseInt(rEvt.type,10)===1)?eidts:elementIDs).join(elementSeparator);var pos=mstrmojo.dom.position(widget.domNode,true);if(pos){rEvt.left=pos.x;rEvt.top=pos.y;}if(isAll&&this.multi&&inc){$ARR.forEach(elements,function(elem){var v=elem.v;if(elementIDs[0]!==v){elementIDs.push(v);}});}node.defn.set("cek",elementIDs);if(showElementCount&&style!==STYLES.SCROLLER){this.parent.set("count",_EH.buildElemsCountStr(elementIDs,elements));}break;}var me=this;window.setTimeout(function(){me.slice(rEvt);},0);},showInfoWin:function showInfoWin(anchor){var m=this.model,ifws=m.getTargetInfoWin(this.tks);if(ifws&&ifws.length){var horiz=this.defn.horiz,actualAnchor=anchor||this.contentNode,aPos=$D.position(actualAnchor),sPos=$D.position(this.contentNode),position=(horiz||this.defn.style==STYLES.SCROLLER)?null:{x:sPos.x,y:aPos.y,w:sPos.w,h:aPos.h};for(var i=0;i<ifws.length;i++){m.showInfoWin(ifws[i],actualAnchor,horiz?"v":"h",false,$HASH.copy(position));}}},preBuildRendering:function preBuildRendering(){var ret=true,style=this.node.defn.style,formatHandlers=$HASH.clone(this.formatHandlers),contentNodeHandler=formatHandlers.contentNode;if(contentNodeHandler){if((style===STYLES.RADIO||style===STYLES.CHECKBOX)&&formatHandlers.filterNode){contentNodeHandler.push("fx");contentNodeHandler.push("background-color");delete formatHandlers.filterNode;}if(style===STYLES.LIST){delete contentNodeHandler.height;}if(style===STYLES.SEARCH_BOX){var domHandler=formatHandlers.domNode;$ARR.removeItem(domHandler,"color");var idx=$ARR.indexOf(domHandler,"F");if(idx>-1){$ARR.removeIndices(domHandler,idx,1);domHandler.push("font");}}}this.formatHandlers=formatHandlers;ret=this._super();this.builder.selectorFactory.updateControlStyles(this);return ret;},postBuildRendering:function postBuildRendering(){var style=this.node.defn.style,filterNodeStyle=this.filterNode.style,contentNode=this.contentNode,defn=this.node.defn;this._super();if(this.formatHandlers.filterNode){var f=this.getFormats();if(!f.width){filterNodeStyle.width=contentNode.clientWidth+"px";}if(!f.height){filterNodeStyle.height=contentNode.clientHeight+"px";if(style===STYLES.METRIC_QUAL||style===STYLES.METRIC_SLIDER){this.updateHeight();}}else{if(style===STYLES.METRIC_QUAL){contentNode.style.height=f.height;}}}else{filterNodeStyle.display="none";}if(this.isInFilterPanel()&&!this.isHorizFP()){this.domNode.style.width=this.contentNode.style.width="100%";if(this.formatHandlers.filterNode){this.filterNode.style.width=this.contentNode.style.width="100%";}this.set("visible",parseInt(defn.ds,10)===0);}this.model.attachEventListener("CGBMapChange",this.id,"onCGBMapChange");this.builder.selectorFactory.attachTargetListeners(this);if($D.isAndroid&&style===STYLES.SCROLLER){contentNode.style.overflow="visible";}return true;},_fetchAllElems:function _fetchAllElems(){var defn=this.node.defn,data=this.node.data;var taskParams={taskId:"browseElements",styleName:"MojoAttributeStyle",attributeID:defn.srcid||"",dataSourcesXML:defn.dsrc||"",browseFlags:1};var me=this,callbacks={success:function(res){me.bGetElems=true;me.set("wait",false);if(res&&res.es){data.elms=(defn.srcid)?_EH.buildElemsTerseID(res.es,defn.srcid,true):res.es;var parent=me.parent,grandParent=parent&&parent.parent;if(data.ces&&data.elms&&data.elms.length>0&&parent){parent.set("count",_EH.buildElemsCountStr(data.ces,data.elms));}if(me.hasRendered){me.refresh();if(me.isInFilterPanel()){if(parent&&parent.defn.ttl){parent.updateContentHeight();}if(grandParent&&grandParent.refreshFP){grandParent.refreshFP();}}}}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};this.set("wait",true);mstrmojo.xhr.request("POST",mstrConfig.taskURL,callbacks,taskParams,false,null,true);},updateHeight:function updateHeight(){this.contentNode.style.height=this.filterNode.style.height=this.content.getClientHeight()+"px";var parent=this.parent;if(parent&&(parent.defn.ttl!==undefined)&&parent.updateContentHeight){parent.updateContentHeight();}},onCGBMapChange:function onCGBMapChange(evt){var cgbMap=evt.cgbMap;if(!cgbMap){return ;}var tks=this.tks;$HASH.forEach(this.defn.cgb,function(key){var targetKey=cgbMap[key];if(targetKey&&tks.indexOf(targetKey)<0){tks+="\u001E"+targetKey;}});this.tks=tks;},update:function update(node){this.node=node;var defn=this.node.defn,style=defn.style,elements=this.node.data.elms,parent=this.parent,isScroller=(style===STYLES.SCROLLER);if(isScroller&&defn.multi){var allIdx=$ARR.find(elements,"v",ELEM_ALL_ID);if(allIdx>-1){$ARR.removeIndices(elements,allIdx,1);}}if(defn.sec&&!isScroller&&!defn.sos){var ces=node.data.ces;if(parent&&parent.count){if(ces&&elements&&elements.length){parent.set("count",_EH.buildElemsCountStr(ces,elements));}}}this.initControlInfo();var widget=this.content=this.builder.selectorFactory.newSelector(this);if(!widget){this.set("visible",false);}},onincludeChange:function onincludeChange(evt){this.node.defn.include=this.include=evt.value;if(this.style!==STYLES.METRIC_SLIDER){this.include=evt.value;var rEvt=getEvent.call(this);rEvt.ckey=this.ckey;this.slice(rEvt);}},slice:function slice(rEvt){var m=this.model;if(this.isInFilterPanel()){var fp=this.getFilterPanel();if(fp&&!fp.defn.cas){fp.bufferSlice(rEvt);return ;}}m.slice(rEvt);},onquaChange:function onquaChange(evt){this.node.data.qt=evt.value;},isInFilterPanel:function isInFilterPanel(){var parent=this.parent;return(parent&&parent.isInFilterPanel&&parent.isInFilterPanel())||false;},isHorizFP:function isHorizFP(){var parent=this.parent;return(parent&&parent.isHorizFP&&parent.isHorizFP())||false;},getFilterPanel:function getFilterPanel(){var parent=this.parent;return(parent&&parent.getFilterPanel&&parent.getFilterPanel())||null;}});if(!mstrmojo.dom.isIE){var formatHandlers=mstrmojo.DocSelector.prototype.formatHandlers;formatHandlers.contentNode=formatHandlers.filterNode;delete formatHandlers.filterNode;}}());