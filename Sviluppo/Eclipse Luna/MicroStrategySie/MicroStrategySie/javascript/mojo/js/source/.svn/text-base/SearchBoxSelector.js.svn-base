(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.elementHelper","mstrmojo.SimpleObjectInputBox");var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,thousandsSeperator=mstrConfig.thousandsSep;if(thousandsSeperator===undefined){thousandsSeperator=",";}var ERR_SDK_E_INVALID=2147762227,ERR_SDK_E_PROMPT_NUMERICAL_VALUES=2147762262,ERR_SDK_E_PROMPT_DATE_TIME=2147762269,MAX_SUGGESTION_POPUP_HEIGHT=140;var markup;mstrmojo.SearchBoxSelectorList=mstrmojo.declare(mstrmojo.SuggestionList,null,{getItemMarkup:function(item,idx){if(!markup){markup=this._super(item,idx).replace(">{@"+this.itemField+"}<",">{@"+this.itemField+"}{@weight}<");}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),weight=item.wt;props.weight=(weight)?"<em>("+mstrmojo.num.addSeparators(weight,thousandsSeperator)+" likes)</em>":"";return props;}});mstrmojo.SearchBoxSelector=mstrmojo.declare(mstrmojo.SimpleObjectInputBox,null,{cssClass:"mstrmojo-SearchBoxSelector",srcid:null,dataSourcesXML:null,maxItemWidth:"",suggestionListClass:"mstrmojo.SearchBoxSelectorList",postCreate:function postCreate(){var suggestionPopup=this.suggestionPopup;suggestionPopup.cssClass="mstrmojo-SearchBoxSelector-suggest";suggestionPopup.nudge=function(){var editorNode=this.editorNode;if(!editorNode){return ;}var height=Math.min(editorNode.offsetHeight,MAX_SUGGESTION_POPUP_HEIGHT),width=editorNode.offsetWidth,windowDimensions=$DOM.windowDim(),left=this.left,top=this.top;if(top+height>=windowDimensions.h){top-=height;}if(left+width>=windowDimensions.w){left-=width;}var editorNodeStyle=editorNode.style;editorNodeStyle.top=top+"px";editorNodeStyle.left=left+"px";};},preBuildRendering:function preBuildRendering(){this.set("maxItemWidth",this.parent.contentNode.offsetWidth);this._super();},postBuildRendering:function postBuildRendering(){var fmts=this.parent.defn.fmts;if(!fmts.height){this.domNode.style.height="auto";}return this._super();},filterCandidates:function filterCandidates(items,t,max){var filteredCandidates=items,suggestCnt=this.suggestCount;if(!this.noCache){max=max||suggestCnt;t=mstrmojo.string.regEscape(t);var itemField=this.itemField,testExp=new RegExp("^"+t,"i");filteredCandidates=$ARR.filter(items,function(item){return testExp.test(item[itemField]);},{max:max});}if(filteredCandidates.length){$ARR.forEach(this.items,function(item){var idx=$ARR.find(filteredCandidates,"v",item.v);if(idx>-1){filteredCandidates.splice(idx,1);}});}if(filteredCandidates.length>=suggestCnt){filteredCandidates=filteredCandidates.slice(0,suggestCnt);}return filteredCandidates;},getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){var id=this.id,targetWas=this.getSuggestionTarget(),searchPattern=params.pattern||"",parent=this.parent,attributeId=this.srcid;searchPattern=searchPattern.replace(/"/,"");if(attributeId){var taskParams={taskId:"browseElements",styleName:"MojoAttributeStyle",attributeID:attributeId,dataSourcesXML:this.dsrc||"",blockCount:this.REQUEST_THRESHOLD,searchPattern:searchPattern,browseFlags:1};var defn=parent.defn;if(defn.dsid){taskParams.datasetID=defn.dsid;taskParams.messageID=parent.model.mid;taskParams.ctlKey=parent.ckey;}if(defn.sfid){taskParams.searchForms=defn.sfid;if(parseInt(defn.sfdt,10)===8){taskParams.searchPattern+="*";}}callbacks.success=function(res){if(res&&res.es){var box=mstrmojo.all[id],target=box.getSuggestionTarget(),len=res.es.length;if(!res||!target||(targetWas!==target)){return ;}if(len&&(len>box.suggestCount)){return ;}var newPattern=target.getSearchPattern(),items=res.es;if(attributeId){items=mstrmojo.elementHelper.buildElemsTerseID(items,attributeId,true);}var srcPattern=params.pattern;box._last_hit={items:items,pattern:srcPattern};if(newPattern&&newPattern.indexOf(srcPattern)>-1){box.updateSuggestion(box.filterCandidates(items,newPattern));}}};callbacks.failure=function(res){var ec=parseInt(res.getResponseHeader("X-MSTR-TaskErrorCode"),10)+4294967296;if(ec!==ERR_SDK_E_INVALID&&ec!==ERR_SDK_E_PROMPT_NUMERICAL_VALUES&&ec!==ERR_SDK_E_PROMPT_DATE_TIME){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callbacks,taskParams,false,null,true);}},onsuggestionItemsChange:function onsuggestionItemsChange(){var suggestionItems=this.suggestionItems,popup=this.suggestionPopup,editorNode=popup.editorNode,hasScrollBar=suggestionItems&&(suggestionItems.length>8),height="",px="";if(hasScrollBar){height=MAX_SUGGESTION_POPUP_HEIGHT;px="px";}if(editorNode){editorNode.style.height=height+px;}else{if(hasScrollBar){px+=";";popup.cssText=(popup.cssText||"")+"height:"+height+px;}}}});}());