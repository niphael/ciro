(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.FileUploadBox","mstrmojo.TextBox","mstrmojo.RadioList","mstrmojo.CheckBox","mstrmojo.Image","mstrmojo.Dialog","mstrmojo.DI.DIConstants","mstrmojo.DI.DISharedViewer");var constants=mstrmojo.DI.DIConstants;var shared=mstrmojo.DI.DISharedViewer;var sheetsDialog={scriptClass:"mstrmojo.Dialog",width:"300px",model:null,buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-blueButton",text:"OK",onclick:function(){var p=this.parent.parent;var m=p.model;m.currentSource.selectSheet(p.preShtsPD.selectedIndex);m.editCube(null,p.preShtsPD.selectedIndex,null,mstrmojo.DI.DISharedViewer.publish(m));p.destroy();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-greyButton",text:"Cancel",onclick:function(){this.parent.parent.destroy();}}],children:[{scriptClass:"mstrmojo.HBox",children:[{scriptClass:"mstrmojo.Label",text:"Select Sheet to Import:"},{scriptClass:"mstrmojo.Pulldown",alias:"preShtsPD",bindings:{items:function(){var shts=this.parent.parent.model.currentSource.sheets;var its=[];var i;if(shts){for(i=0;i<shts.length;i++){if(shts[i]!=="*"){its.push({dssid:i,n:shts[i]});}}return its;}},defaultSelection:function(){return this.parent.parent.model.currentSource.currentIndex;}}}]}]};function getExtensionType(extension){var ext=extension.toLowerCase();if(ext==".xls"||ext==".xlsx"){return constants.xdaType.excel;}else{if(ext==".txt"||ext==".csv"){return constants.xdaType.text;}else{return 0;}}}var forceUpload=false;mstrmojo.DI.DIFileUpload=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.DIFileUpload",cssClass:"mstrmojo-di-fu",model:null,markupString:'<div id="{@id}" class="mstrmojo-di-fileUpload {@cssClass}" ><div></div><div></div><div></div><div></div><div></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},labelNode:function(){return this.domNode.children[0];},optionsNode:function(){return this.domNode.children[1];},fileInputNode:function(){return this.domNode.children[2];},urlInputNode:function(){return this.domNode.children[3];},showPreviewNode:function(){return this.domNode.children[4];},imageNode:function(){return this.domNode.children[5];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},isExtensionValid:function(){var isValid=true;var m=this.model;if((m.operationMode===constants.operationMode.refresh)||(m.operationMode===constants.operationMode.edit)){var name=m.currentSource.sourceInfo.name;var originalExtension=getExtensionType(name.substring(name.lastIndexOf(".")));var currentExtension;var fileNameComponents;if(ultp.selectedIndex===0){var file=this.fuBox.fileNode.value;currentExtension=getExtensionType(file.substring(file.lastIndexOf(".")));}else{fileNameComponents=this.urlInput.value.split("/");if(!fileNameComponents){var urlFileName=fileNameComponents[fileNameComponents.length-1];fileNameComponents=urlFileName.split(".");if(!fileNameComponents){if(fileNameComponents.length>1){currentExtension=getExtensionType("."+fileNameComponents[1]);}}}}if(originalExtension!==currentExtension){isValid=false;}}return isValid;},onNextButtonClick:function(){var showPrv=this.showPrv;var m=this.model;var fuBox=this.fuBox;var urlInput=this.urlInput;var fileOption=(this.ultp.selectedIndex===0);var fileName=fuBox.fileNode.value;var extension;if(this.ultp.selectedIndex===0){var file=this.fuBox.fileNode.value;extension=file.substring(file.lastIndexOf("."));if(getExtensionType(extension)===0){shared.displayError(m.applicationName(),"The following file extension "+extension+" is not supported.",false);return ;}}if(fuBox.fileNode.files[0]!==undefined){if(fuBox.fileNode.files[0].size>m.fileUploadSize){extension=fileName.substring(fileName.lastIndexOf(".")+1);shared.displayError(m.applicationName(),"The maximum file size for "+extension+" files is "+m.fileUploadSize/(1024*1024)+" MB.",false);return ;}}if(!this.isExtensionValid()&&(m.operationMode!==constants.operationMode.create)){shared.displayError(m.applicationName(),"Switching the file type is not allowed during republishing or editing the cube.",false);return ;}var ps={taskContentType:"json",sessionState:mstrApp.sessionState,fileType:"application/octet-stream",fileName:fuBox.fileNode.value};if(m.cubeID!==""){ps.reportid=m.cubeID;}var cb1={success:function(res){var prvFg=constants.requestFlag.sourceInfo|constants.requestFlag.sheets|constants.requestFlag.preview|constants.requestFlag.mapping,shtIx=showPrv.checked?0:-1,cb2={success:function(res){m.populate(res,prvFg,prvFg);if(showPrv.checked){m.set("curPg",constants.pageType.preview);}else{if(m.operationMode!==constants.operationMode.create){if(m.currentSource.sheets.length>1){sheetsDialog.model=m;mstrmojo.insert(sheetsDialog).render();}else{mstrmojo.DI.DISharedViewer.publish(m);}}}},failure:function(res){m.hideWaitPage();shared.displayError(m.applicationName(),"Error in importing the file. Please check the file to import.",false);}};if(fileOption){m.set("msgid",res.content.msg_id);}else{m.set("msgid",res.msg_id);}m.loadRptData(prvFg,shtIx,cb2);},failure:function(res){shared.displayError("Import Data","Error in importing the file. Please check the file being imported",false);}};if(m.currentSource){m.currentSource.reset();}if(fileOption){fuBox.submit(ps,cb1);}else{m.importUrl(urlInput.value,cb1);}},children:[{slot:"labelNode",scriptClass:"mstrmojo.Label",cssClass:"bigTxt",text:"Specify the location of the file you would like to upload"},{slot:"optionsNode",scriptClass:"mstrmojo.RadioListHoriz",cssClass:"upload-options",itemCssClass:"upload-options-item",alias:"ultp",selectedIndex:0,items:[{did:"0",n:"From My Computer/Network"},{did:"1",n:"From the URL(File://,Http://, Https://, Ftp://)"}]},{slot:"fileInputNode",scriptClass:"mstrmojo.FileUploadBox",cssClass:"upload-file",alias:"fuBox",uploadTaskId:"importFile",markupMethods:{onvalueChange:function(){this.inputNode.value=this.value;},onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},preBuildRendering:function(){if(this.parent.model.operationMode!==constants.operationMode.create){if(this.parent.model.currentImportSource){if(this.parent.model.currentImportSource.sourceInfo){this.value="Previously uploaded file: "+this.parent.model.currentImportSource.sourceInfo.name;}}}},bindings:{visible:function(){return(this.parent.ultp.selectedIndex===0);}},markupString:'<div id={@id} class="{@cssClass}" style="{@cssText}"><form class="mstrmojo-FileUploadBox-form" target="{@id}_iframe" enctype="multipart/form-data" method="post" action="{@action}"><input class="uploadFileText" readonly="readonly" type="text"/><div class="mstrmojo-di-fu-buttonDiv"><div class="mstrmojo-di-blueButton">{@browseLabel}</div><input class="mstrmojo-FileUploadBox-file" type="file" {@multiple} size="30" style="font-size:4em;" name="{@fileFieldName}" onchange="mstrmojo.all.{@id}.synValue();"/></div><div style="display:none;"></div></form><iframe id="{@id}_iframe" + name="{@id}_iframe" style="display:none;" src="about:blank"></iframe></div>'},{slot:"urlInputNode",scriptClass:"mstrmojo.TextBox",cssClass:"upload-url",alias:"urlInput",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},bindings:{visible:function(){return(this.parent.ultp.selectedIndex==1);},value:function(){var s=this.parent.model.currentImportSource;if(s){if(s.sourceInfo){if(s.sourceInfo.name!==undefined){return this.parent.model.currentImportSource.sourceInfo.name;}}}return"";}}},{slot:"showPreviewNode",scriptClass:"mstrmojo.ImageCheckBox",cssClass:"preview",alias:"showPrv",label:"Show a preview of the data",bindings:{checked:function(){return(this.parent.model.operationMode===constants.operationMode.create);},visible:function(){return(this.parent.model.operationMode!==constants.operationMode.create);}},onclick:function(){mstrmojo.DI.DISharedViewer.set("showPreview",this.checked);}},{slot:"imageNode",scriptClass:"mstrmojo.Image",cssClass:"mstrmojo-di-fileImportImage",bindings:{visible:function(){return(this.parent.model.operationMode===constants.operationMode.create);}}},{slot:"imageNode",scriptClass:"mstrmojo.Label",cssClass:"imageText",text:"Data can be tabular or crosstab format.",bindings:{visible:function(){return(this.parent.model.operationMode===constants.operationMode.create);}}}]});})();