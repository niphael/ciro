(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.DI.DataImportModel","mstrmojo.DI.SalesforceModel","mstrmojo.DI.DIConstants","mstrmojo.form","mstrmojo.Label","mstrmojo.MenuButton","mstrmojo.Table","mstrmojo.date","mstrmojo.array","mstrmojo.locales");var $DT=mstrmojo.date,SEP_SPACE=" ",SEP_DASH="-",SEP_COLUMN=":",$XDA_TYPE=mstrmojo.DI.DIConstants.xdaType,SF_TOOLTIP=mstrmojo.desc(9943,"Contact your administrator to configure access to Salesforce reports by enabling an https connection and setting the appropriate Salesforce parameters. See Help for more details."),UNIT_CONSTANT=1024;function alertErrorMsg(result){mstrmojo.alert(result.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}function isSalesForceEnabled(){return mstrApp.sfID&&mstrApp.sfSecret&&mstrApp.sfURL&&document.location.protocol.indexOf("https")>-1;}function getDateObject(modifiedtime){var value=modifiedtime.split(SEP_SPACE),datevalue=value[0].split(SEP_DASH),timevalue=value[1].split(SEP_COLUMN);return new Date(Date.UTC(datevalue[0],parseInt(datevalue[1],10)-1,datevalue[2],timevalue[0],timevalue[1],timevalue[2]));}var _getDiExternalInfo=function(model){var sfModel=mstrmojo.all.SalesforceModel,oAuth=sfModel.oAuth;oAuth.clientId=mstrApp.sfID;oAuth.clientSecret=mstrApp.sfSecret;oAuth.redirectUrl=mstrApp.sfURL;if(sfModel.code){_getSfReports(model);}};var _getQuota=function(){var taskParams={taskId:"qBuilder.GetQuota",sessionState:mstrApp.sessionState};var cb={success:function(res){mstrmojo.all.mstrDiIntro.usage=res.cubes.cusage;mstrmojo.all.mstrDiIntro.quota=res.cubes.cquota;var txt=mstrmojo.desc(9101,"You are currently using ##MB of ###MB");txt=txt.replace("###",(res.cubes.cquota/UNIT_CONSTANT).toFixed(0)).replace("##",(res.cubes.cusage/UNIT_CONSTANT).toFixed(2));mstrmojo.all.mstrDiQuota.set("text",txt);var cubes=res.cubes,cubeArray=(cubes&&cubes.cube)||[];if(cubes.cn===1){(cubeArray=[cubeArray]);}mstrmojo.array.forEach(cubeArray,function(cube){cube.dateObj=getDateObject(cube.nutm);cube.formatDate=cube.utm;});mstrmojo.all.mstrDiListOfCubes.set("items",cubeArray);},failure:alertErrorMsg};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,taskParams);};var _getSfReports=function(model){var sfModel=mstrmojo.all.SalesforceModel;var cb={success:function(res){var salesforcePage=mstrmojo.all.mstrDiSalesforce;salesforcePage.populate(res,sfModel);model.set("curPg",mstrmojo.DI.DIConstants.pageType.sfList);model.hideWaitPage();},failure:function(){model.hideWaitPage();}};model.showWaitPage();sfModel.getReports(cb);};var CMS={CDOC:-2,CRPT:-3,CAYS:-4,DEL:-5};function getSwitchPageParams(actionId,cubeId){switch(actionId){case CMS.CDOC:return{evt:"3104",src:microstrategy.servletName+".3104",executionMode:"2",rwDesignMode:"1",objectType:"3",objectID:cubeId};break;case CMS.CRPT:return{iframe:"true",evt:["5005","17004"],src:[microstrategy.servletName+".create.5005",microstrategy.servletName+".create.ObjectExplorer.17004"],selectedObjectID:cubeId,defaultevtlist:"17004"};break;case CMS.CAYS:return{evt:"3104",src:microstrategy.servletName+".3104",executionMode:"1",rwDesignMode:"0",objectType:"3",objectID:cubeId,rwCreateFlags:"16",rwViewMode:"2048"};break;}return{};}function toPage(params){var DIModel=mstrmojo.all.DIModel;if(DIModel){DIModel.showWaitPage();}mstrmojo.form.send(params,mstrApp.name,"post");}function openCreateMenu(){var domSrc=this.domNode,obj=this.parent.data,id="mstr-di-moreCM",menu=mstrmojo.all[id];if(!menu){var cm=[{n:mstrmojo.desc(8042,"Analysis"),did:CMS.CAYS,cssClass:"",feature:"CreateReportServices"},{n:mstrmojo.desc(2918,"Document"),did:CMS.CDOC,cssClass:"",feature:"WebDocumentDesign"},{n:mstrmojo.desc(5,"Report"),did:CMS.CRPT,cssClass:"",feature:"CreateViewReport"}];menu=new mstrmojo.MenuButton({id:id,cmCssClass:"mstrmojo-CXM",cm:cm,domSrc:domSrc,obj:obj,dynamicUpdate:true,queryVisible:function(item){return mstrApp.diParams&&mstrApp.diParams[item.feature];},getMenuPosition:function getMenuPosition(){var pos=mstrmojo.dom.position(this.domSrc,true);return{x:Math.round(pos.x),y:Math.round(pos.y+pos.h)};},executeCommand:function(item){var o=this.obj;toPage(getSwitchPageParams(item.did,o.cube_id));}});menu.render();}else{menu.set("domSrc",domSrc);menu.set("obj",obj);}menu.showContextMenu();menu.onContextMenuClose=function(){domSrc.style.visibility="inherit";};}mstrmojo.DI.DIIntro=mstrmojo.declare(mstrmojo.Table,null,{scriptClass:"mstrmojo.DI.DIIntro",usage:0,quota:0,layout:[{cells:[{cssText:"border-right: 1px solid #888888;vertical-align:top;width:25%;"},{cssText:"vertical-align:top;width:75%;"}]}],children:[{scriptClass:"mstrmojo.Box",alias:"sourcePane",id:"mstrDiPanelOfSources",slot:"0,0",cssText:"padding: 24px 15px 0 15px;",children:[{scriptClass:"mstrmojo.List",alias:"sourceList",id:"mstrDiListOfSources",cssClass:"mstrmojo-di",cssText:"padding: 12px 17px; height: 100%",itemMarkupFunction:function(item){return'<div class="mstrmojo-di-bullet '+item.icon+'" style="padding: 10px 0px 10px;"><table cellpadding="0" cellspacing="0"><tr><td class="mstrmojo-di-icons '+item.icon+'"> </td><td '+(item.xda===$XDA_TYPE.salesforce?' id="mstrDiSf"':"")+'style="vertical-align: top; padding-left: 10px;">'+(item.icon==="SF"?'<div class="mstrmojo-di-source-name-disabled">':'<div class="mstrmojo-di-source-name">')+item.n+"</div>"+(item.icon==="SF"?'<div style="font: 11px Tahoma; color: #aaaaaa;">':'<div style="font: 11px Tahoma; color: #5b5b5b;">')+item.desc+"</div>"+(item.icon==="SF"?'<div class="SFTooltip">'+SF_TOOLTIP+"</div>":"")+"</td></tr></table></div>";},onchange:function(evt){var item=this.items[this.selectedIndex],isFileImport;switch(item.xda){case $XDA_TYPE.text:isFileImport=true;case $XDA_TYPE.salesforce:if(isSalesForceEnabled()||isFileImport){var eventArg={evt:"3137",src:microstrategy.servletName+".3137",isNew:"true",DataImportSource:isFileImport?"0":"2"};mstrApp.isNewAnalysis&&(eventArg.isNewAnalysis="true");mstrApp.messageID&&(eventArg.messageID=mstrApp.messageID);mstrApp.diParams.AnalysisId&&(eventArg.analysisID=mstrApp.diParams.AnalysisId);toPage(eventArg);}break;case $XDA_TYPE.ffsql:toPage({evt:"3171",src:microstrategy.servletName+".3171",FFsql:"true",isNewAnalysis:mstrApp.isNewAnalysis,messageID:mstrApp.messageID,analysisID:mstrApp.diParams.AnalysisId||""});break;case $XDA_TYPE.querybuilder:toPage({evt:"3171",src:microstrategy.servletName+".3171",isNewAnalysis:mstrApp.isNewAnalysis,messageID:mstrApp.messageID,analysisID:mstrApp.diParams.AnalysisId||""});break;default:break;}}}]},{scriptClass:"mstrmojo.Box",id:"mstrDiQuotaAndListOfCubes",slot:"0,1",items:[],children:[{scriptClass:"mstrmojo.Label",id:"mstrDiQuota",cssText:" font:12px Tahoma; font-weight:bold; color:#FFFFFF; background:#989898; padding:8px 0 7px 10px;",text:""},{scriptClass:"mstrmojo.DataGrid",cssClass:"mstrmojo-di-QuotaGrid",id:"mstrDiListOfCubes",resizableColumns:false,bindings:{items:"this.parent.items"},sortBy:{n:1,sz:1,own:1,dt:1},columns:[{headerWidget:{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(945,"Name"),cssClass:"headerText",onclick:function(){var dg=this.dataGrid;dg.sortBy.n=-dg.sortBy.n;var v=dg.sortBy.n;var items=[];items=items.concat(dg.items);dg.set("items",items.sort(function(a,b){return(a.cname.toLowerCase()<b.cname.toLowerCase())?v:(-v);}));}},colCss:"nameCol",dataWidget:{scriptClass:"mstrmojo.Table",cssClass:"nameTable",layout:[{cells:[{rowSpan:3,cssClass:"cubeCell"},{colSpan:6}]},{cells:[{},{},{},{},{},{}],cssClass:"actions"}],children:[{slot:"0,0",scriptClass:"mstrmojo.Image",cssClass:"mstrIcon-lv mstrIcon-lv-cb",cssText:"margin:-9px 10px 0 0;"},{slot:"0,1",scriptClass:"mstrmojo.Label",cssClass:"nameLabel",bindings:{text:function(){var n=this.parent.data.cname;return mstrmojo.string.escape4HTMLText(n);}}},{slot:"1,0",scriptClass:"mstrmojo.HBox",onRender:function(){var w="auto";this.domNode.parentNode.style.width=w;},children:[{scriptClass:"mstrmojo.Label",cssClass:"morelink",text:mstrmojo.desc(3291,"Create"),onclick:function(){this.parent.children[1].onclick();},onRender:function(){var options=[{did:CMS.CAYS,feature:"CreateReportServices",txt:mstrmojo.desc(8042,"Create Dashboard")},{did:CMS.CDOC,feature:"WebDocumentDesign",txt:mstrmojo.desc(2918,"Create Document")},{did:CMS.CRPT,feature:"CreateViewReport",txt:mstrmojo.desc(5,"Create Report")}],featuresSum=0,availableOption=0,cubeId=this.parent.parent.data.cube_id;if(mstrApp.diParams){mstrmojo.array.forEach(options,function(option,i){if(mstrApp.diParams[option.feature]){featuresSum++;availableOption=i;}});if(featuresSum===0){this.set("visible",false);this.parent.children[1].set("visible",false);}else{if(featuresSum===1){this.set("text",options[availableOption].txt);this.onclick=function(){toPage(getSwitchPageParams(options[availableOption].did,cubeId));};}}}}},{scriptClass:"mstrmojo.Label",cssClass:"menu-arrow",onclick:function(){this.parent.domNode.style.visibility="visible";openCreateMenu.call(this.parent);}}]},{slot:"1,1",scriptClass:"mstrmojo.Label",cssClass:"editlink",text:mstrmojo.desc(1088,"Edit"),onRender:function(){if(mstrApp.diParams&&mstrApp.diParams.Republish){this.domNode.parentNode.style.width="35px";}else{this.set("visible",false);}},onclick:function(){var data=this.parent.data,did=data.cube_id,xt=data.xt,xdatype=mstrmojo.DI.DIConstants.xdaType,isFileImport=false,isQB=false,urlparam;var cb={success:function(res){var folderid=res.objects[0].pf.did;switch(parseInt(xt,10)){case xdatype.querybuilder:isQB=true;case xdatype.ffsql:urlparam={evt:"3171",src:microstrategy.servletName+".3171",reportID:did,isCube:1,FolderID:folderid};!isQB&&(urlparam.FFsql=true);toPage(urlparam);break;case xdatype.text:case xdatype.excel:isFileImport=true;case xdatype.salesforce:urlparam={evt:"3137",src:microstrategy.servletName+".3137",isEdit:"true",cubeID:did,folderId:folderid};!isFileImport&&(urlparam.DataImportSource="2");toPage(urlparam);break;default:break;}},failure:alertErrorMsg,complete:function(){iframe.hideWaitPage();}};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,{taskId:"getObjectInfo",objectIDs:did,objectTypes:3,includeParentFolder:true,sessionState:mstrApp.sessionState});}},{slot:"1,2",scriptClass:"mstrmojo.Label",cssClass:"deletelink",text:mstrmojo.desc(629,"Delete"),onRender:function(){if(mstrApp.diParams&&mstrApp.diParams.Delete){this.domNode.parentNode.style.width="50px";}else{this.set("visible",false);}},onclick:function(){var DIModel=mstrmojo.all.DIModel;var data=this.parent.data,did=data.cube_id;DIModel&&DIModel.showWaitPage();mstrmojo.xhr.request("POST",mstrApp.taskURL,{success:function succ(res){_getQuota();},failure:function fail(res){alertErrorMsg(res);},complete:function(){DIModel&&DIModel.hideWaitPage();}},{taskId:"arch.deleteObject",sessionState:mstrApp.sessionState,objectid:did,objecttype:3});}},{slot:"1,3",scriptClass:"mstrmojo.Label",cssClass:"schedulelink",text:mstrmojo.desc(1085,"Schedule"),onRender:function(){if(mstrApp.diParams&&mstrApp.diParams.Subscriptions){this.domNode.parentNode.style.width="65px";}else{this.set("visible",false);}},onclick:function(){var did=this.parent.data.cube_id;toPage({evt:"3032",src:microstrategy.servletName+".3032",objectType:"3",objectID:did});}},{slot:"1,4",scriptClass:"mstrmojo.Label",cssClass:"sharelink",text:mstrmojo.desc(9099,"Share"),onRender:function(){if(mstrApp.diParams&&mstrApp.diParams.Share){this.domNode.parentNode.style.width="45px";}else{this.set("visible",false);}},onclick:function(){var data=this.parent.data,did=data.cube_id,url=mstrApp.appPath,AMP_SEP="&",servName=microstrategy.servletName;url=[url,servName,"?evt=3104&src=",servName,".3104&executionMode=1&rwDesignMode=0&rwViewMode=2048&objectID=",did,"&objectType=3&rwCreateFlags=16"].join("");microstrategy.showSharingEditor&&microstrategy.showSharingEditor(url,{objId:did,objType:3,objectName:data.cname,mid:-1});}},{slot:"1,5",scriptClass:"mstrmojo.Label",cssClass:"republishlink",text:mstrmojo.desc(9242,"Republish"),onRender:function(){if(mstrApp.diParams&&mstrApp.diParams.Republish){this.domNode.parentNode.style.width="70px";}else{this.set("visible",false);}},onclick:function(){toPage({evt:"4001",src:microstrategy.servletName+".4001",visMode:"0",reportViewMode:"1",reportID:this.parent.data.cube_id});}}]}},{headerWidget:{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(8724,"Size (KB)"),cssClass:"headerText",onclick:function(){var dg=this.dataGrid;dg.sortBy.sz=-dg.sortBy.sz;var v=dg.sortBy.sz;var items=[];items=items.concat(dg.items);dg.set("items",items.sort(function(a,b){return(parseInt(a.sz,10)<parseInt(b.sz,10))?v:(-v);}));}},colCss:"sizeCol",dataWidget:{scriptClass:"mstrmojo.Label",cssClass:"sizeLabel",bindings:{text:"this.parent.data.sz"}}},{headerWidget:{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(60,"Owner"),cssClass:"headerText",onclick:function(){var dg=this.dataGrid;dg.sortBy.own=-dg.sortBy.own;var v=dg.sortBy.own;var items=[];items=items.concat(dg.items);dg.set("items",items.sort(function(a,b){return(a.n.toLowerCase()<b.n.toLowerCase())?v:(-v);}));}},colCss:"ownerCol",dataWidget:{scriptClass:"mstrmojo.Label",cssClass:"ownLabel",bindings:{text:"this.parent.data.n"}}},{headerWidget:{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(61,"Modified"),cssClass:"headerText",onclick:function(){var dg=this.dataGrid;dg.sortBy.dt=-dg.sortBy.dt;var v=dg.sortBy.dt;var items=[];items=items.concat(dg.items);dg.set("items",items.sort(function(a,b){return(a.dateObj.getTime()<(b.dateObj.getTime()))?v:(-v);}));}},colCss:"modifiedCol",dataWidget:{scriptClass:"mstrmojo.Label",cssClass:"mtLabel",bindings:{text:"this.parent.data.formatDate"}}}]}]}],populate:function(){var items=[];var composeItem=function composeItem(items,icon,xda,n,desc){items.push({t:12,icon:icon,xda:xda,n:n,desc:desc});};composeItem(items,"File",$XDA_TYPE.text,mstrmojo.desc(4700,"File"),mstrmojo.desc(9096,"Import an Excel, CSV or Text file"));if(mstrApp.allowImportDB){composeItem(items,"Cube",$XDA_TYPE.querybuilder,mstrmojo.desc(1563,"Database"),mstrmojo.desc(9098,"Import from Relational data sources"));}composeItem(items,(isSalesForceEnabled()?"SFA":"SF"),$XDA_TYPE.salesforce,mstrmojo.desc(9213,"Salesforce"),mstrmojo.desc(9214,"Import your Reports from Salesforce.com"));if(mstrApp.allowImportDB){composeItem(items,"Database",$XDA_TYPE.ffsql,mstrmojo.desc(9095,"Freeform"),mstrmojo.desc(9097,"Import Data using a Script:SQL,XQuery,SOQL or HiveQL"));}this.sourcePane.sourceList.set("items",items);if(isSalesForceEnabled()){_getDiExternalInfo(this.model);}_getQuota();},resize:function resize(w,h){if(!this.domNode){return ;}var lw=w*0.3;if(lw<300){lw=300;}var rw=w-lw;this.domNode.rows[0].cells[0].style.width=lw+"px";this.domNode.rows[0].cells[1].style.width=rw+"px";this.setListBaseItemsContainerSize(document.getElementById("mstrDiPanelOfSources"),"100%","100%");var ele=document.getElementById("mstrDiQuotaAndListOfCubes");ele.style.height=h+"px";ele.style.width=rw+"px";},setListBaseItemsContainerSize:function setListBaseItemsContainerSize(elem,w,h){var i;for(i=0;i<elem.children.length;i++){if(elem.children[i].className=="mstrmojo-ListBase2-itemsContainer"){elem.children[i].style.width=w;elem.children[i].style.height=h;}this.setListBaseItemsContainerSize(elem.children[i],w,h);}}});})();