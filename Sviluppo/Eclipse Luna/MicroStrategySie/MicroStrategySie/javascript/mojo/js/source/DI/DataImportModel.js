(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.DI.ImportSource","mstrmojo.DI.DIConstants","mstrmojo.string");var constants=mstrmojo.DI.DIConstants;var _C=mstrmojo.css;var _waitBox=new mstrmojo.Editor({id:"waitBox",cssClass:"mstrmojo-Architect-WaitBox",draggable:false,showTitle:false,zIndex:99999,counter:0,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrIcon-wait"}]});function makeKey(type,subtype){return type+"_"+subtype;}function importFactory(type,subtype){var importSource=new mstrmojo.DI.ImportSource();importSource.init(type,subtype,makeKey(type,subtype));return importSource;}var importSources={};mstrmojo.DI.DataImportModel=mstrmojo.declare(mstrmojo.Obj,null,{id:"DIModel",scriptClass:"mstrmojo.DI.DataImportModel",curPg:constants.pageType.intro,redirect:3,refresh_opt:"1",folderID:"",cubeID:"",cubeName:"",cubeDesc:"",currentSource:null,fileUploadSize:0,application:constants.application.platform,operationMode:constants.operationMode.create,applicationName:function(){switch(this.application){case constants.application.platform:return"Data Import";case constants.application.cloudPersonal:return"Cloud Personal";case constants.application.cloudProfessional:return"Cloud Express";}},initParams:function initParams(params){var m=this;var request;var statusCode=params.StatusCode;var cubeID=params.ReportId;var folderID=params.FolderId;var cubeName=params.CubeName;var cubeDesc=params.CubeDesc;switch(statusCode){case constants.statusCode.edit:this.set("operationMode",constants.operationMode.edit);request=constants.requestFlag.sourceInfo;break;case constants.statusCode.obtainSource:this.set("operationMode",constants.operationMode.refresh);request=constants.requestFlag.sourceInfo;break;case constants.statusCode.xformsError:case constants.statusCode.mappingError:this.set("operationMode",constants.operationMode.refresh);request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping|constants.requestFlag.preview|constants.requestFlag.sheets;break;default:this.set("operationMode",constants.operationMode.create);request=0;break;}this.cubeID=cubeID;this.cubeName=cubeName;this.folderID=folderID;this.cubeDesc=cubeDesc;this.fileUploadSize=params.UploadSizeLimit*1024*1024;if(params.CloudEdition!==undefined){this.application=params.CloudEdition;}if(cubeID!==undefined){var cbload={success:function(res){m.populate(res,request,request);switch(statusCode){case constants.statusCode.xformsError:case constants.statusCode.mappingError:m.set("curPg",constants.pageType.preview);break;default:if(m.currentSource.type===constants.sourceType.file){m.set("curPg",constants.pageType.file);}break;}},failure:function(res){m.hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var params1={taskId:"qBuilder.GetReportXDADefinition",reportid:this.cubeID,messageid:null,sessionState:mstrApp.sessionState,browsetype:4,previewflag:request};this.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,this.restructCB(cbload),params1);}},selectImportSource:function selectImportSource(type,subtype){var importSource=importSources[makeKey(type,subtype)];if(!importSource){this.currentSource=importFactory(type,subtype);importSources[this.currentSource.key]=this.currentSource;}else{this.currentSource=importSource;}this.raiseEvent({name:"ImportTypeChanged"});},loadRptData:function loadRptData(prevFg,shtIx,cb){var params={taskId:"qBuilder.GetReportXDADefinition",messageid:this.msgid,sessionState:mstrApp.sessionState,browsetype:4,previewflag:prevFg};if(shtIx>=0){params.sheetIndex=shtIx;}this.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,this.restructCB(cb),params);},importUrl:function importUrl(url,cb){var params={taskId:"importFile",messageid:this.msgid,sessionState:mstrApp.sessionState,url:url,taskContentType:"json",taskEnv:"xhr"};this.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,this.restructCB(cb),params);},showWaitPage:function showWaitPage(isWide){if(!_waitBox.hasRendered){_waitBox.render();}var ele=_waitBox.editorNode,cont=_waitBox.containerNode.children[0],cur=_waitBox.curtainNode;_waitBox.counter++;if(isWide){if(!_waitBox.visible){_C.addClass(ele,"wide");_C.addClass(cont,"wide");_C.addClass(cur,"wide");}}else{if(!_waitBox.visible){_C.removeClass(ele,"wide");_C.removeClass(cont,"wide");_C.removeClass(cur,"wide");}}_waitBox.open();},hideWaitPage:function hideWaitPage(isForce){if(isForce){if(_waitBox.visible){_waitBox.close();}_waitBox.counter=0;return ;}_waitBox.counter--;if(_waitBox.counter===0&&_waitBox.visible){_waitBox.close();}},editCube:function editCube(rptId,shtIx,chs,cb){var params={taskId:"editCube",msgID:this.msgid,sessionState:mstrApp.sessionState,shtIx:shtIx};if(rptId){params.reportID=rptId;}if(chs){params.chs=chs;}if(this.currentSource.subtype===constants.sourceSubtype.url){params.isUrl=true;}this.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,this.restructCB(cb),params);},restructCB:function restructCB(callbacks){var me=this;var cb={success:function(res){me.hideWaitPage();if(callbacks&&callbacks.success){callbacks.success(res);}},failure:function(res){me.hideWaitPage();mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};return cb;},changeMappings:function(callbacks){var map=this.currentSource.getMappingChanges();var params={taskId:"qBuilder.RemapObject",msgid:this.msgid,mpcs:JSON.stringify(map)};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}var model=this;var cb2={success:function(res){model.hideWaitPage();model.populate(res,constants.requestFlag.mapping,constants.requestFlag.mapping);if(callbacks&&callbacks.success){callbacks.success(res);}},failure:function(res){me.hideWaitPage();mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var cb={success:function(res){model.loadRptData(constants.requestFlag.mapping,-1,cb2);},failure:function(res){model.hideWaitPage();mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};this.showWaitPage(true);mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},pollStatus:function pollStatus(cb){var params={taskId:"pollStatus",resultSetType:3,pollingFrequency:500,maxWait:60000,taskEnv:"xhr",taskContentType:"json",msgID:this.msgid,sessionState:mstrApp.sessionState};this.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,this.restructCB(cb),params);},populateSourceInfo:function populateSourceInfo(data){if(!data){return ;}var src=data.datap.srce;var source;switch(src.xt){case constants.xdaType.excel:case constants.xdaType.text:if(src.iurl){source=importSources[makeKey(constants.sourceType.file,constants.sourceSubtype.url)];if(!source){this.selectImportSource(constants.sourceType.file,constants.sourceSubtype.url);source=this.currentSource;}}else{source=importSources[makeKey(constants.sourceType.file,constants.sourceSubtype.localFile)];if(!source){this.selectImportSource(constants.sourceType.file,constants.sourceSubtype.localFile);source=this.currentSource;}}source.sourceInfo=new mstrmojo.Obj();source.sourceInfo.set("name",src.tbn);source.sourceInfo.set("sheetName",src.shn);source.sourceInfo.set("sheetIndex",src.shnb);source.sourceInfo.set("hasInsertedColumnHeaders",src.hnchs);break;case constants.xdaType.salesforce:source=importSources[makeKey(constants.sourceType.salesforce,constants.sourceSubtype.salesforce)];if(!source){this.selectImportSource(constants.sourceType.salesforce,constants.sourceSubtype.salesforce);source=this.currentSource;}source.sourceInfo=new mstrmojo.Obj();source.sourceInfo.set("sourceId",src.sid);source.sourceInfo.set("name",src.tbn);source.sourceInfo.set("objectId",src.oid);source.sourceInfo.set("objectDesc",src.odesc);break;}},populate:function populate(data,serviceFlags,requestFlags){if((serviceFlags&constants.requestFlag.sourceInfo)===constants.requestFlag.sourceInfo){this.populateSourceInfo(data);}this.currentSource.populate(data,requestFlags,serviceFlags);if((serviceFlags&constants.requestFlag.preview)===constants.requestFlag.preview){this.raiseEvent({name:"PreviewFetched"});}if((serviceFlags&constants.requestFlag.mapping)===constants.requestFlag.mapping){this.raiseEvent({name:"MappingsFetched"});}if((serviceFlags&constants.requestFlag.sheets)===constants.requestFlag.sheets){this.raiseEvent({name:"SheetsFetched"});}}});})();