(function(){mstrmojo.requiresCls("mstrmojo.DI.DIConstants");var constants=mstrmojo.DI.DIConstants;function getBFDType(datatype){switch(datatype){case constants.dataType.decimal:case constants.dataType.dtdouble:case constants.dataType.dtfloat:case constants.dataType.integer:case constants.dataType.dtlong:case constants.dataType.numeric:case constants.dataType.real:case constants.dataType.dtshort:case constants.dataType.unsigned:return constants.baseFormType.number;case constants.dataType.dtchar:case constants.dataType.varChar:case constants.dataType.MBChar:case constants.dataType.varChar:case constants.dataType.nVarChar:case constants.dataType.nChar:return constants.baseFormType.dttext;case constants.dataType.timeStamp:return constants.baseFormType.dtdateTime;case constants.dataType.date:return constants.baseFormType.date;case constants.dataType.dttime:return constants.baseFormType.dttime;case constants.dataType.binary:case constants.dataType.varBin:case constants.dataType.varBin:case constants.dataType.reserved:case constants.dataType.Dunknown:return constants.baseFormType.number;case constants.dataType.bigDecimal:return constants.baseFormType.bigDecimal;default:return constants.baseFormType.Dnumber;}}mstrmojo.DI.ImportSource=mstrmojo.declare(mstrmojo.Obj,null,{type:-1,subtype:-1,key:"",currentIndex:-1,previews:{},mappings:{},originalMappings:{},sourceInfo:null,sheets:null,transformations:null,currentPreview:null,currentMapping:null,reset:function(){this.currentIndex=-1;this.previews={};this.mappings={};this.originalMappings={};this.sourceInfo=null;this.transformations=null;this.sheets=null;this.currentPreview=null;this.currentMapping=null;},hasFetchedPreview:function(index){if(index===undefined){index=0;}if(!this.previews[index]){return false;}return true;},selectSheet:function(index){if(index===undefined){index=0;}this.set("currentIndex",index);this.currentPreview=this.previews[this.currentIndex];this.currentMapping=this.mappings[this.currentIndex];},init:function(type,subtype,key){this.type=type;this.subtype=subtype;this.key=key;},populate:function(data,serviceFlags,requestFlags){if(this.sourceInfo.sheetIndex>=0){this.currentIndex=this.sourceInfo.sheetIndex;}else{this.currentIndex=0;}if((serviceFlags&constants.requestFlag.mapping)===constants.requestFlag.mapping){this.populateMappings(data.datap.maps,this.currentIndex);this.currentMapping=this.mappings[this.currentIndex];}if((serviceFlags&constants.requestFlag.preview)===constants.requestFlag.preview){this.populatePreview(data.datap.data,this.currentIndex);this.currentPreview=this.previews[this.currentIndex];}if((serviceFlags&constants.requestFlag.sheets)===constants.requestFlag.sheets){this.populateSheets(data.datap.shts);}},getMappingChanges:function(){var currentMapping=this.currentMapping;var originalMapping=this.originalMappings[this.currentIndex];var mpcs=[],mpc,i,current,original,changed;for(i=0;i<currentMapping.length-1;i++){current=currentMapping[i];original=originalMapping[i];mpc={did:current.did};changed=false;if(current.alias!==original.alias){mpc.alias=current.alias.replace(/[<]/g,"&lt;");changed=true;}if(current.tp!==original.tp){mpc.ot=current.tp;changed=true;}if(current.dtp!==original.dtp){mpc.bft=current.dtp;changed=true;}if(current.selected!==original.selected){mpc.cmf=(current.selected?1:0);changed=true;}if(changed){mpcs.push(mstrmojo.hash.copy(mpc));}}return mpcs;},getMissingColumns:function getMissingColumns(){var mappings=this.currentMapping;var missingColumns=null;var column,i;if(mappings){for(i=0;i<mappings.length;i++){column=mappings[i];if((column.columnState&constants.columnState.missing)===constants.columnState.missing){if(!missingColumns){missingColumns=[];}missingColumns.push(column);}}}return missingColumns;},populatePreview:function populatePreview(data,sheetIndex){if(!data.length){return ;}var nCols=data.length;var nRows=data[0].dvs.length;var previewData=[];var columnHeaders=[];var i,j;for(i=0;i<nCols;i++){columnHeaders.push(data[i].dcns.cln);}for(j=0;j<nRows;j++){previewData[j]=[];for(i=0;i<nCols;i++){previewData[j].push(data[i].dvs[j]);}}for(j=nRows;j<50;j++){previewData[j]=[];for(i=0;i<nCols;i++){previewData[j].push("");}}var preview=this.previews[sheetIndex];if(!preview){preview=new mstrmojo.Obj();}preview.set("chs",columnHeaders);preview.set("data",previewData);preview.set("hasNewHeaders",false);preview.set("ignoredRows",0);this.previews[sheetIndex]=preview;},populateMappings:function populateMappings(maps,sheetIndex){var attrs=maps.amps,metrs=maps.mtmps;var i,column,len,oi,j,aflen;var columns=[];for(i=0,len=attrs.length;i<len;i++){var attr=attrs[i],aimp=attr.aimp,afmps=attr.afmps;oi=afmps[0].col.oi;column={did:oi.did,alias:aimp.atnm,n:oi.def.cln,isNew:false,columnState:oi.def.dicl.ups,selected:(oi.def.dicl.ups==2),dtp:getBFDType(oi.def.dt.tp),ix:oi.def.dicl.clix,tp:12,timeArr:[],georole:0,geoattrs:{0:false,1:false,2:false}};for(j=0,aflen=afmps.length;j<aflen;j++){column.afid=aimp.atid+afmps[j].fmid;column.fmn=afmps[j].fmn;}columns.push(column);}for(i=0,len=metrs.length;i<len;i++){var metr=metrs[i];oi=metr.col.oi;column={did:oi.did,alias:metr.mtn,n:oi.def.cln,isNew:false,columnState:oi.def.dicl.ups,selected:(oi.def.dicl.ups==2),dtp:getBFDType(oi.def.dt.tp),ix:oi.def.dicl.clix,tp:4,timeArr:[],georole:0,geoattrs:{0:false,1:false,2:false}};columns.push(column);}columns.sort(function(a,b){return a.ix-b.ix;});if(columns.length>0){this.mappings[sheetIndex]=columns;this.originalMappings[sheetIndex]=mstrmojo.hash.clone(columns);}},populateSheets:function populateSheets(data){var i;var shts=[];if(data){for(i=0;i<data.length;i++){if(data[i]!=="*"){shts.push({index:i,name:data[i]});}}this.set("sheets",shts);}}});}());