(function(){mstrmojo.requiresCls("mstrmojo.StringBuffer","mstrmojo.hash","mstrmojo.dom","mstrmojo._IsGraphDataService","mstrmojo.func");mstrmojo.requiresDescs(8445);var $H=mstrmojo.hash;var $DOM=mstrmojo.dom;var $PST=[mstrmojo.desc(8445,"Loading")];var updateNum=0;function submitRequest(params,callback,config){var updateId=updateNum++,updates=this.getTxUpdates(updateId);config=config||{};config.src=arguments.callee.caller.name;if(!mstrmojo.string.isEmpty(updates)){params.updateChanges=updates;}mstrApp.serverRequest(params,this.wrapCallback(callback,updateId),config);}function addContentSize(request){var availableDim=window.mstrMobileApp?this.model.controller.getContentDimensions():mstrApp.getContentDimensions();if(availableDim){request.styleName="RWDocumentMobileStyle";request.availableWidth=availableDim.w;request.availableHeight=availableDim.h;}}mstrmojo.DocDataService=mstrmojo.declare(mstrmojo.Obj,[mstrmojo._IsGraphDataService],{scriptClass:"mstrmojo.DocDataService",wrapCallback:function wrapCallback(callback,updateId){var me=this;return mstrmojo.func.wrapMethods({success:function(res){if(res){me.rwb=res.bs||me.rwb;me.msgId=res.mid||me.msgId;}me.clearTxUpdates(updateId);},failure:function(res){me.resetTxUpdates(updateId);}},callback);},refresh:function refresh(params,callback){var isRefresh=!!params.useRefreshProgress,pst=isRefresh?[mstrmojo.desc(10078,"Refreshing data. Please wait.")]:$PST;delete params.useRefreshProgress;submitRequest.call(this,$H.copy(params,{taskId:"docRefresh",rwb:this.rwb,rePrompt:false,fresh:false,regenerate:false}),callback,{showProgress:true,hideProgress:true,progressStateText:pst,useRefreshProgress:isRefresh});},getTxUpdates:function getTxUpdates(t){var m=this.model;return m&&m.getTransactionUpdates&&m.getTransactionUpdates(t);},clearTxUpdates:function clearTxUpdates(t){var m=this.model;if(m&&m.clearTransactionUpdates){m.clearTransactionUpdates(t);}},resetTxUpdates:function resetTxUpdates(t){var m=this.model;if(m&&m.resetTransactionUpdates){m.resetTransactionUpdates(t);}},loadDocLayout:function loadDocLayout(params,callback){var taskParams=$H.copy(params,{taskId:"loadDocLayout",rwb:this.rwb});addContentSize.call(this,taskParams);submitRequest.call(this,taskParams,callback,{showProgress:true,hideProgress:true,progressStateText:$PST});},setCurrentDocLayout:function setCurrentDocLayout(layoutKey,callback){callback=callback||null;submitRequest.call(this,{taskId:"setDocLayout",rwb:this.rwb,layoutKey:layoutKey},callback,{silent:(callback===null)});if(typeof mstrMobileApp!=="undefined"){mstrMobileApp.clearWebViewCache(false);}},fetchDocPage:function fetchDocPage(position,callback){submitRequest.call(this,{taskId:"fetchDocPage",rwb:this.rwb,pos:position},callback);},setCurrentPanel:function setCurrentPanel(panelKey,panelStackKey,selectorKeyContext,callback){submitRequest.call(this,{taskId:"setCurrentPanel",rwb:this.rwb,key:panelKey,panelStackKey:panelStackKey,selectorKeyContext:selectorKeyContext},callback,{silent:true});},requestNewPanel:function requestNewPanel(panelKey,panelStackKey,selectorKeyContext,dirtyKeys,useLoader,callback){submitRequest.call(this,{taskId:"requestNewPanel",rwb:this.rwb,key:panelKey,panelStackKey:panelStackKey,selectorKeyContext:selectorKeyContext,dirtyKeys:dirtyKeys},callback,{showProgress:useLoader,hideProgress:useLoader,progressStateText:$PST});},applyGraphSelectorAction:function applyGraphSelectorAction(selectorKeyContext,targetList,sliceID,x,y,callback,zoomFactor){submitRequest.call(this,{taskId:"applyGraphSelectorAction",rwb:this.rwb,selectorKeyContext:selectorKeyContext,ctrlKeys:targetList,sliceID:sliceID,x:x,y:y,zoomFactor:zoomFactor},callback);},setDocSelectorElements:function setDocSelectorElements(selectorKeyContext,elemList,controlKey,includeClause,callback,zoomFactor,useAndroidTask,sdpKeys,tks,disablePU){var params={taskId:"setDocSelectorElements",rwb:this.rwb,selectorKeyContext:selectorKeyContext,elemList:elemList,ctlKey:controlKey,zoomFactor:zoomFactor};if($DOM.isAndroid||useAndroidTask){params.taskId="androidSetDocSelectorElements";}if(includeClause!==null&&includeClause!==undefined){params.include=includeClause;}if(sdpKeys){params.sdpKeys=sdpKeys;}if(tks){params.tks=tks;}if(disablePU){params.usePartialUpdate="0";}submitRequest.call(this,params,callback,{showProgress:true,hideProgress:true,progressStateText:$PST,delay:true});},setDocVisSelectorElements:function setDocVisSelectorElements(selectorKeyContext,elemList,controlKey,includeClause,callback,zoomFactor,useAndroidTask,sdpKeys,tks){var params={taskId:"setDocVisSelectorElements",rwb:this.rwb,selectorKeyContext:selectorKeyContext,elemList:elemList,ctlKey:controlKey,zoomFactor:zoomFactor};if($DOM.isAndroid||useAndroidTask){params.taskId="androidSetDocSelectorElements";}if(includeClause!==null&&includeClause!==undefined){params.include=includeClause;}if(sdpKeys){params.sdpKeys=sdpKeys;}if(tks){params.tks=tks;}submitRequest.call(this,params,callback,{showProgress:true,hideProgress:true,progressStateText:$PST,delay:true});},setMultiDocSelectorElements:function setMultiDocSelectorElements(selectorObjects,multiSelect,callback,zoomFactor){var params={taskId:"setMultiDocSelectorElements",rwb:this.rwb,multiSelect:multiSelect,selectorObjects:selectorObjects,zoomFactor:zoomFactor};submitRequest.call(this,params,callback,{showWait:true,hideWait:true,delay:true});},setDocSelectorExpression:function setDocSelectorExpression(unitKeyContext,controlKey,objectId,objectType,expressionFunction,expressionFunctionType,includeClause,expressionConstants,dataType,callback,zoomFactor,unset){var params={taskId:"setDocSelectorExpression"+(unset?"Unset":""),rwb:this.rwb,unitKeyContext:unitKeyContext,ctlKey:controlKey,objectId:objectId,objType:objectType,expFunction:expressionFunction,expFunctionType:expressionFunctionType,zoomFactor:zoomFactor};if(includeClause!==null&&includeClause!==undefined){params.include=includeClause;}if(expressionConstants!==null&&expressionConstants!==undefined){params.expConstants=expressionConstants;}if(dataType!==null&&dataType!==undefined){params.dataType=dataType;}submitRequest.call(this,params,callback);},setDocSelectorInclude:function setDocSelectorInclude(controlKey,includeClause,callback,objectID,objectType,zoomFactor){var params={taskId:"setDocSelectorInclude",rwb:this.rwb,include:includeClause,ctlKey:controlKey,zoomFactor:zoomFactor};if(objectID){params.objectID=objectID;}if(objectType){params.objType=objectType;}submitRequest.call(this,params,callback);},setDocUnsetSelector:function setDocUnsetSelector(unitKeyContext,ctlKey,callback,zoomFactor){submitRequest.call(this,{taskId:"unsetSelector",rwb:this.rwb,unitKeyContext:unitKeyContext,ctlKey:ctlKey,zoomFactor:zoomFactor},callback);},getRWGraphImage:function getRWGraphImage(params,callback){var app=mstrApp,id=this.id,p={taskId:"getRWGraphImage",taskEnv:"xhr",imgType:4,messageID:this.msgId,nodeKey:params.k,sliceID:parseInt(params.sid,10),width:parseInt(params.w,10),height:parseInt(params.h,10)};if(app.onMobileDevice()&&app.useBinaryFormat){window.setTimeout(function(){submitRequest.call(mstrmojo.all[id],p,callback);},0);}else{if(params.encodeImage){p.taskContentEncoding="base64";delete p.taskEnv;submitRequest.call(this,p,{success:function(res){callback.success("data:image/png;base64,"+res);},failure:function(err){(callback.failure||app.onerror)(err);}});}else{var cfg=app.getConfiguration(),projectId=app.getCurrentProjectId(),values=new mstrmojo.StringBuffer();p.__ts__=new Date().getTime();p.sessionState=app.getSessionState(projectId);$H.forEach(p,function(v,n){values.append(n+"="+encodeURIComponent(v));});callback.success(cfg.getTaskUrlByProject(projectId)+"?"+values.toString("&"));}}},getImage:function getImage(url){var app=mstrApp,config=app.getConfiguration();if(config&&url&&url.indexOf("://")===-1){url=config.getHostUrlByProject(app.getCurrentProjectId())+url;}return(mstrApp.useBinaryFormat)?String(mstrMobileApp.getImage(url)):url;},getDocImage:function getDocImage(url){return this.getImage(url);},setQuickSwitchViewMode:function setQuickSwitchViewMode(gridKeyContext,displayMode){submitRequest.call(this,{taskId:"setDisplayMode",gridKeyContext:gridKeyContext,messageID:this.msgId,displayMode:displayMode},null,{silent:true});},setRWUnitProperties:function setRWUnitProperties(key,props,formatType,returnData,callback){submitRequest.call(this,{taskId:"setRWUnitProperties",rwb:this.rwb,nodeKey:key,props:props,formatType:formatType,returnData:returnData},callback,{silent:true});},setDocZoom:function setDocZoom(params,callback){submitRequest.call(this,{taskId:"setDocZoom",rwb:this.rwb,zoomType:params.zoomType,zoomFactor:params.zoomFactor},callback);},sort:function sort(params,callback){submitRequest.call(this,$H.copy(params,{taskId:"DocSort",rwb:this.rwb}),callback);},pivot:function pivot(params,callback){var request=$H.copy(params,{messageID:this.msgId,rwb:this.rwb});request.key=params.nodeKey;delete request.nodeKey;request.taskId=params.formID?"docPivotForm":"docPivot";submitRequest.call(this,request,callback);},drillGrid:function drillGrid(params,callback){submitRequest.call(this,{taskId:"DocDrill",messageID:this.msgId,nodeKey:params.nodeKey,drillPathIndex:params.drillPathIndex,drillPathKey:params.drillPathKey,elementList:params.drillElements},callback,{showProgress:true,hideProgress:true,progressStateText:$PST,delay:true});},changeDocGroupBy:function changeDocGroupBy(params,callback,config){var request={taskId:"changeDocGroupBy",rwb:this.rwb,messageID:this.msgId,treesToRender:3};if(params.flags){request.flags=params.flags;}if(params.groupbyKey){request.groupByKey=params.groupbyKey;request.elementID=params.elementId;}else{request.gbUnits=params.gbUnits;}addContentSize.call(this,request);submitRequest.call(this,request,callback,config);},downloadGridData:function downloadGridData(params,callback){submitRequest.call(this,{taskId:"DocXtabIncrementalFetch",rwb:this.rwb,nodeKey:params.nodeKey,rowPosition:params.rowPosition,maxRows:params.maxRows,colPosition:params.colPosition,sliceId:params.sliceId,maxColumns:params.maxColumns},callback);},txMarkRows:function txMarkRows(params,callback){submitRequest.call(this,{taskId:"markRow",rwb:this.rwb,nodeKey:params.nodeKey,sliceId:params.sliceId,rowOrdinal:params.rowOrdinal,actionType:params.actionType},callback);},txChangeData:function txChangeData(params,callback){submitRequest.call(this,{taskId:"changeData",rwb:this.rwb,nodeKey:params.nodeKey,sliceId:params.sliceId,cells:params.cells,autoRefresh:params.autoRefresh},callback);},sendTransactionActions:function sntTxActs(params,callback){var request={taskId:"DocTransaction",rwb:this.rwb,keyContext:params.keyContext,actions:params.actions,messageID:this.msgId};if(params.txrcd){request.isPending=params.txrcd.pending;request.timestamp=params.txrcd.timestamp;}submitRequest.call(this,request,callback,{silent:!!callback});},RWEventsTask:function RWEventsTask(params,callback){submitRequest.call(this,{taskId:"RWEventsTask",rwb:this.rwb,messageID:params.messageID,styleName:params.styleName,events:params.events},callback);},getPageByTree:function getPageByTree(callback){mstrApp.serverRequest({taskId:"getPageByTree",msgID:this.msgId},callback);},resetSelections:function resetSelections(unitKeyContext,disablePU,callback){submitRequest.call(this,{taskId:"resetSelections",rwb:this.rwb,unitKeyContext:unitKeyContext||"",usePartDisplay:disablePU?"0":"1"},callback);}});}());