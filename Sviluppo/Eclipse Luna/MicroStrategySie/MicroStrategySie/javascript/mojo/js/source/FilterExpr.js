(function(){mstrmojo.requiresCls("mstrmojo.WidgetTree","mstrmojo.expr","mstrmojo.AndOrNode","mstrmojo.ConditionNode");var _E=mstrmojo.expr,_ET=_E.ET,_ET2SC={};_ET2SC[_ET.ANDOR]=mstrmojo.AndOrNode;_ET2SC["*"]=mstrmojo.ConditionNode;function _allowDrop(ctxt){var s=ctxt&&ctxt.src,d=s&&s.data,t=d&&d.et;return(t in _E.ETs);}mstrmojo.FilterExpr=mstrmojo.declare(mstrmojo.WidgetTree,null,{scriptClass:"mstrmojo.FilterExpr",allowDrop:_allowDrop,renderOnScroll:false,itemIdField:null,itemFunction:function(item,idx,widget){var andor=(item.et===_ET.ANDOR),t=widget.tree||widget,cfg={data:item,tree:t,parent:widget,itemFunction:andor?widget.itemFunction:null,draggable:andor?t.draggable:false,dropZone:andor?t.dropZone:false,allowDrop:andor&&t.dropZone?t.allowDrop:null,allowCopy:andor?t.allowCopy:false,editable:t.isEditable?t.isEditable(item):t.editable,makeObservable:andor&&widget.makeObservable,onclick:t.onnodeclick,onadd:t.onnodeadd,onremove:t.onnoderemove},Sc=_ET2SC[item.et]||_ET2SC["*"];return Sc&&(new Sc(cfg));},getDragData:function(ctxt){var d=this._super(ctxt);if(d&&!d.html){var k=d.et&&_E.ET2TGT[d.et];d.html=k?d[k]&&d[k].n||"":d.n||"";}return d;},newCondition:function nc(c){c=c||{et:_ET.AQ};var p=this.selectionParentNode||this,idx;if(p!==this){idx=p.add([c]);}else{var where=this.addCondition([c],null,true);idx=where.index;p=where.widget;}var ret={widget:p,index:idx,data:c};if(this.onNew){this.onNew(ret);}return ret;},addCondition:function addCond(arr,index){var its=this.items,len=its&&its.length,alen=arr&&arr.length;if(!alen){return null;}var w,idx;if(len&&its[0].et===_ET.ANDOR){w=this.ctxtBuilder.itemWidgets[0];idx=w.add(arr,null);}else{if(!len&&(alen===1)){w=this;idx=0;this.add(arr,0);}else{if(len){var cond=its[0];this.remove(cond);arr.unshift(cond);}this.add([{et:_ET.ANDOR,fn:_E.FN.AND,nds:arr}],0);w=this.ctxtBuilder.itemWidgets[0];idx=len?1:0;}}return{widget:w,index:idx};},ondrop:function(c){if(this._super){this._super(c);}var its=this.items,len=its&&its.length,ir=its.concat();if(len>1){this.set("items",null);this.add([{et:_ET.ANDOR,fn:_E.FN.AND,nds:ir}],0);}}});})();