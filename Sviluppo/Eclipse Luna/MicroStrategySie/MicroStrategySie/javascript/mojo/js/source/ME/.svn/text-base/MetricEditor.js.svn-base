(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.Editor","mstrmojo.SaveAsEditor","mstrmojo._FormatDefinition","mstrmojo.ME.MetricDataService","mstrmojo.ME.MetricFormatEditor","mstrmojo.ColorPicker","mstrmojo.ME.MetricEditBox","mstrmojo.InlineEditBox","mstrmojo.ME.FunctionSelector","mstrmojo.ME.FunctionWizard","mstrmojo.MenuButton","mstrmojo.ME.SimpleMetricEditor","mstrmojo.ME.OptionDialog","mstrmojo.ToolSeparator","mstrmojo.ME._MetricEditorHelper");var E=mstrmojo.expr,EDIT_TYPE={functionSelector:0,advanced:65536,simple:131072,func:196608},_VSTATUS=mstrmojo.ME.MetricEditBox.VALIDATION_STATUS;function _clearTokenSection(me,meb){var empty=[];me.oi.tks.met=EDIT_TYPE.functionSelector;me.oi.tks.items=empty;meb.clearTokens(empty);}mstrmojo.ME.MetricEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ME._MetricEditorHelper],{scriptClass:"mstrmojo.ME.MetricEditor",cssClass:"mstrmojo-MetricEditor",zIndex:10,title:mstrmojo.desc(517,"Metric"),help:"Metric_Formula_Editor.htm",onObjectInsert:function onObjectInsert(oi){var tib=this.metricEditBox.inputBox,t={v:mstrmojo.ME.MetricToken.brackets(oi.n),oi:oi,isNew:true};tib.insertTokens([t]);this.closePopup();},onOpen:function onOpen(){var me=this,oi=this.oi,meb=this.metricEditBox,tib=meb.inputBox;this._setupCandidatesCache(tib);tib.noCache=this.noCache;tib.useKeyDelay=this.useKeyDelay;this.set("title",mstrmojo.desc(9559,"Formula Editor:")+" "+oi.n);meb.set("iStatus","");meb.set("vStatus",this.vStatus||0);if(oi&&oi.tks){this.preprocessTokenStram(oi.tks);tib.set("items",oi.tks.items);}},getMetricDefAsTokens:function(){return(this.oi.tks.items);},onClose:function onClose(){if(this._super){this._super();}this.metricEditBox.inputBox.set("items",[]);},handleValidation:function(tks){this.metricEditBox.handleValidation(tks);},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-toolBox mstrmojo-ME-toolBox",children:[{scriptClass:"mstrmojo.ToolBar",cssClass:"mstrmojo-oivmSprite grouped",cssText:"float: right",children:[{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(9560,"Insert function..."),iconClass:"tbFunction",onclick:function(evt){var me=this.parent.parent.parent,meb=me.metricEditBox.inputBox;me.openPopup("functionSelector",{functions:mstrmojo.ME.MetricDataService.getFunctionCatList(),zIndex:me.zIndex+1,openWizard:function(item){var cfg={zIndex:me.zIndex+1,insertMode:true,insertOnFinish:function(tks){meb.insertTokens(tks);}};if(mstrmojo.ME.MetricDataService.isBasicAggMap(item.did)||item.did<-1){cfg.candidates=meb.candidates;cfg.did=item.did;me.openPopup("simpleMetricRef",cfg);}else{cfg.fctOi=item;cfg.oi={did:"",n:mstrmojo.desc(2213,"New Metric"),tks:{items:[],vs:0,vm:""},mhfts:{},mvfts:{}};me.openPopup("wizard",cfg);}}});}},{scriptClass:"mstrmojo.ToolSeparator"},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(6571,"Browse..."),iconClass:"tbBrowse",onclick:function(evt){var me=this.parent.parent.parent;me.openPopup("ob",{zIndex:me.zIndex+1});var ob=me.ob.browser;ob.browse({folderLinksContextId:25,onSelectCB:[me,"onObjectInsert"],browsableTypes:[E.TP.FOLDER,E.TP.FACT,E.TP.ATTR,E.TP.FUNCTION,E.TP.FILTER,E.STP.PROMPT_OBJECTS,E.TP.ATTR,E.TP.DIM,E.TP.METRIC,E.TP.ROLE].join(",")});}},{scriptClass:"mstrmojo.ToolSeparator"},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(9110,"Syntax Validation"),iconClass:"tbValidate",onclick:function(evt){var me=this.parent.parent.parent,meb=me.metricEditBox;meb.set("vStatus",_VSTATUS.VALIDATING);me.tbValidate=this;me.validateSyntax(this);}},{scriptClass:"mstrmojo.ToolSeparator"},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(9561,"Clear Content"),iconClass:"tbClear",onclick:function(evt){var me=this.parent.parent.parent,meb=me.metricEditBox,tib=meb.inputBox;_clearTokenSection(me,tib);tib.raiseChangeEvent({type:"clear"});}}]}]},{scriptClass:"mstrmojo.ME.MetricEditBox",alias:"metricEditBox",ontokensModify:function(evt){this.parent.onmetricModify();},continueValidataion:function(){var editor=this.parent;editor.validateSyntax(editor.tbValidate);}},{scriptClass:"mstrmojo.Button",alias:"btnSwitch",cssClass:"mstrmojo-ME-switch",text:mstrmojo.desc(9562,"Switch to Function Editor"),bindings:{enabled:function(){var error=this.parent.metricEditBox.vStatus==_VSTATUS.ERROR,met=this.parent.oi.tks.met,noerror=!error&&(!met||met&&met!=EDIT_TYPE.advanced);empty=this.parent.metricEditBox.inputBox.items.length==0;return noerror||empty;}},onclick:function(){var editor=this.parent;var cb=function(editor){var oi=editor.oi,met=oi.tks.met||EDIT_TYPE.functionSelector,cfg={zIndex:editor.zIndex+1,candidates:editor.candidates,oi:oi,did:oi.did,insertMode:false},toEditorRef={0:"functionSelector",131072:"simpleMetricRef",196608:"wizard"}[met];if(met==EDIT_TYPE.functionSelector||met==EDIT_TYPE.func){cfg.functions=editor.functions;}if(toEditorRef){if(editor.dirty){cfg.dirty=editor.dirty;}editor.openPopup(toEditorRef,cfg);editor.close();}};if(editor.metricEditBox.inputBox.items.length==0){cb(editor);}else{editor.cbSwtichEditor=cb;editor.tbValidate=this;editor.validateSyntaxAndSwitch(this,"switch");}}},mstrmojo.ME._MetricEditorHelper.buttonBarRef]});})();