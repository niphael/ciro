(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.Editor","mstrmojo.SearchWidget","mstrmojo.SaveAsEditor","mstrmojo.ME._MetricEditorHelper");var $H=mstrmojo.hash;var _SI={n:mstrmojo.desc(9590,"Search Result"),did:-1,fns:[]},_ALL={n:mstrmojo.desc(4561,"All Functions"),did:-2,fns:[]},_TEMPLATES={n:mstrmojo.desc(9591,"Metric Templates"),did:-3,fns:[{n:mstrmojo.desc(3273,"Level"),did:-4,desc:mstrmojo.desc(9592,"Create a level metric.")},{n:mstrmojo.desc(9579,"Condition"),did:-5,desc:mstrmojo.desc(9593,"Create a conditional metric.")},{n:mstrmojo.desc(3324,"Transformation"),did:-6,desc:mstrmojo.desc(9594,"Create a transformation metric.")}]},_SC={n:mstrmojo.desc(4565,"Select a category:"),did:-4,fns:[]};var _openWizard=function(w){var fl=w.functionList;w.openWizard(fl.items[fl.selectedIndex]);};mstrmojo.ME.FunctionSelector=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.ME.FunctionSelector",cssClass:"mstrmojo-FunctionSelector",title:mstrmojo.desc(9595,"Select a function or template"),help:"Select_a_Function_dialog_box.htm",functions:null,selectedCategory:1,selectedIndex:-1,getFunctionSyntax:function(sc,si){var fcts=this.functions;if(!fcts){return"";}var f=fcts[sc].fns[si];if(f.did<0){return f.n;}var pars=f.pars,sa=[],i,len;sa.push(f.n);sa.push("(");for(i=0,len=pars.length;i<len;i++){sa.push(pars[i].n);if(i!==(len-1)){sa.push(", ");}}sa.push(")");return sa.join("");},getFunctionDesc:function(sc,si){var fcts=this.functions;if(!fcts){return"";}var f=fcts[sc].fns[si];return f.desc;},getFunctionHelpTopic:function(sc,si){var fcts=this.functions;if(!fcts){return"";}var f=fcts[sc].fns[si];return mstrmojo.ME.MetricDataService.getFunctionHelpTopic(f.h);},getMetricDefAsTokens:function(){return this.getTokens();},getTokens:function getTokens(){var fl=this.functionList,fctOi=fl.items[fl.selectedIndex],tks=[];if(fctOi){tks.push({v:fctOi.n,oi:fctOi,isNew:true});}return tks;},onOpen:function(){this.selectedCategory=1;this.set("selectedCategory",0);this.set("selectedIndex",-1);if(!this.functions.add){this.functions=$H.make(this.functions,mstrmojo.Arr);}var fcts=this.functions,len=fcts.length;if(len>=1&&fcts[len-1].did!=_TEMPLATES.did){fcts[len]=_TEMPLATES;}},onClose:function(){this.searchWidget.clearSearch();},clearSearchResult:function(){var fcp=this.fcHBox.fcPulldown,fcts=this.functions,li=fcts.length-1;if(fcts[li]===_SI){if(this.selectedCategory===li){this.set("selectedCategory",0);this.set("selectedIndex",-1);}fcts.remove(li);fcp.refresh();}},wizard:{scriptClass:"mstrmojo.ME.FunctionWizard"},simpleMetricRef:{scriptClass:"mstrmojo.ME.SimpleMetricEditor"},metricEditorRef:{scriptClass:"mstrmojo.ME.MetricEditor"},openWizard:function(item){var me=this;if(mstrmojo.ME.MetricDataService.isBasicAggMap(item.did)||item.did<-1){var cfg={zIndex:me.zIndex+10,did:item.did,oi:me.oi};cfg.insertMode=false;me.openPopup("simpleMetricRef",cfg);}else{me.openPopup("wizard",{functions:mstrmojo.ME.MetricDataService.getFunctionCatList(),fctOi:item,zIndex:me.zIndex+10,oi:{did:"",n:mstrmojo.desc(2213,"New Metric"),tks:{items:[],vs:0,vm:""},mhfts:{},mvfts:{}}});}},children:[{scriptClass:"mstrmojo.Label",cssText:"left:0;background:#f2f2f2; height:40px; position:absolute; width:100%;"},{scriptClass:"mstrmojo.SearchWidget",alias:"searchWidget",cssText:"margin: 5px 0 15px 5px;",width:"330px",quickSearch:true,placeholderText:mstrmojo.desc(9168,"Type to search"),onsearch:function(t){var p=this.parent,fl=p.functionList,fcp=p.fcHBox.fcPulldown,fcts=p.functions,f=function(it){return(new RegExp(t,"i")).test(it.n);},its=[],i,len;for(i=0,len=fcts.length;i<len;i++){if(fcts[i]===_SI||fcts[i].did===_ALL.did){continue;}its=its.concat(mstrmojo.array.filter(fcts[i].fns,f));}_SI.fns=its;if(fcts[fcts.length-1]!==_SI){fcts.add([_SI]);}fcp.refresh();p.set("selectedCategory",0);p.set("selectedCategory",fcts.length-1);p.set("selectedIndex",-1);},onclear:function(t){this.parent.clearSearchResult();}},{scriptClass:"mstrmojo.HBox",alias:"fcHBox",cssText:"margin-top: 5px; width:100%;",children:[{scriptClass:"mstrmojo.Pulldown",alias:"fcPulldown",itemIdField:"did",itemField:"n",items:[],bindings:{items:function(){var fncts=this.parent.parent.functions,allFncts=[];if(!fncts){return fncts;}mstrmojo.array.forEach(fncts,function(fnct){mstrmojo.array.forEach(fnct.fns,function(frmla){allFncts.push(frmla);});});var fs=function(a,b){return mstrmojo.array.stringSorter(a.n,b.n);},allFncts=allFncts.sort(fs);if(fncts[0].did!=_ALL.did){var allObj=_ALL;allObj.fns=allFncts;fncts.unshift(allObj);}return fncts;},selectedIndex:"this.parent.parent.selectedCategory",value:function(){var sc=this.parent.parent.selectedCategory;return this.items[sc][this.itemIdField];}},onvalueChange:function(){var fe=this.parent.parent;fe.set("selectedCategory",this.selectedIndex);fe.set("selectedIndex",-1);}}]},{scriptClass:"mstrmojo.List",alias:"functionList",itemIdField:"dssid",itemField:"n",cssClass:"mstrmojo-FE-functionList mstrmojo-suggest-list",itemMarkupFunction:function(data,idx,w){return'<div class="mstrmojo-suggest-text">'+data[w.itemField]+"</div>";},bindings:{items:function(){var fcts=this.parent.functions,sc=this.parent.selectedCategory;return fcts[sc].fns;},selectedIndex:"this.parent.selectedIndex"},onchange:function(evt){this.parent.set("selectedIndex",this.selectedIndex);},ondblclick:function(){var editor=this.parent;_openWizard(editor);editor.close();}},{scriptClass:"mstrmojo.HBox",alias:"buttonBar",slot:"buttonNode",cssClass:"mstrmojo-ME-buttonBox",cellCssClass:"subBox",children:[$H.copy({cssClass:"mstrmojo-Button  mstrmojo-HTMLButton mstrmojo-Editor-button ",cssText:"text-align: center; float:left;",text:mstrmojo.desc(9596,"Use Formula Editor"),title:mstrmojo.desc(9597,"Build a metric formula using metrics, facts, attributes and functions."),getEditor:function(){return this.parent.parent;}},$H.copy(mstrmojo.ME._MetricEditorHelper.switchRef)),{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(1059,"Next"),onclick:function(){var editor=this.parent.parent;_openWizard(editor);editor.close();},bindings:{enabled:function(){return this.parent.parent.functionList.selectedIndex>-1;}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var me=this.parent.parent;me.close();}}]},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-FE-functionSyntax",slot:"editorNode",bindings:{text:function(){return this.parent.getFunctionSyntax(this.parent.selectedCategory,this.parent.selectedIndex);},visible:function(){return this.text.length>0;}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-FE-functionDesc",slot:"editorNode",bindings:{text:function(){var p=this.parent,sc=this.parent.selectedCategory,si=this.parent.selectedIndex;return p.getFunctionDesc(sc,si)+"  "+p.getFunctionHelpTopic(sc,si);},visible:function(){return this.text.length>0;}}}]});})();