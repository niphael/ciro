(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash");var _A=mstrmojo.array,_H=mstrmojo.hash;function _add(me,idxs){var added=[],sel=me.selectedIndices,allIdx=me.allIdx;var i,len,items=me.items;if(me.multiSelect&&(allIdx>-1)&&(_A.indexOf(idxs,me.allIdx)>-1)){for(i=0,len=items.length;i<len;i++){if(!sel[i]){added.push(i);sel[i]=true;me.selectedIndex=i;me.selectedItem=items[i];}}}else{for(i=0,len=idxs.length;i<len;i++){var idx=idxs[i];if(!sel[idx]){sel[idx]=true;added.push(idx);me.selectedIndex=idx;me.selectedItem=items[idx];}}}return added;}function _rmvAll(me){var rmv=[],sel=me.selectedIndices;for(var i in sel){delete sel[i];rmv.push(parseInt(i,10));}me.selectedIndex=-1;me.selectedItem=null;return rmv;}function _rmv(me,idxs){var removed=[],sel=me.selectedIndices,arrIdx=_A.indexOf,allIdx=me.allIdx;if(me.multiSelect&&(allIdx>-1)&&(arrIdx(idxs,allIdx)>-1)){return _rmvAll(me);}if(idxs.length>0&&sel[allIdx]){if(arrIdx(idxs,allIdx)<0){idxs.push(allIdx);}}for(var i=0,len=idxs.length;i<len;i++){var idx=idxs[i];if(sel[idx]){delete sel[idx];removed.push(idx);if(me.selectedIndex==idx){me.selectedIndex=-1;me.selectedItem=null;}}}return removed;}function _apply(me,h){var sel=me.selectedIndices;if(!sel){sel={};me.selectedIndices=sel;}if(!h){h={};}var sidx=me.selectedIndex,rmv=[],idx;for(var i in sel){if(!h[i]){idx=parseInt(i,10);delete sel[i];rmv.push(idx);if(sidx==idx){me.selectedIndex=-1;me.selectedItem=null;}}}var add=[],itms=me.items;for(i in h){if(!sel[i]){idx=parseInt(i,10);sel[i]=true;add.push(idx);me.selectedIndex=idx;me.selectedItem=itms&&itms[idx];}}return{add:add,rmv:rmv};}function _raise(me,added,removed){if(me.raiseEvent&&((added&&added.length)||(removed&&removed.length))){me.raiseEvent({name:"change",added:added,removed:removed});}}mstrmojo._ListBase2Selections=mstrmojo.provide("mstrmojo._ListBase2Selections",{multiSelect:false,selectedIndices:null,selectedIndex:-1,selectedItem:null,selectedIndices_bindEvents:"change",selectedIndex_bindEvents:"change",selectedItem_bindEvents:"change",allowUnlistedValues:true,insertUnlistedValuesAt:-1,allIdx:-1,singleSelect:function ss(idx,silent){if(!this.selectedIndices[idx]||(this.selectionPolicy==="reselect")||(idx!==this.allIdx&&this.selectedIndices[this.allIdx])){var rmv=_rmvAll(this),add=_add(this,[idx]);if(silent!==true){_raise(this,add,rmv);}}},toggleSelect:function ts(idx,silent){var add,rmv;if(this.selectedIndices[idx]){rmv=_rmv(this,[idx]);}else{add=_add(this,[idx]);}if(silent!==true){_raise(this,add,rmv);}},rangeSelect:function rs(idx,silent){this.singleSelect(idx,silent);},clearSelect:function cs(silent){var ret=_rmvAll(this);if(silent!==true){_raise(this,null,ret);}},select:function sel(idxs,silent){var ret=_apply(this,_A.hash(idxs));if((silent!==true)&&(ret.add.length||ret.rmv.length)){_raise(this,ret.add,ret.rmv);}},addSelect:function add(idxs,silent){if(idxs==null){return ;}if(idxs.constructor!==Array){idxs=[idxs];}var ret=_add(this,idxs);if(silent!==true){_raise(this,ret,null);}return ret;},removeSelect:function rmv(idxs,silent){if(idxs==null){return ;}if(idxs.constructor!=Array){idxs=[idxs];}var ret=_rmv(this,idxs);if(silent!==true){_raise(this,null,ret);}return ret;},_set_selectedIndices:function(n,v,silent){if(this.selectedIndices===v){return false;}var ret=_apply(this,v);if(ret.add.length||ret.rmv.length){if(silent!==true){_raise(this,ret.add,ret.rmv);}}return false;},_set_selectedIndex:function(n,v,silent){var idxs={};if(v>-1){idxs[v]=true;}return this._set_selectedIndices(null,idxs,silent);},_set_selectedItem:function(n,v,silent){var isObject=v&&(typeof (v)=="object"),idf=this.itemIdField,idx=-1,its=this.items;if(isObject&&idf!=null){idx=_A.find(its,idf,v[idf]);}else{if(v!=null){idx=_A.indexOf(its,v);}}if((idx===-1)&&(v!=null)&&this.allowUnlistedValues){var at=this.insertUnlistedValuesAt;if(at==null||at<0){at=(its&&its.length)||0;}idx=at;this.add([v],idx);}return this._set_selectedIndex(null,idx,silent);},initSelections:function ints(hash,arr,idx,item,silent){if(!this.selectedIndices){this.selectedIndices={};this.selectedIndex=-1;}if(hash){this._set_selectedIndices(null,hash,silent);}else{if(arr){this.select(arr,silent);}else{if(item){this._set_selectedItem(null,item,silent);}else{if(idx!=null){this._set_selectedIndex(null,idx,silent);}}}}},sortSelectedIndices:function(){return _H.keyarray(this.selectedIndices,true).sort(_A.numSorter);},removeSelectedItems:function(){var idxs=this.sortSelectedIndices(),len=idxs.length,last=idxs[len-1],ret=this.remove(idxs);last=Math.min(last+1-len,this.items.length-1);if(last>=0){this.singleSelect(last);}return ret;},getSelectedItems:function(){return _A.get(this.items,this.sortSelectedIndices())||[];},setSelectedItems:function(arr,dontClear){if(!arr||!arr.length){return ;}var its=this.items||[],ret=this.itemIdField!=null?_A.findMulti(its,this.itemIdField,arr):_A.indexOfMulti(its,arr),arrLen=arr.length,missed=arrLen-ret.count,alw=this.allowUnlistedValues,at=this.insertUnlistedValuesAt,offset=(alw&&(at>-1))?missed:0;if(at<0){at=its.length;}var appIts=[],appIdxs=[],m=ret.map;if(missed&&alw){var c=0;for(var n=0;n<arrLen;n++){if(m[n]==null){appIts.push(arr[n]);appIdxs.push(at+c++);}}this.add(appIts,at);}var addIdxs=[];for(var k in m){var i=m[k];if(i>=at){i+=offset;}addIdxs.push(i);}var toAdd=addIdxs.concat(appIdxs),added=this.addSelect(toAdd,!dontClear);if(!dontClear){var ha=_A.hash(added),sel=this.selectedIndices,toRem=[];for(var j in sel){if(!ha[j]){toRem.push(parseInt(j,10));}}var rmd=this.removeSelect(toRem,true);_raise(this,added,rmd);}}});})();