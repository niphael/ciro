(function(){mstrmojo.requiresCls("mstrmojo.WH.WHModel");var _DEFAULT_LAYER_ID="xDefaultx";var _DEFAULT_LAYER_NAME="Default Layer";var _H=mstrmojo.hash,_A=mstrmojo.array;var func_cat=["Basic","Date and Time","Logical","Math","Internal","Null/Zero","String"];var _waitBox=new mstrmojo.Editor({id:"waitBox",cssClass:"mstrmojo-Architect-WaitBox",draggable:false,showTitle:false,zIndex:99999,counter:0,children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-Architect-Wait"},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Architect-Message",text:"Please wait..."}]});function _showWaitPage(){if(!_waitBox.visible){_waitBox.open();}_waitBox.counter++;}function _hideWaitPage(isForce){if(isForce){if(_waitBox.visible){_waitBox.close();}_waitBox.counter=0;return ;}if(_waitBox.counter>0){_waitBox.counter--;}if(_waitBox.counter===0&&_waitBox.visible){_waitBox.close();}}var MSI_SERVER_NAME_NOT_INITIALIZED=2147760371,MSI_INVALID_SESSION_ID=2147760372,E_MSI_USERMGR_USER_NOTFOUND=2147758245,E_MSI_CONNECT_FAILED=2147759877;function isSessionExpiredError(res){var c=res&&res.getResponseHeader("X-MSTR-TaskErrorCode");c=(c<0)?(4294967296+parseInt(c,10)):c;switch(c){case MSI_SERVER_NAME_NOT_INITIALIZED:case MSI_INVALID_SESSION_ID:case E_MSI_USERMGR_USER_NOTFOUND:case E_MSI_CONNECT_FAILED:return true;}return false;}function _manageError(res){if(isSessionExpiredError(res)){if(mstrApp.isCloudPro){rrOpenHomePage&&rrOpenHomePage();}else{mstrmojo.form.send({evt:"3010"},mstrApp.name,"POST",null,null,false);}}else{if(res.mpidx!==undefined){mstrmojo.alert("SQL Pass "+res.mpidx+" failed to execute!");}else{mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg").substring(0,500));}}}function _sortFunctions(fcts){var fs=function(a,b){return _A.stringSorter(a.n,b.n);},i,len;fcts=fcts.sort(fs);for(i=0,len=fcts.length;i<len;i++){fcts[i].fns=fcts[i].fns.sort(fs);}return fcts;}function _removeItem(arr,item){var idx,len=arr.length;for(idx=0;idx<len;idx++){var it=arr[idx];if(it.pid===item.pid&&it.cid===item.cid){arr.splice(idx,1);return ;}}}function _getSelDBrole(mdl,rid){var idx=_A.find(mdl.dbrs,"did",rid);return mdl.dbrs[idx];}function _getElementCount(c){var count=0;for(var k in c){count++;}return count;}function getFunctionType(fn){switch(fn){case"Sum":return"12";case"Count":return"13";case"Max":return"16";case"Min":return"15";case"Variance":return"33";case"Avg":return"14";}}function _constructMetricXML(nm,fn,fct){var fnType=getFunctionType(fn);var xml="<schm smt='1'><oi tp='4'  n='"+nm+"'><def><fun fnt='"+fnType+"'/><fc did='"+fct.id+"'/></def></oi></schm>";return xml;}function _constructTableXML(t){var xml="<ti ";var tbs='ns="'+t.ns+'" tbn="'+t.tbn+'" sz="'+t.sz+'" tbid="'+t.tbid+'" prid="'+mstrApp.projectID+'" sta="'+t.sta+'"><clis>';xml+=tbs;for(var i=0;i<t.columns.length;i++){var cl=t.columns[i];var cls='<cli cln="'+cl.cln+'" cmid="'+cl.id+'" sta="'+cl.sta+'"><dt tp="'+cl.dttp+'" ps="'+cl.dtps+'" sc="'+cl.dtsc+'"/></cli>';xml+=cls;}xml+="</clis></ti>";return xml;}mstrmojo.Architect.ArchitectModel=mstrmojo.declare(mstrmojo.WH.WHModel,null,{scriptClass:"mstrmojo.Architect.ArchitectModel",id:"ArchModel",attrs:{},fcts:{},frms:{},attrIdx:0,fctIdx:0,SelTableID:null,SelAttrID:null,SchemaInstanceID:null,ProjectID:null,PrjTblDbr:null,ProjectPrimaryDBRole:{did:"",n:""},layers:{},pts:{},tbls:{},prjdbrs:{},relations:[],rlinks:{},currentlayerID:_DEFAULT_LAYER_ID,isMultiView:false,_set_currentlayerID:function layerChange(n,v){var prev=this.currentlayerID;if(prev!=v){this.currentlayerID=v;this.raiseEvent({name:"layerChange",value:v});}},showWaitPage:function(){_showWaitPage();},hideWaitPage:function(isForce){_hideWaitPage(isForce);},getLayer:function(id){return this.layers[id];},getRelationLink:function getRelationLink(x,y){for(var elem in this.rlinks){var coordsArray=this.rlinks[elem].coords;if(this.inPoly(coordsArray,x,y)){return elem;}}return null;},inPoly:function inPoly(poly,px,py){var npoints=poly.length;var xnew,ynew,xold,yold,x1,y1,x2,y2,i;var inside=false;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)==(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;},populateFormCategories:function populateFormCategories(){var mdl=this,params={taskId:"arch.search",schemaid:this.SchemaInstanceID,objecttypes:21};cb={success:function(res){_hideWaitPage();var oi=res.oi,len=oi.length;for(var i=0;i<len;i++){var o=oi[i];if(o.n==="DESC"){mdl.DESCFrmID=o.did;}if(o.n==="ID"){mdl.IDFrmID=o.did;}mdl.frms[oi[i].did]=oi[i];}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},getSelectedDBRoleTables:function(callbacks,usecache){var mdl=this;var dbr=mdl.SelDBRoleID,dbts=mdl.dbtbls;if(!dbr){return ;}var tbls=dbts[dbr];if(usecache&&tbls){var ds=[];for(var k in tbls){ds.push(tbls[k]);}callbacks.success(ds);return ;}dbts[dbr]={};tbls=dbts[dbr];var flags=this.DssCatalogFlags.DssCatalogGetTables|this.DssCatalogFlags.DssCatalogAllNamespaces;flags=mdl.catalogRefresh?(flags|this.DssCatalogFlags.DssCatalogGetFresh):flags;var tableparams={taskId:"arch.catalogAction",dbrid:dbr,flags:flags};var cb={success:function(res){_hideWaitPage();var cas=res.xrc.cas[0];var stamp=cas.timestamp.replace(/&apos;/,"");mdl.raiseEvent({name:"cacheStamped",value:stamp});var cattables=cas.tis;var length=cattables.length,n,count=0,ds=[];for(idx=0;idx<length;idx++){var dbt=cattables[idx],n=dbt.ns?dbt.ns+"."+dbt.tbn:dbt.tbn;if(dbt){if(parseInt(dbt.sta)===mdl.DSSCatalogStateFlags.DssCatalogStateFresh){var tbl={n:n,prid:dbt.prid,did:n,t:"dbt",st:8405,items:[]};ds[count]=tbl;tbls[n]=tbl;count++;}}}callbacks.success(ds);},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},addNextAvailableForm:function(att,w,callBack){var frms=att.Forms,count=0,frmCatID,frmname,mdl=this;for(var id in frms){count++;}var retVal={success:function(res){callBack.success(count);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};switch(count){case 0:frmCatID=mdl.IDFrmID;frmname="ID";break;case 1:frmCatID=mdl.DESCFrmID;frmname="DESC";break;default:frmname=w.n+"_None";}fmt=this.getDataTypeValue(w.DT);mdl.addAttributeForm(att.id,frmCatID,count,w.cmid,w.EXP,w.tbl.did,null,null,null,fmt,1,1,frmname,null,retVal);},addHeterogenousExpr:function(cw,afw){var mdl=this,ctid=cw.parent.data.did,cd=cw.data,afd=afw.data,tp=afd.TP,expr="["+cd.cln+"]",oid=afd.did,cb2={success:function(res){mdl.raiseEvent({name:"refreshGrid"});},failure:function(){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(tp===12){if(ctid===mdl.SelTableID){var att=mdl.getAttribute(afd.did),cb={success:function(res){mdl.addAttributeInfo(res,oid,expr,cd.cmid,ctid,cb2);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};cd.EXP=expr;cd.DT="Text";cd.ORAL=afd.ORAL;mdl.addNextAvailableForm(att,cd,cb);}else{if(afd.FRMNo===0||this.getTable(ctid).AttrInfos[oid]){mdl.addAttributeInfo(afd.FRMNo,oid,expr,cd.cmid,ctid);}else{return ;}}}else{mdl.addFactInfo(oid,expr,cd.cmid,ctid,cb2);}},addAttributeInfo:function addAttributeInfo(baseFormID,AttID,expr,cmid,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:7,objectid:AttID,baseformid:baseFormID,columnid:cmid,expression:expr,tableids:tableIds};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var attInfos=mdl.getTable(tableIds).AttrInfos;if(attInfos[AttID]){var bfms=attInfos[AttID].BaseFrms,idx=bfms.indexOf(baseFormID),exps=attInfos[AttID].Expr;if(idx===-1){bfms.push(baseFormID);exps.push(expr);}else{exps[idx]=expr;}}else{attInfos[AttID]={id:AttID,AttID:AttID,BaseFrms:[baseFormID],TblID:tableIds,ClnID:cmid,Expr:[expr],IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text"};}mdl.raiseEvent({name:"TableContentChange",did:tableIds});if(callback&&callback.success){callback.success(attInfos[AttID]);}},failure:function(res){_hideWaitPage(true);if(callback&&callback.failure){callback.failure(res);}}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},removeAttributeInfo:function removeAttributeInfo(baseFormID,AttID,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:8,objectid:AttID,baseformid:baseFormID,tableids:tableIds};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var t=mdl.tbls[tableIds],found;if(baseFormID===0){delete t.AttrInfos[AttID];}else{var bfms=t.AttrInfos[AttID].BaseFrms,idx=bfms.indexOf(baseFormID);bfms.slice(idx,1);t.AttrInfos[AttID].Expr.slice(idx,1);}var found=false;for(var tid in mdl.tbls){t=mdl.tbls[tid];if(t.AttrInfos[AttID]){found=true;break;}}if(!found){delete mdl.attrs[AttID];}else{}mdl.raiseEvent({name:"TableContentChange",did:tableIds});callback.success(res);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},convertAttributeToFact:function(baseFormID,attr,fct,callback){var mdl=this,tid=mdl.SelTableID,objid2="",att=mdl.getAttribute(attr.did);if(att.Forms.length>1){mstrmojo.alert("Cannot convert to fact now!");return ;}if(!mdl.SchemaInstanceID){return ;}if(fct){objid2=fct.id;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:30,objectid:attr.did,objectid2:objid2,baseformid:baseFormID,columnid:attr.cmid,tableids:mdl.SelTableID,objectname:attr.AL,expression:attr.EXP};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var aid=attr.did;if(!fct){fct=res.mi["in"].oi[0];var fact={id:fct.did,name:fct.n,IsNew:true,IsDirty:false,IsDeleted:false,Sum:true,Count:false,Max:false,Min:false,Variance:false,Average:false};mdl.fcts[fct.did]=fact;}var factInfo={id:fct.did,FactID:fct.did,TblID:tid,ClnID:attr.cmid,Expr:attr.EXP,IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text",tks:attr.tks,tag:fct};var t=mdl.tbls[tid];t.FactInfos[fct.did]=factInfo;for(var ti in mdl.tbls){var t=mdl.tbls[ti];if(t.AttrInfos[aid]){delete t.AttrInfos[aid];}}delete mdl.attrs[aid];mdl.raiseEvent({name:"TableContentChange",did:tid});callback.success(factInfo);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},addFactInfo:function addFactInfo(factID,expr,cmid,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:4,objectid:factID,columnid:cmid,expression:expr,tableids:tableIds};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var factInfo={id:factID,FactID:factID,TblID:tableIds,ClnID:cmid,Expr:expr,Format:"Text",tag:res};var t=mdl.tbls[tableIds];t.FactInfos[factID]=factInfo;mdl.raiseEvent({name:"TableContentChange",did:tableIds});if(callback&&callback.success){callback.success(factInfo);}},failure:function(res){_hideWaitPage(true);if(callback&&callback.failure){callback.failure(res);}}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},removeFactInfo:function removeFactInfo(factID,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:5,objectid:factID,tableids:tableIds};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var t=mdl.tbls[tableIds];delete t.FactInfos[factID];var found=false;for(var tid in mdl.tbls){var t=mdl.tbls[tid];if(t.FactInfos[factID]){found=true;break;}}if(!found){delete mdl.fcts[factID];}else{var idx=mdl.fcts[factID].tbls.indexOf(tableIds);mdl.fcts[factID].tbls.splice(idx,1);}mdl.raiseEvent({name:"TableContentChange",did:tableIds});callback.success(res);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},convertFactToAttribute:function(fact,attr,fmt,isbf,istf,useName,callback){var mdl=this,tid=mdl.SelTableID,objid2="";if(!mdl.SchemaInstanceID){return ;}var frmID=mdl.IDFrmID;if(attr){objid2=attr.id;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:31,objectid:fact.did,objectid2:objid2,columnid:fact.cmid,tableids:mdl.SelTableID,formcatid:frmID,expression:fact.EXP,objectname:fact.AL,isbrowseform:1,istemplateform:1,baseformtype:fmt,usename:useName};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}var cb={success:function(res){_hideWaitPage();var fid=fact.did,attInfo=mdl.tbls[tid].AttrInfos[attr.did];if(!attr){var attr=res.mi[0]["in"].oi,frms={};frms[mdl.IDFormID]={baseFrmID:0,fmcatid:mdl.IDFormID,n:"ID"};var att={id:attr.did,name:attr.n,Relations:[],Forms:frms,IsNew:true,IsDirty:false,IsDeleted:false};mdl.attrs[attr.did]=att;}if(!attInfo){attInfo={id:attr.did,AttID:attr.did,BaseFrms:[0],TblID:tid,ClnID:fact.cmid,Expr:[fact.EXP],IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text",tks:fact.tks};}else{mstrmojo.alert("Already have the attributes on this table!");}for(var r in mdl.pts){var tbls=mdl.pts[r];for(var ti in tbls){var t=tbls[ti];if(t.FactInfos[fid]){delete t.FactInfos[fact.did];}}}delete mdl.fcts[fid];mdl.raiseEvent({name:"TableContentChange",did:tid});callback.success(attInfo);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},updateFactInfo:function updateFactInfo(factID,expr,cmid,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:6,objectid:factID,expression:expr,columnid:cmid,tableids:tableIds};var cb={success:function(res){_hideWaitPage();var factInfo={id:factID,FactID:factID,TblID:tableIds,ClnID:cmid,Expr:expr,IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text",tag:res};var t=mdl.tbls[tableIds];t.FactInfos[factID]=factInfo;mdl.raiseEvent({name:"TableContentChange",did:tableIds});callback.success(factInfo);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},updateAttributeInfo:function updateAttInfo(baseFormID,AttID,expr,cmid,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:7,objectid:AttID,baseformid:baseFormID,expression:expr,columnid:cmid,tableids:tableIds};var cb={success:function(res){_hideWaitPage();var attInfo=mdl.tbls[tableIds].AttrInfos[AttID],idx=attInfo.BaseFrms.indexOf(baseFormID);attInfo.Expr[idx]=expr;mdl.raiseEvent({name:"TableContentChange",did:tableIds});callback.success(attInfo);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},addAttributeForm:function addAttributeForm(objID,sFormCategID,baseFormID,columnId,expr,tableIds,sort,browseSort,isMultilingual,baseformType,isbf,istf,useName,useDesc,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:12,objectid:objID,formcatid:sFormCategID,tableids:tableIds,columnid:columnId,expression:expr};if(typeof sort!="undefined"){tableparams.sorttype=sort;}if(typeof browseSort!="undefined"){tableparams.browsesorttype=browseSort;}if(typeof isMultilingual!="undefined"){tableparams.ismultilingual=isMultilingual;}if(typeof baseformType!="undefined"){tableparams.baseformtype=baseformType;}else{tableparams.baseformtype=mdl.EnumDSSBaseFormType.DssBaseFormText;}if(typeof useName!="undefined"){tableparams.usename=useName;}if(typeof useDesc!="undefined"){tableparams.usedesc=useDesc;}if(typeof isbf!="undefined"){tableparams.isbrowseform=isbf;}if(typeof istf!="undefined"){tableparams.istemplateform=istf;}var localCallBack={success:function(res){_hideWaitPage();var ob=res.mi["in"].oi;var fr=ob.def.fms;var attr=mdl.getAttribute(ob.did);attr.Forms[baseFormID]={baseFrmID:baseFormID,fmcatid:sFormCategID,n:useName},res.expr=expr;res.clnid=columnId;callback.success(res);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,localCallBack,tableparams);},removeAttributeForm:function removeAttributeForm(attID,sFormCategID,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:13,objectid:attID,formcatid:sFormCategID};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,callback,tableparams);},updateAttributeForm:function updateAttributeForm(objID,sFormCategID,columnId,expr,tableIds,sort,browseSort,isMultilingual,baseformType,isbf,istf,useName,useDesc,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:12,objectid:objID,formcatid:sFormCategID,tableids:tableIds,columnid:columnId,expression:expr};if(typeof tableIds!="undefined"){tableparams.tableids=tableIds;}if(typeof expr!="undefined"){tableparams.exp=expr;}if(typeof columnId!="undefined"){tableparams.columnid=columnId;}if(typeof sort!="undefined"){tableparams.sorttype=sort;}if(typeof browseSort!="undefined"){tableparams.browsesorttype=browseSort;}if(typeof isMultilingual!="undefined"){tableparams.ismultilingual=isMultilingual;}if(typeof baseformType!="undefined"){tableparams.baseformtype=baseformType;}if(typeof useName!="undefined"){tableparams.usename=useName;}if(typeof useDesc!="undefined"){tableparams.usedesc=useDesc;}if(typeof isbf!="undefined"){tableparams.isbrowseform=isbf;}if(typeof istf!="undefined"){tableparams.istemplateform=istf;}if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,callback,tableparams);},setAsLookUp:function setAsLookUp(attID,baseFormID,tableIds,callback){var mdl=this;var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:11,objectid:attID,baseformid:baseFormID,tableids:tableIds};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,callback,tableparams);},addLayer:function(callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var count=_getElementCount(mdl.layers);var n="new layer "+count.toString();while(mdl.layers[n]){n=n+"(1)";}mdl.layers[n]={name:n,id:n,tables:{},relations:[]};mdl.currentlayerID=n;callback.success(mdl.layers[n]);},delLayer:function(id,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var layers=mdl.layers,prev=null;if(id!=_DEFAULT_LAYER_ID){if(layers[id]){for(var key in layers){if(key==id){break;}prev=key;}var res=mdl.layers[id];delete mdl.layers[id];mdl.currentlayerID=prev;callback.success(res);}}else{callback.failure("You cannot delete the default layer.");}},addTablesToLayer:function(tlist,layerid,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var layer=mdl.layers[layerid];for(var item in tlist){if(!layer.tables[item]){layer.tables[item]=item;}}},addRelations4Layer:function(layerID,tbl,rels){var r=this.layers[layerID].relations;if(r.length===0){this.layers[layerID].relations=_H.clone(rels);}else{for(var i=0,len=rels.length;i<len;i++){var it=rels[i],find=false;for(var j=0,len2=r.length;j<len2;j++){var it2=r[j];if(it.pid===it2.pid&&it.cid===it2.cid){it2.tbl.concat(it.tbl);find=true;break;}}if(!find){r.push(it);}}}},createTable:function createTable(sObjectName,t,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var t3=_constructTableXML(t);var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:1,objecttype:15,objectname:sObjectName,objectdef:t3};var tablecb={success:function(res){callback.success({item:res});},failure:function(res){_hideWaitPage(true);if(res.getResponseHeader("X-MSTR-TaskErrorCode")==="-2147080975"){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}else{var $NIB=mstrmojo.Button.newInteractiveButton;mstrmojo.confirm(res.getResponseHeader("X-MSTR-TaskFailureMsg")+"Do you want to create multiple sources table?",[$NIB(mstrmojo.desc(1442,"OK"),function yes(){var cb={success:function(res){var tid=res.mi["in"].oi.did;tbl=mdl.getTable(tid);dbr=_getSelDBrole(mdl,mdl.SelDBRoleID);dbr.dbt=t;tbl.secdbrs.push(dbr);mdl.raiseEvent({name:"msChange",tid:tid,dbr:dbr});},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var params={taskId:"arch.schemaManipulation",schemaid:mdl.SchemaInstanceID,manipulationtype:1,objecttype:15,objectname:sObjectName,objectid:mdl.SelDBRoleID,objectdef:"msr"};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},null),$NIB(mstrmojo.desc(221,"Cancel"),function no(){},null)]);}}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},getTbl4Obj:function(pair,callback){var mdl=this;var cb={success:function(res){_hideWaitPage();if(callback&&callback.success){callback.success(res.oi);}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var params={taskId:"arch.search",schemaid:mdl.SchemaInstanceID,objecttypes:"15",uses:pair.join(";")};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},autoRecog:function(tid,callback){var mdl=this,newone=this.getTable(tid);if(!mdl.SchemaInstanceID){return ;}if(newone.hasRendered){mstrmojo.alert("This table has already been automapped!");return ;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:10,tableids:tid};var cb={success:function(res){_hideWaitPage();var its=res.mi["in"].oi,len=its.length,clns=newone.clns;it=its[len-1],pair=[],atts=it.def.at_c.e,len=atts.length;atts=(len)?atts:[atts];for(var i=0;i<len;i++){var att=atts[i],aid=att.at.did,cmid=att.c.did,idx=mstrmojo.array.find(clns,"cmid",cmid),n=clns[idx].cln;if(!mdl.attrs[aid]){mdl.attrs[aid]={id:aid,name:n,tbls:[],Forms:{}};if(mstrmojo.array.find(its,"did",aid)===-1){pair.push(aid+","+12);}else{mdl.attrs[aid].tbls[0]={did:tid,n:newone.n};mdl.attrs[aid].Forms[0]={baseFrmID:0,fmcatid:mdl.IDFrmID,n:"ID"};}}else{mdl.attrs[aid].tbls.push({did:tid,n:newone.n});}newone.AttrInfos[aid]={id:aid,AttID:aid,BaseFrms:[0],TblID:tid,ClnID:cmid,Expr:["["+n+"]"],IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text"};}var cb={success:function(res){var oi=res.mi.es.oi,oi=oi.length?oi:[oi];for(var i=0,len=oi.length;i<len;i++){var o=oi[i],e=o.def.fms.fm_c.e,e=e.length?e:[e],fms={};for(var j=0,len2=e.length;j<len2;j++){var bfm=e[j],cid=bfm.fm.did;fms[bfm.bfi]={baseFrmID:bfm.bfi,fmcatid:cid,n:mdl.frms[cid].n};}mdl.attrs[o.did].Forms=fms;}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.getObjectInBulk(pair,cb);for(var i=0,len=its.length;i<len;i++){var it=its[i];if(it.tp===13){if(!mdl.fcts[it.did]){var e=it.def.ts.e,e=e.length?e:[e],tbls=[];for(var j=0,len2=e.length;j<len2;j++){tbls.push(e[j].did);}mdl.fcts[it.did]={id:it.did,name:it.n,tbls:tbls,Sum:true,Count:false,Max:false,Min:false,Variance:false,Average:false};}else{mdl.fcts[it.did].tbls.push({did:tid,n:newone.n});}newone.FactInfos[it.did]={id:it.did,FactID:it.did,TblID:tid,ClnID:it.def.c.did,Expr:"["+it.n+"]",IsNew:true,IsDirty:false,IsDeleted:false,Format:"Text"};}}newone.hasRendered=true;if(callback&&callback.success){callback.success();}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},findObjectByName:function(n,tp,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var params={taskId:"arch.search",schemaid:this.SchemaInstanceID,namepattern:n,objecttypes:tp};var cb={success:function(res){_hideWaitPage();callback.success(res);},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},findAttributeByName:function(n){for(var did in this.attrs){if(n==this.attrs[did].name){return this.attrs[did];}}return null;},findFactByName:function(n){for(var did in this.fcts){if(n==this.fcts[did].name){return this.fcts[did];}}return null;},getColumnsForDBAddedTable:function getColumnsForDBTable(t,callback){var mdl=this;var dbroleid=this.SelDBRoleID;var dbtablename=t.n;if(dbroleid){var flags=this.DssCatalogFlags.DssCatalogGetColumns;var ctparams={taskId:"arch.catalogAction",dbrid:dbroleid,dbtname:dbtablename,flags:flags};var cbc={success:function(res){var t=res.xrc.cas[0].tis[0];callback.success({item:t});},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(mstrApp.sessionState!==undefined){ctparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cbc,ctparams);}},addTable:function(t,callback){var attinfos=[],mdl=this;var cb2={success:function(res){if(res.item.mi.schml.schm.length){var pos=res.item.mi.schml.schm.length-1;var tbl=res.item.mi.schml.schm[pos].oi;var dbtbl=res.item.mi.schml.schm[pos].ti;}else{var tbl=res.item.mi.schml.schm.oi;var dbtbl=res.item.mi.schml.schm.ti;}var pdbr=_getSelDBrole(mdl,mdl.SelDBRoleID),rid=(mdl.SelDBRoleID===mdl.ProjectPrimaryDBRole.did)?"00000000000000000000000000000000":mdl.SelDBRoleID,clns=dbtbl.clis.cli;pdbr.dbt=t;for(var i=0,len=clns.length;i<len;i++){clns[i].n=clns[i].cln+mdl.getColumnDataTypeString(clns[i].dt);clns[i].t=26;}if(!mdl.pts[rid]){mdl.pts[rid]={};}var newone={n:tbl.n,did:tbl.did,clns:clns,t:15,prid:rid,pdbr:pdbr,secdbrs:[],relations:[],isNew:true,FactInfos:{},AttrInfos:{},items:[]};mdl.PrjTblDbr=rid;mdl.pts[rid][tbl.did]=newone;mdl.tbls[tbl.did]=newone;mdl.raiseEvent({name:"tblsChange",tbls:[newone]});},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.createTable(t.tbn,t,cb2);},addTables:function(dbtables,tr){var mdl=this,length=dbtables.length,newones=[],count=0,tcount,t=dbtables[0];var cb3={success:function(res){newones[count]=res.item;count++;delete mdl.dbtbls[mdl.SelDBRoleID][t.did];if(count===length){_hideWaitPage();if(tr.items){tr.removeSelectedItems();tr.set("selectedIndex",-1);}mdl.raiseEvent({name:"tblsChange",tbls:newones});}else{t=dbtables[count];mdl.addTable(t,cb3);}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));count++;}};_showWaitPage();mdl.addTable(t,cb3);},getTableSampleData:function getTableSampleData(tbl,callbacks){if(tbl.sampleData){callbacks.success(tbl.sampleData);return ;}var mdl=this,rid=tbl.pdbr.did,tbln=tbl.n;var flags=32;var tableparams={taskId:"arch.catalogAction",dbrid:rid,dbtname:tbln,flags:flags,rowlimit:25};var cb={success:function(res){_hideWaitPage();var table=res.xrc.cas[0].tis[0].cnt;tbl.sampleData=table;callbacks.success(table);},failure:function(res){_hideWaitPage(true);callbacks.failure(res);}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,tableparams);},addrmvRelation:function(paid,caid,tp,tbl,callbacks){var mdl=this,params={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:tp,objectid:paid,objectid2:caid,tableids:tbl.did,objecttype:3};var cb={success:function(res){_hideWaitPage();var lr=mdl.layers[mdl.currentlayerID].relations;if(tp===16){var r=tbl.relations,it={pid:paid,cid:caid,tp:0,tbl:[{n:tbl.n,did:tbl.did}]};r.push(it);lr.push(it);}else{_removeItem(lr,{pid:paid,cid:caid});for(var i=0,len=tbl.length;i<len;i++){var r=mdl.getTable(tbl[i].did).relations;_removeItem(r,{pid:paid,cid:caid});}}callbacks.success();},failure:function(res){_hideWaitPage(true);callbacks.failure(res);}};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},removeRelations:function(aid,pids,cids,callbacks){var mdl=this,paids=[],caids=[];for(var i=0,len=pids.length;i<len;i++){caids.push(aid);paids.push(pids[i]);}for(var i=0,len=cids.length;i<len;i++){paids.push(aid);caids.push(cids[i]);}var obj1=paids.join(","),obj2=caids.join(","),params={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:22,objectid:obj1,objectid2:obj2};var cb={success:function(res){_hideWaitPage();var layer=mdl.layers[mdl.currentlayerID],lr=layer.relations,tbls=layer.tables;for(var i=0;i<paids.length;i++){_removeItem(lr,{pid:paids[i],cid:caids[i]});for(var j in tbls){var r=tbls[j].relations;_removeItem(r,{pid:paids[i],cid:caids[i]});}}callbacks.success();},failure:function(res){_hideWaitPage(true);callbacks.failure(res);}};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},insertRelation:function(paid,caid,aid,tbl,callbacks){var mdl=this,params={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:32,objectid:paid,objectid2:caid,objectid3:aid,tableids:tbl.tid};var cb={success:function(res){_hideWaitPage();var r=tbl.relations,lr=mdl.layers[mdl.currentlayerID].relations,it1={pid:paid,cid:aid,tp:0,tbl:[{n:tbl.n,did:tbl.did}]},it2={pid:aid,cid:caid,tp:0,tbl:[{n:tbl.n,did:tbl.did}]};_removeItem(r,{pid:paid,cid:caid});_removeItem(lr,{pid:paid,cid:caid});r.push(it1);r.push(it2);lr.push(it1);lr.push(it2);callbacks.success();},failure:function(res){_hideWaitPage(true);callbacks.failure(res);}};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},getRelations4Table:function(tbl,callbacks){var mdl=this,r=tbl.relations;if(r.length>0&&callbacks&&callbacks.success){callbacks.success(r);return ;}var params={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:17,tableids:tbl.did};cb={success:function(res){_hideWaitPage();var rels=res.mi.ei.ratt,attInfos=mdl.tbls[tbl.did].AttrInfos;if(rels){rels=rels.length?rels:[rels];for(var i=0,len=rels.length;i<len;i++){var rel=rels[i],at=rel.at;if(!at){continue;}at=at.length?at:[at];for(var j=0,len2=at.length;j<len2;j++){var aid=at[j].atid;if(attInfos[aid]){r.push({pid:rel.atid,cid:aid,tbl:[{did:tbl.did,n:tbl.n}]});}}}}if(callbacks&&callbacks.success){callbacks.success(r);}},failure:function(res){_hideWaitPage(true);if(callbacks&&callbacks.success){callbacks.failure(res);}}};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},handleDropfromRelation:function(c){var w=c.src.widget.parent.parent;d=c.src.data,aid=d.did,att=w.attrs[aid];pids=att.pids,cids=att.cids,mdl=this;if(!pids){w.removeChildren(c.src.widget.parent);return ;}var cb={success:function(res){w.parent.refresh();},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},$NIB=mstrmojo.Button.newInteractiveButton;mstrmojo.confirm("Are you sure to delete all of the relations for attribute ### on current project table?".replace("###",att.name),[$NIB(mstrmojo.desc(1442,"OK"),function yes(){mdl.removeRelations(aid,pids,cids,cb);},null),$NIB(mstrmojo.desc(221,"Cancel"),function no(){},null)]);},removeTableFromLayer:function(tbl){var layer=this.getLayer(this.currentlayerID),tbls=layer.tables,r=layer.relations;for(var i=0;i<r.length;i++){var its=r[i].tbl;for(var j=0,len2=its.length;j<len2;j++){if(its[j].did===tbl.did){its.splice(j,1);if(its.length===0){r.splice(i--,1);}break;}}}delete tbls[tbl.did];this.loadLayer();},loadLayer:function(){mstrmojo.all.tablePanel.display();mstrmojo.all.relationPanel.content.refresh();},getIDForm:function getIDForm(){return this.IDFormID;},createMetric:function createMetric(sObjectName,fn,fct,t3,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,manipulationtype:1,objecttype:4,objectname:sObjectName,objectdef:t3};var tablecb={success:function(res){callback.success({item:res});},failure:function(res){callback.failure(res);}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},saveProject:function SaveProject(cb){var mdl=this;var tableparams={taskId:"arch.schemaInstanceAction",schemaaction:"5",schemaid:mdl.SchemaInstanceID};var tablecb14={success:function(res){_hideWaitPage();if(cb&&cb.success){cb.success();}else{alert("Project Saved");}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));_hideWaitPage(true);}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb14,tableparams);},saveAndUpdate:function(cb){var mdl=this;var cb={success:function(res){params={taskId:"arch.refreshEngineSchema"};var uptcb={success:function(res){_hideWaitPage();if(cb&&cb.success){cb.success();}alert("Project saved and Schema updated");},failure:function(res){_hideWaitPage(true);alert("Schema update failed. "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,uptcb,params);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));_hideWaitPage(true);}};this.persistSchemaInstance(cb);},createNFMetrics:function createNewFactMetrics(){var mdl=this;var rets=0;var MetricsXML=null;for(var it in mdl.fcts){var fct=mdl.fcts[it];nm=fct.name;if(fct.IsNew){fct.IsNew=false;if(fct.Count){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Count of "+nm,"Count",fct);}else{MetricsXML=_constructMetricXML("Count of "+nm,"Count",fct);}}if(fct.Average){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Avg of "+nm,"Avg",fct);}else{MetricsXML=_constructMetricXML("Avg of "+nm,"Avg",fct);}}if(fct.Variance){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Variance of "+nm,"Variance",fct);}else{MetricsXML=_constructMetricXML("Variance of "+nm,"Variance",fct);}}if(fct.Min){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Min of "+nm,"Min",fct);}else{MetricsXML=_constructMetricXML("Min of "+nm,"Min",fct);}}if(fct.Max){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Max of "+nm,"Max",fct);}else{MetricsXML=_constructMetricXML("Max of "+nm,"Max",fct);}}if(fct.Sum){if(MetricsXML!=null){MetricsXML=MetricsXML+_constructMetricXML("Sum of "+nm,"Sum",fct);}else{MetricsXML=_constructMetricXML("Sum of "+nm,"Sum",fct);}}}}return MetricsXML;},persistSchemaInstance:function persistSchemaInstance(cb){var mdl=this;var MetricsXML=null;if(!mdl.SchemaInstanceID){return ;}_showWaitPage();MetricsXML=mdl.createNFMetrics();var resut={success:function(res){mdl.saveProject(cb);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(MetricsXML){mdl.createMetric(null,"Multiple Metrics",null,MetricsXML,resut);}else{mdl.saveProject(cb);}},createSchemaInstance:function createSchemaInstance(){var mdl=this;var tableparams={taskId:"arch.schemaInstanceAction",schemaaction:"1"};var tablecb={success:function(res){mdl.set("SchemaInstanceID",res.siid);mdl.populateFormCategories();},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},deleteObject:function deleteObject(tp,id,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,objecttype:tp,manipulationtype:2,objectid:id};var tablecb={success:function(res){_hideWaitPage();var trgt,objs=res.mi["in"].oi;switch(tp){case 12:trgt=mdl.attrs;if(trgt[id]){delete trgt[id];}for(var r in mdl.pts){var tbls=mdl.pts[r];for(var i=0,len=objs.length;i<len;i++){if(objs[i].tp===15){var obj=objs[i];for(var t in tbls){var tbl=tbls[t];if(obj.did===tbl.did){delete tbl.AttrInfos[id];}}}}}mdl.raiseEvent({name:"AttrFctChange",value:null,did:id});break;case 13:trgt=mdl.fcts;if(trgt[id]){delete trgt[id];}for(var r in mdl.pts){var tbls=mdl.pts[r];for(var i=0,len=objs.length;i<len;i++){if(objs[i].tp===15){var obj=objs[i];for(var t in tbls){var tbl=tbls[t];if(obj.did===tbl.did){delete tbl.FactInfos[id];}}}}}mdl.raiseEvent({name:"AttrFctChange",value:null,did:id});break;case 15:if(mdl.SelTableID===id){mdl.set("SelTableID","");}break;}callback.success(res);},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},createObject:function createObject(tp,n,cln,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,objecttype:tp,manipulationtype:1,objectname:n};var trgt;var ele;var tablecb={success:function(res){_hideWaitPage();switch(tp){case 12:var ele=res.mi["in"].oi;var attr={id:ele.did,name:ele.n,Relations:[],Forms:{}};mdl.attrs[ele.did]=attr;ele.clnid=cln;ele.id=ele.did;callback.success(ele);break;case 13:var ele=res.mi["in"].oi[1];var fact={id:ele.did,name:ele.n,Sum:true,Count:false,Max:false,Min:false,Variance:false,Average:false};mdl.fcts[ele.did]=fact;callback.success(ele);break;}},failure:function(res){_hideWaitPage(true);callback.failure(res);}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},renameObject:function renameObject(id,tp,newName,evt,callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var tableparams={taskId:"arch.schemaManipulation",schemaid:this.SchemaInstanceID,objectid:id,objecttype:tp,manipulationtype:3,objectname:newName};var tablecb={success:function(res){_hideWaitPage();switch(tp){case 12:case 13:var o=res.mi["in"].oi;if(tp===12){mdl.attrs[o.did].name=o.n;}else{mdl.fcts[o.did].name=o.n;}if(evt){mdl.raiseEvent({name:"AttrFctChange",value:o.n,did:o.did,tp:tp});}if(callback&&callback.success){callback.success(res);}break;case 15:var t=res.mi["in"].oi[0];if(callback&&callback.success){callback.success(res);}if(evt){mdl.raiseEvent({name:"TableNameChange",value:newName,did:id});}break;}return ;},failure:function(res){_hideWaitPage(true);if(callback&&callback.failure){callback.failure(res);}}};_showWaitPage();if(mstrApp.sessionState!==undefined){tableparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,tablecb,tableparams);},getColumn:function getColumn(cID){for(lIterator=0;lIterator<this.clns.length;lIterator++){var cln=this.clns[lIterator];if(cln.ClnID==cID){return cln;}}},getTable:function getTable(tID){for(var r in this.tbls){if(r===tID){return this.tbls[r];}}},getFact:function getFact(fid){return this.fcts[fid];},getPrimaryDBrole:function(){var dbrs=this.dbrs;for(var i=0,len=dbrs.length;i<len;i++){if(dbrs[i].primary===1){this.ProjectPrimaryDBRole=dbrs[i];this.ProjectPrimaryDBRole.idx=i;return ;}}this.ProjectPrimaryDBRole=dbrs[0];this.ProjectPrimaryDBRole.idx=0;},loadProjectTables:function loadProjectTables(callback){var mdl=this;if(!mdl.SchemaInstanceID){return ;}var params={taskId:"arch.loadLogicalTables",schemaid:this.SchemaInstanceID};var cb={success:function(res){_hideWaitPage();mdl.getPrimaryDBrole();var d=[];if(res.mi.pdb){var pdb=res.mi.pdb,len=pdb.length;if(!len&&typeof pdb==="object"){pdb=[pdb];len=1;}for(var i=0;i<len;i++){var rid=pdb[i].did,oi=pdb[i].ts.oi,len2=oi.length,dbrid,dbr;isPrm=(rid==="00000000000000000000000000000000"),items=[];if(!len2){oi=[oi];len2=1;}dbrid=isPrm?mdl.ProjectPrimaryDBRole.did:rid;dbr=_getSelDBrole(mdl,dbrid);if(!dbr){mstrmojo.alert("Primary DBRole not exists!!");}d[i]={n:dbr.n+(isPrm?"(Primary)":""),pdbr:dbr,st:dbr.stp,t:dbr.tp,isPrm:isPrm,prid:rid};mdl.pts[rid]={};mdl.prjdbrs[rid]=d[i];for(var j=0;j<len2;j++){var tbl=oi[j],dbrs=[],rs=tbl.dbrs.oi;if(rs){rs=rs.length?rs:[rs];for(var k=0,len3=rs.length;k<len3;k++){var r=_getSelDBrole(mdl,rs[k].did);dbrs.push(r);}}var t={n:tbl.n,did:tbl.did,t:dbrs.length===0?15:30,isNew:false,prid:rid,pdbr:dbr,secdbrs:dbrs,relations:[],items:[],clns:[],FactInfos:{},AttrInfos:{}};items.push(t);mdl.pts[rid][tbl.did]=t;mdl.tbls[tbl.did]=t;}d[i].items=items;}}if(callback&&callback.success){callback.success(d);}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},getAttributesFactsInTable:function getAttributesFactsInTable(tbl,flag,callbacks){var result=[],tid=tbl.did;if(tid){var tbl=this.getTable(tid);if(tbl.isNew||tbl.hasRendered){if(callbacks&&callbacks.success){var attrInfo,attribute,factInfo,fact;if(flag===0){result=tbl.clns;}else{for(var aid in tbl.AttrInfos){attribute=this.getAttribute(aid);result.push({n:attribute.name,did:attribute.id,t:12});}for(var fid in tbl.FactInfos){fact=this.getFact(fid);result.push({n:fact.name,did:fact.id,t:13});}}callbacks.success({items:result});}}else{var mdl=this,tn=tbl.n,cb={success:function(res){var attInfos=tbl.AttrInfos,fctInfos=tbl.FactInfos,cols=tbl.clns,afs=res.oi;tbl.hasRendered=true;var arr=[];for(var i=0,len=afs.length;i<len;i++){var af=afs[i];if(af.tp===12){var frms={};frms[0]={baseFrmID:0,fmcatid:mdl.IDFrmID,n:"ID"};if(!mdl.attrs[af.did]){mdl.attrs[af.did]={id:af.did,name:af.n,tbls:[],Forms:frms};arr.push(af.did+","+12);}else{mdl.attrs[af.did].tbls.push({did:tid,n:tbl.n});}attInfos[af.did]={id:af.did,AttID:af.did,name:af.n,BaseFrms:[0],TblID:tid,Expr:["["+af.n+"]"],Format:"Text"};result.push({n:af.n,did:af.did,t:af.tp});}if(af.tp===13){if(!mdl.fcts[af.did]){mdl.fcts[af.did]={id:af.did,name:af.n,tbls:[],Sum:true,Count:false,Max:false,Min:false,Variance:false,Average:false};}fctInfos[af.did]={id:af.did,FactID:af.did,TblID:tid,name:af.n,Expr:"["+af.n+"]",Format:"Text"};result.push({n:af.n,did:af.did,t:af.tp});}if(af.tp===26){var dt={tp:1};cols.push({cln:af.n,n:af.n+" "+mdl.getColumnDataTypeString(dt),t:26,cmid:af.did,dt:dt});}}if(callbacks&&callbacks.success){if(flag===0){callbacks.success({items:cols});}else{callbacks.success({items:result});}}_hideWaitPage();},failure:function(res){_hideWaitPage(true);if(callbacks&&callbacks.failure){callbacks.failure(res);}}};var params={taskId:"arch.search",schemaid:mdl.SchemaInstanceID,objecttypes:"12,13,26",uses:tid+",15"};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);}}},getObjectInBulk:function(pair,callback){var objs=pair.join(";");var cb={success:function(res){_hideWaitPage();if(callback&&callback.success){callback.success(res);}},failure:function(res){_hideWaitPage(true);if(callback&&callback.failure){callback.failure(res);}}};var params={taskId:"arch.getObjectInBulk",schemaid:this.SchemaInstanceID,objects:objs};if(mstrApp.sessionState!==undefined){params.sessionState=mstrApp.sessionState;}_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);},getAttribute:function getAttribute(id){return this.attrs[id];},getProjectObjects:function(tp,callbacks){var me=this,obj=this.ProjectObjects,INITIAL_COUNT=1000;if(obj){callbacks.success(obj);return ;}else{callbacks.success=mstrmojo.func.composite([callbacks.success,function(res){me.ProjectObjects=res;}]);}var taskParams={taskId:"searchMetadata",blockBegin:1,blockCount:INITIAL_COUNT,searchPattern:"*",rootFolderType:24,objectType:tp,recursive:true,styleName:"MojoFolderStyle",sessionState:mstrApp.sessionState};mstrmojo.xhr.request("POST",mstrConfig.taskURL,callbacks,taskParams);},createProject:function(pname,callback){var createp_params={taskId:"arch.createProject",name:pname};var createpcb={success:function(res){if(callback){callback();_hideWaitPage();}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){createp_params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,createpcb,createp_params);},deleteProject:function(pid,callback){var dbrparams={taskId:"arch.deleteProject",projectid:pid};var dbrcb={success:function(res){_hideWaitPage();if(callback){callback();}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){dbrparams.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,dbrcb,dbrparams);},renameProject:function(pid,oid,callback){var pn=new mstrmojo.Editor({title:"Rename Project",cssText:"width:250px;",children:[{scriptClass:"mstrmojo.Label",cssText:"font-weight:bold; width:100%; padding: 5px;",alias:"nameinfo",text:"New Project Name:"},{scriptClass:"mstrmojo.TextBox",alias:"txtname",cssText:"width:200px;"},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"float:right;",text:mstrmojo.desc(1442,"OK"),onclick:function(evt){var e=this.parent.parent;var ret=true;if(e.onOK){ret=e.onOK();}if(ret){e.close();}var renp_params={taskId:"arch.renameObject",objectid:pid,objecttype:oid,objectname:e.children[1].value};var renpcb={success:function(res){_hideWaitPage();if(callback){callback();}},failure:function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();if(mstrApp.sessionState!==undefined){renp_params.sessionState=mstrApp.sessionState;}mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,renpcb,renp_params);}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}]});pn.open();},validateExpr:function validateExpr(params,callbacks){var me=this;var taskParams={taskId:"arch.Parse",schemaid:this.SchemaInstanceID,exp:params.expr,tbls:params.tid,sessionState:mstrApp.sessionState};if(params.vo==1){taskParams.vo=1;}var cb={success:function(res){_hideWaitPage();if(callbacks&&callbacks.success){callbacks.success(res);}},failure:function(res){_hideWaitPage(true);if(callbacks&&callbacks.failure){callbacks.failure(res);}mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,taskParams);},exprEditor:function(obj){var id="ARExp",fcts=null,openME=function(oi){var ae=mstrmojo.all[id];if(!ae){ae=new mstrmojo.Architect.ExpressionEditor({id:id,oi:oi});}else{ae.set("oi",oi);}_hideWaitPage();ae.open();},failure=function(res){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));},fsuccess=function(res){try{if(obj){if(obj.EXP){var info=obj.Info;obj.tks={tkn:[{isNew:true,v:obj.EXP,oi:{cmid:info.cmid,DT:info.format}}],vs:0,vm:""};}else{obj.n="New "+(obj.tp===12?"Attribute":"Metric")+" Expression";obj.tks={tkn:[],vs:0,vm:""};}openME(obj);}}catch(ex){}};_showWaitPage();this.getFunctions({success:fsuccess,failure:failure});},getFunctions:function getFunctions(callbacks){var me=this,fcts=this.functions||window.sessionStorage&&window.sessionStorage.getItem("functions");if(fcts){fcts=_sortFunctions(eval("("+fcts+")").fncs);callbacks.success(fcts);}else{var cb={failure:callbacks.failure,textResponse:true},taskParams={taskId:"getSystemFunctions",includeFunctionDetails:false,functionFlags:2,sessionState:mstrApp.sessionState};cb.success=function(res){if(window.sessionStorage){window.sessionStorage.setItem("functions",res);}me.functions=res;fcts=_sortFunctions(eval("("+res+")").fncs);callbacks.success(fcts);};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,taskParams);}},getSuggestFunctions:function getSuggestFunctions(callbacks){var me=this,sf=this.suggestedFunctions;if(sf&&sf.length>0){callbacks.success(sf);return ;}else{var cb={success:function(res){var sf=new Array();for(var k=0,len=res.length;k<len;k++){for(var i=0,len2=func_cat.length;i<len2;i++){if(res[k].n.indexOf(func_cat[i])>-1){sf=sf.concat(res[k].fns);break;}}}me.suggestedFunctions=sf;_hideWaitPage();callbacks.success(sf);},failure:function(){_hideWaitPage(true);mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};_showWaitPage();this.getFunctions(cb);}},getFunctionCatList:function getFunctionCatList(){if(this._functionCatList){return this._functionCatList;}var fcts=this.functions||window.sessionStorage&&window.sessionStorage.getItem("functions");if(!fcts){mstrmojo.alert("We shall not reach this point!");}fcts=_sortFunctions(eval("("+fcts+")").fncs);fcts=_H.make(fcts,mstrmojo.Arr);this._functionCatList=fcts;return fcts;},getDataTypeValue:function(dt){switch(dt){case"Text":return 3;break;case"Number":return 2;break;case"Date":return 8;break;case"Time":return 9;break;case"DateTime":return 1;break;case"URL":return 5;break;case"Email":return 6;break;case"HTML Tag":return 7;break;case"Symbol":return 10;break;case"Big Decimal":return 11;break;case"Phone Number":return 12;break;}},postCreate:function(){this.layers[_DEFAULT_LAYER_ID]={};this.layers[_DEFAULT_LAYER_ID].name=_DEFAULT_LAYER_NAME;this.layers[_DEFAULT_LAYER_ID].id=_DEFAULT_LAYER_ID;this.layers[_DEFAULT_LAYER_ID].tables={};this.layers[_DEFAULT_LAYER_ID].relations=[];},init:function init(props){this._super(props);if(!this.features){this.features=new mstrmojo.Model();}this.ondefnChange();},ondefnChange:function ondefnChg(){},DSSObjectType:{DSSObjectTypeFact:13,DSSObjectTypeAttribute:12,DSSObjectTypeTable:15},DSSSchemaUpdateFlag:{Load:1,Unload:2,Reload:3}});})();