(function(){mstrmojo.requiresCls("mstrmojo.HBox","mstrmojo.Box","mstrmojo.Table","mstrmojo.QB.QContextMenu","mstrmojo.Architect.AttributeLabel","mstrmojo.Architect.RelationLinker");var _C=mstrmojo.css,$D=mstrmojo.dom,_ROW_HEIGHT=30,ReltationTables={};var _menuItems=[{did:"Delete",n:mstrmojo.desc(629,"Delete")},{did:-1,n:"-"},{did:"1to1",n:"One to One"},{did:"1tom",n:"One to Many"},{did:"mtom",n:"Many to Many"},{did:-1,n:"-"},{did:"RelTbl",n:"RelationShip Table",fns:[{did:"1",n:"1"}],onContextMenuOpen:function(){var mdl=mstrmojo.all.ArchModel;if(this._subMenu){var sm=this._subMenu,tbl=this.parent.parent.data.tbl;sm.set("items",tbl);}}}];function _addAttr(w,att,i,j,len,mx){var width=mx/len,x=(j+0.5)*width-50+"px",y=30+i*70+"px",al=att.name,aid=att.id,attrLabel=new mstrmojo.Architect.AttributeLabel({did:aid,AL:al,tbls:att.tbls});w.attrs[aid]=att;attrLabel.addRow(att,0,[12],"");w.addChildren([attrLabel]);attrLabel.set("left",x);attrLabel.set("top",y);}function _getTopLevel(level,vtx,count){var cur=[];var isEmpty=true;for(var id in count){isEmpty=false;(count[id]===0)&&cur.push(id);}if(isEmpty){return level;}var child;for(var i=0,len=cur.length;i<len;i++){delete count[cur[i]];child=vtx[cur[i]];if(child){for(var j=0;j<child.length;j++){count[child[j]]--;}}}if(level.max<cur.length){level.max=cur.length;}level.push(cur);_getTopLevel(level,vtx,count);}function _generateLevels(pairs){var pid,cid,vtx={};var count={};for(var i=0,len=pairs.length;i<len;i++){pid=pairs[i].pid;cid=pairs[i].cid;vtx[pid]=vtx[pid]||[];vtx[pid].push(cid);count[pid]=count[pid]||0;count[cid]=(count[cid]||0)+1;}var level=[];level.max=0;_getTopLevel(level,vtx,count);for(var i=1,len=level.length;i<len;i++){var temp=[],prev=level[i-1];for(var j=0,len2=prev.length;j<len2;j++){var arr=vtx[prev[j]];if(arr){for(var k=0,len3=temp.length;k<len3;k++){mstrmojo.array.removeItem(arr,temp[k]);}temp=temp.concat(arr);}}level[i]=temp;}return level;}function _reachable(attrs,id1,id2,tp){if(id1===id2){return true;}var att=attrs[id1];if(tp===1){var cids=att.cids;for(var i=0,len=cids.length;i<len;i++){if(_reachable(attrs,cids[i],id2,tp)){return true;}}}if(tp===2){var pids=att.pids;for(var i=0,len=pids.length;i<len;i++){if(_reachable(attrs,pids[i],id2,tp)){return true;}}}return false;}mstrmojo.Architect.RelationPanel=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.Architect.RelationPanel",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},children:[{scriptClass:"mstrmojo.Table",alias:"subheader",rows:1,cols:2,layout:[{cells:[{cssText:"padding-left: 5px; padding-right: 10px;"},{cssText:"height: 20px;"}]}],cssClass:"mstrmojo-Architect-Panel-header subheader",children:[{scriptClass:"mstrmojo.Label",slot:"0,0",cssClass:"mstrmojo-Architect-Panel-header subheader",text:"Parent-Child Relationship"},{scriptClass:"mstrmojo.Table",slot:"0,1",rows:1,cssText:"float:right;",cols:2,layout:[{cells:[{cssText:"height: 20px; width:20px;"},{cssText:"height: 20px; width:20px;"}]}],children:[{scriptClass:"mstrmojo.Button",slot:"0,0",iconClass:"mstrmojo-ArchitectListIcon addbtn",title:"add"},{scriptClass:"mstrmojo.Button",slot:"0,1",iconClass:"mstrmojo-ArchitectListIcon edtbtn",title:"edit"}]}]},{scriptClass:"mstrmojo.Box",alias:"content",cssText:"position:relative; width: 100%; height:100%;",children:[{scriptClass:"mstrmojo.Architect.RelationLinker",alias:"linker",dropZone:true,allowDrop:function allowDrop(ctxt){return true;},ondrop:function ondrop(c){this.parent.elemBox.ondrop(c);}},{scriptClass:"mstrmojo.Box",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}" mstrAttach:click> </div>',cssText:"position:absolute;left:0px;top:0px;",alias:"elemBox",attrs:{},maxh:0,maxw:0,dropZone:true,allowDrop:function allowDrop(ctxt){return true;},loadAttrs:function(){this.removeChildren();this.attrs={};var mdl=mstrmojo.all.ArchModel,pairs=mdl.layers[mdl.currentlayerID].relations,n=this.domNode,p=this.parent.domNode,pst=p.style,linker=this.parent.linker,lv_atts=_generateLevels(pairs),len=lv_atts.length,mx=lv_atts.max*120,my=75+(len-1)*70,iswidth=mx>p.clientWidth,isheight=my>p.clientHeight;this.maxw=iswidth?mx:p.clientWidth;this.maxh=isheight?my:p.clientHeight;n.style.width=this.maxw+"px";n.style.height=this.maxh+"px";linker.height=this.maxh;linker.width=this.maxw;linker.NeedRender=true;if(iswidth){pst["overflow-x"]="auto";}else{pst["overflow-x"]="hidden";}if(isheight){pst["overflow-y"]="auto";}else{pst["overflow-y"]="hidden";}for(var i=0;i<len;i++){atts=lv_atts[i];for(var j=0,len2=atts.length;j<len2;j++){var att=mdl.getAttribute(atts[j]);att.n=att.name;att.pids=[];att.cids=[];_addAttr(this,att,i,j,len2,mx);}}var as=this.attrs,len=pairs.length;for(var i in as){var att=as[i];att.pids=[];att.cids=[];for(var j=0;j<len;j++){pa=pairs[j];if(pa.pid===i){att.cids.push(pa.cid);}if(pa.cid===i){att.pids.push(pa.pid);}}}},findConflictAttrs:function(d,pids,cids,tp){var attrs=this.attrs,pds=d.pids,cds=d.cids;if(tp!==1){for(var i=0,len=pds.length;i<len;i++){if(_reachable(attrs,pds[i],d.caid,2)){pids.push(pds[i]);}}}if(tp!==2){for(var i=0,len=cds.length;i<len;i++){if(_reachable(attrs,cds[i],d.paid,1)){cids.push(pds[i]);}}}},attrNameChange:function(evt){var c=this.children;if(!c){return ;}var n=evt.value,id=evt.did,len=c.length;for(var i=0;i<len;i++){if(c.did===id){c.children[0].set("text",n);}}},tableChange:function(evt){var me=this,mdl=mstrmojo.all.ArchModel;cb={success:function(res){mdl.addRelations4Layer(mdl.currentlayerID,evt.tbl,res);me.parent.refresh();},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.getRelations4Table(evt.tbl,cb);},onclick:function onclick(c){var mdl=mstrmojo.all.ArchModel,el=document.elementFromPoint(c.e.clientX,c.e.clientY),w=$D.findWidget(el);if(w.alias!=="elemBox"){return ;}var pos=$D.position(this.domNode),x=c.e.clientX-pos.x,y=c.e.clientY-pos.y,lid=mdl.getRelationLink(x,y),p=this.parent,linker=p.linker;if(lid){linker.highLightLink(lid);var st=p.cxtmenu.domNode.style;st.visibility="visible";st.left=x+"px";st.top=y+"px";p.cxtmenu.data=mdl.rlinks[lid];p.cxtmenu.showContextMenu();}else{linker.clearHighLightCanvas();}},ondrop:function ondrop(c){var st=this.parent.linker.tooltip.style,mdl=mstrmojo.all.ArchModel;if(st.display==="block"){st.display="none";}if(c.src&&c.src.data){var d=c.src.data;if(this.attrs[d.did]&&d.DT){mstrmojo.alert("This attribute is already on the panel!!");return ;}if(d.caid&&d.paid){var me=this,aid=d.did;var cb={success:function(res){var cb1={success:function(res){me.parent.refresh();},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.insertRelation(d.paid,d.caid,aid,d.tbl,cb1);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var att=this.attrs[aid];if(!att||!att.pids){cb.success();}else{var pids=[],cids=[];d.pids=att.pids;d.cids=att.cids;this.findConflictAttrs(d,pids,cids,3);if(pids.length===0){cb.success();}else{mdl.removeRelations(aid,pids,cids,cb);}}}else{if(d.Obj){var pos=$D.position(this.domNode),x=c.tgt.e.clientX-pos.x,y=c.tgt.e.clientY-pos.y;attrLabel=new mstrmojo.Architect.AttributeLabel({AL:d.n,did:d.did});attrLabel.addRow(d,0,[12],"");this.addChildren([attrLabel]);attrLabel.set("left",x+"px");attrLabel.set("top",y+"px");this.attrs[d.did]=d;}}}},ondragover:function(c){var mdl=mstrmojo.all.ArchModel,pos=$D.position(this.domNode),x=c.tgt.e.clientX-pos.x,y=c.tgt.e.clientY-pos.y,lid=mdl.getRelationLink(x,y),linker=this.parent.linker,html="";if(!lid){if(linker.hl_link){linker.clearHighLightCanvas();}linker.tooltip.style.display="none";return ;}var lk=mdl.rlinks[lid],d=c.src.data;if(d){d.type=3;if(d.did!==lk.srcw.did&&d.did!==lk.tgtw.did){d.paid=lk.srcw.did;d.caid=lk.tgtw.did;linker.highLightLink(lid);html="<div>parent:"+lk.srcw.AL+"</div><div>child:"+lk.tgtw.AL+"</div>";linker.renderTooltip(html,x,y);}}}},{scriptClass:"mstrmojo.QB.QContextMenu",cssText:"visibility:hidden; border:0px solid; background-color:transparent;",alias:"cxtmenu",itemChildrenField:"fns",itemIdField:"did",itemField:"n",text:"",searchItemAdded:true,dynamicUpdate:true,queryChecked:function queryChecked(item){return item.did==="tbls";},queryEnabled:function(item){var mdl=mstrmojo.all.ArchModel,linker=this.parent.linker,lk=mdl.rlinks[linker.hl_link];switch(item.did){case"1to1":return lk.tp!==0;case"1tom":return lk.tp!==1;case"mtom":return lk.tp!==2;default:return true;}},executeCommand:function(item){var p=this.parent,linker=p.linker,idx=linker.hl_link,mdl=mstrmojo.all.ArchModel,lk=mdl.rlinks[idx],rel=mdl.relations[idx],did=item.did;switch(did){case"Delete":var cb={success:function(){linker.hl_link=null;p.refresh();},failure:function(){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.addrmvRelation(lk.srcw.did,lk.tgtw.did,22,lk.tbl,cb);break;case"1to1":lk.tp=0;rel.tp=0;linker.clearHighLightCanvas();break;case"1tom":lk.tp=1;rel.tp=1;linker.clearHighLightCanvas();break;case"mtom":lk.tp=2;rel.tp=2;linker.clearHighLightCanvas();break;default:break;}},postCreate:function(){this.cm=_menuItems;}}],refresh:function(){this.elemBox.loadAttrs();this.linker.drawLinks();}}],onwidthChange:function hchange(){var w=parseInt(this.width,10)-5;if(this.domNode){var c=this.content,b=c.elemBox,l=c.linker;this.domNode.style.width=w+"px";c.domNode.style.width=w+"px";if(w>b.maxw){b.maxw=w;b.domNode.style.width=w+"px";l.set("width",w);}}else{this.content.linker.width=w;}},onheightChange:function hchange(){var h=parseInt(this.height,10);if(this.domNode){var c=this.content,b=c.elemBox,l=c.linker;this.domNode.style.height=h-10+"px";c.domNode.style.height=h-30+"px";if(h-30>b.maxh){b.maxh=h-45;b.domNode.style.height=h-30+"px";l.set("height",h-30);}}else{this.content.linker.height=h-60;}},postBuildRendering:function(){if(this._super){this._super();}var h=parseInt(this.height,10),w=parseInt(this.width,10)-5,c=this.content,b=c.elemBox;this.domNode.style.height=h-10+"px";c.domNode.style.height=h-30+"px";b.domNode.style.height=h-30+"px";b.domNode.style.width=w+"px";var mdl=mstrmojo.all.ArchModel,id=b.id;mdl.attachEventListener("SelTableIDChange",id,"tableChange");mdl.attachEventListener("layerChange",this.content.id,"refresh");mdl.attachEventListener("AttrFctNameChange",id,"attrNameChange");}});})();