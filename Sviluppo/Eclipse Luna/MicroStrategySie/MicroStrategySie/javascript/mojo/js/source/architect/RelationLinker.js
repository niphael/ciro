(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.color");var _C=mstrmojo.css;var $D=mstrmojo.dom;function _getWidget(me,id){var ch=me.parent.elemBox.children,len=ch.length;for(var i=0;i<len;i++){if(ch[i].did===id){return ch[i];}}}mstrmojo.Architect.RelationLinker=mstrmojo.declare(mstrmojo.Vis,null,{scriptClass:"mstrmojo.Architect.RelationLinker",width:0,height:0,context:0,browserSupportsHtml5:true,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="position:absolute;left:0px;top:0px;width:{@width}px;height:{@height}px;overflow:hidden;"  mstrAttach:click ><canvas width="{@width}px" height="{@height}px"></canvas><canvas style="position:absolute;left:0;top:0" width="{@width}px" height="{@height}px"></canvas><div id="{@id}-tooltip" class="mstrmojo-Architect-tooltip"></div></div>',markupSlots:{canvas:function(){return this.domNode.firstChild;},highlightCanvas:function(){return this.domNode.childNodes[1];},tooltip:function(){return this.domNode.childNodes[2];}},postBuildRendering:function postBR(){if(this._super){this._super();}browserSupportsHtml5=this.canvas.getContext("2d");if(!browserSupportsHtml5){this.renderErrorMessage(mstrmojo.desc(8126));return ;}if(browserSupportsHtml5){this.context=this.canvas.getContext("2d");this.highlight=this.highlightCanvas.getContext("2d");}else{this.createVMLCanvas();}this.model=mstrmojo.all.ArchModel;},drawLinks:function drawLinks(){this.clearCanvas();this.clearHighLightCanvas();if(this.NeedRender){this.render();this.NeedRender=false;}var mdl=this.model,rls=mdl.layers[mdl.currentlayerID].relations,lks=mdl.rlinks;for(var i=0,len=rls.length;i<len;i++){var srcw=_getWidget(this,rls[i].pid),tgtw=_getWidget(this,rls[i].cid),sln=srcw.editorNode,tln=tgtw.editorNode,spos=$D.position(sln),tpos=$D.position(tln),canvas_pos=$D.position(this.domNode),srcwx=spos.x+0.5*sln.clientWidth-canvas_pos.x,srcwy=spos.y+sln.clientHeight-canvas_pos.y,tgtwx=tpos.x+0.5*tln.clientWidth-canvas_pos.x,tgtwy=tpos.y-canvas_pos.y,srcwy1=srcwy+5,tgtwy1=tgtwy-5;lks[i]={};lks[i].tp=rls[i].tp;lks[i].tbl=rls[i].tbl;lks[i].srcw=srcw;lks[i].tgtw=tgtw;lks[i].coords=[srcwx-5,srcwy1,srcwx+5,srcwy1,tgtwx+5,tgtwy1,tgtwx-5,tgtwy1];lks[i].marker=[{x:srcwx,y:srcwy},{x:srcwx,y:srcwy1},{x:tgtwx,y:tgtwy},{x:tgtwx,y:tgtwy1}];this.drawLine(srcwx,srcwy,srcwx,srcwy1);this.drawLine(srcwx,srcwy1,tgtwx,tgtwy1);this.drawLine(tgtwx,tgtwy1,tgtwx,tgtwy);this.drawLine(tgtwx,tgtwy,tgtwx-5,tgtwy-2.5);this.drawLine(tgtwx,tgtwy,tgtwx+5,tgtwy-2.5);}if(this.browserSupportsHtml5){this.context.stroke();}},clearCanvas:function clearCanvas(){if(this.browserSupportsHtml5){this.context.clearRect(0,0,this.width,this.height);this.context.beginPath();}else{var canvas=document.getElementById("vmlCanvas");if(canvas.hasChildNodes()){while(canvas.childNodes.length>=1){canvas.removeChild(canvas.firstChild);}this.createVMLCanvasFrame();}}},clearHighLightCanvas:function(){this.highlight.clearRect(0,0,this.width,this.height);this.hl_link=null;this.highlight.beginPath();},highLightLink:function(lid){if(this.browserSupportsHtml5){if(this.hl_link&&this.hl_link!==lid){this.clearHighLightCanvas();}var mdl=this.model,ele=mdl.rlinks[lid].marker,ctx=this.highlight;this.hl_link=lid;for(var i=0,len=ele.length;i<len;i++){ctx.strokeStyle="blue";ctx.beginPath();ctx.arc(ele[i].x,ele[i].y,3,0,Math.PI*2,true);ctx.closePath();ctx.stroke();}}},drawLine:function drwLine(x1,y1,x2,y2){if(this.browserSupportsHtml5){this.context=this.canvas.getContext("2d");this.context.moveTo(x1,y1);this.context.lineTo(x2,y2);}else{var line=document.createElement("v:line");line.setAttribute("from",x1+" "+y1);line.setAttribute("to",x2+" "+y2);document.getElementById("vmlCanvas").appendChild(line);}},createVMLCanvasFrame:function cVMLCF(){var rect=document.createElement("v:rect");rect.setAttribute("id","vmlFrame");rect.setAttribute("stroke","true");rect.setAttribute("strokecolor","red");rect.style.width=this.width;rect.style.height=this.height;rect.style.zindex="-1";document.getElementById("vmlCanvas").appendChild(rect);},createVMLCanvas:function cVMLC(){var pixelWidth=parseInt(this.width);var pixelHeight=parseInt(this.height);var vml=document.createElement("v:group");vml.setAttribute("id","vmlCanvas");vml.style.width=this.width;vml.style.height=this.height;vml.setAttribute("coordorigin","0, 0");vml.setAttribute("coordsize",pixelWidth+", "+pixelHeight);this.domNode.appendChild(vml);this.createVMLCanvasFrame();return ;},onwidthChange:function(){this.render();this.drawLinks();},onheightChange:function(){this.render();this.drawLinks();},renderTooltip:function rndrttp(html,touchX,touchY){var tp=this.tooltip,st=tp.style;if(st.display==="none"){st.display="block";}tp.innerHTML=html;if(touchX+this.tooltip.offsetWidth>this.width){touchX=touchX-tp.offsetWidth;}st.left=touchX+"px";st.top=touchY+"px";}});})();