(function(){var SAME_PROMPT=1;var DO_NOT_ANSWER=2;var CLOSE=3;var DYNAMIC=4;var STATIC=5;var CURRENT_UNIT=6;var ALL_VALID_UNITS=7;var USE_DEFAULT_ANSWER=8;var DRILLING_ACTION=1;var SELECTOR_ACTION=2;var HYPERLINK_ACTION=4;var SORT_ACTION=8;var PRIMARY_DATA_PROVIDER=0;var SECONDARY_DATA_PROVIDER=1;var DEFAULT_BUBBLE_SIZE=10;var EnumMarkerType={MARKER:"1",BUBBLE:"2",POLYGON:"3",DENSITY:"4",PATH:"5"};var EnumAreaSelectionType={RECTANGLE:1,CIRCLE:2,POLYGON:3};mstrmojo.requiresCls("mstrmojo.gmaps.MapDataViewer","mstrmojo.color","mstrmojo.array","mstrmojo.dom");var $D=mstrmojo.dom;mstrmojo.gmaps.GoogleMapViewer=mstrmojo.declare(mstrmojo.gmaps.MapDataViewer,null,{scriptClass:"mstrmojo.gmaps.GoogleMapViewer",_affinityAnimationFinished:false,_affinityLines:null,AFFINITY_LINE_DEFAULT_COLOR:null,_animationMarkers:null,_animationSourceMarkerLines:null,previousState:null,savedSliceInfo:null,areaInfoWindow:null,_applyThreshold:false,bounds:null,bubbleMode:false,cluster:[],clusterIndex:0,columnIndices:{state:-1,zip:-1},createMode:true,_currentAffinityInterval:0,DEFAULT_LINE_COLOR:16711680,defaultThresholdColor:"#FE766A",_defaultView:null,densityLayer:null,densityLocations:null,_displayTitleIndex:-1,enableBubble:false,enableLatLng:false,enablePoint:false,enableShape:false,enumNumber:2,enumText:3,enumImage:4,enumUrl:5,enumQuickSymbol:10,geoElements:{},geoLists:null,grids:null,gridParams:null,highlightStroke:"#000000",imageMap:{},infoAnchor:null,infoWindow:null,infoWindowUseGrid:true,infoWindowRenderedSub:null,latColumnIndex:-1,longColumnIndex:-1,lookupColumnIndex:-1,map:null,mapLayers:[],MAX_PATH_BUBBLE_RADIUS:2,_markerElementIDs:null,_markerImage:null,_hiliImage:null,mstrInfo:null,numAttributes:-1,panelStackInfoPos:null,pathObject:null,pointColumnIndex:-1,previousShownBubble:null,primaryModel:null,regularStroke:"#FFFFFF",renderCompleteCallbackFunc:null,secondaryDPFirstAttrColIndex:-1,secondaryDPMetricMaxVal:null,secondaryDPSecondAttrColIndex:-1,secondaryModel:null,_selectedAffinityMarkers:null,selectedStroke:"#0000ff",_useAttribute:false,_useLatlng:true,validBubble:false,wpAggregateAttributeForm:true,wpAttribute:null,wpDensityTheme:null,wpDrawArcsLines:"Arcs",wpDisPlayAffinityLines:0,wpLat:null,wpLng:null,wpLookupAttId:null,wpMarkerType:"1",wpMarkerStyle:"images/balloonpp.png",wpMapSizingStyle:null,wpMaxLineThickness:5,wpPoint:null,wpSecondaryDPKey:null,loadByGridChange:false,mouseX:0,mouseY:0,init:function init(props){this._super(props);this.setMapModel(this.grids);this.initPathVariables();this.loadWidgetProps();this.initMapProperty();this._markerImage=new google.maps.MarkerImage(this.wpMarkerStyle,null,null,null,new google.maps.Size(23,28));this._hiliImage=new google.maps.MarkerImage(this.wpMarkerStyle,null,null,null,new google.maps.Size(46,56));},initPathVariables:function initPathVariables(){this.pathObject={};this.pathObject.minPathBubbleRadius=1;this.pathObject.pathCurrentPolygonIndex=-1;this.pathObject.animatePathBubbleIndex=-1;},addDensity:function addDensity(markerList,latLng,attributes,simpleHTML,geoPosition,cell,idkey,oldMarker){if(this.densityLocations===null){this.densityLocations=[];}this.densityLocations.push({position:latLng,attributes:attributes,geoPosition:geoPosition,simpleHTML:simpleHTML});this.bounds.extend(latLng);},animatePathBubbles:function animatePathBubbles(){var that=this;this.pathObject.pathBubbles[this.pathObject.animatePathBubbleIndex].setMap(this.map);this.pathObject.animatePathBubbleIndex++;if(this.pathObject.animatePathBubbleIndex==this.pathObject.pathBubbles.length){clearTimeout(this.pathObject.pathLabelTimer);}else{this.pathObject.pathLabelTimer=setTimeout(function(){that.animatePathBubbles();},50);}},animatePath:function animatePath(){var that=this;this.pathObject.pathLines[this.pathObject.pathCurrentPolygonIndex].setMap(this.map);this.pathObject.pathCurrentPolygonIndex++;if(this.pathObject.pathCurrentPolygonIndex==this.pathObject.pathLines.length){clearTimeout(this.pathObject.pathTimer);}else{this.pathObject.pathTimer=setTimeout(function(){that.animatePath();},75);}},handleMetricSelectionChange:function handleMetricSelectionChange(){if(this.enableLatLng||this.enablePoint){this.adjustMarker();}},adjustMarker:function adjustMarker(){if(this.wpMarkerType===EnumMarkerType.MARKER&&!this._applyThreshold){return ;}this.populateMinMax(this.selectedMetricIndex);this.populateBubbleVariables();var gradientFill={type:"radial",cx:0,cy:0},markerList=[],g,colorString,numMarker,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER);if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}numMarker=markerList.length;var highlightedGraphics=this.getHighlightedGraphics(this.latColumnIndex);highlightedGraphics.length=0;for(g=0;g<numMarker;g++){var marker=markerList[g],rowIndex=marker.attributes.rowIndex,rowCell,markerSelected=false,type=this.enumNumber;rowCell=priModel.getMetricValue(rowIndex,this.selectedMetricIndex);type=rowCell.getThresholdType();for(var i in this.selectedRowIndices){if(mstrmojo.array.indexOf(this.selectedRowIndices[i],rowIndex)>-1){markerSelected=true;break;}}if(this.wpMarkerType===EnumMarkerType.MARKER){var fill=null,imageMarker;if((type===this.enumImage)||(type===this.enumUrl)){var imageString=priModel.getMetricValue(rowIndex,this.selectedMetricIndex).getThresholdValue("no");if(imageString!="no"){var markerImage;if(this.imageMap.hasOwnProperty(imageString)){markerImage=this.imageMap[imageString];}else{var markerImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(23,28));this.imageMap[imageString]=markerImage;}if(marker instanceof google.maps.MarkerImage){marker.setIcon(markerImage);}else{imageMarker=new google.maps.Marker({position:marker.getPosition(),icon:markerImage,attributes:marker.attributes,simpleHTML:marker.simpleHTML,mapWidget:this,geoPosition:[this.latColumnIndex,this.longColumnIndex],map:this.map,isSelected:markerSelected});}}}else{var markerImage=new google.maps.MarkerImage(this.wpMarkerStyle,null,null,null,new google.maps.Size(23,28));var hiliImage=new google.maps.MarkerImage(this.wpMarkerStyle,null,null,null,new google.maps.Size(46,56));imageMarker=new google.maps.Marker({position:marker.getPosition(),icon:markerSelected?hiliImage:markerImage,attributes:marker.attributes,mapWidget:this,geoPosition:[this.latColumnIndex,this.longColumnIndex],simpleHTML:marker.simpleHTML,image:markerImage,hili:hiliImage,map:this.map,isSelected:markerSelected});}if(markerSelected){highlightedGraphics.push(imageMarker);}google.maps.event.addListener(imageMarker,"mouseover",function(){if(this.hili){this.setIcon(this.hili);}});google.maps.event.addListener(imageMarker,"mouseout",function(){if(!this.isSelected&&this.image){this.setIcon(this.image);}this._mousedown=false;});var that=this;google.maps.event.addListener(imageMarker,"mousedown",function(){if(that.parent.buttonsBox.state==0){this._mousedown=true;}});google.maps.event.addListener(imageMarker,"click",function(event){var mapWidget=this.mapWidget;if(mapWidget.parent._affinityGlow){mapWidget.handleAffinityAnimationMouseClick(this,event);}else{if(mapWidget.parent.enableClickSelect){mapWidget.handleSelection(this,event);}else{if(this._mousedown===true){mapWidget.showInfoWindow(this);}}}this._mousedown=false;});markerList[g]=imageMarker;marker.setMap(null);}else{if(this._applyThreshold){colorString=priModel.getMetricValue(rowIndex,this.selectedMetricIndex).getFillColor(this.defaultThresholdColor);}else{colorString=this.defaultThresholdColor;}var radius=DEFAULT_BUBBLE_SIZE;var cellNumber=parseFloat(!rowCell.getRawValue()?this.stripNumberFormat(rowCell.getValue()):rowCell.getRawValue());if(this.validBubble){radius=this.calculateBubbleRadius(cellNumber);}if(marker instanceof mstrmojo.gmaps.CircleMarker){if(colorString==="transparent"){marker.set("fillOpacity",0);marker.set("strokeColor",this.defaultThresholdColor);}else{marker.set("fillColor",colorString);marker.set("strokeColor",this.regularStroke);}marker.set("radius",radius);}}}},addMarker:function addMarker(markerList,latLng,attributes,simpleHTML,geoPosition,cell,idkey,oldMarker){var marker,colorString;if(this.wpMarkerType===EnumMarkerType.MARKER){if(this._applyThreshold&&((cell.getThresholdType()===this.enumImage)||(cell.getThresholdType()===this.enumUrl))){var imageString=this.getMapModel(PRIMARY_DATA_PROVIDER).getMetricValue(rowIndex,this.selectedMetricIndex).getThresholdValue("no");var markerImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(23,28));var hiliImage=new google.maps.MarkerImage(imageString,null,null,null,new google.maps.Size(29,36));marker=new google.maps.Marker({position:latLng,icon:markerImage,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,image:markerImage,hili:hiliImage,map:this.map});}else{marker=new google.maps.Marker({position:latLng,icon:this._markerImage,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,image:this._markerImage,hili:this._hiliImage,map:this.map});}}else{if(this.wpMarkerType===EnumMarkerType.BUBBLE||this.wpMarkerType===EnumMarkerType.PATH){if(this._applyThreshold){colorString=this.getMapModel(PRIMARY_DATA_PROVIDER).getMetricValue(rowIndex,this.selectedMetricIndex).getFillColor(this.defaultThresholdColor);}else{colorString=this.defaultThresholdColor;}var radius=DEFAULT_BUBBLE_SIZE;var type=cell.getThresholdType();var cellNumber;if(!type||type===this.enumNumber){cellNumber=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());}else{cellNumber=cell.getRawValue();}if(this.validBubble){radius=this.calculateBubbleRadius(cellNumber);}if(oldMarker){if(oldMarker instanceof mstrmojo.gmaps.CircleMarker){if(colorString==="transparent"){oldMarker.set("fillOpacity",0);}else{oldMarker.set("fillColor",colorString);}oldMarker.set("radius",radius);}marker=oldMarker;}else{marker=new mstrmojo.gmaps.CircleMarker({position:latLng,fillOpacity:colorString==="transparent"?0:0.75,fillColor:colorString,strokeColor:colorString==="transparent"?this.defaultThresholdColor:this.regularStroke,selectedColor:this.selectedStroke,radius:radius,attributes:attributes,mapWidget:this,geoPosition:geoPosition,simpleHTML:simpleHTML,map:this.map,originalzIndex:this.layerIndex+Math.round(this.parent.maxBubbleRadius-radius)});}}else{if(this.isDensityMap()){this.addDensity(markerList,latLng,attributes,simpleHTML,geoPosition,cell,idkey,oldMarker);return ;}}}marker.attributes=attributes;var registeredMarker=marker;if(registeredMarker instanceof mstrmojo.gmaps.CircleMarker){registeredMarker=marker.circle;}var that=this;google.maps.event.addListener(registeredMarker,"mouseover",function(event){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){that.mouseX=rawMouseEvent.clientX;that.mouseY=rawMouseEvent.clientY;}}if(this.hili){this.setIcon(this.hili);}});google.maps.event.addListener(registeredMarker,"mouseout",function(event){if($D.isIE9||$D.isIE10||$D.isIEW3C){var rawMouseEvent=marker.getMouseEventFromGoogleEvent&&marker.getMouseEventFromGoogleEvent(event);if(!!rawMouseEvent){if(rawMouseEvent.clientX==-1&&rawMouseEvent.clientY==-1||rawMouseEvent.clientX==that.mouseX&&rawMouseEvent.clientY==that.mouseY){return ;}}}if(!this.isSelected&&this.image){this.setIcon(this.image);}if(marker instanceof mstrmojo.gmaps.CircleMarker){marker.setBubbleZIndex(marker.getOriginalBubbleZIndex());if(that.previousShownBubble){that.previousShownBubble.set("highlight",true);}}this._mousedown=false;});google.maps.event.addListener(registeredMarker,"mouseup",function(event){that.parent.onMouseUp(event);});google.maps.event.addListener(registeredMarker,"mousemove",function(event){that.parent.onMouseMove(event);});google.maps.event.addListener(registeredMarker,"mousedown",function(){if(that.parent.buttonsBox.state==0){this._mousedown=true;}});google.maps.event.addListener(registeredMarker,"click",function(event){var mapWidget=that;if(mapWidget.parent._affinityGlow){mapWidget.handleAffinityAnimationMouseClick(this,event);}else{if(mapWidget.parent.enableClickSelect){mapWidget.handleSelection(marker,event);}else{if(this._mousedown===true){mapWidget.showInfoWindow(marker);}}}this._mousedown=false;});markerList.push(marker);this.bounds.extend(latLng);this.idMarkerMap[idkey]=marker;return marker;},calculateBubbleRadius:function calculateBubbleSize(value){if(value<0){if(this.wpMapSizingStyle==="1"){return this.minRadius;}else{value=Math.abs(value);}}if(this.wpMarkerType===EnumMarkerType.PATH){return Math.max(this.maxRadius*(value/this.maxValue),this.pathObject.minPathBubbleRadius);}else{return Math.max(this.maxRadius*Math.sqrt(value/this.maxValue),this.minRadius);}},checkLookUpAttributeInSecondaryDP:function checkLookUpAttributeInSecondaryDP(){var rowAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size();for(i=0;i<numTemplateUnits;i++){if(rowAttributes.getTitle(i).getUnitId()===this.wpLookupAttId){return true;}}return false;},cleanDensityMap:function cleanDensityMap(){if(this.densityLayer){this.densityLayer.setMap(null);this.dnesityLayer=null;}},clearAffinityAnimationObjects:function clearAffinityAnimationObjects(){if(this._animationMarkers){var len=this._animationMarkers.length;for(i=0;i<len;i++){this._animationMarkers[i].setMap(null);}for(i=len;i>0;i--){this._animationMarkers.pop();}}this._selectedAffinityMarkers=null;this._affinityAnimationFinished=false;},clearAffinityLines:function clearAffinityLines(){if(!this._affinityLines){return ;}for(id in this._affinityLines){var polyline=this._affinityLines[id];polyline.setMap(null);}},clearAllHighlight:function clearAllHighlight(){var i,j;for(i in this.highlightedGraphics){if(this.highlightedGraphics[i] instanceof Array){var highlightedGraphics=this.highlightedGraphics[i];var hilightCount=highlightedGraphics.length;for(j=0;j<hilightCount;j++){var g=highlightedGraphics[j];if(typeof (g.onisSelectedChange)!="undefined"){g.set("isSelected",false);}else{g.isSelected=false;if(g.image){g.setIcon(g.image);}else{if(g.setOptions){g.setOptions({strokeColor:(g.highlight?this.highlightedStroke:this.regularStroke)});}}}}}}},clearPath:function clearPath(){if(!this.pathObject.pathLines){return ;}for(line in this.pathObject.pathLines){this.pathObject.pathLines[line].setMap(null);}this.pathObject.pathLabel.setMap(null);},computeSecondaryDPMetricMax:function computeSecondaryDPMetricMax(metricColumnIndex){if(!this.secondaryDPMetricMaxVal){this.secondaryDPMetricMaxVal={};}if(this.secondaryDPMetricMaxVal.hasOwnProperty(metricColumnIndex)){return ;}var rowIndex=0,maxValue=-Infinity,secModel=this.getMapModel(SECONDARY_DATA_PROVIDER),rowCount=secModel.getTotalRows(),cell;for(rowIndex=0;rowIndex<rowCount;rowIndex++){cell=secModel.getMetricValue(rowIndex,metricColumnIndex);if(cell.getValue()){var cellNumber=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());maxValue=(cellNumber>maxValue)?cellNumber:maxValue;}}this.secondaryDPMetricMaxVal[metricColumnIndex]={max:maxValue};},createAffinityAnimationMarker:function createAffinityAnimationMarker(latLng){var markerImage=new google.maps.MarkerImage("images/glow_marker.png",null,null,null,new google.maps.Size(10,8)),marker=new google.maps.Marker({position:latLng,icon:markerImage,map:this.map});return marker;},createDensityMap:function createDensityMap(){this.cleanDensityMap();this.densityLayer=new mstrmojo.gmaps.DensityOverlay({width:this.parent.width,height:this.parent.height,map:this.map,mapViewer:this,themeId:this.wpDensityTheme,bounds:this.bounds,locations:this.densityLocations,originalzIndex:this.layerIndex});},createGridInfoWindow:function createGridInfoWindow(dataRows,table){var isIE=(navigator.appVersion.indexOf("MSIE")!=-1)?true:false;var table=this.parent.infoTabDiv.childNodes[0],css="gridInfoWindowTable",cell,header,tui,idx,td,titleSpan,i,j,k,tr,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),numRowAttributes=priModel.getRowHeaders(0).size(),numColAttributes=priModel.getTotalCols(),titles=priModel.getRowTitles(),colHeaders=priModel.getColHeaders(0),numRows=dataRows.length,rowIndex,rowHeaders,numMetrics=priModel.getColumnHeaderCount(),numAttributes=priModel.getRowHeaders(0).size();while(table.rows.length>0){table.deleteRow(table.rows.length-1);}table.className=css;if(table.tHead){var thead=table.tHead;while(thead.rows.length>0){thead.deleteRow(thead.rows.length-1);}tr=thead.insertRow(thead.rows.length);for(i=0;i<numRowAttributes;i++){if(this.isIndexGeoPosition(i)){continue;}td=tr.insertCell(tr.cells.length);header=titles.getTitle(i);css=titles.getCSS(i);td.className=css;titleSpan=document.createElement("span");titleSpan.innerHTML=header.getName();td.appendChild(titleSpan);}for(i=0;i<numColAttributes;i++){td=tr.insertCell(tr.cells.length);header=colHeaders.getHeader(i);css=colHeaders.getCSS(i);td.className=css;titleSpan=document.createElement("span");titleSpan.innerHTML=header.getName();td.appendChild(titleSpan);}}var tbody=table.tBodies[0];for(i=0;i<numRows;i++){rowIndex=dataRows[i];tr=tbody.insertRow(tbody.rows.length);rowHeaders=priModel.getRowHeaders(rowIndex);for(j=0;j<numAttributes;j++){if(this.isIndexGeoPosition(j)){continue;}cell=rowHeaders.getHeader(j);var attributeName="";if(!!cell){idx=cell.getElementIndex();css=rowHeaders.getCSS(j);attributeName=cell.getName();}td=tr.insertCell(tr.cells.length);td.className=css;td.innerHTML="    "+attributeName+"    ";}for(k=0;k<numMetrics;k++){var metricValues=priModel.getMetricValue(rowIndex,k),metricValue=metricValues.getValue(),thresholdType=metricValues.getThresholdType();css=metricValues.getCSS();td=tr.insertCell(tr.cells.length);td.className=css;if(!thresholdType||thresholdType===this.enumNumber){td.innerHTML="    "+metricValue+"    ";}else{td.innerHTML="    "+metricValues.getRawValue()+"    ";}}}return table;},createInfoWindow:function createInfoWindow(title,content){var s;s='<div id="infoWindow" class="mstrMapButton" style="max-width:640px;font-size:8pt;">';s+=this.getInfoWindowNavigationHTML(title);if(title){s+='<div id="title" style="line-height:16px;white-space:nowrap"><b>'+title+"</b></div>";}if(title||this.cluster.length>1){s+='<div id="bodyContent" style="border-top: 2px solid lightblue; padding: 3px;padding-top:5px;">';}else{s+='<div id="bodyContent" >';}s+=content+"</div>";s+="</div>";return s;},createLatLngMarker:function createLatLngMarker(){if(!this.map){return ;}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate();if(this.infoWindowHTML===""){this.infoWindowHTML=this.defaultInfoWindowHTML;}var markerList=this.getGeoList(this.latColumnIndex);markerList.length=0;var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),colCount=priModel.getTotalCols(),colHeaderRowCount=priModel.getTotalColHeaderRows(),rowHeaderElements,rowCount=priModel.getTotalRows(),strippedElementID,attrId,nextElementIndex=Math.max(this.latColumnIndex,this.longColumnIndex)+1,marker,latitudeTitleIndex,latitude,latitudeId,latitudeElement,longitudeTitleIndex,longitude,longitudeId,longitudeElement,errTitle,err,idkey,s="",markersCounter=0;this._markerElementIDs=new Object();this.populateBubbleVariables();for(rowIndex=0;rowIndex<rowCount;rowIndex++){rowHeaderElements=priModel.getRowHeaders(rowIndex);latitudeElement=rowHeaderElements.getHeader(this.latColumnIndex);if(!latitudeElement||latitudeElement.getElementIndex()<0){continue;}latitudeTitleIndex=this.latColumnIndex;latitude=this.stripNumberFormat(latitudeElement.getName());latitudeId=latitudeElement.getElementId();if(latitudeId.indexOf("DB:")===0){continue;}longitudeElement=rowHeaderElements.getHeader(this.longColumnIndex);if(!longitudeElement||longitudeElement.getElementIndex()<0){continue;}longitudeTitleIndex=this.longColumnIndex;longitude=this.stripNumberFormat(longitudeElement.getName());longitudeId=longitudeElement.getElementId();if(longitudeId.indexOf("DB:")===0){continue;}if(isNaN(latitude)){continue;}if(isNaN(longitude)){continue;}if(this._useAttribute){if(!this.isAggregate){idkey=rowIndex;}else{idkey=latitudeId+"|"+longitudeId;}}else{if(!this.wpAggregateAttributeForm){idkey=rowIndex;}else{idkey=latitudeId;}}marker=null;if(this.idMarkerMap[idkey]){if((this.wpMarkerType===EnumMarkerType.BUBBLE||this.wpMarkerType===EnumMarkerType.PATH)&&this.isTotal(nextElementIndex,rowIndex)){marker=this.idMarkerMap[idkey];}else{continue;}}attrId=latitudeElement.getElementId();if(this._useAttribute&&this.lookupColumnIndex>=0){strippedElementID=this.getElementIdWithoutAttributeID(rowHeaderElements.getHeader(this.lookupColumnIndex).getElementId());}else{strippedElementID=this.getElementIdWithoutAttributeID(attrId);}var attributes={},i,titleIndex,elementValue;for(i=0;i<rowHeaderElements.size();i++){titleIndex=i;elementValue=rowHeaderElements.getHeader(titleIndex).getName();attributes[this.replaceSpace(rowAttributes.getTitle(titleIndex).getName())]=elementValue;if(titleIndex===this._displayTitleIndex){attributes.NAME=elementValue;}}var columnHeaderName,columnHeaderColumnIndex,columnHeaderRowIndex;for(columnHeaderColumnIndex=0;columnHeaderColumnIndex<colCount;columnHeaderColumnIndex++){columnHeaderName=null;for(columnHeaderRowIndex=0;columnHeaderRowIndex<colHeaderRowCount;columnHeaderRowIndex++){var cellElement=priModel.getColHeaders(columnHeaderRowIndex).getHeader(columnHeaderColumnIndex),cellName=cellElement.getName();if(!columnHeaderName){columnHeaderName=cellName;}else{columnHeaderName+=" "+cellName;}}var values=priModel.getMetricValue(rowIndex,columnHeaderColumnIndex),thresholdType=values.getThresholdType();if(!thresholdType||thresholdType===this.enumNumber){attributes[this.replaceSpace(columnHeaderName)]=values.getValue();}else{attributes[this.replaceSpace(columnHeaderName)]=values.getRawValue();}if(rowIndex===0){s+="<b>"+columnHeaderName+"</b> :${"+this.replaceSpace(columnHeaderName)+"}<br />";}}attributes.rowIndex=rowIndex;attributes.geoIndex=latitudeElement.getElementIndex();attributes.id=attrId;var cell=priModel.getMetricValue(rowIndex,this.selectedMetricIndex);var latLng=new google.maps.LatLng(latitude,longitude);this.parent.updateMinMaxLatLng(latLng);attributes.latLng=latLng;this._markerElementIDs[strippedElementID]=latLng;s=this.createSimpleInfoHTML(rowIndex,attributes);this.addMarker(markerList,latLng,attributes,s,[this.latColumnIndex,this.longColumnIndex],cell,idkey,marker);markersCounter++;}if(markersCounter==0){this.parent.map.setZoom(1);this.parent.map.setCenter(new google.maps.LatLng(31,-10));}else{if(this.createMode==true){this.parent.updateMapExtent(this.loadByGridChange);}}if(this.isDensityMap()){this.createDensityMap();}else{this.doPostViewerRenderComplete();}this.doPostMapRendering();},createPointMarker:function createPointMarker(){if(!this.map){return ;}this.defaultInfoWindowHTML=this.getDefaultInfoWindowTemplate();this.infoWindowHTML=this.defaultInfoWindowHTML;var markerList=this.getGeoList(this.pointColumnIndex);markerList.length=0;var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),rowCount=priModel.getTotalRows(),colCount=priModel.getTotalCols(),colHeaderRowCount=priModel.getTotalColHeaderRows(),s="",marker,leftParenIndex,rightParenIndex,coreString,strippedElementID,attrId,rowHeaderElements,pointElement,pointTitleIndex,point,pointId,leftParenIndex,rightParenIndex,elems,errTitle,err,longitude,latitude,columnHeaderName,columnHeaderColumnIndex,columnHeaderRowIndex,markersCounter=0;this.populateBubbleVariables();this._markerElementIDs=new Object();for(rowIndex=0;rowIndex<rowCount;rowIndex++){rowHeaderElements=priModel.getRowHeaders(rowIndex);pointElement=rowHeaderElements.getHeader(this.pointColumnIndex);if(!pointElement||pointElement.getElementIndex()<0){continue;}pointTitleIndex=this.pointColumnIndex;point=pointElement.getName();pointId=pointElement.getElementId();marker=null;if((this._useAttribute&&this.isAggregate)||(!this._useAttribute&&this.wpAggregateAttributeForm)){if(this.idMarkerMap[pointId]){if((this.wpMarkerType===EnumMarkerType.BUBBLE||this.wpMarkerType===EnumMarkerType.PATH)&&this.isTotal(this.pointColumnIndex+1,rowIndex)){marker=this.idMarkerMap[pointId];}else{continue;}}}if(this._useAttribute&&this.lookupColumnIndex>=0){attrId=rowHeaderElements.getHeader(this.lookupColumnIndex).getElementId();strippedElementID=this.getElementIdWithoutAttributeID(attrId);}else{strippedElementID=this.getElementIdWithoutAttributeID(pointId);}leftParenIndex=point.indexOf("(");if(leftParenIndex<0){continue;}rightParenIndex=point.indexOf(")",leftParenIndex);if(rightParenIndex<0){continue;}coreString=point.substring(leftParenIndex+1,rightParenIndex);elems=coreString.split(" ");if(!elems||elems.length!=2){continue;}longitude=this.stripNumberFormat(elems[0]);latitude=this.stripNumberFormat(elems[1]);if(isNaN(latitude)||isNaN(longitude)){continue;}var attributes={},i,titleIndex,elementValue;for(i=0;i<rowHeaderElements.size();i++){titleIndex=i;elementValue=rowHeaderElements.getHeader(titleIndex).getName();attributes[this.replaceSpace(rowAttributes.getTitle(titleIndex).getName())]=elementValue;}if(this._useAttribute){attributes.id=attrId;}else{attributes.id=pointId;}for(columnHeaderColumnIndex=0;columnHeaderColumnIndex<colCount;columnHeaderColumnIndex++){columnHeaderName=null;for(columnHeaderRowIndex=0;columnHeaderRowIndex<colHeaderRowCount;columnHeaderRowIndex++){var cellElement=priModel.getColHeaders(columnHeaderRowIndex).getHeader(columnHeaderColumnIndex),cellName=cellElement.getName();if(!columnHeaderName){columnHeaderName=cellName;}else{columnHeaderName+=" "+cellName;}}var values=priModel.getMetricValue(rowIndex,columnHeaderColumnIndex),thresholdType=values.getThresholdType();if(!thresholdType||thresholdType===this.enumNumber){attributes[this.replaceSpace(columnHeaderName)]=values.getValue();}else{attributes[this.replaceSpace(columnHeaderName)]=values.getRawValue();}if(rowIndex===0){s+="<b>"+columnHeaderName+"</b> :${"+this.replaceSpace(columnHeaderName)+"}<br />";}}attributes.rowIndex=rowIndex;attributes.geoIndex=pointElement.getElementIndex();var cell=priModel.getMetricValue(rowIndex,this.selectedMetricIndex);var latLng=new google.maps.LatLng(latitude,longitude);this.parent.updateMinMaxLatLng(latLng);s=this.createSimpleInfoHTML(rowIndex,attributes);this.addMarker(markerList,latLng,attributes,s,this.pointColumnIndex,cell,pointId,marker);this._markerElementIDs[strippedElementID]=latLng;markersCounter++;}if(markersCounter==0){this.parent.map.setCenter(new google.maps.LatLng(31,-10));this.parent.map.setZoom(1);}else{if(this.createMode==true){this.parent.updateMapExtent(this.loadByGridChange);}}},createSimpleInfoHTML:function createSimpleInfoHTML(rowIndex,attributes){var s="",priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowCell,rowCellTitle,rowCellValue,rowHeaders=priModel.getRowHeaders(rowIndex),rowTitles=priModel.getRowTitles(),colTitle=priModel.getColTitles(),colHeaderCount=priModel.getColumnHeaderCount(),k,j,stylePrefix="<tr><td style='color:#000;white-space:nowrap;text-align:right;padding-right:3px'>";var fnAddRow=function(title,value){return stylePrefix+title+" &nbsp;&nbsp; :</td><td style='color:#555;white-space:nowrap'> "+value+"</td></tr>";};for(k=0;k<rowHeaders.size();k++){if(k===this.latColumnIndex||k===this.longColumnIndex||k===this.pointColumnIndex){continue;}rowCellTitle=rowTitles.getTitle(k).getName();rowCellValue=rowHeaders.getHeader(k).getName();attributes[this.replaceSpace(rowCellTitle)]=rowCellValue;s+=fnAddRow(rowCellTitle,rowCellValue);}if(colTitle.size()===1&&colTitle.getTitle(0).getName()===mstrmojo.desc(1158,"Metrics")){rowHeaders=colTitle.getTitle(0).getHeaderValues();for(j=0;j<colHeaderCount;j++){var dataRow=priModel.getMetricValue(rowIndex,j);rowCellTitle=rowHeaders[j].n;rowCellValue=dataRow.getValue();var thresholdType=dataRow.getThresholdType();if(!thresholdType||thresholdType===this.enumNumber){s+=fnAddRow(rowCellTitle,rowCellValue);attributes[this.replaceSpace(rowCellTitle)]=rowCellValue;}else{s+=fnAddRow(rowCellTitle,dataRow.getRawValue());attributes[this.replaceSpace(rowCellTitle)]=dataRow.getRawValue();}}}return"<div style='overflow:hidden'><table>"+s+"</table></div>";},doAffinityAnimation:function doAffinityAnimation(){var that=this;this._glowTimer=setTimeout(function(){that.moveAffinityAnimationMarker();},50);},doDrill:function doDrill(index){this.performDrill(index);},doPostMapRendering:function doPostMapRendering(){if(this.isPath()){this.clearPath();this.drawPath();}},drawAffinityLinesUsingSecondaryDataProvider:function drawAffinityLinesUsingSecondaryDataProvider(){var secModel=this.getMapModel(SECONDARY_DATA_PROVIDER);if(!secModel){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()===-1){return ;}if(this._useAttribute&&!this.checkLookUpAttributeInSecondaryDP()){mstrmojo.alert("Lookup Attribute must be present in the affinity data provider.",null,"Affinity Lines Error");return ;}var sourceAttrElementID,destAttrElementID,lineColor,lineThickness,secondMetricIndex,cell,polyline,maxLineThickness=this.wpMaxLineThickness,rowCount=secModel.getTotalRows();if(secModel.getColTitles().size()===0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);this.clearAffinityLines();this._affinityLines=new Object();if(!this.AFFINITY_LINE_DEFAULT_COLOR){this.AFFINITY_LINE_DEFAULT_COLOR=this.parent.getNextDefaultAffinityLineColor();}for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=secModel.getRowHeaders(rowIndex);var firstAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPFirstAttrColIndex);var secondAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPSecondAttrColIndex);sourceAttrElementID=this.getElementIdWithoutAttributeID(firstAttrElementHeader.getElementId());destAttrElementID=this.getElementIdWithoutAttributeID(secondAttrElementHeader.getElementId());if(!this._markerElementIDs[sourceAttrElementID]||!this._markerElementIDs[destAttrElementID]){continue;}lineColor=secModel.getMetricValue(rowIndex,this.selectedMetricIndex).getFillColor(this.AFFINITY_LINE_DEFAULT_COLOR);if(secondMetricIndex!=-1){lineColor=secModel.getMetricValue(rowIndex,secondMetricIndex).getFillColor(lineColor);}cell=secModel.getMetricValue(rowIndex,0);if(cell.getValue()){metricCellValue=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());lineThickness=(metricCellValue*maxLineThickness)/this.secondaryDPMetricMaxVal[0]["max"];}else{lineThickness=1;}polyline=new google.maps.Polyline({path:[this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]],icons:[{icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:1.8,strokeColor:lineColor},offset:"0%",repeat:"10%"}],geodesic:(this.wpDrawArcsLines==="Arcs"),strokeColor:lineColor,strokeOpacity:1,strokeWeight:lineThickness});this._affinityLines[sourceAttrElementID+destAttrElementID]=polyline;polyline.setMap(this.map);}},drawPath:function drawPath(){var projection=this.parent.overlay.getProjection();if(!projection){return ;}this.clearPath();var count=0;var bubbles=[],latlng=[];this.pathObject.pathLines=[];var currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate,center;var points1,points2,latlng1,latlng2,upperTangentPath=[],lowerTangentPath=[],originalPath=[];var markerList=this.getGeoList(this.latColumnIndex);this.pathObject.pathBubbles=markerList;var currentBubbleLatLng,nextBubbleLatLng;var polyFillColor=this.pathObject.pathFillColor;var labelPos=markerList[0].attributes.latLng;var labelxPos=projection.fromLatLngToContainerPixel(labelPos).x;for(var i=0;i<markerList.length-1;i++){markerList[i].setMap(null);currentBubbleLatLng=markerList[i].attributes.latLng;originalPath.push(currentBubbleLatLng);center=projection.fromLatLngToContainerPixel(currentBubbleLatLng);currentBubbleCenterXCoordinate=center.x;currentBubbleCenterYCoordinate=center.y;currentBubbleRadius=markerList[i].getRadius();if(labelxPos<currentBubbleCenterXCoordinate){labelxPos=currentBubbleCenterXCoordinate;labelPos=currentBubbleLatLng;}nextBubbleLatLng=markerList[i+1].attributes.latLng;center=projection.fromLatLngToContainerPixel(nextBubbleLatLng);nextBubbleCenterXCoordinate=center.x;nextBubbleCenterYCoordinate=center.y;nextBubbleRadius=markerList[i+1].getRadius();points1=this.getTangentPoints(currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate);currentBubbleRadius=currentBubbleRadius*-1;nextBubbleRadius=nextBubbleRadius*-1;points2=this.getTangentPoints(currentBubbleRadius,nextBubbleRadius,currentBubbleCenterXCoordinate,currentBubbleCenterYCoordinate,nextBubbleCenterXCoordinate,nextBubbleCenterYCoordinate);latlng1=projection.fromContainerPixelToLatLng(points1[0],true);latlng2=projection.fromContainerPixelToLatLng(points1[1],true);lowerTangentPath.push(latlng2);lowerTangentPath.push(latlng1);latlng1=projection.fromContainerPixelToLatLng(points2[0],true);latlng2=projection.fromContainerPixelToLatLng(points2[1],true);upperTangentPath.push(latlng2);upperTangentPath.push(latlng1);}var that=this;for(i=0;i<upperTangentPath.length-1;i++){var polygon=new google.maps.Polygon({paths:[upperTangentPath[i],upperTangentPath[i+1],lowerTangentPath[i+1],lowerTangentPath[i]],strokeColor:polyFillColor,strokeWeight:1,strokeOpacity:0,fillColor:polyFillColor,fillOpacity:1});polygon._bubbleIndex=Math.floor(i/2);google.maps.event.addListener(polygon,"click",function(event){var markerList=that.getGeoList(that.getGeoColumnIndex());var bubble;for(var ind in markerList){bubble=markerList[ind];bubble.setMap(that.map);}});this.pathObject.pathLines.push(polygon);}this.pathObject.pathCurrentPolygonIndex=0;this.pathObject.pathTimer=setTimeout(function(){that.animatePath();},75);this.pathObject.pathLabel=new mstrmojo.gmaps.TextMarker({labelText:this.getViewerGridName(),clickable:true,position:labelPos,map:this.map,labelClass:"pathLabel",labelOffset:new google.maps.Size(-20,10)});google.maps.event.addListener(this.pathObject.pathLabel,"click",function(event){that.pathObject.pathLabelTimer=setTimeout(function(){that.animatePathBubbles();},50);that.pathObject.animatePathBubbleIndex=0;});},getPathArrowColor:function getPathArrowColor(color){var hsv=mstrmojo.color.hex2hsv(color);var rgb=mstrmojo.color.hsv2rgb(hsv[0],hsv[1],(hsv[2]*0.8)%100);return"#"+mstrmojo.color.rgb2hex(rgb[0],rgb[1],rgb[2]);},drawRectangleEnd:function drawRectangleEnd(searchBounds,selectionType){if(this.visible&&(this.enableLatLng||this.enablePoint)){this.rectangleMarkerSearch(searchBounds,selectionType);if(this.parent._affinityGlow){if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}var highlightedGraphics=this.getHighlightedGraphics(this.latColumnIndex);var sourceIds=new Object();for(marker in highlightedGraphics){var id=highlightedGraphics[marker].attributes.id;sourceIds[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceIds);}}},findCluster:function findCluster(latlng,width,height){var bounds=this.parent.createClusterBounds(latlng,width,height);var markerList=[];if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}var i;for(i=0;i<markerList.length;i++){marker=markerList[i];markerLatLng=marker.getPosition();geoIndex=marker.attributes.geoIndex;rowIndex=marker.attributes.rowIndex;var markerSelected=mstrmojo.array.indexOf(this.cluster,marker);if((markerSelected<0)&&bounds.contains(markerLatLng)){this.cluster.push(marker);}}},findLatLngPositionAttribute:function findLatLngPositionAttribute(){this.enableLatLng=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),latAttrId=this.wpLat,longAttrId=this.wpLng,i,attrId;for(i=0;i<numTemplateUnits;i++){attrId=rowAttributes.getTitle(i).getUnitId();if(attrId===latAttrId){this.columnIndices.Lat=i;this.latColumnIndex=i;}else{if(attrId===longAttrId){this.columnIndices.Long=i;this.longColumnIndex=i;}}if(attrId===this.wpLookupAttId){this.lookupColumnIndex=i;}}this.enableLatLng=((this.latColumnIndex!=-1)&&(this.longColumnIndex!=-1));return this.enableLatLng;},findLatLngPositionForm:function findLatLngPositionForm(){this.enableLatLng=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),latFormId=this.wpLat,longFormId=this.wpLng,attrId=this.wpAttribute,i,title;for(i=0;i<numTemplateUnits;i++){title=rowAttributes.getTitle(i);if(title.getUnitId()===attrId){var formId=title.getFormId();if(formId===latFormId){this.columnIndices.Lat=i;this.latColumnIndex=i;}else{if(formId===longFormId){this.columnIndices.Long=i;this.longColumnIndex=i;}}}}this.enableLatLng=((this.latColumnIndex!=-1)&&(this.longColumnIndex!=-1));return this.enableLatLng;},findNumAttributes:function findNumAttributes(){var attrList=[],rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),i;this.numAttributes=0;for(i=0;i<numTemplateUnits;i++){if(mstrmojo.array.indexOf(attrList,rowAttributes.getTitle(i).getUnitId())<0){attrList.push(rowAttributes.getTitle(i).getUnitId());this.numAttributes++;}}},findPointPositionAttribute:function findPointPositionAttribute(){this.enablePoint=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),pointAttrId=this.wpPoint,i,id;for(i=0;i<numTemplateUnits;i++){title=rowAttributes.getTitle(i).getUnitId();if(id===pointAttrId){this.columnIndices.Point=i;this.pointColumnIndex=i;}if(id===this.wpLookupAttId){this.lookupColumnIndex=i;}}this.enablePoint=this.pointColumnIndex!=-1;return this.enablePoint;},findPointPositionForm:function findPointPositionForm(){this.enablePoint=false;var rowAttributes=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles(),numTemplateUnits=rowAttributes.size(),pointFormId=this.wpPoint,attrId=this.wpAttribute,i,title;for(i=0;i<numTemplateUnits;i++){title=rowAttributes.getTitle(i);if((title.getUnitId()===attrId)&&(title.getFormId()===pointFormId)){this.columnIndices.Point=i;this.pointColumnIndex=i;}}this.enablePoint=this.pointColumnIndex!=-1;return this.enablePoint;},findSecondaryDPAttrColIndexes:function findSecondaryDPAttrColIndexes(){var rowAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getRowTitles(),attrId=rowAttributes.getTitle(0).getUnitId(),size=rowAttributes.size(),i;this.secondaryDPFirstAttrColIndex=0;for(i=1;i<size;i++){if(rowAttributes.getTitle(i).getUnitId()!=attrId){this.secondaryDPSecondAttrColIndex=i;break;}}return this.secondaryDPSecondAttrColIndex;},findSecondaryDPSecondMetricIndex:function findSecondaryDPSecondMetricIndex(){var colAttributes=this.getMapModel(SECONDARY_DATA_PROVIDER).getColTitles().getTitle(0).getHeaderValues();return(colAttributes.length>1)?1:-1;},getBounds:function getBounds(){return this.bounds;},getColumnHeaderByIndex:function getColumnHeaderByIndex(colIndex){if(!this.isValidColIndex(colIndex)){return"invalid column index";}var columnHeaders=this.getMapModel(PRIMARY_DATA_PROVIDER).getColTitles(),numColumnHeaders=columnHeaders.size(),columnHeaderString=columnHeaders.getTitle(0).getHeaderValues()[colIndex].n,i;for(i=0;i<numColumnHeaders;i++){columnHeaderString+=" "+columnHeaders.getTitle(i).getHeaderValues()[colIndex].n;}return columnHeaderString;},getCurrentSelections:function getCurrentSelection(columnIndex){if(!this.currentSelections){this.currentSelections={};}if(!this.currentSelections.hasOwnProperty(columnIndex)){this.currentSelections[columnIndex]=[];}return this.currentSelections[columnIndex];},getDefaultInfoWindowTemplate:function getDefaultInfoWindowTemplate(){var contentHTML="",model=this.getMapModel(PRIMARY_DATA_PROVIDER),rowHeaders=model.getRowHeaders(0),rowTitles=model.getRowTitles(),colTitles=model.getColTitles(),rowCell,rowCellTitle,k,j,size;for(k=0,size=rowHeaders.size();k<size;k++){if(k===this.latColumnIndex||k===this.longColumnIndex||k===this.pointColumnIndex){continue;}rowCellTitle=rowTitles.getTitle(k).getName();contentHTML+="<b>"+rowCellTitle+"</b>: ${"+this.replaceSpace(rowCellTitle)+"}<br />";}if(colTitles.size()===1&&colTitles.getTitle(0).getName()===mstrmojo.desc(1158,"Metrics")){rowHeaders=colTitles.getTitle(0).getHeaderValues();for(j=0,size=rowHeaders.length;j<size;j++){rowCellTitle=rowHeaders[j].n;contentHTML+="<b>"+rowCellTitle+"</b>: ${"+this.replaceSpace(rowCellTitle)+"}<br />";}}return contentHTML;},getDrillStatus:function getDrillStatus(){return this.getDrillStatusByColumnIndex(this.latColumnIndex);},getDrillStatusByColumnIndex:function getDrillStatusByColumnIndex(index){var selected=this.getSelectedRowIndices(index);if(selected===undefined||!selected instanceof Array||selected.length===0){return false;}var actionType=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(selected[0]).getHeader(index).getActionType();if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}if(this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(index).getDrillPath()){return true;}return false;},getElementIDByIndex:function getElementIDByIndex(index,columnIndex){var es=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(columnIndex).getHeaderValues();if(index>=0&&index<es.length){return es[index].id;}return null;},getElementIdWithoutAttributeID:function getElementIdWithoutAttributeID(elementID){var newElementID="";var pos=0;var i;for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===":"){pos++;}if(pos===1){continue;}newElementID=newElementID+elementID.charAt(i);}return newElementID;},getGeoColumnIndex:function getGeoColumnIndex(){if(this.enableLatLng){return this.latColumnIndex;}if(this.enablePoint){return this.pointColumnIndex;}},getGeoList:function getGeoList(columnIndex){if(!this.geoLists){this.geoLists={};}if(!this.geoLists.hasOwnProperty(columnIndex)){this.geoLists[columnIndex]=[];}return this.geoLists[columnIndex];},getHighlightedGraphics:function getHighlightedGraphics(columnIndex){if(!this.highlightedGraphics){this.highlightedGraphics={};}if(!this.highlightedGraphics.hasOwnProperty(columnIndex)){this.highlightedGraphics[columnIndex]=[];}return this.highlightedGraphics[columnIndex];},getInfoWindowClusterNavigationHTML:function getInfoWindowClusterNavigationHTML(isPrev){var htmlStr="";var isEnabled=isPrev?(this.clusterIndex>0):(this.clusterIndex<this.cluster.length-1);if(this.cluster.length>1){htmlStr='<div id="'+(isPrev?"infoPrev":"infoNext")+'" class="mstrmojo-Button mstrtbMap'+(isPrev?"Prev":"Next");if(isEnabled){htmlStr+='" onclick="mstrmojo.all[\'';htmlStr+=this.id;htmlStr+="']."+(isPrev?"getPrev":"getNext")+"();return false;";}else{htmlStr+=" disabled";}htmlStr+='" style="float:left;display: block" ></div>';}return htmlStr;},getInfoWindowNavigationHTML:function getInfoWindowNavigationHTML(title){var s="";if(this.cluster.length>1){s+='<div style="margin-left:-3px;margin-top:-5px;height:20px">';s+=this.getInfoWindowClusterNavigationHTML(true);s+='<div style="float:left;color:lightseagreen;font-size:8pt;margin-top:5px"> ';var ofString=mstrmojo.desc(4891,"## of ###");var resultString=ofString.replace("##",""+(this.clusterIndex+1)).replace("###",""+(this.cluster.length));s+=resultString+"</div>";s+=this.getInfoWindowClusterNavigationHTML(false);s+="</div>";}return s;},getMapModel:function(key){return key===PRIMARY_DATA_PROVIDER?this.primaryModel:this.secondaryModel;},getNext:function getNext(){this.clusterIndex++;var mapObj=this.cluster[this.clusterIndex];this.showInfoWindow(mapObj,null,true);},getPrev:function getPrev(){this.clusterIndex--;var mapObj=this.cluster[this.clusterIndex];this.showInfoWindow(mapObj,null,true);},getRowAxisAttributeIndex:function getRowAxisAttributeIndex(columnIndex){var titles=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles();if(typeof (columnIndex)=="undefined"||columnIndex>=titles.size()){return -1;}var attributeIndex=-1,attributeLookup={},i;for(i=0;i<=columnIndex;i++){if(typeof (attributeLookup[titles.getTitle(i).getUnitId()])=="undefined"){attributeLookup[titles.getTitle(i).getUnitId()]=1;attributeIndex++;}}return attributeIndex;},getSelectionInfo:function(sliceInfo){var newIndicesKey=sliceInfo.elementIndex.sort().join("_");if(this.currentSelectedIndex===newIndicesKey){return ;}this.currentSelectedIndex=newIndicesKey;var geoPosition=sliceInfo.pos,geoAttributeSelector=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(geoPosition).getSelectorControl();if(!geoAttributeSelector){return ;}var targetKeys=geoAttributeSelector.tks,controlKeyContext=geoAttributeSelector.ck,controlKey=geoAttributeSelector.ckey,elementsList,elementIDs=[],numElements=sliceInfo.elementIndex.length,itemSeparator="\x1e";var i;for(i=0;i<numElements;i++){elementIDs.push(this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(geoPosition).getHeaderValues()[sliceInfo.elementIndex[i]].id);}elementsList=elementIDs.join(itemSeparator);return{targetKeys:targetKeys,elementsList:elementsList,controlKeyContext:controlKeyContext,controlKey:controlKey};},handleAffinityAnimationMouseClick:function handleAffinityAnimationMouseClick(marker,event){if(!marker){return ;}if(this._affinityAnimationFinished){this.clearAffinityAnimationObjects();}var ctrlKey=event.ctrlKey;if(!this._selectedAffinityMarkers){this._selectedAffinityMarkers=new Object();}if(!ctrlKey){this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;this.handleAffinityAnimationKeyUp();}else{if(this._selectedAffinityMarkers.hasOwnProperty(marker.attributes.id)){marker.isSelected=false;id=marker.attributes.id;delete this._selectedAffinityMarkers[marker.attributes.id];}else{this._selectedAffinityMarkers[marker.attributes.id]=marker;marker.isSelected=true;}}},handleAffinityAnimationKeyUp:function handleAffinityAnimationKeyUp(){if(!this._affinityAnimationFinished&&this.parent._affinityGlow){var sourceId={},id,marker;for(id in this._selectedAffinityMarkers){sourceId[this.getElementIdWithoutAttributeID(id)]=id;}this.startAffinityLinesAnimation(sourceId);}},getTangentPoints:function getTangentPoints(rA,rB,xA,yA,xB,yB){var points=[new google.maps.Point(),new google.maps.Point()];var cosT=((xA-xB)*(rA-rB)+(yA-yB)*Math.sqrt((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB)-(rA-rB)*(rA-rB)))/((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB));var sinT=((yA-yB)*(rA-rB)-(xA-xB)*Math.sqrt((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB)-(rA-rB)*(rA-rB)))/((xA-xB)*(xA-xB)+(yA-yB)*(yA-yB));points[0].x=xB-rB*cosT;points[0].y=yB-rB*sinT;points[1].x=xA-rA*cosT;points[1].y=yA-rA*sinT;return points;},getViewerGridName:function getViewerGridName(){return this.data.n;},handleDensitySelections:function handleDensitySelections(selections){var columnIndex;if(this._useLatlng){columnIndex=this.latColumnIndex;}else{columnIndex=this.pointColumnIndex;}var markerList=this.getGeoList(columnIndex);var marker;var markerLatLng;var geoIndex;var rowIndex;var markerSelected;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);currentSelections.length=0;selectedRowIndices.length=0;this.clearAllHighlight();highlightedGraphics.length=0;var i;for(i=0;i<selections.length;i++){var attr=selections[i].attributes;geoIndex=attr.geoIndex;rowIndex=attr.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);if(markerSelected<0){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);}}if(currentSelections.length>0){var sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.command.applySelection(sliceInfo);}},handleMapOnMouseUp:function handleMapOnMouseUp(){if(this.wpMarkerType===EnumMarkerType.PATH){var markerList=this.getGeoList(this.getGeoColumnIndex());for(var i=0;i<markerList.length;i++){markerList[i].setMap(null);}}},handleSelection:function handleSelection(mapObj,event){if(!this.parent.enableClickSelect){return ;}var geoIndex=mapObj.attributes.geoIndex,rowIndex=mapObj.attributes.rowIndex,columnIndex,highlightedGraphics,currentSelections,selectedRowIndices,isAdd=true,map=this.map,i,sliceInfo;if(mapObj.geoPosition instanceof Array){columnIndex=mapObj.geoPosition[0];}else{columnIndex=mapObj.geoPosition;}highlightedGraphics=this.getHighlightedGraphics(columnIndex);currentSelections=this.getCurrentSelections(columnIndex);selectedRowIndices=this.getSelectedRowIndices(columnIndex);if(!this.previousState){this.previousState={};this.previousState.columnIndex=columnIndex;this.previousState.currentSelections=currentSelections.slice(0);this.previousState.selectedRowIndices=selectedRowIndices.slice(0);this.previousState.highlightedGraphics=highlightedGraphics.slice(0);this.previousState.mapObjectsState={selectedObj:[],unselectedObj:[]};this.previousState.stateChangedMarker=[];}i=mstrmojo.array.indexOf(currentSelections,geoIndex);if(i!=-1){currentSelections.splice(i,1);selectedRowIndices.splice(i,1);if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.selectedObj.push(mapObj);}var graphicIndex=mstrmojo.array.indexOf(highlightedGraphics,mapObj);if(typeof (mapObj.onisSelectedChange)!="undefined"){mapObj.set("isSelected",false);}else{mapObj.isSelected=false;}highlightedGraphics.splice(graphicIndex,1);if(typeof (mapObj.image)!="undefined"){mapObj.setIcon(mapObj.image);}}else{currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);highlightedGraphics.push(mapObj);if(mstrmojo.array.indexOf(this.previousState.stateChangedMarker,geoIndex)==-1){this.previousState.stateChangedMarker.push(geoIndex);this.previousState.mapObjectsState.unselectedObj.push(mapObj);}if(typeof (mapObj.onisSelectedChange)!="undefined"){mapObj.set("isSelected",true);}else{mapObj.isSelected=true;}if(typeof (mapObj.hili)!="undefined"){mapObj.setIcon(mapObj.hili);}}if(currentSelections.length>0){sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.savedSliceInfo=sliceInfo;}return currentSelections;},initMapProperty:function initMapProperty(){var geoName;for(geoName in this.columnIndices){if(this.columnIndices.hasOwnProperty(geoName)){this.columnIndices[geoName]=-1;}}this.bounds=new google.maps.LatLngBounds();},isAffinityLinesEnabled:function isAffinityLinesEnabled(){return this.wpDisPlayAffinityLines!="0";},isDensityMap:function isDensityMap(){return(this.wpMarkerType===EnumMarkerType.DENSITY);},isIndexGeoPosition:function isIndexGeoPosition(index){return(this.latColumnIndex===index)||(this.longColumnIndex===index);},isPath:function isPath(){return(this.wpMarkerType===EnumMarkerType.PATH);},isTotal:function isTotalCell(nextColumnIndex,rowIndex){var rowHeaderElements=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(rowIndex),nextCellElement=rowHeaderElements.getHeader(nextColumnIndex),nextElementId;if(!nextCellElement){return false;}nextElementId=nextCellElement.getElementId();if(nextElementId.indexOf("DB:")===0){return true;}return false;},isValidColIndex:function isValidColIndex(colIndex){var firstRowOfColumnHeader=this.getMapModel(PRIMARY_DATA_PROVIDER).getColTitles().getTitle(0).getHeaderValues();return(colIndex>=0&&colIndex<firstRowOfColumnHeader.length);},latlngDrill:function latlngDrill(){this.doDrill(this.latColumnIndex);},loadWidgetProps:function loadWidgetProps(){var props=this.widgetProps;if(!props){return false;}var property=props.af;if(property){this._useAttribute=(property==="0");}property=props.gr;if(property){this._useLatlng=(property==="0");}if(!this._useAttribute){this.wpAttribute=props.ga;}if(this._useLatlng){this.wpLat=props.flat;this.wpLng=props.flong;}else{this.wpPoint=props.fpt;}property=props.mtp;if(property){this.wpMarkerType=property;if(this.isDensityMap()){if(this.parent.isCanvasSupported()){this.wpDensityTheme=parseInt(props.dms);}else{this.wpMarkerType=EnumMarkerType.MARKER;mstrmojo.alert(mstrmojo.desc(9281,"Density Maps is not supported on this Browser version."));}}else{property=props.mss;if(property){this.wpMapSizingStyle=property;}if(this.wpMarkerType===EnumMarkerType.PATH){property=props.pcp;if(property){this.pathObject.pathFillColor="#"+property;}else{this.pathObject.pathFillColor=this.parent.getNextDefaultAffinityLineColor();}this.maxRadius=this.MAX_PATH_BUBBLE_RADIUS;}}}property=props.mstyl;if(property){this.wpMarkerStyle=property;}property=props.at;if(property){this._applyThreshold=(property==="1");}property=props.da;if(property){this.wpDisPlayAffinityLines=property;if(this.wpDisPlayAffinityLines!="0"){this.wpDrawArcsLines=props.dal;this.wpMaxLineThickness=props.lwm;}}else{this.wpDisPlayAffinityLines="0";}property=props.dv;if(property){this._defaultView=property;}property=props.dm;if(property){this.isAggregate=(property==="1");}property=props.dmaf;if(property){this.wpAggregateAttributeForm=(property==="1");}property=props.mbs;if(property){this.maxRadius=parseInt(property)/2;if(this.wpMarkerType===EnumMarkerType.PATH){this.maxRadius=this.MAX_PATH_BUBBLE_RADIUS;}}this.parent.updateMaxBubbleRadius(this.maxRadius);property=props.latt;if(property){this.wpLookupAttId=property;}if(props&&props.iwd){this.infoWindowHTML=unescape(props.iwd);}this._displayTitleIndex=-1;var displayUnitId=this._useAttribute?props.atf:props.satf;if(displayUnitId&&this.primaryModel&&this.primaryModel.getTotalRows()>0){var titles=this.primaryModel.getRowTitles();if(titles){for(var i=0,len=titles.size();i<len;++i){var title=titles.getTitle(i);var unitIdToCheck=this._useAttribute?title.getUnitId():title.getFormId();if(title&&displayUnitId==unitIdToCheck){this._displayTitleIndex=i;break;}}}}if(typeof (console)!=undefined){}},moveAffinityAnimationMarker:function moveAffinityAnimationMarker(){var i,len,arr,marker,interval=this._currentAffinityInterval;for(i=0,len=this._animationSourceMarkerLines.length;i<len;i++){arr=this._animationSourceMarkerLines[i];marker=this._animationMarkers[i];if(interval<this.parent.NO_OF_POINTS){marker.setPosition(arr[interval]);}if(interval===0){marker.setMap(this.map);}}if(interval===this.parent.NO_OF_POINTS-1){for(i=0,len=this._animationMarkers.length;i<len;i++){this._animationMarkers[i].setMap(null);}clearTimeout(this._glowTimer);}else{this._currentAffinityInterval++;this.doAffinityAnimation();}},onAffinityAnimationModeChange:function onAffinityAnimationModeChange(){if(this.wpDisPlayAffinityLines==="0"||!this.getMapModel(SECONDARY_DATA_PROVIDER)){return ;}if(!this.parent._affinityGlow){var polyline;var key;for(key in this._affinityLines){polyline=this._affinityLines[key];polyline.setMap(this.map);}this.clearAffinityAnimationObjects();}},onInfoWindowRendered:function onInfoWindowRendered(evt){id=evt.id;var w=mstrmojo.all[id],newDiv=document.createElement("div");if(this.parent.enableClickSelect||this.parent.enableRectangleSelect){newDiv.className="clickSelectfuionTableInfoWindow";if(w){newDiv.appendChild(w.domNode);}return ;}if(w){w.set("autoCloses",false);w.set("locksHover",false);newDiv.className="fusionTableInfoWindow";newDiv.style.overflow="hidden";if(w.children[0]){var divH=parseInt(w.children[0].defn.fmts.height)+50+"px";newDiv.style.height=divH;newDiv.style.width=w.children[0].defn.fmts.width;}else{newDiv.style.height="125px";newDiv.style.width="200px";newDiv.style.overflow="auto";}w.containerNode.style.top="18px";w.containerNode.style.left="0px";var navigationBar='<div class ="mstrMapButton" style="font-size:8pt;height:26px;top:5px;left:5px">'+this.getInfoWindowNavigationHTML()+"</div>";newDiv.innerHTML=navigationBar;newDiv.appendChild(w.tipNode);newDiv.appendChild(w.domNode);}var areaInfoWindow=this.parent.infowindow;if(areaInfoWindow){areaInfoWindow.close();}else{areaInfoWindow=new google.maps.InfoWindow();}areaInfoWindow.setContent(newDiv);if(this.panelStackInfoPos instanceof google.maps.LatLng){areaInfoWindow.setPosition(this.panelStackInfoPos);areaInfoWindow.open(this.map);}else{areaInfoWindow.open(this.map,this.panelStackInfoPos);}if(infoWindowRenderedSub&&mstrApp.docModel){mstrApp.docModel.detachEventListener(infoWindowRenderedSub);infoWindowRenderedSub=null;}},populateBubbleVariables:function populateBubbleVariables(){if(this.wpMarkerType!==EnumMarkerType.BUBBLE&&this.wpMarkerType!==EnumMarkerType.PATH){return ;}this.populateMinMax(this.selectedMetricIndex);var minMaxObject=this.minMaxMap[this.selectedMetricIndex];this.maxValue=minMaxObject.max;this.validBubble=(this.maxValue!=Infinity);},populateMinMax:function populateMinMax(metricColumnIndex){if(!this.minMaxMap){this.minMaxMap={};}var geoColumnIndices,priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),rowAttributes=priModel.getRowTitles(),rowCount=priModel.getTotalRows(),rowIndex=0,minValue=Infinity,maxValue=-Infinity,latitudeElement,latitudeTitleIndex,latitude,latitudeId,longitudeElement,longitudeTitleIndex,longitude,longitudeId,pointElement,pointTitleIndex,point,pointId,leftParenIndex,rightParenIndex,elems,errTitle,err,cell,type,cellNumber;for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=priModel.getRowHeaders(rowIndex);if(this.enableLatLng){latitudeElement=rowHeaderElements.getHeader(this.latColumnIndex);if(!latitudeElement||latitudeElement.getElementIndex()<0){continue;}latitudeTitleIndex=this.latColumnIndex;latitude=this.stripNumberFormat(latitudeElement.getName());latitudeId=latitudeElement.getElementId();if(latitudeId.indexOf("DB:")===0){continue;}longitudeElement=rowHeaderElements.getHeader(this.longColumnIndex);if(!longitudeElement||longitudeElement.getElementIndex()<0){continue;}longitudeTitleIndex=this.longColumnIndex;longitude=this.stripNumberFormat(longitudeElement.getName());longitudeId=longitudeElement.getElementId();if(longitudeId.indexOf("DB:")===0){continue;}if(isNaN(latitude)||isNaN(longitude)){continue;}}else{pointElement=rowHeaderElements.getHeader(this.pointColumnIndex);if(!pointElement||pointElement.getElementIndex()<0){continue;}pointTitleIndex=this.pointColumnIndex;point=pointElement.getName();pointId=pointElement.getElementId();if(pointId.indexOf("DB:")===0){continue;}leftParenIndex=point.indexOf("(");if(leftParenIndex<0){continue;}rightParenIndex=point.indexOf(")",leftParenIndex);if(rightParenIndex<0){continue;}coreString=point.substring(leftParenIndex+1,rightParenIndex);elems=coreString.split(" ");if(!elems||elems.length!=2){continue;}latitude=this.stripNumberFormat(elems[0]);longitude=this.stripNumberFormat(elems[1]);if(isNaN(latitude)||isNaN(longitude)){continue;}}cell=priModel.getMetricValue(rowIndex,metricColumnIndex);type=cell.getThresholdType();cellNumber;if(!type||type===this.enumNumber){cellNumber=parseFloat(!cell.getRawValue()?this.stripNumberFormat(cell.getValue()):cell.getRawValue());}else{cellNumber=cell.getRawValue();}if(this.wpMapSizingStyle==="1"&&cellNumber<0){continue;}cellNumber=Math.abs(cellNumber);maxValue=(cellNumber>maxValue)?cellNumber:maxValue;minValue=(cellNumber<minValue)?cellNumber:minValue;}this.minMaxMap[metricColumnIndex]={min:minValue,max:maxValue};},processDrill:function processDrillRequest(){if(this.enableLatLng){this.latlngDrill();}if(this.enablePoint){this.doDrill(this.pointColumnIndex);}},rectangleMarkerSearch:function rectangleMarkerSearch(searchBounds,selectionType){if(!searchBounds){return ;}var columnIndex;if(this._useLatlng){columnIndex=this.latColumnIndex;}else{columnIndex=this.pointColumnIndex;}var markerList=this.getGeoList(columnIndex);var marker;var markerLatLng;var geoIndex;var rowIndex;var markerSelected;var highlightedGraphics=this.getHighlightedGraphics(columnIndex);var currentSelections=this.getCurrentSelections(columnIndex);var selectedRowIndices=this.getSelectedRowIndices(columnIndex);var i;if(this.isDensityMap()){var selection=[],location,position;for(var i=0;i<this.densityLocations.length;i++){location=this.densityLocations[i];position=location.position;if(this.isMarkerInArea(searchBounds,position,selectionType)){selection.push(location);}}for(i=0;i<selection.length;i++){var attr=selection[i].attributes;geoIndex=attr.geoIndex;rowIndex=attr.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);if(markerSelected<0){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);}}}else{for(i=0;i<markerList.length;i++){marker=markerList[i];markerLatLng=marker.getPosition();geoIndex=marker.attributes.geoIndex;rowIndex=marker.attributes.rowIndex;markerSelected=mstrmojo.array.indexOf(currentSelections,geoIndex);var isMarkerInArea=this.isMarkerInArea(searchBounds,markerLatLng,selectionType);if((markerSelected<0)&&isMarkerInArea){currentSelections.push(geoIndex);selectedRowIndices.push(rowIndex);if(typeof (marker.onisSelectedChange)!="undefined"){marker.set("isSelected",true);}else{if(marker.hili){marker.isSelected=true;marker.setIcon(marker.hili);}}highlightedGraphics.push(marker);}}}if(this.parent._affinityGlow){return ;}if(currentSelections.length>0){var sliceInfo={pos:[columnIndex],elementIndex:currentSelections,setViewDataFlag:false,applyControl:true,beanPath:this.parent.getBeanPath()};this.command.applySelection(sliceInfo);}},isMarkerInArea:function isMarkerInArea(areaObj,markerLatLng,selectionType){if(selectionType==EnumAreaSelectionType.RECTANGLE){return areaObj.contains(markerLatLng);}else{if(selectionType==EnumAreaSelectionType.CIRCLE){var radius=areaObj.getRadius();var center=areaObj.getCenter();var distance=google.maps.geometry.spherical.computeDistanceBetween(center,markerLatLng);return distance<=radius?true:false;}else{return google.maps.geometry.poly.containsLocation(markerLatLng,areaObj);}}},render:function renderGridLayer(loadByGridChange,createMode,callbackFunc){this.loadByGridChange=loadByGridChange;if(this.primaryModel.getTotalRows()==0){mstrmojo.alert(!!this.data.eg?this.data.eg:"No rows returned for this dataset.",null,this.data.n);return ;}this.renderCompleteCallbackFunc=callbackFunc;this.visible=true;this.createMode=createMode;this.findNumAttributes();this.idMarkerMap={};var validAttributes=false;if(this._useAttribute){if(this._useLatlng){if(this.findLatLngPositionAttribute()){validAttributes=true;this.createLatLngMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}else{if(this.findPointPositionAttribute()){validAttributes=true;this.createPointMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}}else{if(this._useLatlng){if(this.findLatLngPositionForm()){validAttributes=true;this.createLatLngMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}else{if(this.findPointPositionForm()){validAttributes=true;this.createPointMarker();if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}}}}if(!validAttributes){mstrmojo.alert(mstrmojo.desc(8214,"No Mappable attributes present on the report."));}},doPostViewerRenderComplete:function doPostViewerRenderComplete(){if(this.renderCompleteCallbackFunc){this.renderCompleteCallbackFunc.call(this.parent);this.renderCompleteCallbackFunc=null;}},replaceSpace:function replaceSpace(str,replaceStr){var replace=replaceStr;if(replace===undefined){replace="_";}return str.replace(/ /g,replace);},resetModel:function resetModel(data){this.primaryModel=null;this.primaryModel=new mstrmojo.Vis.DataParser(data);this.data=data;this.unrender();this.render();},resetAffinityLinesData:function resetAffinityLinesData(data){this.secondaryModel=null;this.secondaryModel=new mstrmojo.Vis.DataParser(data);if(this.gridParams.isRW&&this.wpDisPlayAffinityLines!="0"){this.drawAffinityLinesUsingSecondaryDataProvider();}},resolveCustomizedInfoWindow:function resolveCustomizedInfoWindow(attributes){var input=this.infoWindowHTML;var result="";var baseIndex=0;var startIndex=input.indexOf("${",baseIndex);var endIndex=input.indexOf("}",startIndex+1);var macroName;var transformedMacroName;var replaceValue;while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);var colonIndex=macroName.indexOf(":");if(colonIndex>=0){transformedMacroName=macroName.substring(0,colonIndex)+" "+macroName.substring(colonIndex+1);}else{transformedMacroName=macroName;}transformedMacroName=this.replaceSpace(transformedMacroName);if(attributes.hasOwnProperty(transformedMacroName)){result+=input.substring(baseIndex,startIndex)+attributes[transformedMacroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex+1;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex,input.length);return result;},retrieveDataRows:function retrieveDataRows(sliceInfo){var dataRows=[];var j,k;if(sliceInfo){var geoElemIdx=parseInt(sliceInfo.elementIndex,10);var pos;if(sliceInfo.pos instanceof Array){pos=sliceInfo.pos;}else{pos=[parseInt(sliceInfo.pos,10)];}if(!this.viewCache){this.viewCache={};}if(this.viewCache[geoElemIdx]){dataRows=this.viewCache[geoElemIdx];}else{var numRows=this.getMapModel(PRIMARY_DATA_PROVIDER).getTotalRows();var validRow;for(k=0;k<numRows;k++){var rowHeader=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowHeaders(k);validRow=true;for(j=0;j<pos.length;j++){var cellHeader=rowHeader.getHeader(pos[j]);if(!cellHeader||cellHeader.getElementIndex()!=geoElemIdx){validRow=false;break;}}if(validRow){dataRows.push(k);}}this.viewCache[geoElemIdx]=dataRows;}}return dataRows;},setMapModel:function(model){this.primaryModel=(model.grid1?new mstrmojo.Vis.DataParser(model.grid1):null);this.secondaryModel=(model.grid2?new mstrmojo.Vis.DataParser(model.grid2):null);},showInfoWindow:function createContent(geoItem,latlng,clusterMode){if(!this.parent.enablePopup||!this.parent.infowindow){return ;}var geoPos=[],sc;if(geoItem.geoPosition instanceof Array){geoPos=geoItem.geoPosition;}else{geoPos[0]=geoItem.geoPosition;}if(!clusterMode){this.clusterIndex=0;if(this.isDensityMap()){this.cluster=this.densityLayer.getLastCluster();}else{if(this.isPath()){this.cluster=this.getGeoList(this.getGeoColumnIndex());this.clusterIndex=geoItem.attributes.rowIndex;}else{this.cluster.length=0;this.cluster.push(geoItem);if(geoItem instanceof mstrmojo.gmaps.CircleMarker){this.findCluster(latlng||geoItem.getPosition(),geoItem.radius,geoItem.radius);}else{this.findCluster(latlng||geoItem.getPosition(),9,32);}}}}if(!(geoItem instanceof google.maps.Marker)&&!(geoItem instanceof google.maps.OverlayView)&&geoItem.position){latlng=geoItem.position;}if(geoItem instanceof mstrmojo.gmaps.CircleMarker){if(this.previousShownBubble){this.previousShownBubble.setBubbleZIndex(this.previousShownBubble.getOriginalBubbleZIndex());this.previousShownBubble.set("highlight",false);}this.previousShownBubble=geoItem;this.previousShownBubble.set("highlight",true);geoItem.setBubbleZIndex(this.parent.maxBubbleRadius+1);this.parent.infowindow.setZIndex(this.parent.maxBubbleRadius+2);}for(var i=0;i<geoPos.length;i++){sc=this.getMapModel(PRIMARY_DATA_PROVIDER).getRowTitles().getTitle(geoPos[i]).getSelectorControl();var $FE=mstrmojo.hash.forEach,ifws=this.parent.findPanelStackAsInfoWindowSelectorTarget(sc);if(ifws){var that=this;if(mstrApp.docModel){infoWindowRenderedSub=mstrApp.docModel.attachEventListener("infoWindowRendered",this.id,function(evt){that.onInfoWindowRendered(evt);});this.showPanelStackInfoWindow(geoItem,geoPos[i],latlng);$FE(ifws,function(psId,psKey){mstrApp.docModel.showInfoWin(psId);});}return ;}}var dataRows,sliceInfo,div,content,detail,title,size;if((this._useAttribute&&this.isAggregate)||(!this._useAttribute&&this.wpAggregateAttributeForm)){var posValue=(geoItem.geoPosition instanceof Array)?geoItem.geoPosition:[geoItem.geoPosition];sliceInfo={pos:posValue,elementIndex:geoItem.attributes.geoIndex,setViewDataFlag:false,applyControl:false,beanPath:this.parent.getBeanPath()};dataRows=this.retrieveDataRows(sliceInfo);}else{dataRows=[geoItem.attributes.rowIndex];}if(this.infoWindowHTML!==undefined&&(this.infoWindowHTML!=""&&this.infoWindowHTML!=this.defaultInfoWindowHTML)){detail=this.resolveCustomizedInfoWindow(geoItem.attributes);content=this.createInfoWindow(geoItem.attributes.NAME,detail);this.parent.infowindow.setContent(content);}else{if(dataRows.length===1){if(geoItem.attributes.NAME){content=this.createInfoWindow(geoItem.attributes.NAME,geoItem.simpleHTML);}else{content=this.createInfoWindow("",geoItem.simpleHTML);}size=mstrmojo.dom.position(content);this.parent.infowindow.setContent(content);}else{if(this.infoWindowUseGrid){content=this.createGridInfoWindow(dataRows);this.parent.infowindow.setContent(this.parent.infoTabDiv);}}}if(latlng){this.parent.infowindow.setPosition(latlng);this.parent.infowindow.open(this.map);}else{this.parent.infowindow.open(this.map,geoItem);}},showPanelStackInfoWindow:function showPanelStackInfoWindow(geoItem,colIndex,latLng){var priModel=this.getMapModel(PRIMARY_DATA_PROVIDER),sc=priModel.getRowTitles().getTitle(colIndex).getSelectorControl(),eid=priModel.getRowHeaders(geoItem.attributes.rowIndex).getHeader(colIndex).getElementId(),ps={x:0,y:0,h:60,w:0};if(latLng){this.panelStackInfoPos=latLng;}else{this.panelStackInfoPos=geoItem;}mstrApp.docModel.slice({type:mstrmojo.EnumRWUnitType.GRID,sPos:ps,ck:sc.ck,ctlKey:sc.ckey,tks:sc.tks,eid:eid});},startAffinityLinesAnimation:function startAffinityLinesAnimation(sourceMarkerIds){var secModel=this.getMapModel(SECONDARY_DATA_PROVIDER);if(!secModel){mstrmojo.alert("Secondary data provider could not be found. In order to see the Affinity Lines, please reset the secondary data provider in the design mode.",null,"Affinity Lines Error");return ;}if(this.findSecondaryDPAttrColIndexes()===-1){return ;}var secondMetricIndex,sourceAttrElementID,destAttrElementID,polyline,option,i,arr,marker,len,rowCount=secModel.getTotalRows();if(secModel.getColTitles().size()===0){mstrmojo.alert("No Metric is present on the secondary data provider.",null,"Affinity Lines Error");return ;}secondMetricIndex=this.findSecondaryDPSecondMetricIndex();this.computeSecondaryDPMetricMax(0);if(!this._animationSourceMarkerLines){this._animationSourceMarkerLines=[];}len=this._animationSourceMarkerLines.length;for(i=len;i>0;i--){this._animationSourceMarkerLines.pop();}for(rowIndex=0;rowIndex<rowCount;rowIndex++){var rowHeaderElements=secModel.getRowHeaders(rowIndex);var firstAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPFirstAttrColIndex);var secondAttrElementHeader=rowHeaderElements.getHeader(this.secondaryDPSecondAttrColIndex);sourceAttrElementID=this.getElementIdWithoutAttributeID(firstAttrElementHeader.getElementId());destAttrElementID=this.getElementIdWithoutAttributeID(secondAttrElementHeader.getElementId());if(!sourceMarkerIds[sourceAttrElementID]||!this._markerElementIDs[destAttrElementID]){if(this._affinityLines[sourceAttrElementID+destAttrElementID]!=null){polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.setMap(null);}continue;}polyline=this._affinityLines[sourceAttrElementID+destAttrElementID];polyline.strokeOpacity=1;polyline.setMap(this.map);if(this.wpDrawArcsLines==="Arcs"){this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.parent.findPointsOnArc(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}else{this._animationSourceMarkerLines[this._animationSourceMarkerLines.length]=this.parent.findPointsOnLine(this._markerElementIDs[sourceAttrElementID],this._markerElementIDs[destAttrElementID]);}}if(!this._animationMarkers){this._animationMarkers=[];}len=this._animationMarkers.length;for(i=len;i>0;i--){this._animationMarkers.pop();}this._affinityAnimationFinished=true;if(this._animationSourceMarkerLines.length===0){return ;}len=this._animationSourceMarkerLines.length;for(i=0;i<len;i++){arr=this._animationSourceMarkerLines[i];marker=this.createAffinityAnimationMarker(arr[0]);this._animationMarkers[i]=marker;}this._currentAffinityInterval=0;this.doAffinityAnimation();},stripNumberFormat:function stripNumberFormat(numString){var newString=numString.replace(this.gridParams.currencySymbol,"");var oldString;do{oldString=newString;newString=newString.replace(this.gridParams.groupingSeparator,"");}while(oldString!=newString);var resultString=newString.replace(this.gridParams.decimalSeparator,".");return resultString;},unrender:function unrender(){this.visible=false;if(!this.idMarkerMap){return ;}var key;for(key in this.idMarkerMap){this.idMarkerMap[key].setMap(null);}this.idMarkerMap=null;var markerList,ind;if(this.enableLatLng){markerList=this.getGeoList(this.latColumnIndex);}else{if(this.enablePoint){markerList=this.getGeoList(this.pointColumnIndex);}}if(!!markerList){for(ind=0;ind<markerList.length;ind++){markerList[ind].setMap(null);}}this.clearAffinityLines();this.cleanDensityMap();this.densityLocations=null;this.clearPath();if(this.parent.refitContent==true){this.loadByGridChange=true;this.parent.updateMapExtent(this.loadByGridChange);}}});})();