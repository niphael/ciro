(function(){mstrmojo.requiresCls("mstrmojo.Container");function _makeTable(txt,ind,img,s,h,w,menus){var sh=h?"height:"+h+"px;":"";var sw=w?"width:"+w+"px;":"";var item='<div class="mstrmojo-qb-DBTableRow-bullet" style="'+sh+sw+'">';item+='<div class="icon t'+img[1]+'"></div>';item+='<div class="text" >'+txt+"</div>";if(menus&&menus.length){for(var i=0;i<menus.length;i++){item+='<div class="cxtmenu '+menus[i].n+'"></div>';}}item+="</div></div>";return item;}var _D=mstrmojo.dom,_doc=mstrmojo.global.document;var _av,_avin,_avs;var _pos;function _updateAvatar(pos,allowDrop,html){if(html!=null){_avin.innerHTML=html;}_avs.left=pos.x+"px";_avs.top=pos.y+"px";}function _showAvatar(html,pos){if(!_av){_av=_doc.createElement("div");_avs=_av.style;_avs.position="absolute";_avs["z-index"]=9999;_av.className="mstrmojo-Architect-TableRow-avatar";_av.innerHTML="<div></div>";_avin=_av.firstChild;_doc.body.appendChild(_av);}_updateAvatar(pos,true,html);_avs.display="block";}function _hideAvatar(){if(_av){_avs.display="none";}}function _isOver(w,x,y){if(!w.domNode){return false;}var pos=_D.position(w.domNode,true);return((pos.y<=y)&&(pos.x<=x)&&(pos.x+pos.w>=x)&&(pos.y+pos.h>=y));}function _findTouchDroppable(t,x,y){var el=document.elementFromPoint(x,y);var w=_D.findWidget(el);while(w){if(w.dropZone){if(w.allowDrop&&w.allowDrop(t)){return w;}}w=w.parent;}return null;}mstrmojo.qb.DBTableRow=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.qb.DBTableRow",indent:0,text:"",checkBox:false,draggable:true,ownAvatar:true,dropZone:true,cxtmenus:null,allowDrop:function allowDrop(ctxt){return true;},ondrop:function ondrop(c){var srcw=c.src.widget,tgtw=c.tgt.widget,qdl=mstrmojo.all.QBuilderModel;if(srcw.domNode.className.indexOf("mstrmojo-qb-DBTableRow")<0){return ;}if(srcw.srcID==tgtw.srcID){return ;}var linker=this.parent.parent.parent.parent.linker;var cb={success:function(){linker.drawLinks();},failure:function(){}};if(qdl.joinsInfo[srcw.srcID+tgtw.srcID]){qdl.addLink(srcw,tgtw,srcw.srcID+tgtw.srcID,cb);}else{if(qdl.joinsInfo[tgtw.srcID+srcw.srcID]){qdl.addLink(tgtw,srcw,tgtw.srcID+srcw.srcID,cb);}else{qdl.addJoin(srcw,tgtw,0,null,cb);}}},_leftPos:0,_topPos:0,movable:false,dropTarget:null,markupString:'<div id="{@id}" class="mstrmojo-qb-DBTableRow {@cssClass}" style="{@cssText}" mstrAttach:click,dblclick></div>',markupMethods:{ontextChange:function(){this.domNode.innerHTML=_makeTable(this.text,this.indent,this.images,this.selected,null,null,this.cxtmenus);}},getDragData:function(c){var d=new Object();if(this.domNode){d.html=_makeTable(this.text,this.indent,this.images,this.selected,this.domNode.offsetHeight,this.domNode.offsetWidth);d.n=this.text;}return d;},ondragstart:function(c){var n=c.src.node,tn=this.domNode;if(_D.contains(tn,n,true,document.body)){if(_D.isWK){document.onselectstart=function(e){e.preventDefault();return false;};}this.domNode.style.cssText="opacity:0.3; filter: alpha(opacity=30);";_pos=_D.position(this.domNode);_showAvatar(_makeTable(this.text,this.indent,this.images,this.selected,this.domNode.offsetHeight,this.domNode.offsetWidth),_pos);return true;}else{return false;}},ondragmove:function(c){var e=c.tgt.pos,s=c.src.pos,dx=e.x-s.x,dy=e.y-s.y;_updateAvatar({x:e.x+5,y:e.y+5},true,_makeTable(this.text,this.indent,this.images,this.selected,this.domNode.offsetHeight,this.domNode.offsetWidth));},ondragend:function(c){if(_D.isWK){document.onselectstart=function(e){return true;};}if(this.domNode){this.domNode.style.cssText="opacity:1; filter: alpha(opacity=100);";}_hideAvatar();},onclick:function(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement;if(tgt.type=="checkbox"){if(this.onCheck){this.onCheck(tgt.checked);}}}});})();