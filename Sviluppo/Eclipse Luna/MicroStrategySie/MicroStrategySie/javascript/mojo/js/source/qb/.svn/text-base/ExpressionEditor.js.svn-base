(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.Editor","mstrmojo.List","mstrmojo.SaveAsEditor","mstrmojo.ME.MetricEditBox","mstrmojo.ME.FunctionSelector","mstrmojo.qb.FunctionWizard","mstrmojo.MenuButton","mstrmojo.qb.FFsqlToken","mstrmojo.array");var _S=mstrmojo.string,_D=mstrmojo.dom,_C=mstrmojo.css,_H=mstrmojo.hash,_R=mstrmojo.range,$A=mstrmojo.array,qdl=mstrmojo.all.QBuilderModel;_VSTATUS={VALID:0,UNKNOWN:1,VALIDATING:2,ERROR:3},_VSTATUSCSS={0:"valid",1:"unknown",2:"validating",3:"error"},_VSTATUSDESC={0:mstrmojo.desc(9105,"Valid Expression Formula."),1:mstrmojo.desc(9106,"Require Validation?"),2:mstrmojo.desc(9107,"Validation in Progress..."),3:mstrmojo.desc(9108,"Validation Failed with Syntax Error")};var ENUM_EXPRESSION_TYPE_NEW_COLUMN=0,ENUM_EXPRESSION_TYPE_EXISTING_COLUMN=3;function _mapErrorCode(code){if(!code){return _VSTATUS.VALID;}return{"-2147214845":_VSTATUS.ERROR}[code]||_VSTATUS.ERROR;}function _getTokensAsString(its){var sa=[],i,j;for(i=0,len=its.length;i<len;i++){sa[i]=its[i].v;}return sa.join("").replace(/<\s/g,"<").replace(/>\s/g,">");}function _validateExpression(validateOnly,callbacks,cIndex){var tksXML="",qbrex=1,expr="",vo=null,ib=this.exprEditBox.inputBox;if(ib.doubleByte){expr=ib.editNode.innerText||ib.editNode.textContent;ib.ime=false;}else{if(this.oi.type!==0&&this.oi.type!==3){expr=_getTokensAsString(ib.items);qbrex=2;}else{tksXML=_getTokenStreamXML(ib.items);}}if(validateOnly){vo=1;}var me=this;mstrApp.getRootController().parseExpression({expr:expr,tKnStrm:tksXML,isNew:true,qbrex:qbrex,vo:vo,cIndex:cIndex},{success:function(res){if(res&&res.mi&&res.mi.tknstrm.mi){var stp=res.mi.exp.sqltp;if(stp!=null){me.sqltp=stp;}me.exprEditBox.handleValidation(res.mi,!validateOnly);if(!res.mi.reject_error_code&&callbacks&&callbacks.success){callbacks.success(res);}else{callbacks&&callbacks.failure&&callbacks.failure();}}}});}function _getTokenStreamXML(tks){var tks=_postprocessTokenStram(tks);var props={v:true,tp:true,lv:true,n:true,did:true,t:true,st:true,cn:true,mi:true,omit:true,extra:true,tknctx:true,sqlti:true,tindex:true,cli:true,sta:true,tindex:true,ix:true},config={getArrItemName:function(n,v,i){return"tkn";},isSerializable:function(nodeName,jsons,index){return(props[nodeName])?true:false;}};return mstrApp.getRootController().exprjson2xml("mi",tks,config);}function _preprocessTokenStram(tokens){var len=tokens.length,last=tokens[len-1];if(last&&last.tp===-1){tokens.pop();}if(tokens[0]&&(tokens[0].tp===64||(tokens[0].tp===36&&tokens[0].v==="$"))){tokens.splice(0,1);}}function _postprocessTokenStram(tks){var its=tks,len=its.length,last=its[its.length-1],i,it,newItems=[],newV="";if(its[0]&&its[0].tp!==64){newItems.push({v:"",tp:64,lv:3,sta:1});}for(i=0,len=its.length;i<len;i++){it=its[i];if(!it.oi){newV+=it.v;}else{if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}it.lv=1;it.tp=2;it.sta=1;newItems.push(it);}}if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}if(last&&last.tp!==-1){newItems.push({v:"",tp:-1,lv:2,sta:1});}return{omit:newItems,cn:newItems.length};}function brackets(s){return["[",s,"]"].join("");}mstrmojo.qb.ExpressionEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.qb.ExpressionEditor",cssClass:"mstrmojo-MetricEditor",zIndex:70,title:mstrmojo.desc(4449,"Expression"),functionSelector:{scriptClass:"mstrmojo.ME.FunctionSelector"},wizard:{scriptClass:"mstrmojo.qb.FunctionWizard"},model:null,onfunclistChange:function onfunclistChange(){this.toolBox.toolBar.func.set("cm",[{n:mstrmojo.desc(9925,"Functions"),did:-3,fns:this.funclist}]);},onOpen:function onOpen(){var me=this,oi=this.oi,meb=this.exprEditBox,tib=meb.inputBox;tib.customFunctionMode=false;tib.doubleByte=false;oi.isSave=false;this.set("funclist",(this.funclist||mstrApp.getRootController().getFunctionList()));var cds={items:mstrApp.getRootController().getSuggestionItems(false),isComplete:true};tib.set("candidates",cds);me.set("candidates",cds);meb.set("iStatus","");meb.set("vStatus",0);var expressionTitle={0:mstrmojo.desc(4449,"Expression"),1:mstrmojo.desc(9109,"Filter Expression"),3:mstrmojo.desc(4449,"Expression")},HelpTopic={0:(mstrApp.helpTopics&&mstrApp.helpTopics.expression)||"expression_dialog_box.htm",3:(mstrApp.helpTopics&&mstrApp.helpTopics.expression)||"expression_dialog_box.htm"};this.set("title",[expressionTitle[oi.type]||"",oi.n].join(""));this.set("help",HelpTopic[oi.type]||((mstrApp.helpTopics&&mstrApp.helpTopics.condition)||"new_condition_dialog_box.htm"));var tkn;if(oi&&(tkn=_H.clone(oi.tkn))){_preprocessTokenStram(tkn);tib.set("items",tkn);}},onClose:function onClose(){var inputbox=this.exprEditBox.inputBox;inputbox.set("items",[]);inputbox.itemcount=0;},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-toolBox",alias:"toolBox",children:[{scriptClass:"mstrmojo.Label",cssText:"font-size: 10pt",text:mstrmojo.desc(4449,"Expression")+":"},{scriptClass:"mstrmojo.ToolBar",cssClass:"mstrmojo-oivmSprite grouped",alias:"toolBar",cssText:"float: right",children:[{scriptClass:"mstrmojo.MenuButton",alias:"func",iconClass:"tbInsert",title:mstrmojo.desc(2919,"Insert"),zIndex:80,itemIdField:"did",itemField:"n",itemChildrenField:"fns",isSeparatorItem:function isSeparatorItem(item){return item[this.itemIdField]===-1;},executeCommand:function executeCommand(item){var me=this.parent.parent.parent,meb=me.exprEditBox.inputBox;if(item.did===-999){me.openPopup("functionSelector",{functions:me.funclist,zIndex:me.zIndex+10,openWizard:function(item){me.openPopup("wizard",{fctOi:item,zIndex:me.zIndex+10,insertOnFinish:function(tks){meb.insertTokens(tks);}});}});}else{me.openPopup("wizard",{fctOi:item,zIndex:me.zIndex+10,insertOnFinish:function(tks){meb.insertTokens(tks);}});}}},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(9110,"Syntax Validation"),iconClass:"tbValidate",onclick:function(evt){var me=this.parent.parent.parent;_validateExpression.call(me,true,null,1);}},{scriptClass:"mstrmojo.Button",title:mstrmojo.desc(2827,"Clear"),iconClass:"tbClear",onclick:function(evt){var me=this.parent.parent.parent,empty=[];me.oi.tkn=empty;me.exprEditBox.inputBox.clearTokens(empty);}}]}]},{scriptClass:"mstrmojo.ME.MetricEditBox",alias:"exprEditBox",children:[{scriptClass:"mstrmojo.ME.TokenInputBox",alias:"inputBox",slot:"editNode",cssText:"height:100px;",browseItemVisible:false,renderBlockSize:1000,item2textCss:function item2textCss(data){return{11:" mstrmojo-ArchitectListIconSuggest t11 ",26:" mstrmojo-ArchitectListIconSuggest t26 "}[data.t]||"";},itemFunction:function itemFunction(item,idx,w){return new mstrmojo.ME.MetricToken({data:item,brackets:brackets,isDelimiter:function isDelimiter(){return this.data.isDelimiter||(this.length()===1&&mstrmojo.qb.FFsqlToken.isDelimiter(this.data.v));}});},isDelimiter:mstrmojo.qb.FFsqlToken.isDelimiter}],markupMethods:{onvStatusChange:function(){var s=this.vStatus,vn=this.vStatusNode;vn.className="mstrmojo-MEBox-vStatus "+_VSTATUSCSS[s];vn.innerHTML=_VSTATUSDESC[s];},oniStatusChange:function(){this.iStatusNode.innerHTML=this.iStatus;}},handleValidation:function handleValidation(r,isSaved){if(!r){this.set("vStatus",_VSTATUS.ERROR);return ;}r.vs=_mapErrorCode(r.reject_error_code);this.set("vStatus",r.vs);this.set("iStatus",r.reject_error_description||"");var tkns=r.tknstrm.mi.tkn;var n_tkns=[],tokenvalue,SEP=".",speratorIndex,tbn;$A.forEach(tkns,function(tk,idx){n_tkns[idx]={};if(tk.tp===304&&!/^'.*'$/.test(tk.v)){tk.v=["'",tk.v,"'"].join("");}if(tk.tknctx){tokenvalue=tk.v;speratorIndex=tokenvalue.lastIndexOf(SEP);if(speratorIndex<1){tbn=tk.extra.sqlti.als;tk.v=brackets([tbn,SEP,tokenvalue].join(""));n_tkns[idx].oi={tn:tbn,rn:tokenvalue,tp:26};}else{tk.v=brackets(tokenvalue);n_tkns[idx].oi={tn:tokenvalue.slice(0,speratorIndex),rn:tokenvalue.slice(speratorIndex+1),tp:26};}}if(tk.orf){n_tkns[idx].oi=tk.orf;tk.v=[" ",tk.v," "].join("");}n_tkns[idx].v=!tk.v||(typeof tk.v)==="string"?tk.v:tk.v.toString();n_tkns[idx].sta=tk.sta;});this.inputBox.set("items",n_tkns);if(!isSaved){this.inputBox.focus();}}},{scriptClass:"mstrmojo.HBox",cssText:"float: right; border-collapse: separate;margin:10px 0px;",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(5891,"Save"),onclick:function(){var me=this.parent.parent,oi=me.oi,exprtype=oi.type,rw=mstrmojo.all[oi.did],wce=oi.w,ib=me.exprEditBox.inputBox,expr_s=_getTokensAsString(ib.items);oi.isSave=true;var setExpression=function setExpression(res){_validateExpression.call(me,false,{success:function(){mstrApp.getRootController().updateTableViewWithExpression(res.cIndex,ib.items);me.close();}},res.cIndex);};switch(exprtype){case ENUM_EXPRESSION_TYPE_NEW_COLUMN:_validateExpression.call(me,true,{success:function success(){mstrApp.getRootController().addSelectedColumn(wce,expr_s,{success:setExpression});}},1);break;case ENUM_EXPRESSION_TYPE_EXISTING_COLUMN:setExpression({cIndex:oi.cIndex});break;default:_validateExpression.call(me,true,mstrmojo.func.wrapMethods(oi.callbacks,{success:function success(res){me.close();}}));}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var me=this.parent.parent;me.close();}}]}]});})();