(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._FillsBrowser","mstrmojo._HasLayout","mstrmojo._HasPopup","mstrmojo.Box","mstrmojo.Table","mstrmojo.Image","mstrmojo.Button","mstrmojo.qb.SplitPanel","mstrmojo.qb.VSplitPanel","mstrmojo.qb.QBuilderModel","mstrmojo.WH.WHPanel","mstrmojo.qb.QBPanel","mstrmojo.qb.QBMappings","mstrmojo.qb.MissingColumnWarning","mstrmojo.form","mstrmojo.hash","mstrmojo.array","mstrmojo.qb.Toolbar","mstrmojo.qb.QBPageLayout","mstrmojo.qb.Footer","mstrmojo.DI.DIExitOptions");var $H=mstrmojo.hash;var ENUM_REFRESH_OPTION_REPLACE=1,ENUM_REFRESH_OPTION_KEEP_AND_ADD=2,ENUM_REFRESH_OPTION_UPDATE_AND_ADD=4;var refreshOptionItems=[{did:ENUM_REFRESH_OPTION_REPLACE,n:mstrmojo.desc(9117,"Replace existing data")},{did:ENUM_REFRESH_OPTION_UPDATE_AND_ADD,n:mstrmojo.desc(9118,"Update existing data and add new data")},{did:ENUM_REFRESH_OPTION_KEEP_AND_ADD,n:mstrmojo.desc(9119,"Keep existing data and add new data")}];var REFRESH_OPTION_ID="qb-refresh-option",refreshOptionConfig={scriptClass:"mstrmojo.Editor",id:REFRESH_OPTION_ID,cssClass:"mstrmojo-qb-refreshoption-editor",showTitle:true,title:mstrmojo.desc(9120,"Options - Data Refresh"),zIndex:9999,onoptionChange:function onoptionChange(){this.radiolist.singleSelectByField(this.option,"did");},children:[{scriptClass:"mstrmojo.Label",cssClass:"instruction",text:mstrmojo.desc(9121,"Choose data refresh policy:")},{scriptClass:"mstrmojo.RadioList",alias:"radiolist",cssClass:"optionlist",itemCssClass:"optionlist-item",items:refreshOptionItems},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button OK",text:mstrmojo.desc(1442,"OK"),onclick:function onclick(evt){var editor=this.parent.parent;mstrApp.getRootController().setRefreshOption(editor.radiolist.selectedItem.did);editor.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){this.parent.parent.close();}}]}]};var EXPR_EDITOR_ID="qbexpr",exprEditorConfig={scriptClass:"mstrmojo.qb.ExpressionEditor",id:EXPR_EDITOR_ID};var SPACE_SEP=" ",PERIOD_SEP=".";function processName(input,pattern){if(!pattern){return input;}return(input.indexOf(SPACE_SEP)>-1||input.indexOf(PERIOD_SEP)>-1)?pattern.replace("#0",input):input;}function composeSQLTokens(namespace,tablename,columns){var tokens=[],ff=mstrmojo.all.FFsql,existingcount,count,len=columns.length,items=ff.items,notLastColumn,whtree=this.main.WHTableTree,columnpattern=whtree.getDBRole(whtree.getDBRoleID()).cpat;existingcount=count=ff.itemCount;tokens.push({isNew:true,v:"select",oi:{n:"select",sta:100,t:100},did:count++},{isNew:true,v:" ",isDelimiter:true,did:count++});mstrmojo.array.forEach(columns,function(column,idx){tokens.push({isNew:true,v:processName(column.cln,columnpattern),did:count++});notLastColumn=idx<len-1;if(notLastColumn){tokens.push({isNew:true,v:",",isDelimiter:true,did:count++});}tokens.push({isNew:true,v:"\n",isDelimiter:true,did:count++});if(notLastColumn){tokens.push({isNew:true,v:" ",isDelimiter:true,did:count++});}});tablename=processName(tablename,columnpattern);tokens.push({isNew:true,v:"from",oi:{n:"from",sta:100,t:100},did:count++},{isNew:true,v:" ",isDelimiter:true,did:count++},{isNew:true,v:(namespace?processName(namespace,columnpattern)+PERIOD_SEP+tablename:tablename),did:count++},{isNew:true,v:";",did:count++});if(existingcount>0&&items[existingcount-1]!=="\n"){items.push({isNew:true,v:"\n",isDelimiter:true,did:count++});}items=items.concat(tokens);ff.itemCount=count;ff.set("items",items);ff.updatepasses();}mstrmojo.qb.QBuilderPage=mstrmojo.declare(mstrmojo.Container,[mstrmojo._FillsBrowser,mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.qb.QBuilderPage",markupString:'<div id="{@id}" class="mstrmojo-qb {@cssClass}" style="{@cssText}"><div class="mstrmojo-qb-toolbar"></div><div class="mstrmojo-qb-layout"></div><div class="mstrmojo-qb-footer"></div></div>',markupSlots:{toolbar:function(){return this.domNode.firstChild;},layout:function(){return this.domNode.children[1];},footer:function(){return this.domNode.lastChild;}},layoutConfig:{h:{toolbar:"25px",footer:"44px",layout:"100%"},w:{toolbar:"100%",footer:"100%",layout:"100%"}},id:"QBuilderPage",onError:mstrmojo.emptyFn,renderPageLoadError:function renderPageLoadError(){var err=this.error,message=err.message,title=err.title,buttons=err.btns;this.onError(err);if(!buttons||!buttons.length){mstrmojo.alert(message,null,title);}else{mstrmojo.confirm(message,buttons,title);}},render:function render(){if(this.error){this.renderPageLoadError();}else{this._super();}},saveasRef:{scriptClass:"mstrmojo.SaveAsEditor",help:(mstrApp.helpTopics&&mstrApp.helpTopics.saveAs)||"Save_As_dialog_box.htm",typeDesc:mstrmojo.desc(3377,"Object"),browsableTypes:"3,8",showCompletePath:false,onObjectSaved:function(o){var p=this.opener,oi=p&&p.oi;if(p&&oi){oi.did=o.did;oi.n=o.name;oi.desc=o.desc;p.set("title","QBReport: "+o.name);}}},children:[{scriptClass:"mstrmojo.qb.Toolbar",slot:"toolbar",alias:"toolbarWidget"},{scriptClass:"mstrmojo.qb.QBPageLayout",slot:"layout",alias:"main"},{scriptClass:"mstrmojo.qb.Footer",slot:"footer",alias:"footerWidget"}],openDialog:function openDialog(config){this.openPopup(config);},openRefreshOptionDialog:function openRefreshOptionDialog(opt){var refreshOptionEditor=mstrmojo.all[REFRESH_OPTION_ID]||mstrmojo.insert(refreshOptionConfig);refreshOptionEditor.open();refreshOptionEditor.set("option",opt||ENUM_REFRESH_OPTION_REPLACE);},openExpressionEditor:function openExpressionEditor(obj){var exprEditor=mstrmojo.all[EXPR_EDITOR_ID]||mstrmojo.insert(exprEditorConfig);exprEditor.set("oi",$H.copy(obj,{mhfts:{},mvfts:{}}));exprEditor.open();},addSQLFromColumn:function addSQLFromColumn(column){composeSQLTokens.call(this,column.ns,column.tbn,[column]);},addSQLFromTable:function addSQLFromTable(ns,tbn,its){composeSQLTokens.call(this,ns,tbn,its);},getSQLStatement:function getSQLStatement(){return mstrmojo.all.FFsql.getSQLstmt();},toggleDatabaseView:function toggleDatabaseView(show){this.main.set("leftItemVisible",show);},toggleDataPreview:function toggleDataPreview(show){this.main.workPanel.set("bottomItemVisible",show);},setDBRoleID:function setDBRole(evt){this.main.WHTableTree.setDBRoleID(evt.value);},loadView:function loadView(){this.main.WHTableTree.load();this.toggleDataPreview(true);this.toggleDataPreview(false);},showRedirectionPage:function showRedirectionPage(reportID,path){this.set("children",[{scriptClass:"mstrmojo.Label",slot:"toolbar",text:"Data Imported",cssClass:"mstrmojo-qb-title"},{scriptClass:"mstrmojo.Image",cssClass:"mstrmojo-qb-toolbarIcon help",slot:"toolbar",title:mstrmojo.desc(1143,"help"),onclick:function(){var url=(mstrApp.helpUrl||"../help/")+"WebUser/WebHelp/Lang_"+(mstrApp.helpLocaleId?mstrApp.helpLocaleId:mstrApp.localeId)+"/"+(mstrApp.userHelpPage||"MicroStrategy_Web_Help.htm")+"#"+((mstrApp.helpTopics&&mstrApp.helpTopics.general)||"About_importing_data.htm");window.open(url);}},{scriptClass:"mstrmojo.DI.DIExitOptions",privileges:{CreateViewReport:mstrConfig.canCreateReport,CreateReportServices:mstrConfig.canCreateDocument,CreateAnalysis:mstrConfig.canCreateAnalysis},model:{cubeID:reportID,path:path},slot:"layout"},{scriptClass:"mstrmojo.qb.Footer",slot:"footer",alias:"footerWidget"}]);this.footerWidget.hidePublish();},browserResized:function browserResized(size){var nw=parseInt(size.w,10)-15+"px";var nh=parseInt(size.h,10)-70+"px";if(this.height&&nh!==this.height){this.set("height",nh);}else{this.height=nh;}if(this.width&&nw!==this.width){this.set("width",nw);}else{this.width=nw;}return true;}});})();