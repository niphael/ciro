(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.string","mstrmojo.form","mstrmojo.qb.ExpressionEditor","mstrmojo.qb.MissingColumnWarning","mstrmojo.qb.DataService");mstrmojo.requiresDescs(9945,9946,9926,219,218,1442,9220,9221,9222,9223,9224,9225,9226,9227,9228,9229,9230);var _S=mstrmojo.string,_H=mstrmojo.hash,_A=mstrmojo.array,_C=mstrmojo.css,$DESC=mstrmojo.desc,$DECODEHTML=_S.decodeHtmlString;var _DEFAULT_TEMPLATE_ID="A61B85F4485D3B953003B195E58B5138";var _twipPerPixel=15;var ENUM_OBJECT_TYPE_ATTRIBUTE=12,ENUM_OBJECT_TYPE_METRIC=4;var ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE=1,ENUM_LOAD_REPORT_BROWSE_TYPE_SQLPREVIEW=2,ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW=4,ENUM_LOAD_REPORT_BINDING_FLAG_ALL=15,ENUM_LOAD_REPORT_BINDING_FLAG_TABLE_AND_DBTABLE=1,ENUM_LOAD_REPORT_BINDING_FLAG_REPORT=2,ENUM_LOAD_REPORT_BINDING_FLAG_TEMPLATE=4,ENUM_LOAD_REPORT_BINDING_FLAG_COLUMN=8,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo=1,ENUM_LOAD_REPORT_PREVIEW_FLAG_DataInfo=2,ENUM_LOAD_REPORT_PREVIEW_FLAG_SourceInfo=8,ENUM_LOAD_REPORT_PREVIEW_FLAG_SheetsInfo=16,ENUM_LOAD_REPORT_AUTOMAP_TRIGGER=1,ENUM_LOAD_REPORT_AUTOMAP_NOT_TRIGGER=0;var ENUM_EXPRESSION_TYPE_COLUMN=1,ENUM_EXPRESSION_TYPE_WHERE=2,ENUM_EXPRESSION_TYPE_JOIN=3,ENUM_EXPRESSION_TYPE_HAVING=4;var ENUM_PARSE_TYPE_WHERECLAUSE=2,ENUM_PARSE_TYPE_HAVINGCLAUSE=4;var ENUM_ERROR_OBJECT_NOT_FOUND="-2147216373";var MSI_SERVER_NAME_NOT_INITIALIZED=2147760371,MSI_INVALID_SESSION_ID=2147760372,E_MSI_USERMGR_USER_NOTFOUND=2147758245,E_MSI_CONNECT_FAILED=2147759877;function isSessionExpiredError(res){var c=res&&res.getResponseHeader("X-MSTR-TaskErrorCode");c=(c<0)?(4294967296+parseInt(c,10)):c;switch(c){case MSI_SERVER_NAME_NOT_INITIALIZED:case MSI_INVALID_SESSION_ID:case E_MSI_USERMGR_USER_NOTFOUND:case E_MSI_CONNECT_FAILED:return true;}return false;}function _manageError(res,fn){if(isSessionExpiredError(res)){if(mstrApp.isCloudPro){rrOpenHomePage&&rrOpenHomePage();}else{mstrmojo.form.send({evt:"3010"},mstrApp.name,"POST",null,null,false);}}else{var msg=res.getResponseHeader("X-MSTR-TaskFailureMsg");if(msg){msg=(msg.length>2000)?msg.substring(0,2000)+"...":msg;mstrmojo.alert(msg.replace(/com\.microstrategy(\.\w+)*: \(?/,"").replace(/\)$/,""),fn);}else{msg=res.responseText;msg=msg&&msg.match(/\[HttpException \(0x80004005\): (.)+\]/);mstrmojo.alert((msg&&msg[0]&&msg[0].replace(/\[HttpException \(0x80004005\): |\]/gi,""))||"Request timed out.");}}}function preprocessTokenStream(tokens){if(!tokens||!tokens.length){return ;}var last=tokens[tokens.length-1];if(last&&last.tp===-1){tokens.pop();}if(tokens[0]&&(tokens[0].tp===64||(tokens[0].tp===36&&tokens[0].v==="$"))){tokens.splice(0,1);}var SINGLE_QUOTE="'";_A.forEach(tokens,function(token){(token.tp===304)&&(token.v=SINGLE_QUOTE+token.v+SINGLE_QUOTE);});}function getTokensAsString(tokens){var sa=[];_A.forEach(tokens,function(token){sa.push(token.v);});return sa.join(" ").replace(/<\s/g,"<").replace(/>\s/g,">");}function _getOp(expression){var operators={">=":2,"<>":5,"<=":4,"<":3,">":1},op;for(op in operators){if(expression.indexOf(op)>-1){return operators[op];}}return 0;}function sliceFunctions(fcts){var fs=function(a,b){return mstrmojo.array.stringSorter(a.n||a.did,b.n||b.did);},i,len,myFunctions=[];_A.forEach(fcts,function(currentFunctionCategory){_A.forEach(currentFunctionCategory.fns,function(currentFunction){if(_A.indexOf(PREDEFINED_FUNCTION_IDS,currentFunction.did)>-1){currentFunctionCategory.fns=currentFunctionCategory.fns.sort(fs);myFunctions.push(currentFunctionCategory);return false;}});});myFunctions=myFunctions.sort(fs);return myFunctions;}var _fns={1:"Sum",2:"Avg",3:"Min",4:"Max",5:"Count",6:"Count<Distinct=true>"};var PREDEFINED_FUNCTION_IDS=["8107C31BDD9911D3B98100C04F2233EA","6F7DF5F8449111D5BEA300B0D01A55EF","4A257916A153468384320E8DB7FD338B","8107C345DD9911D3B98100C04F2233EA","6F7DF605449111D5BEA300B0D01A55EF","8107C324DD9911D3B98100C04F2233EA","F262C81CDDA611D3B98100C04F2233EA"];function removeTableFromCondition(condition,tablename){if(!condition){return false;}var nds=condition.nds;if(nds){var indices=[],index,length;_A.forEach(nds,function(node,idx){removeTableFromCondition(node,tablename)&&indices.push(idx);});for(index=indices.length-1;index>-1;index--){nds.splice(indices[index],1);}length=nds.length;if(length===1){condition=nds[0];}return(length===0);}var requireDelete;_A.forEach(condition.expr,function(token){oi=token.tknctx&&token.tknctx.oi;if(oi&&oi.tp===26&&tablename===token.extra.sqlti.als.toLowerCase()){requireDelete=true;return false;}});if(!requireDelete){_A.forEach(condition.cols,function(column){if(tablename===column.t.toLowerCase()){requireDelete=true;return false;}});}return requireDelete;}function updateTableAliasInCondition(oldname,newname,condition){if(!condition){return ;}var tokens=condition.expr,oi,cols=condition.cols;_A.forEach(tokens,function(token){oi=token.tknctx&&token.tknctx.oi;if(oi&&oi.tp===26){if(token.extra.sqlti.als===oldname){token.extra.sqlti.als=newname;token.v=(token.v+"").replace(oldname,newname);}}});_A.forEach(cols,function(token){if(token.t===oldname){token.t=newname;token.v=(token.v+"").replace(oldname,newname);}});condition.n=(condition.n+"").replace(oldname,newname);_A.forEach(condition.nds,function(node){updateTableAliasInCondition(oldname,newname,node);});}function getRowsWithFilter(rows,condition){rows=rows||{};if(!condition){return ;}var tokens=condition.expr,oi,tablename,cols=condition.cols;_A.forEach(tokens,function(token){oi=token.tknctx&&token.tknctx.oi;if(oi&&oi.tp===26){tablename=token.extra.sqlti.als.toLowerCase();rows[tablename]=rows[tablename]||{};rows[tablename][oi.n.toLowerCase()]=true;}});_A.forEach(cols,function(token){tablename=token.t.toLowerCase();rows[tablename]=rows[tablename]||{};rows[tablename][token.col.toLowerCase()]=true;});_A.forEach(condition.nds,function(node){getRowsWithFilter(rows,node);});}var _E=mstrmojo.expr,_ET=_E.ET,_BF=_E.BRANCH_FNS,OPs={19:" "+_BF[19]+" ",20:" "+_BF[20]+" ",21:"("+_BF[21]+"( "},NOT_SUFFIX="))";function getConditionExpr(condition){if(!condition){return"";}if(!condition.nds){return condition.n||"";}var exprStringArr=[],nds=condition.nds,fn=condition.fn,isNot;_A.forEach(nds,function(node,idx){isNot=node.not;if(idx!==0){exprStringArr.push(OPs[fn]);}isNot&&exprStringArr.push(OPs[21]);exprStringArr.push("(");exprStringArr.push(getConditionExpr(node));exprStringArr.push(")");isNot&&exprStringArr.push(NOT_SUFFIX);});return exprStringArr.join("");}function decodeHTMLString(input){return $DECODEHTML(input).replace(/&apos;/g,"'");}function _rmescp(s){return s.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;apos;/g,'"').replace(/&apos;/g,"'").replace(/^\n+|\n+$/g,"").replace(/\t/g," ").replace(/&amp;/g,"&");}var _typeOf=function(v){if(v==null){return"null";}var t=typeof (v);if(t!="object"){return t;}else{if(v.length===undefined){return"object";}else{return"array";}}};var _formats=[{n:"Text",v:"3"},{n:"Number",v:"2"},{n:"Date",v:"8"},{n:"Time",v:"9"},{n:"DateTime",v:"1"},{n:"URL",v:"5"},{n:"Email",v:"6"},{n:"HTML Tag",v:"7"},{n:"Symbol",v:"10"},{n:"Big Decimal",v:"11"},{n:"Phone Number",v:"12"}];function composeSQLToken(keyword){}function _getTokenStreamXML(expr){var newItems=[],xml=[];var props={mi:true,cn:true,v:true,tp:true,lv:true,sta:true,tkn:true};newItems.push({lv:3,sta:1,tp:64,v:""});newItems.push({lv:1,sta:1,tp:2,v:expr});newItems.push({lv:2,sta:1,tp:-1,v:""});var config={getArrItemName:function(n,v,i){return"tkn";},isSerializable:function(nodeName,jsons,index){return(props[nodeName])?true:false;}};xml.push('<mi cn="3">');xml.push(_S.json2xml("tkn",newItems[0],config));xml.push(_S.json2xml("tkn",newItems[1],config));xml.push(_S.json2xml("tkn",newItems[2],config));xml.push("</mi>");return xml.join("");}var EnumDSSBaseFormType_Reserved=0,EnumDSSBaseFormType_DateTime=1,EnumDSSBaseFormType_Number=2,EnumDSSBaseFormType_Text=3,EnumDSSBaseFormType_Picture=4,EnumDSSBaseFormType_Url=5,EnumDSSBaseFormType_Email=6,EnumDSSBaseFormType_HTMLTag=7,EnumDSSBaseFormType_Date=8,EnumDSSBaseFormType_Time=9,EnumDSSBaseFormType_Symbol=10,EnumDSSBaseFormType_BigDecimal=11,EnumDSSBaseFormType_PhoneNumber=12;var dataTypeToBaseFormType={0:EnumDSSBaseFormType_Reserved,1:EnumDSSBaseFormType_Number,2:EnumDSSBaseFormType_Number,3:EnumDSSBaseFormType_Number,4:EnumDSSBaseFormType_Number,5:EnumDSSBaseFormType_Number,6:EnumDSSBaseFormType_Number,7:EnumDSSBaseFormType_Number,8:EnumDSSBaseFormType_Text,9:EnumDSSBaseFormType_Text,10:EnumDSSBaseFormType_Text,11:EnumDSSBaseFormType_Text,12:EnumDSSBaseFormType_Text,13:EnumDSSBaseFormType_Text,14:EnumDSSBaseFormType_Date,15:EnumDSSBaseFormType_Time,16:EnumDSSBaseFormType_DateTime,17:EnumDSSBaseFormType_Text,18:EnumDSSBaseFormType_Text,30:EnumDSSBaseFormType_BigDecimal,31:EnumDSSBaseFormType_Reserved,33:EnumDSSBaseFormType_Reserved};function _getcolwids(model,cols){var ids=[],col,wid;for(var i=0,len=cols.length;i<len;i++){col=cols[i];if(model.uiids[col.tid+col.cid]){wid=model.uiids[col.tid+col.cid];ids.push(wid);}}return ids;}function _loadConditions(model,roo,arr,whe,sqltp,sysprompt){if(!roo.ftype){var exp=_rmescp(roo.exp);if(exp.indexOf("? aptqbr_prompt")>-1){sysprompt.push({n:exp});return ;}var wids=_getcolwids(model,_findSelectedColumns(whe,[])),rowWidget,cols=[];_A.forEach(wids,function(wid){rowWidget=mstrmojo.all[wid];rowWidget&&rowWidget.updateState&&rowWidget.updateState(2);cols.push({t:rowWidget.srcTable,col:rowWidget.text});});return arr.push({et:"*",n:exp,expr:[{v:exp}],sqltp:sqltp,cols:cols});}switch(roo.ftype){case 19:case 20:case 21:var tmp=[],opnd;for(var i=0,len=roo.children.length;i<len;i++){opnd=roo.children[i];_loadConditions(model,opnd,tmp,whe.chn[i],sqltp,sysprompt);}if(tmp.length==0){return ;}if(tmp.length<len&&tmp.length==1){arr.push(tmp[0]);}else{arr.push({et:14,fn:roo.ftype,nds:tmp,not:(roo.ftype==21),sqltp:sqltp});}break;default:break;}}function _getJoinPairs(roo,exp,arr){if(!exp.ftype){arr.push({lcid:roo.chn[0].col,rcid:roo.chn[1].col,exp:exp.exp});return exp.exp;}var exp1,exp2,exptxt;switch(exp.ftype){case 19:case 20:exp1=_getJoinPairs(roo.chn[0],exp.children[0],arr);exp2=_getJoinPairs(roo.chn[1],exp.children[1],arr);exptxt=exp1+((exp.ftype==19)?" AND ":" OR ")+exp2;break;case 21:exptxt=" NOT "+_getJoinPairs(roo.chn[0],exp.children[0],arr);break;default:break;}return exptxt;}function _findSelectedColumns(roo,cols){var chn=roo.chn;if(!chn){if(roo.col&&roo.stbid){cols.push({cid:roo.col,tid:roo.stbid});}return cols;}for(var i=0,len=chn.length;i<len;i++){cols=_findSelectedColumns(chn[i],cols);}return cols;}function _loadFFSQLReport(arr,maps,model){var sql=arr[arr.length-1].oi.def.csl.roo.chn[0].va.vv;sql=sql?_rmescp(sql):"";mstrApp.getRootController().raiseEvent({name:"reportModeChange",mode:2,value:sql});model.populateFFSQLMapping(maps);if(model.firstTimeLoading){model.raiseEvent({name:"dataPreview"});model.firstTimeLoading=false;}}function _loadExistingReport(res,model){if(!res||!res.btb){return ;}var arr=res.btb;var maps=res.datap.maps;if(model.firstTimeLoading){model.orimaps=maps;}model.refresh_opt=arr[0].oi.def.crpt;var dbrid=null;if(arr[0].oi.ext_type===304){model.set("isFFSQL",true);model.set("FFSQLMode",true);mstrApp.isFFSQL=mstrApp.isFFSQLMode=true;for(var i=0,len=arr.length;i<len;i++){if(arr[i].oi.tp===53){dbrid=arr[i].oi.def.dbr.did;}}dbrid&&model.setXDADBRole(dbrid);_loadFFSQLReport(arr,maps,model);return ;}var dbtables={},clns={},rpt,obj;for(var i=0,len=arr.length;i<len;i++){obj=arr[i].oi;switch(obj.tp){case 53:dbtables[obj.did]={cs:obj.def.cs.cs,tbn:decodeHTMLString(obj.def.tbn),did:obj.did,ns:obj.def.ns};break;case 26:clns[obj.did]={did:obj.did,cln:decodeHTMLString(obj.def.cln),dttp:obj.def.dt.tp,dtps:obj.def.dt.ps,dtsc:obj.def.dt.sc};break;case 3:rpt=obj.efd;break;default:break;}}var def=null,oi=null;for(var i=0,len=rpt.length;i<len;i++){oi=rpt[i].oi;switch(oi.tp){case 53:def=oi.def.sqs.c_c[0];dbrid=oi.def.dbr.did;break;default:break;}}model.setXDADBRole(dbrid);if(def===null){return ;}var selected=def.sqcs.c_c;var joins=def.sjs.c_c;var ts=def.stbs.c_c;var whe=def.whe;var cds=def.w_cond;var he=def.he;var hds=def.h_cond;model.selectedClns=[];model.dbtables=[];model.joins=[];model.joinsInfo={};model.uiids={};model.tables={};var selclns=model.selectedClns;var mps={},cols,exp,cid,tid,col;for(var i=0,len=selected.length;i<len;i++){if(selected[i].der&2147483648){selclns.push({isDerived:true,existing:true});continue;}cols=_findSelectedColumns(selected[i].exp.roo,[]);exp=decodeHTMLString(selected[i].exp.exp);selclns.push({wid:[],expr:[{v:exp}],existing:true});for(var j=0;j<cols.length;j++){col=cols[j];cid=col.cid;tid=col.tid;mps[tid]=mps[tid]||{};mps[tid][cid]=mps[tid][cid]||{};mps[tid][cid].state=1;mps[tid][cid].count=!mps[tid][cid].count?1:mps[tid][cid].count+1;selclns[i].wid.push(tid+cid);}}model.populateMappings(maps);model.raiseEvent({name:"dataPreview"});model.tbns={};var pos_hash=model.pos_hash;var tbns=model.tbns,tables=[];var t,dbtid,tf,cid,cs,ncs,als;for(var i=0,len=ts.length;i<len;i++){tables[i]={};t=ts[i];tid=t.id;dbtid=t.dbt.did;als=t.als?decodeHTMLString(t.als):dbtables[dbtid].tbn;cs=dbtables[dbtid].cs;if(pos_hash&&pos_hash[als]){tables[i].pos={w:pos_hash[als].w,h:pos_hash[als].h,t:pos_hash[als].t,l:pos_hash[als].l};}else{tf=t.sqltf;if(tf&&tf.length){tables[i].pos={w:tf[0].pdv/_twipPerPixel,h:tf[1].pdv/_twipPerPixel,t:tf[2].pdv/_twipPerPixel,l:tf[3].pdv/_twipPerPixel};}}ncs=[];for(var j=0,cnt=cs.length;j<cnt;j++){cid=cs[j].did;ncs.push(_H.copy(clns[cid]));if(mps[tid]&&mps[tid][cid]){ncs[j].state=1;ncs[j].count=mps[tid][cid].count;}}tables[i].did=tid;tables[i].cs=ncs;tables[i].tbn=als;tables[i].ns=dbtables[dbtid].ns;tables[i].dbtbn=dbtables[dbtid].tbn;tbns[als]=als;}if(model.firstTimeLoading){model.orits=tables.slice(0);}var originalTables=model.orits;_A.forEach(tables,function(table){if(_A.find(originalTables,"did",table.did)>-1){table.existing=true;}});model.raiseEvent({name:"BindingTableLoaded",value:tables});for(var i=0,len=selclns.length;i<len;i++){var wids=selclns[i].wid;if(wids){for(var j=0,cnt=wids.length;j<cnt;j++){wids[j]=model.uiids[wids[j]];}}}var join,ltid,rtid,jt,op,root,lcid,rcid,exp,jid,jcarr;for(var i=0,len=joins.length;i<len;i++){join=joins[i];ltid=join.ltid,rtid=join.rtid,jt=join.jt,idx=join.ix;root=join.cdn.roo;jcarr=[];exp=decodeHTMLString(_getJoinPairs(root,join.exp_bo,jcarr));jid=model.uiids[ltid]+model.uiids[rtid];model.joins.push(jid);model.joinsInfo[jid]=new Object();model.joinsInfo[jid].jt=""+jt;model.joinsInfo[jid].exp=exp;model.joinsInfo[jid].srctID=model.uiids[ltid];model.joinsInfo[jid].tgttID=model.uiids[rtid];if(!model.joinsInfo[jid].links){model.joinsInfo[jid].links=new Object();}if(model.tables[model.uiids[ltid]].njoins){model.tables[model.uiids[ltid]].njoins++;}else{model.tables[model.uiids[ltid]].njoins=1;}if(model.tables[model.uiids[rtid]].njoins){model.tables[model.uiids[rtid]].njoins++;}else{model.tables[model.uiids[rtid]].njoins=1;}for(var j=0;j<jcarr.length;j++){lcid=jcarr[j].lcid;rcid=jcarr[j].rcid;exp=decodeHTMLString(jcarr[j].exp);var srcwid=model.uiids[ltid+lcid],tgtwid=model.uiids[rtid+rcid];model.joinsInfo[jid].links[srcwid+tgtwid]={srcw:mstrmojo.all[srcwid],tgtw:mstrmojo.all[tgtwid],coords:[],exp:exp,jid:jid,op:_getOp(exp)};if(model.joinsInfo[jid].nlinks){model.joinsInfo[jid].nlinks++;}else{model.joinsInfo[jid].nlinks=1;}}}model.raiseEvent({name:"JoinsLoaded"});var arr=[],sysprompt=[];if(whe.exp!=""){_loadConditions(model,cds,arr,whe.roo,0,sysprompt);arr.length&&(model.conditions.where=arr[0]);}if(he.exp!=""){arr=[];_loadConditions(model,hds,arr,he.roo,1);arr.length&&(model.conditions.having=arr[0]);}model.firstTimeLoading=false;}function _removeIndex(clns,cIndex){var gap=1;if(clns[cIndex].existing){clns[cIndex].missing=true;gap=0;}else{clns.splice(cIndex,1);}return gap;}mstrmojo.qb.QBuilderModel=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.qb.QBuilderModel",id:"QBuilderModel",tables:new Object(),selLink:null,dbtbls:{},uiids:{},riid:"",analysisID:null,alertTitle:null,msgid:"",dbtables:[],selectedClns:[],joins:[],joinsInfo:new Object(),dbrs:[],dsns:[],drivers:[],dbms:[],suppdbs:[],pos_hash:{},bindingT:[],tbns:{},catalogRefresh:false,SelDBRoleID:null,isDI:false,FFSQLMode:false,isFFSQL:false,isCloud:false,supportTimeGeo:true,isCubeReport:true,autoRefreshSQL:false,isDirty:false,SQLPreviewStmt:"",SQLstmt:"",refresh_opt:1,mappings:[],cloneMappings:[],dataset:[],cacheMP:[],cacheDS:[],conditions:new Object(),cnum:0,datatypes:_formats,addLink:function addLink(srcw,tgtw,jid,callbacks){var mdl=this,key=srcw.id+tgtw.id,links=mdl.joinsInfo[jid].links;var jIndex=this.getjIndex(jid),lexp=this.brackets(srcw.oriexpr)+"="+this.brackets(tgtw.oriexpr),jexp="";if(mdl.joinsInfo[jid].exp){jexp=mdl.joinsInfo[jid].exp+" AND "+lexp;}else{jexp=lexp;}var cbexpr={success:function(res){mdl.joinsInfo[jid].exp=jexp;links[key]=new Object();links[key].srcw=srcw;links[key].tgtw=tgtw;links[key].coords=[];links[key].exp=lexp;links[key].jid=jid;mdl.joinsInfo[jid].exp=jexp;if(callbacks&&callbacks.success){callbacks.success();}}};mdl.parseExpression(false,1,null,jIndex,ENUM_EXPRESSION_TYPE_JOIN,jexp,null,cbexpr);},removeLink:function removeLink(linkid,jid,callbacks){var mdl=this,links=mdl.joinsInfo[jid].links,jIndex=this.getjIndex(jid),jexp="";for(var k in links){if(k!==linkid){if(jexp){jexp+=" AND "+links[k].exp;}else{jexp=links[k].exp;}}}if(!jexp){mdl.removeJoin(jid,callbacks);}else{var cbexpr={success:function(res){mdl.joinsInfo[jid].exp=jexp;delete links[linkid];if(callbacks&&callbacks.success){callbacks.success();}}};mdl.parseExpression(false,1,null,jIndex,ENUM_EXPRESSION_TYPE_JOIN,jexp,null,cbexpr);}},getTouchValue:function getTouchValue(x,y){for(var j in this.joinsInfo){var links=this.joinsInfo[j].links;for(var elem in links){var coordsArray=links[elem].coords;if(this.inPoly(coordsArray,x,y)){return[j,elem];}}}return null;},inPoly:function inPoly(poly,px,py){var npoints=poly.length;var xnew,ynew,xold,yold,x1,y1,x2,y2,i;var inside=false;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)==(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;},exprEditor:function(w,type,widget,cIndex){var id="mstrQB",me=this,fcts=null,openME=function(oi){_hideWaitPage();var ae=mstrmojo.all[id];if(!ae){ae=new mstrmojo.qb.ExpressionEditor({id:id,oi:oi,funclist:fcts,model:me});}else{ae.set("oi",oi);}ae.open();},failure=function(res){_hideWaitPage(true);_manageError(res);},fsuccess=function(res){try{fcts=res;if(!w){openME({n:"New Condition Expression",type:type,w:widget,tks:{tkn:[],vs:0,vm:""},mhfts:{},mvfts:{}});}else{if(type==3){openME({did:"editsc",n:"Edit Column "+cIndex,type:type,w:w,cIndex:cIndex,tks:{tkn:w.expr,vs:0,vm:""},mhfts:{},mvfts:{}});}else{if(w.id&&!w.length){var rowID=w.id;openME({did:rowID,n:mstrmojo.all[rowID].oriexpr,w:w,type:type,cIndex:cIndex,tks:{tkn:mstrmojo.all[rowID].expr,vs:0,vm:""},mhfts:{},mvfts:{}});}else{openME({did:"mod",n:"Modify Condition Expression",type:type,w:widget,tks:{tkn:w,vs:0,vm:""},mhfts:{},mvfts:{}});}}}}catch(ex){}};_showWaitPage();this.getFunctions({success:fsuccess,failure:failure});},brackets:function(s){return"["+s+"]";},isEquivalentExpr:function(exp1,exp2){var updateString=function updateString(input){return input.replace(/\s/g,"").replace(/\[+(.*?)\]+/g,"$1").replace(/\(+(.*?)\)+/g,"($1)").toUpperCase();};return(updateString(exp1)===updateString(exp2));},_set_SelDBRoleID:function(n,v){var chg=(this.SelDBRoleID!==v);this.SelDBRoleID=v;if(chg){this.raiseEvent({name:"dbroleChange",value:v});this.setDBRole(v);}return chg;},autoMap:function(callbacks,silent,previewOnly){var mdl=this;if(!mdl.FFSQLMode){if(mdl.getColumnsCount()===0){mstrmojo.alert($DESC(9945,"Please add at least one column and try again."),null,mdl.alertTitle);if(callbacks&&callbacks.failure){callbacks.failure();}return ;}else{if(mdl.getTablesCount()===0){mstrmojo.alert($DESC(9946,"Please add at least one table and try again."),null,mdl.alertTitle);if(callbacks&&callbacks.failure){callbacks.failure();}return ;}}}var cb2={success:function(res){mdl.isDirty=false;if(!silent){var datap=res.datap,maps=datap.maps,dataset=datap.data;if(mdl.FFSQLMode){var indices=[];mdl.populateFFSQLMapping(maps);mdl.populateDataset(dataset);}else{mdl.populatePreview(maps,dataset);}mdl.raiseEvent({name:"dataPreview"});}if(callbacks&&callbacks.success){callbacks.success(res);}}};mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo+ENUM_LOAD_REPORT_PREVIEW_FLAG_DataInfo,previewOnly?ENUM_LOAD_REPORT_AUTOMAP_NOT_TRIGGER:ENUM_LOAD_REPORT_AUTOMAP_TRIGGER,cb2);},convertToQueryBuilder:function convertToQueryBuilder(callbacks){var mdl=this;mstrApp.getRootController().getDataService().convertToQB({success:function success(res){mstrApp.msgid=res.msgid;mstrApp.isFFSQLMode=false;mdl.isDirty=true;mdl.FFSQLMode=false;mdl.mappings=mdl.cacheMP;mdl.dataset=mdl.cacheDS;mdl.raiseEvent({name:"dataPreview"});callbacks&&callbacks.success&&callbacks.success(res);}});},convertToFFSQL:function convertToFFSQL(stmt,callbacks,silent){var mdl=this;mdl.SQLstmt=stmt;mstrApp.getRootController().getDataService().convertToFFSQL({success:function success(res){mstrApp.msgid=res.msgid;mdl.isDirty=true;mdl.FFSQLMode=true;mstrApp.isFFSQLMode=true;mdl.cacheMP=mdl.mappings;mdl.cacheDS=mdl.dataset;mdl.dataset=[];mdl.mappings=[];if(!silent){mdl.raiseEvent({name:"dataPreview"});}callbacks&&callbacks.success&&callbacks.success(res);}},{exp:_S.encodeXMLAttribute(stmt)});},editFFSQL:function editFFSQL(callbacks,stmt){var mdl=this;if(this.SQLstmt===stmt){if(callbacks&&callbacks.success){callbacks.success();return ;}}this.SQLstmt=stmt;mstrApp.getRootController().getDataService().editFFSQL({success:function success(res){mstrApp.msgid=res.msgid;mdl.isDirty=true;callbacks&&callbacks.success&&callbacks.success(res);}},{exp:_S.encodeXMLAttribute(stmt)});},updateSQL:function(callbacks){this.getSQL(callbacks);},getSQL:function getSQL(callbacks){var mdl=this;if((!mdl.SelDBRoleID&&mdl.riid===_DEFAULT_TEMPLATE_ID)||mdl.dbtables.length===0){var v="";if(callbacks&&callbacks.success){callbacks.success(v);}}else{mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_SQLPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,null,null,{success:function success(res){var s=res.sqls[res.sqls.length-1],v=s?_rmescp(s):"";if(callbacks&&callbacks.success){callbacks.success(v);}}},true);}},isNameUnique:function(did,cIndex,v){var mdl=this,mp=mdl.mappings;for(var i=0,len=mp.length;i<len;i++){if(i!=cIndex){if(v===mp[i].alias&&mp[cIndex].tp==mp[i].tp){return false;}}}return true;},mapAttribute:function(did,aid,fid,idf,callbacks,originalObjectId){var mdl=this,mappings=mdl.mappings;for(var i=0,len=mappings.length;i<len;i++){if(mappings[i].afid===(aid+fid)){if(callbacks&&callbacks.failure){callbacks.failure($DESC(9926,"The attribute form you select has been mapped. Please choose a different one."));}return false;}}var index=_A.find(mappings,"did",did),mapping=mappings[index],remap=function remap(changedMappings){mstrApp.getRootController().getDataService().remapObject({success:function success(res){mdl.autoMap();if(callbacks&&callbacks.success){callbacks.success(res);}},failure:function fail(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}},{mpcs:JSON.stringify(changedMappings),docid:mstrApp.docID||"",suppressError:true});};if(mapping.isIDForm&&mapping.multiForms&&!mapping.ipa){mstrmojo.confirm(mstrmojo.desc(11164,"All other forms of the attribute will be unmapped. Do you want to continue?"),[mstrmojo.Button.newInteractiveButton($DESC(219,"Yes"),function OK(){var changedMappings=[];_A.forEach(mappings,function(map){if(map.oid===originalObjectId&&map.did!==did){changedMappings.push({did:map.did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});}});changedMappings.push({did:did,aid:aid,fid:fid});remap(changedMappings);}),mstrmojo.Button.newInteractiveButton($DESC(218,"No"))]);}else{remap([{did:did,aid:aid,fid:fid}]);}},unmap:function(did,attributeid){var mdl=this,mappings=mdl.mappings,index=_A.find(mappings,"did",did),mapping=mappings[index],remap=function remap(changedMappings){mstrApp.getRootController().getDataService().remapObject({success:function success(res){mdl.autoMap();},failure:function fail(res){var ec=parseInt(res.getResponseHeader("X-MSTR-TaskErrorCode"),10)+4294967296;mstrmojo.alert((ec===2147755261)?"Please unmap the attribute's non-key form first.":res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}},{mpcs:JSON.stringify(changedMappings),docid:mstrApp.docID||"",suppressError:true});};if(mapping.isIDForm&&mapping.multiForms){mstrmojo.confirm(mstrmojo.desc(11164,"All other forms of the attribute will be unmapped. Do you want to continue?"),[mstrmojo.Button.newInteractiveButton($DESC(219,"Yes"),function OK(){var changedMappings=[];_A.forEach(mappings,function(map){if(map.oid===attributeid&&map.did!==did){changedMappings.push({did:map.did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});}});changedMappings.push({did:did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE});remap(changedMappings);}),mstrmojo.Button.newInteractiveButton($DESC(218,"No"))]);}else{remap([{did:did,aid:"",ot:ENUM_OBJECT_TYPE_ATTRIBUTE}]);}},remap:function(did,alias,bft,ot,georole,drvflgs,shapekey,callbacks){var mpcs=[],mpc={did:did};alias&&(mpc.alias=alias);bft&&(mpc.bft=bft);ot&&(mpc.ot=ot);georole&&(mpc.georole=georole);drvflgs&&(mpc.drvflgs=drvflgs);shapekey&&(mpc.shapekey=shapekey);mpcs.push(mpc);mstrApp.getRootController().getDataService().remapObject({success:function(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(mpcs),docid:mstrApp.docID||""});},commitMapping:function(callbacks){var mdl=this;var clone=this.cloneMappings,maps=this.mappings;var mpc,mpcs=[],dirty,m,nm;for(var i=0,len=clone.length;i<len;i++){m=clone[i];nm=maps[i];mpc={};dirty=false;if(!nm.selected){mpcs.push({did:nm.did,cmf:0});}else{if(nm.alias!=m.alias){mpc.alias=nm.alias;dirty=true;}if(nm.dtp!=m.dtp){mpc.bft=nm.dtp;dirty=true;}if(nm.tp!=m.tp){mpc.ot=nm.tp;dirty=true;}if(dirty){mpc.did=nm.did;mpcs.push(mpc);}}}if(mpcs.length>0){mstrApp.getRootController().getDataService().remapObject({success:function(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(mpcs),docid:mstrApp.docID||""});}else{if(callbacks&&callbacks.success){callbacks.success();}}},setXDADBRole:function(dbrid){var mdl=this;if(mdl.SelDBRoleID!==dbrid){mdl.SelDBRoleID=dbrid;mdl.raiseEvent({name:"dbrsChange"});mdl.raiseEvent({name:"dbroleChange",value:dbrid});}},validateExpr:function validateExpr(params,callbacks){this.parseExpression(params.vo===1,1,params.cIndex,null,params.qbrex,params.expr,params.tKnStrm,callbacks);},parseExpression:function parseExpression(validateOnly,qindex,cindex,jindex,type,exp,tokenstrm,callbacks){var params={qbrex:type};params.qindex=qindex||1;if(cindex!=null){params.cindex=cindex;}if(jindex!=null){params.jindex=jindex;}if(exp!=null){params.exp=exp;}if(tokenstrm){params.tokenStrm=tokenstrm;}if(validateOnly){params.vo=1;}mstrApp.getRootController().getDataService().parse({success:function(res){if(res&&res.mi&&res.mi.tknstrm.mi){var tokens=res.mi.tknstrm.mi.tkn;preprocessTokenStream(tokens);res.expr=getTokensAsString(tokens);}if(callbacks&&callbacks.success){callbacks.success(res);}}},params);},addTable:function addTable(table,cls){var mdl=this;var alias=table.tbn,tbns=mdl.tbns;alias=alias.replace(/^[0-9]/,"L");var tmp=alias,i=1;while(tbns[tmp]){tmp=alias+"_"+(i++);}alias=tmp;tbns[tmp]=tmp;var params={tbn:table.tbn,clns:JSON.stringify(cls),ns:table.ns,alias:alias};var missingTableID=this.getMissingTableID(table.tbn,alias,table.ns);if(missingTableID){params.tbid=missingTableID;}var cb={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;mdl.raiseEvent({name:"TableAdded",data:cls,table:{x:table.posX,y:table.posY,tbn:alias,dbtbn:table.tbn,ns:table.ns,did:missingTableID}});}};mstrApp.getRootController().getDataService().addTable(cb,params);},removeTable:function(tablewidget,callbacks){var mdl=this,tIndex=this.gettIndex(tablewidget.id),rows=tablewidget.Rows.children;var cb={widget:tablewidget,success:function(res){mstrApp.msgid=res.msgid;mdl.isDirty=true;var wid=this.widget.id;var tbns=mdl.tbns,table=mdl.tables[wid];tbn=table.tbn,dbtbn=table.dbtbn,ns=table.ns;if(tbns[tbn]){delete tbns[tbn];}for(var k in mdl.joinsInfo){var srctID=mdl.joinsInfo[k].srctID,tgttID=mdl.joinsInfo[k].tgttID;if(wid==srctID||wid==tgttID){delete mdl.joinsInfo[k];mstrmojo.array.removeItem(mdl.joins,k);mdl.tables[srctID].njoins--;mdl.tables[tgttID].njoins--;}if(mdl.selLink&&mdl.selLink[0].indexOf(wid)>-1){mdl.selLink=null;}}mdl.upttIndex(tbn,dbtbn,wid,false,table.did,ns);var selectedColumns=mdl.selectedClns,cIndices=[],index;_A.forEach(rows,function(rowitem){_A.forEach(selectedColumns,function(selectedColumn,idx){index=_A.indexOf(selectedColumn.wid,rowitem.id);if(index>-1){_A.removeIndices(selectedColumn.wid,index,1);if(cIndices.indexOf(idx+1)==-1){cIndices.push(idx+1);}}});});cIndices.sort(mstrmojo.array.numSorter);for(var j=cIndices.length-1;j>-1;j--){mdl.removeExpression(cIndices[j]);}var conditions=mdl.conditions;tbn=tbn.toLowerCase();removeTableFromCondition(conditions.where,tbn)&&(delete conditions.where);removeTableFromCondition(conditions.having,tbn)&&(delete conditions.having);mdl.updateFilterLabel(conditions);if(callbacks&&callbacks.success){callbacks.success();}}};mstrApp.getRootController().getDataService().removeTable(cb,{tindex:tIndex});},addExpression:function addExpression(cIndex){var exp=getTokensAsString(this.selectedClns[cIndex-1].expr);var item={did:cIndex+exp,alias:exp,n:exp,selected:false,hasMapped:false,isQB:!this.FFSQLMode,expr:this.selectedClns[cIndex-1].expr,dtp:1,ix:cIndex-1,tp:0};this.mappings.push(item);var count=this.dataset.length;if(count>0){for(var i=0;i<count;i++){var row=this.dataset[i];row.push("");}}mstrApp.getRootController().toggleDataPreview(true);this.raiseEvent({name:"dataPreview"});},removeExpression:function removeExpression(cIndex){var sel=this.selectedClns[cIndex-1],wids=sel.wid;for(var i=0,len=wids.length;i<len;i++){var row=mstrmojo.all[wids[i]];row.count--;row.updateState(0);}var gap=_removeIndex(this.selectedClns,cIndex-1);var idx=0;for(var i=0,len=this.mappings.length;i<len;i++){var mp=this.mappings[i];var ix=mp.ix;if(ix!=null){if(ix==cIndex-1){idx=i;}else{if(ix>=cIndex){mp.ix=ix-gap;}}}}mstrmojo.array.removeIndices(this.mappings,idx,1);var count=this.dataset.length;if(count>0){for(var i=0;i<count;i++){var row=this.dataset[i];mstrmojo.array.removeIndices(row,idx,1);}}this.raiseEvent({name:"dataPreview"});},editExpression:function(cIndex){var scl=this.selectedClns[cIndex-1],ws=scl.wid;this.exprEditor(scl,3,null,cIndex);},updateExpression:function updateExpression(cIndex){var exp=getTokensAsString(this.selectedClns[cIndex-1].expr);var item=this.mappings[cIndex-1];if(!item){return ;}item.did=cIndex+exp;item.alias=exp;item.n=exp;item.expr=this.selectedClns[cIndex-1].expr,item.selected=false;item.hasMapped=false;item.tp=0;var count=this.dataset.length;if(count>0){for(var i=0;i<count;i++){var row=this.dataset[i];row[cIndex-1]="";}}this.raiseEvent({name:"dataPreview"});},addSelectedColumns:function addSelectedColumns(selRows,tbIdx,funIndex,callbacks){var mdl=this,missingID,coldef,colArray=[],colrow,exp,data,isExistingTable=mdl.tables[mdl.dbtables[tbIdx-1]].existing;for(i=0;i<selRows.length;i++){colrow=selRows[i];data=colrow.dt;coldef={dt:data.tp,ps:data.ps,sc:data.sc,clix:colrow.rIndex+1,tblIdx:tbIdx};if(funIndex!=null){coldef.findex=funIndex;exp=[_fns[funIndex],"(",colrow.oriexpr,")"].join("");}else{exp=colrow.expr[0].oi.n;}if(isExistingTable){missingID=this.getMissingColumnID(exp);if(missingID){coldef.cmid=missingID;}}colArray.push(coldef);}var strObj=JSON.stringify(colArray);var cb={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;for(var i=0,len=selRows.length;i<len;i++){mdl.addColumnIndex(selRows[i],funIndex,null,!isExistingTable,colArray[i].cmid);}if(callbacks&&callbacks.success){callbacks.success(colrow);}}};mstrApp.getRootController().getDataService().addSelectedColumns(cb,{colArray:strObj});},addSelectedColumn:function addSelectedColumn(colrow,expr,callbacks){var mdl=this,data=colrow.dt;isExistingTable=this.tables[colrow.srcID].existing;var params={dt:data.tp,ps:data.ps,sc:data.sc};if(isExistingTable){var missingID=this.getMissingColumnID(expr);if(missingID){params.cmid=missingID;}}mstrApp.getRootController().getDataService().addColumn({success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;res.cIndex=mdl.addColumnIndex(colrow,null,expr,!isExistingTable,missingID);if(callbacks&&callbacks.success){callbacks.success(res);}}},params);},removeSelectedColumn:function(cIndex,callbacks,ng){var mdl=this;mstrApp.getRootController().getDataService().removeColumn({success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;if(!ng){mdl.removeExpression(cIndex);}else{_removeIndex(mdl.selectedClns,cIndex-1);}if(callbacks&&callbacks.success){callbacks.success();}}},{cindex:cIndex});},editExpr:function(cIndex){var scl=this.selectedClns[cIndex-1];this.exprEditor(scl,3,null,cIndex);},autoJoin:function(tIndex,flag,qIndex,callbacks){mstrApp.getRootController().getDataService().autoJoin({success:function success(res){if(callbacks&&callbacks.success){callbacks.success();}}},{tindex:tIndex,jflag:flag,qindex:qIndex||1});},addJoin:function addJoin(srcw,tgtw,jt,exp,callbacks){var mdl=this;var cbjoin={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;var jid=srcw.srcID+tgtw.srcID;mdl.joins.push(jid);mdl.joinsInfo[jid]=new Object();mdl.joinsInfo[jid].jt=0;mdl.joinsInfo[jid].exp="";mdl.joinsInfo[jid].srctID=srcw.srcID;mdl.joinsInfo[jid].tgttID=tgtw.srcID;mdl.joinsInfo[jid].links=new Object();mdl.tables[srcw.srcID].njoins++;mdl.tables[tgtw.srcID].njoins++;cb={success:function(res){mdl.joinsInfo[jid].nlinks++;callbacks&&callbacks.success&&callbacks.success();},failure:function(res){}};mdl.addLink(srcw,tgtw,jid,cb);}};mstrApp.getRootController().getDataService().addJoin(cbjoin,{srcIndex:mdl.gettIndex(srcw.srcID),dstIndex:mdl.gettIndex(tgtw.srcID),jtype:jt});},removeJoin:function(jid,callbacks){var mdl=this;var jinfo=mdl.joinsInfo[jid],srctID=jinfo.srctID,tgttID=jinfo.tgttID;var cb={success:function(res){mdl.isDirty=true;mstrApp.msgid=res.msgid;mstrmojo.array.removeItem(mdl.joins,jid);delete mdl.joinsInfo[jid];mdl.tables[srctID].njoins--;mdl.tables[tgttID].njoins--;if(callbacks&&callbacks.success){callbacks.success();}}};mstrApp.getRootController().getDataService().removeJoin(cb,{jindex:mdl.getjIndex(jid)});},editJoin:function(jid,linkid,jointype,callbacks,lexp,joinOperator){var mdl=this,jIndex=this.getjIndex(jid);var cb={success:function(res){mstrApp.msgid=res.msgid;mdl.joinsInfo[jid].jt=jointype;links=mdl.joinsInfo[jid].links;if(lexp){var pexp=links[linkid].exp,jexp="";links[linkid].exp=lexp;if(joinOperator!==undefined){links[linkid].op=joinOperator;}for(var k in links){if(jexp){jexp+=" AND "+links[k].exp;}else{jexp=links[k].exp;}}var cbexpr={success:function(res){mdl.joinsInfo[jid].exp=jexp;if(callbacks&&callbacks.success){callbacks.success();}},failure:function(res){links[linkid].exp=pexp;}};mdl.parseExpression(false,1,null,jIndex,ENUM_EXPRESSION_TYPE_JOIN,jexp,null,cbexpr);}else{if(callbacks&&callbacks.success){callbacks.success();}}}};mstrApp.getRootController().getDataService().editJoin(cb,{jindex:jIndex,jtype:jointype});},renameTable:function renameTable(tid,old,current){var mdl=this;mstrApp.getRootController().getDataService().editTable({success:function(res){mstrApp.msgid=res.msgid;delete mdl.tbns[old];mdl.tbns[current]=current;mdl.tables[tid].tbn=current;_H.forEach(mdl.conditions,function(condition){updateTableAliasInCondition(old,current,condition);});mdl.raiseEvent({name:"TableNameChanged",value:current,tid:tid});}},{tables:JSON.stringify([{alias:current,tindex:this.gettIndex(tid)}])});},saveTableLayout:function saveTableLayout(callbacks){var tables=[];for(var wid in this.tables){var w=mstrmojo.all[wid];if(w&&w.editorNode){tables.push({tindex:this.gettIndex(wid),t:parseInt(w.top,10)*_twipPerPixel,l:parseInt(w.left,10)*_twipPerPixel,w:w.editorNode.clientWidth*_twipPerPixel,h:w.editorNode.clientHeight*_twipPerPixel});}}mstrApp.getRootController().getDataService().editTable({success:function success(res){mstrApp.msgid=res.msgid;if(callbacks&&callbacks.success){callbacks.success();}}},{tables:JSON.stringify(tables)});},loadReport:function loadReport(browseType,bindingFlag,previewFlag,automap,callbacks,hideWait){var mdl=this;bindingFlag=bindingFlag||ENUM_LOAD_REPORT_BINDING_FLAG_ALL;var params={browsetype:browseType,bindingflag:bindingFlag,suppressError:true,showWait:!hideWait};if(previewFlag!=null){params.previewflag=previewFlag;}if(automap!=null){params.automap=automap;params.docid=mstrApp.docID||"";}var cb={success:function(res){if(browseType&ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE){if(res.btb){mdl.bindingT=res.btb.slice(0);}}if(callbacks&&callbacks.success){callbacks.success(res);}},failure:function(res){if(mdl.FFSQLMode){var error=res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(\w+\.*\w+): \(/,"").replace(/ \)$/,"");if(error.match(/(.\s)*DataImport\)?\[(\d+)\](.\s)*/)){var passNumber=parseInt(RegExp.$2,10),innerHTML=mstrmojo.desc(9944,"SQL Pass ## failed to execute").replace("##",passNumber);mstrmojo.all.FFsql.markFailureLabel(passNumber);innerHTML=[innerHTML,"<div class='mstrmojo-qb-error-tooltip'>",innerHTML,"<br><br>",error,"</div>"].join("");mstrmojo.alert(innerHTML);return ;}}_manageError(res);}};mstrApp.getRootController().getDataService().getReportDefinition(cb,params);},getcIndex:function getcIndex(wid){return mstrmojo.array.indexOf(this.selectedClns,wid)+1;},getRowWidget:function getRowWidget(tn,rn){var tbls=this.tables;rn=rn.toLowerCase();if(!tn){for(var k in tbls){var rows=tbls[k].rows;for(var j in rows){if(rows[j].text.toLowerCase()===rn){return mstrmojo.all[j];}}}}else{tn=tn.toLowerCase();for(var k in tbls){if(tbls[k].tbn.toLowerCase()===tn){var rows=tbls[k].rows;for(var j in rows){if(rows[j].text.toLowerCase()===rn){return mstrmojo.all[j];}}}}}},uptcIndex:function uptcIndex(wid,idx){while(idx>this.selectedClns.length){this.selectedClns.push("");}this.selectedClns[idx]=wid;},getjIndex:function getjIndex(lid){return mstrmojo.array.indexOf(this.joins,lid)+1;},gettIndex:function gettIndex(tid){return mstrmojo.array.indexOf(this.dbtables,tid)+1;},upttIndex:function upttIndex(tbn,dbtbn,tid,toAdd,did,ns){var dbts=this.dbtables,t,ts=this.tables,originalTables=this.orits,constructTableObject=function constructTableObject(tbn,ns,dbtbn,existing,missing,did){return{rows:{},njoins:0,tbn:tbn,ns:ns,alias:"",dbtbn:dbtbn,existing:existing,missing:missing,did:did};};if(!this.isNew&&originalTables){var isExistingTable=_A.find(originalTables,"did",did)>-1,oldTableWidgetID,oldTableIndex=0;if(isExistingTable){_A.forEach(dbts,function(tableWidgetID,index){if(ts[tableWidgetID].did===did){oldTableWidgetID=tableWidgetID;oldTableIndex=index;return false;}});if(toAdd){ts[tid]=constructTableObject(tbn,ns,dbtbn,true,false,did);if(oldTableWidgetID){delete ts[oldTableWidgetID];dbts[oldTableIndex]=tid;}else{dbts.push(tid);}}else{if(oldTableWidgetID){ts[oldTableWidgetID].missing=true;}}return ;}}if(toAdd){ts[tid]=constructTableObject(tbn,ns,dbtbn,false,false,did);dbts.push(tid);}else{delete ts[tid];mstrmojo.array.removeItem(dbts,tid);}},save:function(name,desc,folderId,overwrite,autoName,SQLstmt,callback){var mdl=this;var cb6={success:function(res){var reportID=res.did;mdl.riid=reportID;mstrApp.path=res.path;mstrApp.reportID=reportID;mstrApp.folderID=folderId;var cb={success:function(res){if(callback&&callback.success){callback.success({did:reportID,path:mstrApp.path});}},failure:function(res){var errorCode=res.getResponseHeader("X-MSTR-TaskErrorCode");errorCode=(errorCode<0)?(4294967296+parseInt(errorCode,10)):errorCode;if(2147895426===errorCode){_manageError(res,function(){mstrmojo.form.send({evt:"3124",src:mstrApp.name+".qbuilder.3124",relativePageNumber:"-1"},mstrApp.name,"POST",null,null,false);});return ;}_manageError(res,function(){var tables=mdl.dbtables,w,pos_hash=mdl.pos_hash;for(var i=0,len=tables.length;i<len;i++){w=mstrmojo.all[tables[i]];if(w&&w.editorNode){pos_hash[w.title]={t:parseInt(w.top,10),l:parseInt(w.left,10),w:w.editorNode.clientWidth,h:w.editorNode.clientHeight};}if(w){w.set("visible",false);w.set("opener",null);}delete mstrmojo.all[tables[i]];}var CE=mstrmojo.all.CE,cel;if(CE&&(cel=CE.CEl)){cel.filterExpr.set("items",[]);cel.aggfilterExpr.set("items",[]);}mdl.createReportInstance();});}};mstrApp.getRootController().getDataService().publishCube(cb,{reportid:reportID});},failure:function(res){_manageError(res);}};var cb5={success:function(){params={reportid:mdl.riid,folderID:folderId,isCube:mdl.isCubeReport,crb:mdl.refresh_opt,overwrite:!!overwrite,autoName:!!autoName};if(name){params.name=name;}if(desc){params.desc=desc;}mstrApp.getRootController().getDataService().saveReport(cb6,params);}};var cb4={success:function(){mdl.updateDerivedFlags(cb5);}};var cb3={success:function(){if(mdl.skipMissingCheck){cb4.success();return ;}var missings=mdl.getMissingMaps();if(missings){var m=mstrmojo.insert({scriptClass:"mstrmojo.qb.MissingColumnWarning",mappings:missings,onOK:function(){cb4.success();return true;}});m.open();}else{cb4.success();}}};var cb2={success:function(){if(mdl.isDirty){mdl.autoMap(cb3);}else{cb3.success();}}};if(!mdl.FFSQLMode){mdl.saveTableLayout(cb2);}else{mdl.editFFSQL(cb2,SQLstmt);}},populatePreview:function populatePreview(maps,data){this.populateMappings(maps);this.populateDataset(data);},populateMappings:function populateMappings(maps){var attrs=maps.amps,metrs=maps.mtmps,isReadOnly=!mstrApp.isCloud&&(mstrApp.saveAsCube==2)&&(!this.isNew);var hash={};var bak=this.mappings.slice(0);this.mappings=[];this.cloneMappings=[];var j,attr,aimp,afmps,sqc,cnt=0,pos,ipa,isDerived,formcount,getFormCount=function(forms){var formcount=0;_A.forEach(forms,function(form){if(!(form.sqc.der&2147483648)){formcount++;}});return formcount;};for(var i=0,len=attrs.length;i<len;i++){attr=attrs[i];aimp=attr.aimp;ipa=aimp.ipa;afmps=attr.afmps;cnt+=afmps.length;formcount=getFormCount(afmps);for(j=0,aflen=afmps.length;j<aflen;j++){sqc=afmps[j].sqc;pos=mstrmojo.array.find(bak,"did",sqc.id);isDerived=(sqc.der&2147483648)?true:false;var item={did:sqc.id,alias:decodeHTMLString(aimp.atnm),n:decodeHTMLString(attr.afmps[j].cln),selected:(sqc.se==1),hasMapped:true,isReadOnly:isReadOnly,isDI:this.isDI,isQB:!(this.FFSQLMode),dtp:afmps[j].bft,ix:sqc.ix,tp:12,ipa:ipa,georole:(pos>=0)?bak[pos].georole:sqc.geo,der:(pos>=0)?bak[pos].der:sqc.der,oid:aimp.atid,fmid:afmps[j].fmid,afid:aimp.atid+afmps[j].fmid,fmn:decodeHTMLString(afmps[j].fmn),shapeKey:decodeHTMLString((pos>=0)?bak[pos].shapeKey:afmps[j].sha),toDel:(sqc.ups&4)?true:false,isDerived:isDerived,multiForms:formcount>1,isIDForm:j===0};hash[item.ix]=item;}}for(var i=0,len=metrs.length;i<len;i++){var metr=metrs[i],sqc=metr.sqc;var item={did:sqc.id,alias:decodeHTMLString(metr.mtn),n:decodeHTMLString(metr.cln),selected:(sqc.se==1),isReadOnly:isReadOnly,hasMapped:true,isDI:this.isDI,isQB:!(this.FFSQLMode),dtp:dataTypeToBaseFormType[sqc.dt.tp],ix:sqc.ix,tp:4,oid:metr.mtid,georole:sqc.geo,der:sqc.der,toDel:(sqc.ups&4)?true:false};hash[item.ix]=item;}var item;for(var i=0,len=cnt+metrs.length;i<len;i++){item=hash[i];if(item.toDel){this.selectedClns&&this.selectedClns[i]&&(this.selectedClns[i].missing=true);}else{if(item.isDerived){this.selectedClns&&this.selectedClns[i]&&(this.selectedClns[i].isDerived=true);}else{this.mappings.push(item);this.cloneMappings.push(_H.copy(item));}}}},populateDataset:function populateDataset(data){var isTimeValue,dataset;if(!data.length){this.dataset=[];return ;}dataset=[];_A.forEach(data,function(item){isTimeValue=(item.dcns.cltp===15);_A.forEach(item.dvs,function(value,idx){dataset[idx]=dataset[idx]||[];dataset[idx].push(isTimeValue?value.slice(10):value);});});this.dataset=dataset;},populateFFSQLMapping:function populateFFSQLMapping(maps){var attrs=maps.amps,metrs=maps.mtmps;var hash={};var bak=this.mappings.slice(0);this.mappings=[];this.cloneMappings=[];var j,attr,aimp,c,cnt=0,aflen,afmps,item,ipa,isDerived,formcount,getFormCount=function getFormCount(forms){var formcount=0;_A.forEach(forms,function(form){if(!(form.col.oi.def.dicl.der&2147483648)){formcount++;}});return formcount;};for(var i=0,len=attrs.length;i<len;i++){attr=attrs[i];aimp=attr.aimp;ipa=aimp.ipa;afmps=attr.afmps;formcount=getFormCount(afmps);for(j=0,aflen=afmps.length;j<aflen;j++){c=afmps[j].col.oi;pos=mstrmojo.array.find(bak,"did",c.did);if(c.def.dicl.ups&4){break;}isDerived=(c.def.dicl.der&2147483648)?true:false;cnt++;item={did:c.did,alias:decodeHTMLString(aimp.atnm),n:decodeHTMLString(c.def.cln),selected:true,hasMapped:true,dtp:afmps[j].bft,georole:(pos>=0)?bak[pos].georole:c.def.dicl.geo,shapeKey:decodeHTMLString((pos>=0)?bak[pos].shapeKey:afmps[j].sha),oid:aimp.atid,fmid:afmps[j].fmid,afid:aimp.atid+afmps[j].fmid,fmn:decodeHTMLString(afmps[j].fmn),ipa:ipa,ix:c.def.dicl.clix-1,tp:12,der:(pos>=0)?bak[pos].der:c.def.dicl.der,isDerived:isDerived,multiForms:formcount>1,isIDform:j===0};hash[item.ix]=item;}}var idx=attrs.length;for(var i=0,len=metrs.length;i<len;i++){var metr=metrs[i],c=metr.col.oi;if(c.def.dicl.ups&4){continue;}cnt++;var item={did:c.did,alias:decodeHTMLString(metr.mtn),n:decodeHTMLString(c.def.cln),selected:true,hasMapped:true,dtp:dataTypeToBaseFormType[c.def.dt.tp],ix:c.def.dicl.clix-1,oid:metr.mtid,tp:4,georole:c.def.dicl.geo,der:c.def.dicl.der};hash[item.ix]=item;}var item;for(var i=0;i<cnt;i++){item=hash[i];if(item&&!item.isDerived){this.mappings.push(item);this.cloneMappings.push(_H.copy(item));}}},updateDerivedFlags:function(callbacks){var cur=this.mappings;var mpcs=[],mpc;for(var i=0,len=cur.length;i<len;i++){if(cur[i].hasMapped){mpcs.push({did:cur[i].did,georole:cur[i].georole,shapekey:cur[i].shapeKey,drvflgs:cur[i].der});}}if(mpcs.length===0){callbacks&&callbacks.success&&callbacks.success();}else{mstrApp.getRootController().getDataService().remapObject({success:function success(res){if(callbacks&&callbacks.success){callbacks.success(res);}}},{mpcs:JSON.stringify(mpcs),docid:mstrApp.docID||"",utm:1});}},getMissingMaps:function(personalAttributes){if(!this.orimaps){return null;}var diff=[],i,j,len,item;var ori=this.orimaps;var cur=this.mappings;var amps=ori.amps,mtmps=ori.mtmps;ori={};var atid,atnm,afmps,def,sqc,exp,cmid,isFFSQL=mstrApp.isFFSQL;for(i=0,len=amps.length;i<len;i++){item=amps[i].aimp;atid=item.atid;atnm=decodeHTMLString(item.atnm);item=amps[i].afmps;for(j=0;j<item.length;j++){if(isFFSQL){def=item[j].col.oi.def;if(def.dicl.der&2147483648){break;}exp=def.cln;cmid=item[j].col.oi.did;}else{sqc=item[j].sqc;if(sqc.der&2147483648){break;}exp=sqc.exp.exp;cmid=sqc.id;}ori[atid]=ori[atid]||{n:atnm,oid:atid,tp:12,fms:[]};ori[atid].fms.push({fmid:item[j].fmid,fnm:decodeHTMLString(item[j].fmn),exp:decodeHTMLString(exp),cmid:cmid});}}for(i=0,len=mtmps.length;i<len;i++){if(isFFSQL){exp=mtmps[i].col.oi.def.cln;cmid=mtmps[i].col.oi.did;}else{sqc=mtmps[i].sqc;exp=sqc.exp.exp;cmid=sqc.id;}ori[mtmps[i].mtid]={oid:mtmps[i].mtid,n:decodeHTMLString(mtmps[i].mtn),tp:4,exp:decodeHTMLString(exp),cmid:cmid};}var ps=mstrmojo.hash.copy((this.pattrs||{}));var len=cur.length,oid,originalobj,forms,index;for(i=0;i<len;i++){oid=cur[i].oid;originalobj=ori[oid];if(originalobj&&originalobj.tp==cur[i].tp){forms=originalobj.fms;if(forms){index=_A.find(forms,"fmid",cur[i].fmid);if(index>-1){_A.removeIndices(forms,index,1);}}else{delete ori[oid];}}if(ps[oid]&&ps[oid].tp==cur[i].tp){delete ps[oid];}}if(personalAttributes){for(oid in ps){item=ps[oid];personalAttributes.push(item);}}for(oid in ori){item=ori[oid];if(item.tp===12){if(item.fms.length){diff.push(item);}}else{diff.push(item);}}return((diff.length>0)?diff:null);},getMissingColumnID:function(exp){var model=this,missings=model.getMissingMaps();if(!missings){return null;}var missingColId=null,expArray,currentMappings=model.mappings;_A.forEach(missings,function(item){expArray=(item.tp===4)?[item]:item.fms;_A.forEach(expArray,function(expitem){if(_A.find(currentMappings,"did",expitem.cmid)===-1&&model.isEquivalentExpr(expitem.exp,exp)){missingColId=expitem.cmid;return false;}});if(missingColId){return false;}});if(missingColId){_A.forEach(model.selectedClns,function(column){if(column.cmid===missingColId&&!column.missing){missingColId=null;return false;}});}return missingColId;},getMissingTableID:function(tbn,alias,ns){var ori=this.orits;if(!ori){return null;}var dbts=this.dbtables,ts=this.tables,t;for(var i=0,len=dbts.length;i<len;i++){t=ts[dbts[i]];if(t.existing&&t.missing&&t.tbn===alias&&t.dbtbn===tbn&&t.ns===ns){return(!t.did?null:t.did);}}return null;},getTablesCount:function(){var ts=this.tables,dbts=this.dbtables,cnt=0;for(var i=0,len=dbts.length;i<len;i++){!ts[dbts[i]].missing&&(cnt++);}return cnt;},getColumnsCount:function(){var selClns=this.selectedClns,cnt=0;for(var i=0,len=selClns.length;i<len;i++){!selClns[i].missing&&(cnt++);}return cnt;},addColumnIndex:function(row,aggIndex,expr,ignoreCheck,existingMissingColumnID){var selClns=this.selectedClns,tIndex=this.gettIndex(row.parent.parent.id),exp,cIndex,found,len=selClns.length,i,column;if(!!expr){exp=expr;}else{if(aggIndex){exp=_fns[aggIndex]+"("+(row.oriexpr)+")";}else{exp=this.brackets(row.oriexpr);}}if(!ignoreCheck){for(i=0;i<len;i++){column=selClns[i];if(column.missing&&column.expr&&this.isEquivalentExpr(column.expr[0].v,exp)){column.missing=false;column.wid=[row.id];column.cmid=existingMissingColumnID;found=true;break;}}cIndex=i+1;}else{cIndex=len+1;}if(!found){if(aggIndex){if(aggIndex===6){selClns.push({wid:[row.id],expr:[{isNew:true,v:"Count",oi:{t:"11",n:"Count"}},{isNew:true,v:"<Distinct=true>",oi:{t:"11",n:"<Distinct=true>"}},{isNew:true,v:"(",isDelimiter:true},{isNew:true,v:this.brackets(row.oriexpr),oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}},{isNew:true,v:")",isDelimiter:true}]});}else{selClns.push({wid:[row.id],expr:[{isNew:true,v:_fns[aggIndex],oi:{t:"11",n:_fns[aggIndex]}},{isNew:true,v:"(",isDelimiter:true},{isNew:true,v:this.brackets(row.oriexpr),oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}},{isNew:true,v:")",isDelimiter:true}]});}}else{selClns.push({wid:[row.id],expr:[{isNew:true,v:exp,oi:{tIndex:tIndex,rIndex:row.rIndex,t:"26",n:row.oriexpr}}]});}}this.addExpression(cIndex);return cIndex;},compareDBTables:function(callback){var model=this;if(model.dbtables.length===0){return ;}var cbload={success:function(res){var arr=res.btb,whts=[],obj,def;_A.forEach(arr,function(item){obj=item.oi;def=obj.def;(obj.tp===53)&&whts.push({tbid:obj.did,tbn:decodeHTMLString(def.tbn),ns:decodeHTMLString(def.ns)});});if(whts.length==0){return ;}model.whts=whts;mstrApp.getRootController().getDataService().catalogAction({success:function suc(res){var def=res.xrc.cas[0];model.whdef=def.tis?def.tis:[def];callback&&callback.success&&callback.success();}},{dbrid:model.SelDBRoleID,flags:1073741824|2|524288,mid:mstrApp.msgid,dbts:JSON.stringify(whts),showWait:true});}};model.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,null,cbload);},updateDBTables:function(callback){var mdl=this,t,cli,tbs=[],tclone,clis,clisclone,i,j,len,cl;for(i=0,len=mdl.whdef.length;i<len;i++){t=mdl.whdef[i];if(t.sta!=0){tclone={ns:t.ns,sta:t.sta,tbid:t.tbid,tbn:decodeHTMLString(t.tbn),clis:[]};clisclone=tclone.clis;clis=t.clis;for(j=0;j<clis.length;j++){cl=clis[j];clisclone.push({cln:decodeHTMLString(cl.cln),cmid:cl.cmid,sta:cl.sta,prec:cl.dt.prec,scl:cl.dt.scl,tp:cl.dt.tp});}tbs.push(tclone);}}if(tbs.length==0){return ;}var cb={success:function(res){mstrApp.msgid=res.msgid;var cbload={success:function(res){var tables=mdl.dbtables,w,pos_hash=mdl.pos_hash;for(var i=0,len=tables.length;i<len;i++){w=mstrmojo.all[tables[i]];if(w&&w.editorNode){pos_hash[w.title]={t:parseInt(w.top,10),l:parseInt(w.left,10),w:w.editorNode.clientWidth,h:w.editorNode.clientHeight};}w.set("visible",false);w.set("opener",null);delete mstrmojo.all[tables[i]];}var CE=mstrmojo.all.CE,cel;if(CE&&(cel=CE.CEl)){cel.filterExpr.set("items",[]);cel.aggfilterExpr.set("items",[]);}_loadExistingReport(res,mdl);if(callback&&callback.success){callback.success();}}};mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,null,cbload);}};mstrApp.getRootController().getDataService().updateTableStructure(cb,{tables:JSON.stringify(tbs)});},isColumnUsed:function(t,cl){var tbn=t.tbn,cln=cl.cln,i,len,rows;var ts=this.tables;for(var id in ts){if(ts[id].dbtbn===tbn){rows=ts[id].rows;for(var rid in rows){if((rows[rid].text===cln)&&(rows[rid].state!=0)){return true;}}}}return false;},hasMissingUsedDBColumns:function(){var tbs=this.whdef,t,i,j,len,lenj,cl,clis;for(i=0,len=tbs.length;i<len;i++){t=tbs[i];switch(parseInt(t.sta,10)){case 0:case 64:break;default:clis=t.clis;for(j=0,lenj=clis.length;j<lenj;j++){cl=clis[j];if(parseInt(cl.sta,10)===4){if(this.isColumnUsed(t,cl)){return true;}}}break;}if(t.sta==4){clis=t.clis;for(j=0,lenj=clis.length;j<lenj;j++){cl=clis[j];if(this.isColumnUsed(t,cl)){return true;}}}}return false;},getShapeKeys:function(){var mdl=this;var cb={success:function(res){if(res&&res.ShapeFileMaps&&res.ShapeFileMaps.ShapeFileMap){var keys=res.ShapeFileMaps.ShapeFileMap,items=[],desc,name,nameSorter=function nameSorter(a,b){var A=a.n.toLowerCase();var B=b.n.toLowerCase();if(A<B){return -1;}else{if(A>B){return 1;}else{return 0;}}};_A.forEach(keys,function(item){desc=item.descWeb;name=desc?$DESC(desc.slice(8)):decodeHTMLString(item.name);items.push({did:item.shapeKey,n:name});});items.sort(nameSorter);mdl.shapeKeys=items;}}};mstrApp.getRootController().getDataService().getShapeKeys(cb,{fileNumber:2});},createReportInstance:function createReportInstance(){var mdl=this;mdl.msgid=mstrApp.msgid;mdl.riid=mstrApp.reportID||_DEFAULT_TEMPLATE_ID;var isCloud=mstrApp.isCloudPro;mdl.supportTimeGeo=!isCloud;mdl.analysisID=mstrApp.analysisID;mdl.isNew=(mdl.riid==_DEFAULT_TEMPLATE_ID);mdl.alertTitle=isCloud?"Oops!":null;var cb={success:function succ(res){mdl.msgid=res.msgid;mstrApp.msgid=res.msgid;if(mdl.riid!==_DEFAULT_TEMPLATE_ID){mdl.firstTimeLoading=true;mdl.loadReport(ENUM_LOAD_REPORT_BROWSE_TYPE_BINDINGTABLE+ENUM_LOAD_REPORT_BROWSE_TYPE_DATAPREVIEW,ENUM_LOAD_REPORT_BINDING_FLAG_ALL,ENUM_LOAD_REPORT_PREVIEW_FLAG_MappingInfo,ENUM_LOAD_REPORT_AUTOMAP_TRIGGER,{success:function(res){_loadExistingReport(res,mdl);}});}else{mdl.skipMissingCheck=true;if(mstrApp.isFFSQL){mdl.set("isFFSQL",true);mdl.set("FFSQLMode",true);mstrApp.isFFSQLMode=true;mdl.convertToFFSQL("",null,true);}}mdl.set("isCloud",isCloud);mdl.set("isCubeReport",mstrApp.saveAsCube!=2);},failure:function fail(res){if(mdl.riid===_DEFAULT_TEMPLATE_ID){if(res.getResponseHeader("X-MSTR-TaskErrorCode")===ENUM_ERROR_OBJECT_NOT_FOUND){mstrmojo.confirm("Please contact your Administrator to update the Project Metadata.",[mstrmojo.Button.newInteractiveButton($DESC(1442,"OK"),function OK(){mstrApp.redirectToPage({evt:3010});})]);return ;}}mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}};mstrApp.getRootController().getDataService().createReportInstance(cb,{reportid:mdl.riid});mdl.getShapeKeys();mdl.getFunctions();},setDBRole:function setDBRole(dbrid){if(this.SelDBRoleID===dbrid){return ;}if(dbrid){mstrApp.getRootController().getDataService().setDBRole({success:function(res){mstrApp.msgid=res.msgid;}},{dbrid:dbrid});}this.SelDBRoleID=dbrid;},getRefreshOption:function getRefreshOption(){return this.refresh_opt;},setRefreshOption:function setRefreshOption(opt){this.refresh_opt=opt;},getAutoReportName:function getAutoReportName(){var tbns=this.tbns,name=[];_H.forEach(tbns,function(table,tbn){name.push(tbn);});name=name.join("_");if(name==""){name="FFSQL";}return name.substring(0,252);},getFunctions:function getFunctions(){var me=this;if(!this.functions){mstrApp.getRootController().getDataService().getSystemFunctions({success:function(res){me.functions=sliceFunctions(res.fncs);}},{includeFunctionDetails:false,functionFlags:2});}},getFunctionList:function getFunctionList(){return this.functions;},getSuggestionItems:function getSuggestionItems(isFFSQLMode){var items=[],expr;if(isFFSQLMode){var tables=this.dbtbls[this.SelDBRoleID];_H.forEach(tables,function(v,key){items.push({n:key,sta:2,t:15});});}else{_H.forEach(this.tables,function(v){_H.forEach(v.rows,function(col){expr=col.oriexpr;items.push({n:expr,cmid:col.srcData.id,rIndex:col.rIndex+1,t:26,display:['<span class="mstrmojo-ArchitectListIconBlock t26 "></span><span>',expr,"</span>"].join("")});});});}_A.forEach(this.functions,function(v){_A.forEach(v.fns,function(fn){items.push(fn);});});if(isFFSQLMode){this.FFsqlComp=items;}return items;},getConditions:function getConditions(){return this.conditions;},removeCondition:function removeCondition(isWhere,callbacks){mstrApp.getRootController().getDataService().editCondition({success:function success(res){mstrApp.msgid=res.msgid;if(callbacks&&callbacks.success){callbacks.success(res);}}},{clause:isWhere?"where":"having",exp:""});},updateConditions:function updateConditions(filterItem,aggfilterItem){var model=this,conditions=this.conditions,updatecallback={success:function suc(res){conditions.having=aggfilterItem;model.updateFilterLabel(conditions);}},handleHavingClause=function handleHavingClause(res){conditions.where=filterItem;if(aggfilterItem){model.parseExpression(false,1,1,null,ENUM_PARSE_TYPE_HAVINGCLAUSE,getConditionExpr(aggfilterItem),"",updatecallback);}else{if(conditions.having){model.removeCondition(true,updatecallback);}else{updatecallback.success();}}},callback={success:handleHavingClause};if(filterItem){this.parseExpression(false,1,1,null,ENUM_PARSE_TYPE_WHERECLAUSE,getConditionExpr(filterItem),"",callback);}else{if(conditions.where){this.removeCondition(true,callback);}else{handleHavingClause();}}},appendCondition:function appendCondition(newitem){var conditions=this.conditions,isWhereClause=newitem.sqltp===0;condition=isWhereClause?conditions.where:conditions.having;if(!condition){condition=newitem;}else{if(condition.nds){condition.nds.push(newitem);}else{condition={et:_ET.ANDOR,fn:_E.FN.AND,nds:[_H.copy(condition),newitem]};}}conditions[isWhereClause?"where":"having"]=condition;this.parseExpression(false,1,1,null,(isWhereClause?ENUM_PARSE_TYPE_WHERECLAUSE:ENUM_PARSE_TYPE_HAVINGCLAUSE),getConditionExpr(condition),"",null);this.updateFilterLabel(conditions);},updateFilterLabel:function updateFilterLabel(conditions){var rowsWithFilter={},tables=this.tables,tablename,rows,rowname,hasFilter,state;_H.forEach(conditions,function(condition){getRowsWithFilter(rowsWithFilter,condition);});_H.forEach(tables,function(table){rows=table.rows;tablename=table.tbn.toLowerCase();hasFilter=rowsWithFilter[tablename];_H.forEach(rows,function(row){state=row.state;state=(hasFilter&&hasFilter[row.text.toLowerCase()])?(state|2):(state&(~2));if(row.state!==state){row.state=state;row.images[1]=row.img[state];row.render();}});});}});})();