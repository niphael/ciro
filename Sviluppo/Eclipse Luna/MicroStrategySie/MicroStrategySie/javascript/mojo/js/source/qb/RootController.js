(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.hash","mstrmojo.Serializer","mstrmojo.array","mstrmojo.qb.QBuilderPage","mstrmojo.qb.QBuilderModel");var $H=mstrmojo.hash,$A=mstrmojo.array;var typeOf=function(v){if(v==null){return"null";}var t=typeof (v);if(t!="object"){return t;}else{if(v.length===undefined){return"object";}else{return"array";}}};mstrmojo.qb.RootController=mstrmojo.declare(mstrmojo.Obj,null,{start:function start(){var rootView=this.rootView,model=this.model;this.dataService=mstrmojo.qb.DataService;model.attachEventListener("dbroleChange",rootView.id,rootView.setDBRoleID);rootView.render();mstrApp.docID=mstrApp.docID||mstrApp.analysisID||"";mstrApp.isFFSQL&&this.raiseEvent({name:"reportModeChange",mode:2,value:""});rootView.loadView();model.createReportInstance();},getDataService:function getDataService(){return this.dataService;},toggleDatabaseView:function toggleDatabaseView(show){this.rootView.toggleDatabaseView(show);},toggleDataPreview:function toggleDataPreview(show){var rootView=this.rootView,isFFSQLMode=this.model.FFSQLMode;rootView.toggleDataPreview(show);if(!isFFSQLMode){rootView.showQBPreview=show;}if(show){this.raiseEvent({name:"dataPreview"});}},openConditionDialog:function openConditionDialog(){var model=this.model;if(model.dbtables.length===0){mstrmojo.alert(mstrmojo.desc(9114,"Cannot add Filter without any Tables being added, please add some Tables first"));return ;}var CONDITION_EDITOR_ID="qbcondition",conditionEditor=mstrmojo.all[CONDITION_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.qb.ConditionEditor",id:CONDITION_EDITOR_ID});if(!conditionEditor.hasRendered){conditionEditor.render();}conditionEditor.set("data",$H.copy(model.getConditions()));conditionEditor.set("visible",true);},openRefreshOptionDialog:function openRefreshOptionDialog(){this.rootView.openRefreshOptionDialog(this.model.getRefreshOption());},openHelp:function openHelp(){var topics=mstrApp.helpTopics||{},url=(mstrApp.helpUrl||"../help/")+"WebUser/WebHelp/Lang_"+(mstrApp.helpLocaleId?mstrApp.helpLocaleId:mstrApp.localeId)+"/"+(mstrApp.userHelpPage||"MicroStrategy_Web_Help.htm")+"#"+(mstrApp.isFFSQL?(topics.mainSQL||"freeform_import_page.htm"):(topics.mainDB||"database_import_page.htm"));window.open(url);},openExpressionEditor:function openExpressionEditor(obj){this.rootView.openExpressionEditor(obj);},getFunctionList:function getFunctionList(){return this.model.getFunctionList();},getSuggestionItems:function getSuggestionItems(isFFSQLMode){return this.model.getSuggestionItems(isFFSQLMode);},exprjson2xml:function exprjson2xml(nodeName,jsons,config){if(!(jsons instanceof Array)){jsons=[jsons];}var serial=config&&config.isSerializable,convertBoolean=(config.convertBoolean===false)?false:true;var att=[],ch=[],n,v;for(var ji=0,jlen=jsons.length;ji<jlen;ji++){var json=jsons[ji];for(n in json){if(serial){var ret=serial(n,jsons,ji);if(ret!==true){if(ret===false){continue;}else{if(ret.att){att.push(ret.att);}if(ret.child){ch.push(ret.child);}continue;}}}v=json[n];switch(typeOf(v)){case"array":if(n!=="omit"){ch.push(["<",n,">"].join(""));for(var i=0,len=v.length;i<len;i++){var cn=config.getArrItemName(n,v,i)||i;ch.push(this.exprjson2xml(cn,v[i],config));}ch.push("</"+n+">");}else{for(var i=0,len=v.length;i<len;i++){var cn=config.getArrItemName(n,v,i)||i;ch.push(this.exprjson2xml(cn,v[i],config));}}break;case"object":ch.push(this.exprjson2xml(n,v,config));break;case"string":att.push([n,'="',mstrmojo.string.encodeXMLAttribute(v),'"'].join(""));break;case"boolean":att.push([n,'="',((convertBoolean)?(v?"-1":"0"):v),'"'].join(""));break;case"null":if(!config.skipNull){att.push([n,'="',config.nullValue,'"'].join(""));}break;default:att.push([n,'="',v,'"'].join(""));break;}}}return["<",nodeName," ",att.join(" "),">",ch.join(""),"</",nodeName,">"].join("");},parseExpression:function parseExpression(params,callbacks){this.model.validateExpr(params,callbacks);},autoMap:function autoMap(){var me=this;if(!me.hasDBConnection()){return ;}me.model.autoMap({success:function(){me.toggleDataPreview(true);}},false,false);},getSQLPreview:function getSQLPreview(callback){this.model.getSQL(callback);},convertMode:function convertMode(fromQB){var me=this;if(fromQB){this.model.getSQL({success:function success(sqlstmt){me.model.convertToFFSQL(sqlstmt,{success:function suc(){me.toggleDataPreview(false);me.raiseEvent({name:"reportModeChange",mode:2,value:sqlstmt});}});}});}else{var showPreview=me.rootView.showQBPreview,callback={success:function(){me.toggleDataPreview(showPreview);me.raiseEvent({name:"reportModeChange",mode:1,showPreview:showPreview});}};var ff=mstrmojo.all.FFsql;if(ff.oriSQL===ff.getSQLstmt()){me.model.convertToQueryBuilder(callback);}else{var $NIB=mstrmojo.Button.newInteractiveButton;mstrmojo.confirm(mstrmojo.desc(9139,"All changes performed in FFSQL mode will be lost. Do you want to leave FFSQL mode?"),[$NIB(mstrmojo.desc(1442,"OK"),function yes(){me.model.convertToQueryBuilder(callback);},null),$NIB(mstrmojo.desc(221,"Cancel"),function no(){},null)]);}}},editSQL:function editSQL(stmt,callback){this.model.editFFSQL(callback,stmt);},setRefreshOption:function setRefreshOption(opt){this.model.setRefreshOption(opt);},setDBRole:function setDBRole(dbrid){this.model.setDBRole(dbrid);},addTable:function addTable(t,cls){this.model.addTable(t,cls);},addSQLFromTable:function addSQLFromTable(ns,tbn,cls){this.rootView.addSQLFromTable(ns,tbn,cls);},addSQLFromColumn:function addSQLFromColumn(data){this.rootView.addSQLFromColumn(data);},addSelectedColumns:function addSelectedColumns(rows,tbIdx,funIndex,callbacks){this.model.addSelectedColumns(rows,tbIdx,funIndex,callbacks);},addSelectedColumn:function addSelectedColumn(colrow,expr,callbacks){this.model.addSelectedColumn(colrow,expr,callbacks);},getColumnsForDBTable:function getColumnsForDBTable(table,callback){this.rootView.main.WHTableTree.getTableColumns(table,callback);},updateTableViewWithExpression:function updateTableViewWithExpression(cIndex,exprTokens){var model=this.model,scl=model.selectedClns[cIndex-1],ws=scl.wid,w,oi;scl.expr=exprTokens;$A.forEach(ws,function(id){w=mstrmojo.all[id];if(w){if(w.count>0){w.count--;}w.updateState(0);}});ws=[];$A.forEach(exprTokens,function(token){oi=token.oi;if(oi&&oi.tp===26){w=model.getRowWidget(oi.tn,oi.rn);if(w){w.count++;w.updateState(1);ws.push(w.id);}}});scl.wid=ws;model.updateExpression(cIndex);},updateFilters:function updateFilters(filterItem,aggfilterItem){this.model.updateConditions(filterItem,aggfilterItem);},addNewFilter:function addNewFilter(condition){this.model.appendCondition(condition);},cancel:function cancel(){if(mstrApp.isCloudPro){rrOpenHomePage&&rrOpenHomePage();}else{mstrmojo.form.send({evt:"3124",src:mstrApp.name+".qbuilder.3124",relativePageNumber:"-1"},mstrApp.name,"POST",null,null,false);}},addSQLCandidateTables:function addSQLCandidateTables(tables){this.raiseEvent({name:"addCandidateTables",value:tables});},hasDBConnection:function hasDBConnection(){if(this.model.SelDBRoleID){return true;}mstrmojo.alert(mstrmojo.desc(9915,"Please select a database connection first."));return false;},publish:function publish(){var model=this.model,stmt=model.FFSQLMode?this.rootView.getSQLStatement():"",isNew=model.isNew,folderID=mstrApp.folderID,controller=this,scb={success:function(res){if(mstrApp.analysisID||mstrApp.msgID){var targetEvent=mstrApp.analysisID?[3169,mstrApp.name+".3169","messageID",mstrApp.analysisID]:[3104,mstrApp.name+".3104","messageID",mstrApp.msgID,"rwDesignMode",1,"executionMode",2],events=[targetEvent,[2048007,mstrApp.name+".rwd.rwframe.rwb.2048007","dsObjectID",res.did,"dsType",3,"isDatasetAdded",false,"isDefault",false]];mstrApp.redirectToPage({evt:"1024001",events:mstrmojo.Serializer.serializeValueGroup(events),src:mstrApp.name+"."+mstrApp.pageName+".1024001","1024001":"1",evtorder:"1024001"});}else{controller.gotoRedirectionPage(res.did,res.path);}}};if(!this.hasDBConnection()){return ;}if(folderID||!isNew){var isCloudNew=isNew&&mstrApp.isCloud;model.save((isCloudNew?model.getAutoReportName():null),null,folderID,!isNew,isCloudNew,stmt,{success:function(res){var analysisID=mstrApp.analysisID;if(!isNew&&analysisID){mstrApp.hideWait(true);var pop=mstrmojo.insert({scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-ObjectInfoEditor",showTitle:false,analysisID:analysisID,children:[{scriptClass:"mstrmojo.Label",text:"Edit data successfully!",cssClass:"mstrmojo-AttCreator-Text"},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button",onclick:function(evt){var popup=this.parent.parent;popup.close();if(rrLockAndRunDashboard){rrLockAndRunDashboard(analysisID);}else{mstrApp.redirectToPage({evt:"3104",rwDesignMode:"0",rwViewMode:"2048",executionMode:"1",objectType:"55",objectID:analysisID});}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button",onclick:function(evt){var popup=this.parent.parent;popup.close();mstrApp.showWait();if(mstrApp.isCloud){rrOpenHomePage&&rrOpenHomePage();}else{mstrApp.redirectToPage({evt:3010});}}}]}]});pop.open();}else{controller.gotoRedirectionPage(res.did,res.path);}}});}else{var rootView=this.rootView;rootView.openPopup("saveasRef",{folderLinksContextId:mstrConfig.hasProfileReports?28:1,name:mstrmojo.desc(8041,"New Cube"),saveAs:function(overwrite){var me=this,panel=me.contPanel,name=panel.name.value,currentFolder=me.ob.currentFolder,folderId=currentFolder.did,existingItems=currentFolder.items,currentName=name.toUpperCase();if(!name){mstrmojo.confirm(mstrmojo.desc(9523,"Enter a Name"),[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(1442),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})]);return ;}$A.forEach(existingItems,function(item){if(item.t===3&&item.n.toUpperCase()===currentName){currentName="";return false;}});var saveCube=function saveCube(){model.save(name||"",panel.desc.value||"",folderId,true,false,stmt,scb);me.close();};if(currentName){saveCube();}else{mstrmojo.confirm(mstrmojo.desc(7986,"The ## '###' already exists. Do you want to replace the existing one?").replace("##",mstrmojo.desc(3377)).replace("###",name),[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(219),function(){saveCube();},null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"}),mstrmojo.Button.newInteractiveButton(mstrmojo.desc(218),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})],mstrmojo.desc(3179));}}});}},updateTableStructure:function updateTableStructure(){var model=this.model;model.compareDBTables({success:function(){if(model.hasMissingUsedDBColumns()){mstrmojo.confirm("There are missing columns used in expressions. Do you want to update?",[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(219),function(){model.updateDBTables();},null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"}),mstrmojo.Button.newInteractiveButton(mstrmojo.desc(218),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})],mstrmojo.desc(3179));}else{model.updateDBTables();}}});},gotoRedirectionPage:function gotoRedirectionPage(reportid,path){if(mstrApp.isNewAnalysis){mstrApp.redirectToPage({evt:"3104",src:microstrategy.servletName+".3104",executionMode:"1",rwDesignMode:"0",objectType:"3",objectID:reportid,rwCreateFlags:"16",rwViewMode:"2048"});return ;}if(mstrApp.msgID){mstrApp.redirectToPage({evt:"3104",src:microstrategy.servletName+".3104",executionMode:"2",rwDesignMode:"1",objectType:"3",objectID:reportid});return ;}this.rootView.showRedirectionPage(reportid,path);},save:function save(){this.model.save();}});}());