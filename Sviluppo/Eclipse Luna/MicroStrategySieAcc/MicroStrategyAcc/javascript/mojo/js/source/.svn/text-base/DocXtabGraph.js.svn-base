(function(){mstrmojo.requiresCls("mstrmojo.GraphBase","mstrmojo._Formattable","mstrmojo._HasWaitIcon","mstrmojo._IsSelectorTarget","mstrmojo.tooltip");var $D=mstrmojo.dom;function adjustGraphHeight(w){var f=w.getFormats();if(!f.width&&"gp" in f){f=f.gp;}w.resizeForDisplayState(parseInt(f.height,10),parseInt(f.width,10),false);}function _getEventPos(e){var domNodePosition=$D.position(this.domNode),mousePosition=$D.getMousePosition(e);return{x:parseInt(mousePosition.x-domNodePosition.x,10),y:parseInt(mousePosition.y-domNodePosition.y,10)};}function getOverlappedItems(e,win){var t=$D.eventTarget(win,e),p=t&&t.parentNode,c=p&&p.children,as=[],coords=t.getAttribute("coords");if(c&&!!coords){for(var i=0;i<c.length;++i){if(c[i]&&c[i].getAttribute&&c[i].getAttribute("coords")==coords){as.push(c[i]);}}}return as;}mstrmojo.DocXtabGraph=mstrmojo.declare(mstrmojo.GraphBase,[mstrmojo._Formattable,mstrmojo._HasWaitIcon,mstrmojo._IsSelectorTarget],{scriptClass:"mstrmojo.DocXtabGraph",cssClassPrefix:"mstrmojo-DocXtabGraph",areaMarkup:'<area shape="{@shape}" coords="{@coords}" ttl="{@tooltip}" aid="{@aid}" onclick="mstrmojo.all[\'{@id}\'].onClickArea(this, event);" onmousemove="mstrmojo.all[\'{@id}\']._updateTooltip(event, self);" {@extra}/>',_att:"",markupSlots:{imgNode:function(){return this.domNode.childNodes[1];},mapNode:function(){return this.domNode.childNodes.length>2?this.domNode.childNodes[2]:null;},textNode:function(){return this.domNode.firstChild;}},formatHandlers:{domNode:["RW","B","background-color","fx"]},markupMethods:{onvisibleChange:function(){this.domNode.style.display=(this.visible)?"block":"none";}},onClickArea:function onClickArea(elem,e){e=e||window.event;var ep=_getEventPos.apply(this,[e]),defn=this.defn,domNodePosition=$D.position(this.domNode),area=this.as[elem.getAttribute("aid")],key=this.k,x=ep.x,y=ep.y,anchor={getBoundingClientRect:function(){var left=domNodePosition.x+x,top=domNodePosition.y+y;return{left:left,top:top,right:left+1,bottom:top+1};},w:this};this.showInfoWin(area.tks,anchor);this.model.slice({type:parseInt(defn.t,10)||mstrmojo.EnumRWUnitType.GRAPH,src:key,ck:defn.ck,gk:key,tks:area.tks,cks:area.cks,sid:this.node.data.sid,x:x,y:y,anchor:anchor,tty:area.tty});},showInfoWin:function showInfoWin(tks,anchor){var m=this.model,ifws=tks&&m.getTargetInfoWin(tks);if(ifws&&ifws.length){for(var i=0;i<ifws.length;i++){m.showInfoWin(ifws[i],anchor,"h");}}},showTooltip:function showTooltip(e,win){this._updateTooltip(e,win);var items=getOverlappedItems(e,win);if(items&&items.length>1){mstrmojo.DocXtabGraph.multiTooltip.open(this,e,win,items);}else{this._super(e,win);}},_updateTooltip:function _updateTooltip(evt,win){this.updatingTooltipHelper($D.eventTarget(win,evt),_getEventPos.apply(this,[evt]));},hideTooltip:function hideTooltip(e,win){var elem=$D.eventTarget(win,e);if(elem.getAttribute("aid")===this.cAreaIdx){this.cAreaIdx=-1;var items=getOverlappedItems(e,win);if(items&&items.length>1){mstrmojo.DocXtabGraph.multiTooltip.close(this,e,win,items);}else{this._super(e,win);}}},update:function update(node){this.node.data=node.data;this.as=node.data.as;var sep="\u001E",m=this.model,cgbm=m.getCGBMap&&m.getCGBMap(),as=this.as||[],i,j;for(i=0;i<as.length;i++){var a=as[i],cgb=a&&a.tgbs;if(cgb){var cgbs=cgb.split(sep);var keys={};for(j=0;j<cgbs.length;j++){var k=cgbm&&cgbm[cgbs[j]];if(k){keys[k]=true;}else{keys[cgbs[j]]=true;}}a.tks=mstrmojo.hash.keyarray(keys).join(sep);}}this.eg=node.data.eg;},retrieveGraphSrc:function retrieveGraphSrc(h,w){var src=mstrConfig.taskURL+"?taskId=getRWGraphImage&taskEnv=xhr&__ts__="+(new Date().getTime())+"&messageID="+this.model.mid+"&nodeKey="+this.k+"&sliceID="+parseInt(this.node.data.sid,10)+"&imgType=4&width="+parseInt(w,10)+"&height="+parseInt(h,10)+"&sessionState="+mstrApp.sessionState,imgNode=this.imgNode;if(imgNode.src!==src){imgNode.src=src;}},resize:function(){adjustGraphHeight(this);},resizeForDisplayState:function resizeForDisplayState(h,w,doDom){var f=this.getFormats(),imgNode=this.imgNode;if(doDom){var dns=this.domNode.style;dns.top=f.top;dns.left=f.left;dns.height=f.height;dns.width=f.width;}if(imgNode){imgNode.style.height=h+"px";}if(!this.eg){this.retrieveGraphSrc(h,w);if(h){this.refreshMap();}}}});function getTargetWidth(a){if(a&&a.getAttribute){var c=a.getAttribute("coords");c=c&&c.split(",");if(c&&c.length>=3){return c[2]-c[0];}}return 0;}function getMultiPosition(targetWid){var p=[],docw=document.body.offsetWidth,doch=document.body.offsetHeight,maxw=0,maxh=0,x=ttpList[0]&&ttpList[0].domNode?ttpList[0].domNode.offsetLeft:0,y=ttpList[0]&&ttpList[0].domNode?ttpList[0].domNode.offsetTop:0,line=Math.ceil(ttpList.length/2),margin=5,originalX=function(x,tpWid){if(x+targetWid+tpWid+margin>docw){return docw-targetWid-tpWid-margin;}else{if(ttpList.length>1&&x-tpWid-margin<0){return tpWid+margin;}}return x;},originalY=function(y,tpHeight,line){y+=tpHeight;var toph=line==1?tpHeight:(line*tpHeight+(line-1)*margin)/2;if(toph>y){return 0;}else{if(toph+y>doch){return doch-toph*2;}else{return y-toph;}}};for(var i=0;i<ttpList.length;++i){maxw=Math.max(maxw,ttpList[i].containerNode.offsetWidth);maxh=Math.max(maxh,ttpList[i].containerNode.offsetHeight);}x=originalX(x,maxw);y=originalY(y,maxh,line);for(var i=0;i<ttpList.length;++i){if(i%2==0){p.push({l:x+targetWid+margin,t:y});}else{p.push({l:x-ttpList[i].containerNode.offsetWidth-margin,t:y});y+=maxh+margin;}}return p;}var ttpList=[];mstrmojo.DocXtabGraph.multiTooltip={_posMultiTp:function(multiPos){for(var i=0;i<ttpList.length;++i){ttpList[i].domNode.style.left=multiPos[i].l+"px";ttpList[i].domNode.style.top=multiPos[i].t+"px";}},open:function(opener,e,win,as,config){if(!config){config={};}config.e=e;config.win=win;var tw=0;if(as&&as.length){tw=getTargetWidth(as[0]);}for(var i=0;i<as.length;++i){var tp=ttpList[i];if(!tp||!mstrmojo.all[tp.id]){tp=new mstrmojo.Tooltip();var count=0,me=this;tp.optimizePos=function(){count++;if(count>=ttpList.length){count=0;me._posMultiTp(getMultiPosition(tw));}};ttpList.push(tp);}opener.richTooltip.content=as[i]&&as[i].getAttribute("ttl");tp.open(opener,config);}},close:function(){for(var j=ttpList.length-1;j>=0;--j){ttpList[j].close();}ttpList=[];}};}());