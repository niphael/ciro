(function(){mstrmojo.requiresCls("mstrmojo.XtabModel","mstrmojo.array","mstrmojo.func");var MX="Metrics",SELECTOR_ACTION=2;function _resolveCGBToTKS(cgbMap){if(!cgbMap){return ;}var scm=this.scm,delim="\u001E",i=0,id=null,curSelector=null,cgb=null,cgbKey=null,targetKey=null,updatedTks=false;for(id in scm){curSelector=scm[id];cgb=curSelector.cgb;for(i in cgb){cgKey=cgb[i];targetKey=cgbMap[cgKey];if(targetKey){if(!curSelector.tks){curSelector.tks=targetKey;updatedTks=true;}else{if(curSelector.tks&&(curSelector.tks.indexOf(targetKey)<0)){curSelector.tks+=delim+targetKey;updatedTks=true;}}}}}return updatedTks;}function createSelectorMap(){var data=this.data,gridTitles=data.gts;if(!gridTitles){return ;}var map;mstrmojo.array.forEach([gridTitles.row,gridTitles.col],function(axis){for(var i=0,cnt=axis.length;i<cnt;i++){var unit=axis[i];if(unit.sc){map=map||{};map[unit.id||MX]=unit.sc;if(unit.fid){map[unit.id+"_"+unit.fid]=unit.sc;}}}});this.scm=map;_resolveCGBToTKS.call(this,this.docModel.getCGBMap());}function submitToDataService(methodName,args){var dataService=this.getDataService();dataService[methodName].apply(dataService,args);}mstrmojo.DocXtabModel=mstrmojo.declare(mstrmojo.XtabModel,null,{scriptClass:"mstrmojo.DocXtabModel",docModel:null,init:function init(props){this._super(props);this.docModel.attachEventListener("CGBMapChange",this.id,function(evt){});},ondataChange:function ondataChange(evt){createSelectorMap.call(this);},getMessageId:function getMessageId(){return this.docModel.mid;},getDataService:function getDataService(){return this.docModel.getDataService();},getAction:function getAction(cells,domNode,isReselect){var cell=cells[0],actionType=cell&&cell.at;var action;if(actionType){if(actionType&SELECTOR_ACTION){var titleInfo=this.getCellTitleInfo(cell),title=titleInfo&&titleInfo.title,titleId=title&&title.id,selectorControlMap=this.scm;this.sti={titleId:titleId||MX};var sc=(titleId&&selectorControlMap[titleId])||selectorControlMap[MX];if(sc){var xtab=this.xtab,shouldDeselectCurrentCell=(xtab.allowToggleSelections&&sc.all&&isReselect),selectAllElements=(titleInfo.isSrcTitle||shouldDeselectCurrentCell);this.sti.deselectCurrent=shouldDeselectCurrentCell;action={h:"onGridSelector",a:{type:mstrmojo.EnumRWUnitType.GRID,anchor:domNode,ck:sc.ck,tks:sc.tks,eid:selectAllElements?"OA:(All)":cell._e.id,ctlKey:sc.ckey,sliceId:xtab.sid,isUConDS:sc.isUConDS}};}}}if(!action){var action=this._super(cells);}if(action&&action.a){action.a.sliceId=this.xtab.sid;}return action;},getDownloadAction:function getDownloadAction(rowPosition,maxRows,colPosition,maxCols,widgetID,memo){var action=this._super(rowPosition,maxRows,colPosition,maxCols,widgetID,memo);action.sliceId=this.xtab.sid;return action;},getDrillAction:function getDrillAction(cells){var action=this._super(cells);action.srcMsgId=this.docModel.mid;return action;},sort:function sort(params,callback){submitToDataService.call(this,"sort",arguments);},pivot:function pivot(params,callback){submitToDataService.call(this,"pivot",arguments);},drillGrid:function drillGrid(params,callback){submitToDataService.call(this,"drillGrid",arguments);},downloadGridData:function downloadGridData(params,callback){submitToDataService.call(this,"downloadGridData",arguments);},loadLayout:function loadLayout(res){this.docModel.loadLayout(res);}});})();