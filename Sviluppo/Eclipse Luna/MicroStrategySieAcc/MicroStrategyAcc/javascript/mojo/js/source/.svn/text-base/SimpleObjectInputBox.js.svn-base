(function(){mstrmojo.requiresCls("mstrmojo.ListBase","mstrmojo._IsList","mstrmojo._HasSuggestion","mstrmojo.Enum_Keys","mstrmojo.hash","mstrmojo.dom");var $DOM=mstrmojo.dom,$KEYS=mstrmojo.Enum_Keys,KEY_DELAY=200,markup;var STATES={DEFAULT:1,ADDING:2,EMPTY:3,FULL:4};var deleteCssCls="mstrmojo-SimpleObjectInputBox-del";function testInputText(){var inputBox=this.inputBox,text=inputBox.value;if(text!==this._lastPattern){this.showSuggestion(text);}this._lastPattern=text;delete this._timerHandle;}function clearInputTextTimer(){var timerHandle=this._timerHandle;if(timerHandle){window.clearTimeout(timerHandle);delete this._timerHandle;}}function setDefaultState(){var mx=this.maxObjectCount,itsLen=(this.items&&this.items.length)||0,isFull=(mx!=null&&itsLen>=mx);this.set("state",!itsLen?STATES.EMPTY:(isFull?STATES.FULL:STATES.DEFAULT));}mstrmojo.SimpleObjectInputBox=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo._HasSuggestion],{scriptClass:"mstrmojo.SimpleObjectInputBox",markupString:'<div id="{@id}" class="mstrmojo-ListBase mstrmojo-SimpleObjectInputBox {@cssClass}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-SimpleObjectInputBox-container {@icnCss}" style="{@icnCssText}">{@itemsHtml}<input type="text" mstrAttach:keydown,keyup,blur style="display: none;" /></div><div class="mstrmojo-SimpleObjectInputBox-empty"><div>{@emptyText}</div></div></div>',markupSlots:{itemsContainerNode:function(){return this.domNode.firstChild;},scrollboxNode:function(){return this.domNode;},emptyTextNode:function(){return this.domNode.childNodes[1];},inputBox:function(){return this.domNode.firstChild.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod,onmaxItemWidthChange:function onmaxItemWidthChange(){var w=this.maxItemWidth;if(!isNaN(w)){w+="px";}this.emptyTextNode.style.maxWidth=w;}},itemField:"n",emptyText:"",state:0,maxItemWidth:"none",useKeyDelay:false,maxObjectCount:null,getItemMarkup:function(item){if(!markup){var itemField=this.itemField;markup=this._super(item).replace(">{@n}<",' title="{@'+itemField+'}"><div class="elem">{@'+itemField+'}<div class="'+deleteCssCls+'"></div></div><');}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),itemField=this.itemField;props[itemField]=item[itemField];var maxWidth=this.maxItemWidth;if(!isNaN(maxWidth)){maxWidth=(maxWidth-24)+"px";}props.addStyle("max-width:"+maxWidth);return props;},getSuggestionPos:function getSuggestionPos(){var inputPosition=this._inputPos;return{target:this.inputBox,left:inputPosition.x,top:inputPosition.y+inputPosition.h,zIndex:100};},getSearchPattern:function getSearchPattern(){return this.inputBox.value;},onSuggestionItemSelect:function onSuggestionItemSelect(item){clearInputTextTimer.call(this);this.set("items",this.items.concat(item));this._super();var id=this.id;window.setTimeout(function(){var obj=mstrmojo.all[id];if(obj.state!=STATES.FULL){obj.set("state",STATES.ADDING);}},0);},onstateChange:function onstateChange(evt){var state=evt.value;this.emptyTextNode.style.display=(state===STATES.EMPTY)?"block":"none";var inputBox=this.inputBox,inputStyle=inputBox.style,itemsContainer=this.itemsContainerNode;if(state===STATES.ADDING){inputStyle.display="";inputBox.focus();this._inputPos=$DOM.position(inputBox,true);}else{clearInputTextTimer.call(this);inputStyle.display="none";inputBox.value="";this._lastPattern="";}},postBuildRendering:function postBuildRendering(){setDefaultState.call(this);return this._super();},preitemsChange:function preitemsChange(){setDefaultState.call(this);},onclick:function onclick(evt){var target=$DOM.eventTarget(evt.hWin,evt.e);if(target&&target.className===deleteCssCls){var item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),idx=item&&parseInt(item.value,10);if(idx!==null&&!isNaN(idx)){var items=this.items.concat();items.splice(idx,1);this.set("items",items);}return ;}if(this.state!=STATES.FULL){this.set("state",STATES.ADDING);}},onblur:function onblur(){clearInputTextTimer.call(this);if(!this.suggestionShown){setDefaultState.call(this);}},prekeydown:function prekeydown(evt){var e=evt.e;switch(parseInt(e.keyCode||e.charCode,10)){case $KEYS.DOWN_ARROW:this.nextHighlight();break;case $KEYS.UP_ARROW:this.preHighlight();break;case $KEYS.TAB:case $KEYS.ENTER:$DOM.preventDefault(evt.hWin,e);var item=this.getSelected();if(item){this.handleSuggestionItemSelect(item);}else{this.hideSuggestion();setDefaultState.call(this);}break;case $KEYS.ESCAPE:clearInputTextTimer.call(this);this.hideSuggestion();setDefaultState.call(this);break;case $KEYS.BACKSPACE:if(!this.getSearchPattern()){$DOM.preventDefault(evt.hWin,e);var items=this.items&&this.items.concat();if(items&&items.length){items.splice(items.length-1,1);this.set("items",items);var id=this.id;window.setTimeout(function(){mstrmojo.all[id].set("state",STATES.ADDING);},0);}}break;}},prekeyup:function prekeyup(){if(this.useKeyDelay){var id=this.id;if(!this._timerHandle){this._timerHandle=window.setTimeout(function(){testInputText.call(mstrmojo.all[id]);},KEY_DELAY);}}else{testInputText.call(this);}}});}());