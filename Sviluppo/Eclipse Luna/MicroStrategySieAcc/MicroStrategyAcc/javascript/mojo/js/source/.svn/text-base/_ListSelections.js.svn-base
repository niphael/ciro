(function(){mstrmojo.requiresCls("mstrmojo.array");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash;function _add(me,idxs){if(!idxs){return ;}var added=[],sel=me.selectedIndices,allIdx=me.allIdx,noneIdx=me.noneIdx,inc=me.parent&&me.parent.include;if(me.multiSelect&&(noneIdx>-1)&&($ARR.indexOf(idxs,noneIdx)>-1)){return added;}var i,len,items=me.items,idf=me.itemIdField,selectedItems=me.selectedItems,item;if(me.multiSelect&&(allIdx>-1)&&($ARR.indexOf(idxs,me.allIdx)>-1)){for(i=0,len=items.length;i<len;i++){if(!sel[i]){added.push(i);sel[i]=true;me.selectedIndex=i;me.selectedItem=items[i];}}}else{for(i=0,len=idxs.length;i<len;i++){var idx=idxs[i];if(!sel[idx]){sel[idx]=true;added.push(idx);me.selectedIndex=idx;item=me.selectedItem=items[idx];if(selectedItems){selectedItems[item[idf]]=item;}}}}return added;}function _rmvAll(me){var rmv=[],sel=me.selectedIndices,selectedItems=me.selectedItems;for(var i in sel){delete sel[i];rmv.push(parseInt(i,10));}me.selectedIndex=-1;me.selectedItem=null;if(selectedItems){me.selectedItems={};}return rmv;}function _rmv(me,idxs){if(!idxs){return ;}var removed=[],sel=me.selectedIndices,arrIdx=$ARR.indexOf,allIdx=me.allIdx,noneIdx=me.noneIdx,idf=me.itemIdField,selectedItems=me.selectedItems;if(me.multiSelect&&(((allIdx>-1)&&(arrIdx(idxs,allIdx)>-1))||((noneIdx>-1)&&(arrIdx(idxs,noneIdx)>-1)))){return _rmvAll(me);}if(idxs.length>0&&sel[allIdx]){if(arrIdx(idxs,allIdx)<0){idxs.push(allIdx);}}for(var i=0,len=idxs.length;i<len;i++){var idx=idxs[i];if(sel[idx]){delete sel[idx];removed.push(idx);if(selectedItems){delete selectedItems[me.items[idx][idf]];}if(me.selectedIndex==idx){me.selectedIndex=-1;me.selectedItem=null;}}}return removed;}function _raise(me,added,removed,idxs){if(me.raiseEvent){me.raiseEvent({name:"select",idxs:idxs||[]});if((added&&added.length)||(removed&&removed.length)){try{me.raiseEvent({name:"selectionChange",added:added,removed:removed});}catch(ex){_rmv(me,added);_add(me,removed);throw ex;}}}}function indexOf(me,item){if(item==null){return -1;}var isObject=typeof (item)=="object",idf=me.itemIdField;if(isObject&&idf!=null){return $ARR.find(me.items,idf,item[idf]);}else{return $ARR.indexOf(me.items,item);}}mstrmojo._ListSelections={multiSelect:false,allIdx:-1,items:null,selectedIndices:null,selectedIndex:-1,selectedIndices_bindEvents:"selectionChange",selectedIndex_bindEvents:"selectionChange",selectedItem:null,selectedItem_bindEvts:"selectionChange",allowUnlistedValues:true,selectedItems:null,supportsIncFetch:false,init:function(props){this._super(props);if(this.supportsIncFetch&&this.itemIdField){this.selectedItems={};}if(!this.items){this.items=[];}if(!this.selectedIndices){this.selectedIndices={};if(this.selectedIndex>-1){this._set_selectedIndex("selectedIndex",this.selectedIndex,true);}else{if(this.selectedItem){this._set_selectedItem("selectedItem",this.selectedItem,true);}}}},addItems:function addItems(newItems){if(!newItems){return ;}if(newItems.constructor!=Array){newItems=[newItems];}var items=this.items,start=this.items.length,selectedItems=this.selectedItems,newSelected=[],end;items=this.items=items.concat(newItems);end=items.length;if(selectedItems){var selectedIndices=this.selectedIndices,idf=this.itemIdField,i,item;for(i=start;i<items.length;i++){item=items[i];if(selectedItems[item[idf]]){newSelected.push(i);}}}if(newSelected&&newSelected.length){_add(this,newSelected);}if(end>start){this.itemsContainerNode.innerHTML+=this._buildItemsMarkup(start,end-1).join("");}},addSelectedItems:function addSelectedItems(newSelections){this.selectItems(newSelections,false);},setSelectedItems:function setSelectedItems(newSelections){this.selectItems(newSelections,true);},selectItems:function selectItems(newSelections,clearPrevSelections){if(!newSelections){return ;}if(newSelections.constructor!=Array){newSelections=[newSelections];}var me=this;if(clearPrevSelections&&me.selectedItems){me.selectedItems={};}var selectedItems=me.selectedItems,idf=me.itemIdField,item,idx,i,addedItems=[],addedIdx=me.items.length,newSelectedIndices=[],allowUnlistedValues=me.allowUnlistedValues;for(i=0;i<newSelections.length;i++){item=newSelections[i];idx=indexOf(this,item);if(idx===-1){if(selectedItems===null){if(allowUnlistedValues){addedItems.push(v);idx=addedIdx++;}}else{selectedItems[item[idf]]=item;}}if(idx!==-1){newSelectedIndices.push(idx);}}if(addedItems.length>0){me.addItems(addedItems);}if(newSelectedIndices.length>0){if(clearPrevSelections){me.select(newSelectedIndices);}else{me.addSelect(newSelectedIndices);}}},unselectItems:function selectItems(items){if(!items){return ;}if(items.constructor!=Array){items=[items];}var me=this,selectedItems=me.selectedItems,unselectedIndices=[],idf=me.itemIdField,item,idx,i;if(selectedItems===null){return ;}for(i=0;i<items.length;i++){item=items[i];if(selectedItems){delete selectedItems[item[idf]];}idx=indexOf(this,item);if(idx!==-1){unselectedIndices.push(idx);}}if(unselectedIndices.length>0){me.removeSelect(unselectedIndices);}},getSelectedItems:function getSelectedItems(){if(this.selectedItems!=null){return $HASH.valarray(this.selectedItems);}else{return $ARR.get(this.items,$HASH.keyarray(this.selectedIndices,true));}},singleSelect:function(idx,suppressEvt){if(idx!==-1){this.select([idx],suppressEvt);}},singleSelectByField:function singleSelectByField(value,fieldName,suppressEvt){this.singleSelect($ARR.find(this.items,fieldName,value),suppressEvt);},toggleSelect:function(idx){var add,rmv;if(this.selectedIndices[idx]){rmv=_rmv(this,[idx]);}else{add=_add(this,[idx]);}_raise(this,add,rmv,[idx]);},rangeSelect:function(idx){},select:function(idxs,bSuppressEvt){if(idxs==null){return ;}if(idxs.constructor!=Array){idxs=[idxs];}var rmv=_rmvAll(this),add=_add(this,idxs),i=rmv.length-1;if(this.selectionPolicy!=="reselect"){for(;i>=0;i--){var ind=$ARR.indexOf(add,rmv[i]);if(ind>-1){rmv.splice(i,1);add.splice(ind,1);}}}if(!bSuppressEvt){_raise(this,add,rmv,idxs);}},clearSelect:function(bSuppressEvt){var ret=_rmvAll(this);if(bSuppressEvt!==true){_raise(this,null,ret,[]);}},addSelect:function(idxs,bSuppressEvt){if(idxs==null){return ;}if(idxs.constructor!=Array){idxs=[idxs];}var ret=_add(this,idxs);var rmv=null,noneIdx=this.noneIdx;if(this.multiSelect&&(noneIdx>-1&&$ARR.indexOf(idxs,noneIdx)>-1)){rmv=_rmv(this,idxs);}if(bSuppressEvt!==true){_raise(this,ret,rmv,idxs);}},removeSelect:function(idxs){if(idxs==null){return ;}if(idxs.constructor!=Array){idxs=[idxs];}_raise(this,null,_rmv(this,idxs),idxs);},_set_selectedIndices:function(n,v,bSuppressEvt){var me=this,sel=me.selectedIndices;if(me.selectedItems){me.selectedItems={};}var sel=me.selectedIndices;if(sel==v){return false;}if(!sel){sel={};me.selectedIndices=sel;}if(!v){v={};}var sidx=me.selectedIndex,rmv=[],idx;for(idx in sel){if(!v[idx]){idx=parseInt(idx,10);delete sel[idx];rmv.push(idx);if(sidx==idx){me.selectedIndex=-1;me.selectedItem=null;}}}var add=[],itms=me.items,idf=me.itemIdField,item;for(idx in v){if(!sel[idx]){idx=parseInt(idx,10);sel[idx]=true;add.push(idx);me.selectedIndex=idx;item=me.selectedItem=itms[idx];if(me.selectedItems){me.selectedItems[item[idf]]=item;}}}if(bSuppressEvt!==true){var idxs=[];for(idx in v){if(sel[idx]){idx=parseInt(idx,10);idxs.push(idx);}}_raise(me,add,rmv,idxs);}return(add.length||rmv.length);},_set_selectedIndex:function(n,v,bSuppressEvt){var idxs={};if(v>-1){idxs[v]=true;}return this._set_selectedIndices("selectedIndices",idxs,bSuppressEvt);},_set_selectedItem:function(n,v,bSuppressEvt){var idx=indexOf(this,v);if((idx===-1)&&(v!=null)&&this.allowUnlistedValues&&this.items){this.set("items",this.items.concat(v));idx=this.items.length-1;}return this._set_selectedIndex("selectedIndex",idx,bSuppressEvt);}};})();