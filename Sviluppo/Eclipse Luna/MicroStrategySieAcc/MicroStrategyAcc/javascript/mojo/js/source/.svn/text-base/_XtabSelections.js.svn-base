(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.array");var ROW_AXIS=1,COL_AXIS=2;function _isOfSameUnit(c1,c2){return _isOfSameTitle(c1,c2)&&c1.o===c2.o;}function _isOfSameTitle(c1,c2){return c1&&c2&&c1.ui===c2.ui&&c1.axis===c2.axis&&c1.mix===c2.mix;}function _addToSelection(td,cell,w){var ttlId=w.getCellTitleId(cell),idx=w.getCellUnitIndex(cell);w.selections[ttlId]=w.selections[ttlId]||{};w.selections[ttlId][idx]=w.selections[ttlId][idx]||[];w.selections[ttlId][idx].push(td);_hilite(td);}function _clearSelection(w){var sel=w.selections;for(var i in sel){for(var j in sel[i]){for(var k=0,len=sel[i][j].length;k<len;k++){_unHilite(sel[i][j][k]);}}}w.selections={};}function _hilite(td){mstrmojo.css.setOpacity(td,50);}function _unHilite(td){mstrmojo.css.setOpacity(td,100);}function _getFormCount(cell,w){if(cell.mix===undefined){var titles=w.gridData.gts[cell.axis===ROW_AXIS?"row":"col"],ttl=titles[cell.tui||cell.ui],count=0;for(var i=0,len=titles.length;i<len;i++){if(titles[i].id===ttl.id){count++;}}return count;}return 0;}mstrmojo._XtabSelections={lastSelectedTD:null,singleSelect:function singleSelect(td,toggle){var data=this.getCellForNode(td),row=td.parentNode;if(toggle){var ttlId=this.getCellTitleId(data),idx=this.getCellUnitIndex(data);selectedTitle=this.selections[ttlId];selectedUnit=selectedTitle&&selectedTitle[idx];if(selectedUnit){for(var i=0,len=selectedUnit.length;i<len;i++){_unHilite(selectedUnit[i]);}delete selectedTitle[idx];return ;}}var totalForms=_getFormCount(data,this);if(data.axis===ROW_AXIS){for(var i=0,formFound=0,len=row.cells.length;i<len&&formFound<totalForms;i++){var tc=row.cells[i],tcData=this.getCellForNode(tc);if(_isOfSameUnit(tcData,data)){_addToSelection(tc,tcData,this);formFound++;}}}else{if(data.axis===COL_AXIS){var table=mstrmojo.dom.findAncestorByName(td,"table",false),rows=table.rows;for(var i=0,formFound=0,len=rows.length;i<len&&formFound<totalForms;i++){var cells=rows[i].cells;for(var j=0,len2=cells.length;j<len2;j++){var tc=cells[j],tcData=this.getCellForNode(tc);if(_isOfSameUnit(tcData,data)){_addToSelection(tc,tcData,this);formFound++;break;}}}}else{_addToSelection(td,data,this);}}},rangeSelect:function rangeSelect(fromTD,toTD){var fromCell=this.getCellForNode(fromTD),toCell=this.getCellForNode(toTD);if(_isOfSameTitle(fromCell,toCell)){if(fromCell.o>toCell.o||fromCell._ei>toCell._ei){var tmp=fromTD;fromTD=toTD;fromCell=this.getCellForNode(fromTD);toTD=tmp;toCell=this.getCellForNode(toTD);}var totalForms=_getFormCount(fromCell,this),axis=fromCell.axis,table=mstrmojo.dom.findAncestorByName(fromTD,"table",false),rows=table.rows,fromRow=fromTD.parentNode,fromRowIdx=fromRow.rowIndex,fromRowCells=fromRow.cells,toRowIdx=toTD.parentNode.rowIndex;if(axis===ROW_AXIS){for(var i=fromRowIdx;i<=toRowIdx;i++){var cells=rows[i].cells,found1=false;for(var j=0,len=cells.length,formFound=0;j<len&&formFound<totalForms;j++){var tc=cells[j],tcData=this.getCellForNode(tc);if(_isOfSameTitle(tcData,fromCell)){_addToSelection(tc,tcData,this);formFound++;}}}}else{if(axis===COL_AXIS){for(var i=0,len=rows.length,formsFound=0;i<len&&formsFound<totalForms;i++){var cells=rows[i].cells,shouldSelect=false;for(var j=0,len2=cells.length;j<len2;j++){var tc=cells[j],tcData=this.getCellForNode(tc);if(_isOfSameUnit(tcData,fromCell)){shouldSelect=true;}if(shouldSelect){_addToSelection(tc,tcData,this);}if(_isOfSameUnit(tcData,toCell)){break;}}if(shouldSelect){formsFound++;}}}else{if(fromRowIdx==toRowIdx){for(var i=fromTD.cellIndex,len=toTD.cellIndex;i<=len;i++){var tc=fromRowCells[i],tcData=this.getCellForNode(tc);_addToSelection(tc,tcData,this);}}else{for(var i=fromRowIdx,len=toRowIdx;i<=len;i++){var cells=rows[i].cells;for(var j=0,len2=cells.length;j<len2;j++){var tc=cells[j],tcData=this.getCellForNode(tc);if(_isOfSameTitle(tcData,fromCell)){_addToSelection(tc,tcData,this);break;}}}}}}}},doSelection:function(e,hWin,td){var d=mstrmojo.dom,ctrl=d.ctrlKey(hWin,e),shift=d.shiftKey(hWin,e);if(!ctrl){_clearSelection(this);}var data=this.getCellForNode(td);var isHeaderValue=data&&(data.mix===undefined&&data.o!==undefined),isMetricValue=data&&(data.mix!==undefined&&(data._lp||data._tp));if(isHeaderValue||isMetricValue){if(shift){this.rangeSelect(this.lastSelectedTD,td);}else{this.singleSelect(td,ctrl);this.lastSelectedTD=td;}}}};})();