(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.VisChartUtils","mstrmojo._TouchGestures","mstrmojo._HasTouchScroller","mstrmojo.color","mstrmojo.array","mstrmojo.css");var browserSupportsHtml5=true;var DISPLAY_MODE_AUTOMATIC="0",DISPLAY_MODE_AREA="1",DISPLAY_MODE_BUBBLE="2";var MARKER_UNDEFINED=0,MARKER_IMAGE=1,MARKER_BUBBLE=2;var SHAPE_FILE_UNDEFINED=0,SHAPE_FILE_POLYGON=1,SHAPE_FILE_POINT=2;var THRESHOLD_UNDEFINED=0,THRESHOLD_COLOR=1,THRESHOLD_IMAGE=2;var SIZE_MODE_AUTOMATIC=0,SIZE_MODE_MANUAL=1;var MAX_RATIO_UP_LIMIT=1,MAX_RATIO_LOW_LIMIT=0.01;var MAX_SIZE_DEFAULT_RATIO_FOR_SCATTER=0.3,MAX_SIZE_DEFAULT_RATIO_FOR_AUTOMATIC=0.3,MAX_SIZE_DEFAULT_RATIO_FOR_MANUAL=0.3;var HIGHLIGHT_MODE_NORMAL=0,HIGHLIGHT_MODE_HOVER=1,HIGHLIGHT_MODE_SELECTED=2;var THEME_DARK=0,THEME_LIGHT=1;var DRILLING_ACTION=1,SELECTOR_ACTION=2,HYPERLINK_ACTION=4;var ROW_AXIS=1,COL_AXIS=2;var DEFAULT_BG_COLOR="#FFFFFF";var POLY_COLOR_NO_ALT_DARK_THEME="RGBA(139,139,139,0.8)",POLY_COLOR_NO_COLORBY_DARK_THEME="RGBA(33,195,255,0.8)",POLY_COLOR_NO_ALT_LIGHT_THEME="RGBA(195,195,195,0.8)",POLY_COLOR_NO_COLORBY_LIGHT_THEME="RGBA(112,168,207,0.8)",POLY_STROKE_COLOR_DARK_THEME="#4C4C4C",POLY_STROKE_COLOR_LIGHT_THEME="#FFFFFF",POLY_NORMAL_OPACITY=0.8,POLY_ABOVE_BG_OPACITY=0.7,POLY_UNDER_BUBBLE_OPACITY=1,POLY_HOVER_OPACITY=0.5,POLY_LINKDRILL_OPACITY=0.5,POLY_SELECTED_OPACITY_WITHOUT_BG=1,POLY_SELECTED_OPACITY_WITH_BG=0.7,POLY_UNSELECTED_OPACITY=0.5,POLY_SELECTED_HOVER_OPACITY_WITH_BG=0.7,POLY_SELECTED_HOVER_OPACITY_WITHOUT_BG=1,POLY_STROKE_COLOR_HOVER_DARK_THEME="#FFFFFF",POLY_STROKE_COLOR_HOVER_LIGHT_THEME="#000000",POLY_STROKE_COLOR_LINKDRILL_DARK_THEME="#FFFFFF",POLY_STROKE_COLOR_LINKDRILL_LIGHT_THEME="#000000",POLY_STROKE_COLOR_SELECTED_DARK_THEME="#FFFFFF",POLY_STROKE_COLOR_SELECTED_LIGHT_THEME="#000000",POLY_STROKE_COLOR_SELECTED_HOVER_DARK_THEME="RGBA(0,0,0,0)",POLY_STROKE_COLOR_SELECTED_HOVER_LIGHT_THEME="RGBA(0,0,0,0)",BUBBLE_COLOR_NO_COLORBY_DARK_THEME="RGBA(33,195,255,0.8)",BUBBLE_COLOR_NO_COLORBY_LIGHT_THEME="RGBA(31,119,180,0.8)",BUBBLE_STROKE_COLOR_DARK_THEME="RGBA(129,129,129,0.8)",BUBBLE_STROKE_COLOR_LIGHT_THEME="RGBA(129,129,129,0.8)",BUBBLE_NORMAL_OPACITY=0.8,BUBBLE_HOVER_OPACITY=0.5,BUBBLE_SELECTED_OPACITY=1,BUBBLE_LINKDRILL_OPACITY=0.8,BUBBLE_STROKE_COLOR_HOVER_DARK_THEME="RGBA(129,129,129,0.8)",BUBBLE_STROKE_COLOR_HOVER_LIGHT_THEME="RGBA(129,129,129,0.8)",BUBBLE_STROKE_COLOR_LINKDRILL_DARK_THEME="RGBA(129,129,129,0.8)",BUBBLE_STROKE_COLOR_LINKDRILL_LIGHT_THEME="RGBA(129,129,129,0.8)",BUBBLE_STROKE_COLOR_SELECTED_DARK_THEME="RGBA(255,255,255,0.8)",BUBBLE_STROKE_COLOR_SELECTED_LIGHT_THEME="RGBA(0,0,0,0.8)",BUBBLE_HIGHLIGHT_STROKE_COLOR_DARK_THEME="#FFFFFF",BUBBLE_HIGHLIGHT_STROKE_COLOR_LIGHT_THEME="#000000";var ERROR_MSG_FONT_COLOR_DARK_THEME="#FFF",ERROR_MSG_FONT_COLOR_LIGHT_THEME="#000";var RENDERING_TIME=300;function isOwnEmpty(obj){var name;for(name in obj){if(obj.hasOwnProperty(name)){return false;}}return true;}function getLighterColor(c){var rgb=mstrmojo.color.hex2rgb(c);mstrmojo.array.forEach(rgb,function(v,idx){rgb[idx]=Math.floor(v*0.75);});return"rgb("+rgb.join(",")+")";}function positionTooltip(tooltip,touchX,touchY){var tooltipStyle=tooltip.style,translateValue="translate("+touchX+"px, "+touchY+"px)",translateValue3d=translateValue.replace("late(","late3d(").replace("px)","px, 0)");tooltipStyle.MozTransform=translateValue;tooltipStyle.msTransform=translateValue;tooltipStyle.webkitTransform=translateValue3d;tooltipStyle.transform=translateValue3d;}function inPoly(poly,px,py){var npoints=poly.length,inside=false,xnew,ynew,xold,yold,x1,y1,x2,y2,i;if(npoints/2<3){return false;}xold=poly[npoints-2];yold=poly[npoints-1];for(i=0;i<npoints;i=i+2){xnew=poly[i];ynew=poly[i+1];if(xnew>xold){x1=xold;x2=xnew;y1=yold;y2=ynew;}else{x1=xnew;x2=xold;y1=ynew;y2=yold;}if((xnew<px)===(px<=xold)&&((py-y1)*(x2-x1)<(y2-y1)*(px-x1))){inside=!inside;}xold=xnew;yold=ynew;}return inside;}function drawPoly(ctx,coordsArray,offset,strokeColor,strokeWidth,fillColor){try{var offsetX=offset?offset.x:0,offsetY=offset?offset.y:0;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};var i,j;for(i=0;i<coordsArray.length;i++){var pointsArray=coordsArray[i];ctx.beginPath();ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){var xx=getPointAt(j),yy=getPointAt(j+1);ctx.lineTo(xx,yy);}var x=getPointAt(0),y=getPointAt(1),fillStyle=fillColor;ctx.lineTo(x,y);ctx.fillStyle=fillStyle;ctx.fill();ctx.strokeStyle=strokeColor;ctx.lineWidth=strokeWidth;ctx.stroke();}}catch(e){}}function drawBubble(context,pt,offset,color,radius){context.fillStyle=color;context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();context.fill();}function drawStroke(context,pt,offset,color,radius,strokeWidth){context.strokeStyle=color;context.lineWidth=strokeWidth;context.beginPath();context.arc(pt[0]+offset.x,pt[1]+offset.y,radius,0,Math.PI*2,true);context.closePath();context.stroke();}function getShapeFileType(coords){if(coords){var elem;for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}if(coords[elem][0]){if(coords[elem][0].length===2){return SHAPE_FILE_POINT;}else{if(coords[elem][0].length>2){return SHAPE_FILE_POLYGON;}else{return SHAPE_FILE_UNDEFINED;}}}else{return SHAPE_FILE_UNDEFINED;}}}}else{return SHAPE_FILE_UNDEFINED;}}function getPolygonCenter(pointsArr){var sumX=0,sumY=0;i;for(i=0;i<pointsArr.length;i++){sumX=sumX+pointsArr[i];i++;sumY=sumY+pointsArr[i];}var centerX=sumX/(pointsArr.length/2),centerY=sumY/(pointsArr.length/2),center1=[centerX,centerY];center2=[];center2.push(center1);return center2;}function getCentroidOfPolygon(points){if(points==null||points.length<4){return null;}var area=0,len=points.length,i,px,py,p2x,p2y;for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];area+=(px*p2y-p2x*py);}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];area+=(px*p2y-p2x*py);area=Math.abs(area/2);if(area<=0){return null;}var centroid=[0,0];for(i=0;i<len-2;i+=2){px=points[i];py=points[i+1];p2x=points[i+2];p2y=points[i+3];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));}px=points[len-2];py=points[len-1];p2x=points[0];p2y=points[1];centroid[0]+=((px+p2x)*(px*p2y-p2x*py));centroid[1]+=((py+p2y)*(px*p2y-p2x*py));centroid=[Math.abs(centroid[0]/(area*6)),Math.abs(centroid[1]/(area*6))];var two_dim_centroid=[];two_dim_centroid.push(centroid);return two_dim_centroid;}function getOpacityColor(color,opacity){var opacityColor,i;var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(color){var colorNew;if(/^(rgba|RGBA)/.test(color)){var tempColor=color.replace(/rgba\(|RGBA\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");opacityColor="RGBA("+colorNew[0]+","+colorNew[1]+","+colorNew[2]+","+opacity+")";return opacityColor;}else{if(/^(rgb|RGB)/.test(color)){colorNew=color.replace(/rgb\(|RGB\(/,"");colorNew=colorNew.replace(")","");opacityColor="RGBA("+colorNew+","+opacity+")";return opacityColor;}else{if(reg.test(color)){if(color.length===4){colorNew="#";for(i=1;i<4;i++){colorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}color=colorNew;}var colorChange=[];for(i=1;i<7;i+=2){colorChange.push(parseInt("0x"+color.slice(i,i+2)));}colorChange.push(opacity);opacityColor="RGBA("+colorChange.join(",")+")";return opacityColor;}else{return color;}}}}else{return null;}}function getThemeMode(color){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,i,r,g,b,brightness;if(color){var colorNew,tempColor;if(/^(rgba|RGBA)/.test(color)){tempColor=color.replace(/rgba\(|RGBA\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");r=colorNew[0];g=colorNew[1];b=colorNew[2];}else{if(/^(rgb|RGB)/.test(color)){tempColor=color.replace(/rgb\(|RGB\(/,"");tempColor=tempColor.replace(")","");colorNew=tempColor.split(",");r=colorNew[0];g=colorNew[1];b=colorNew[2];}else{if(reg.test(color)){if(color.length===4){colorNew="#";for(i=1;i<4;i++){colorNew+=color.slice(i,i+1).concat(color.slice(i,i+1));}color=colorNew;}var colorChange=[];for(i=1;i<7;i+=2){colorChange.push(parseInt("0x"+color.slice(i,i+2)));}r=colorChange[0];g=colorChange[1];b=colorChange[2];}else{return THEME_DARK;}}}brightness=(r*299+g*587+b*114)/1000;if(brightness>150){return THEME_LIGHT;}else{return THEME_DARK;}}else{return THEME_DARK;}}function drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height){hlContext.strokeStyle="#FFF";hlContext.lineWidth=2;hlContext.beginPath();hlContext.moveTo(xOffset+width*0.25,yOffset);hlContext.lineTo(xOffset,yOffset);hlContext.lineTo(xOffset,yOffset+height*0.25);hlContext.moveTo(xOffset,yOffset+height*0.75);hlContext.lineTo(xOffset,yOffset+height);hlContext.lineTo(xOffset+width*0.25,yOffset+height);hlContext.moveTo(xOffset+width*0.75,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height);hlContext.lineTo(xOffset+width,yOffset+height*0.75);hlContext.moveTo(xOffset+width,yOffset+height*0.25);hlContext.lineTo(xOffset+width,yOffset);hlContext.lineTo(xOffset+width*0.75,yOffset);hlContext.stroke();hlContext.closePath();}mstrmojo.AndroidVisMap=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._TouchGestures,mstrmojo._HasTouchScroller],{scriptClass:"mstrmojo.AndroidVisMap",model:null,utils:mstrmojo.VisChartUtils,scrollerConfig:{bounces:false,showScrollbars:false,useTranslate3d:true,vScroll:true,hScroll:true,offset:{y:{start:0,end:0},x:{start:0,end:0}},origin:{x:0,y:0}},relScaleFactor:1,scaleFactor:1,currSelectedObj:null,defaultSelectedObjs:{},currHoverObj:null,currLinkObj:null,tooltipOn:false,context:null,multiTap:true,multiTouch:true,browserSupportsHtml5:true,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="width:{@width};height:{@height};top:{@top};left:{@left};z-index:{@zIndex};position:absolute;{@cssText};overflow:hidden;"  mstrAttach:mouseover,mousemove ><div id="{@id}"-scroll-element style="position:absolute;left:0;top:0;width:{@width};height={@height}"><canvas id="{@id}-highlightCanvas" style="position:absolute;left:0;top:0;z-index:100" width="{@width}" height="{@height}"></canvas><canvas id="{@id}-animationCanvas" style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas></div><div id="{@id}-tooltip" style="z-index:200" class="mstrmojo-ImageLayout-tooltip" clk="clk"><table style="margin:5px 7px"></table></div><div id="{@id}-infowindow-anchor" style="position:absolute;width:18px;height:18px;display:block"></div><div id="{@id}-css" style="display:none"></div><div id="{@id}-errMsg" align="center" style="position:absolute; z-index:300; top:35%; word-wrap:break-word;"></div></div>',markupSlots:{scrollableCanvasDiv:function(){return this.domNode.childNodes[0];},highlightCanvas:function(){return this.domNode.childNodes[0].firstChild;},animationCanvas:function(){return this.domNode.childNodes[0].lastChild;},tooltip:function(){return this.domNode.childNodes[1];},infowindowAnchor:function(){return this.domNode.childNodes[2];},cssDiv:function(){return this.domNode.childNodes[3];},errorMessage:function(){return this.domNode.childNodes[4];}},postBuildRendering:function postBuildRendering(){var me=this;me.setFontByDPI();browserSupportsHtml5=me.highlightCanvas.getContext;if(!browserSupportsHtml5){me.renderErrorMessage(mstrmojo.desc(8126,"Your browser does not support HTML5"));return ;}if(me.model.hasOwnProperty("eg")){var errorMessage=me.model.eg,wrongTemplateStr="The Image Layout requires:";if(errorMessage.match(wrongTemplateStr)){me.renderErrorMessage(mstrmojo.desc(9853,errorMessage));}else{me.renderErrorMessage(errorMessage);}return ;}me.newRenderFlag=true;me.attrIndices=me.getAttrIndices();me.createTooltipTable();me.getDefaultSelectedObjs();me.highlightContext=me.highlightCanvas.getContext("2d");me.animationContext=me.animationCanvas.getContext("2d");var sclConfig=me.scrollerConfig;sclConfig.scrollEl=me.scrollableCanvasDiv;sclConfig.offset.x.start=0;sclConfig.offset.x.end=me.getWidth()*(me.scaleFactor-1);sclConfig.offset.y.start=0;sclConfig.offset.y.end=me.getHeight()*(me.scaleFactor-1);if(sclConfig.origin.x>sclConfig.offset.x.end){sclConfig.origin.x=sclConfig.offset.x.end;}if(sclConfig.origin.y>sclConfig.offset.y.end){sclConfig.origin.y=sclConfig.offset.y.end;}me.animationCanvas.width=me.highlightCanvas.width=me.getWidth()*2;me.animationCanvas.height=me.highlightCanvas.height=me.getHeight()*2;if(!me.model.coords){if(typeof (mstrApp)!="undefined"&&mstrApp.serverRequest){var xhrCfg={success:function(res){if(!res){return ;}me.model.coords=res.coords;me.drawMap();if(me.markerType!==MARKER_IMAGE){me.highlightPoint();}me.adjustWidgetOffsets();if(!me.mapDataScreenshotTaken){me.mapDataScreenshotTaken=true;me.localTakeScreenshot(RENDERING_TIME);}},failure:function(res){}};params={taskId:"getMapCoordinates"};var vp=me.model.vp;if(vp&&vp.mf){params.coordinatesFile=vp.mf;}mstrApp.serverRequest(params,xhrCfg,{src:"postBuildRendering"});}}else{me.drawMap();me.highlightPoint();this.adjustWidgetOffsets();}if(this._super){this._super();}if(this._tn){var backup=this._tsCallback;this._tsCallback=function(e){me.infowindowOn=me.model.infowindowOn;me.currSelectedObjBackup=me.currSelectedObj;backup.call(this,e);};mstrmojo.dom.detachEvent(this._tn,mstrmojo.dom.TOUCHSTART,backup);mstrmojo.dom.attachEvent(this._tn,mstrmojo.dom.TOUCHSTART,this._tsCallback);}var xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){me.docModelListener=me.xtabModel.docModel.attachEventListener("infoWindowClosed",this.id,function(evt){me.model.infowindowOn=false;if(!me.hasNonifwTarget&&me.currSelectedObj){window.setTimeout(function(){me.currSelectedObj=null;me.highlightPoint();},10);}});}me.fullScreenListener=mstrmojo.touchManager.attachEventListener("fullScreenStateChange",this.id,function(evt){me.adjustWidgetOffsets();});},getFullPath:function getFullPath(path){var fullPath="";var reg=/^[A-z]:\/\//;if(reg.test(path)){fullPath=path;}else{var tempReg1=/^(..\/|..\\)/;var tempReg2=/^(.\/|.\\)/;var tempReg3=/^(\/|\\)/;path=path.replace(tempReg1,"");path=path.replace(tempReg2,"");path=path.replace(tempReg3,"");if(typeof (mstrApp)!="undefined"&&mstrApp.getConfiguration){fullPath=mstrmojo.url.getAbsoluteURL(path,mstrApp.getConfiguration().getCurrentProjectWebServerUrl());}}return fullPath;},touchMultiBegin:function(touch){this.hideTooltip();var touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length==2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:100,pageY:100};}var xDiff=touch1.pageX-touch2.pageX,yDiff=touch1.pageY-touch2.pageY;this.initDiffDiff=xDiff*xDiff+yDiff*yDiff;this.initCenterX=(touch1.pageX+touch2.pageX)>>1;this.initCenterY=(touch1.pageY+touch2.pageY)>>1;this.initScrollX=this._scroller.origin.x;this.initScrollY=this._scroller.origin.y;this.relScaleFactor=1;},touchMultiMove:function(touch){var touch1,touch2;if(touch.evt.touches&&touch.evt.touches.length==2){touch1=touch.evt.touches[0];touch2=touch.evt.touches[1];}else{touch1=touch;touch2={pageX:100,pageY:100};}var xDiff=touch1.pageX-touch2.pageX,yDiff=touch1.pageY-touch2.pageY,curDiffDiff=xDiff*xDiff+yDiff*yDiff,curCenterX=(touch1.pageX+touch2.pageX)>>1,curCenterY=(touch1.pageY+touch2.pageY)>>1;var scale=Math.sqrt(curDiffDiff/this.initDiffDiff);var offset={x:scale*(this.initCenterX+this.initScrollX)-curCenterX,y:scale*(this.initCenterY+this.initScrollY)-curCenterY};var transform={scale:scale,offset:offset};this.relScaleFactor=scale;this.applyTransform(transform);},touchMultiEnd:function(touch){if(this.relScaleFactor*this.scaleFactor<1){this.relScaleFactor=1/this.scaleFactor;this.applyTransform({scale:this.relScaleFactor},500,this.postScale);}else{if(this.relScaleFactor*this.scaleFactor>2){var scaleBack=this.relScaleFactor*this.scaleFactor/2;this.relScaleFactor=2/this.scaleFactor;this.applyTransform({scale:this.relScaleFactor,scaleBack:scaleBack},500,this.postScale);}else{this.postScale();}}},handleTouchSelectWithIfw:function handleTouchSelectWithIfw(touchX,touchY){var me=this,nearestObj=me.getAreaOrNearestBubble(false,touchX,touchY);if(!nearestObj){me.closeInfowindow();}else{if(nearestObj.hdrIndex<0){me.closeInfowindow();}else{if(!me.currSelectedObj||nearestObj.touchVal!==me.currSelectedObj.touchVal){me.showInfowindow(nearestObj);me.currSelectedObj=nearestObj;me.highlightPoint();}else{}}}},handleTouchSelectNoIfw:function handleTouchSelectNoIfw(touchX,touchY){var me=this,nearestObj=me.getAreaOrNearestBubble(false,touchX,touchY);if(!nearestObj){me.hideTooltip();}else{if(!me.currHoverObj||nearestObj.touchVal!==me.currHoverObj.touchVal){me.currHoverObj=nearestObj;me.highlightPoint();}else{me.renderTooltip(nearestObj.touchVal,nearestObj.point.x,nearestObj.point.y,nearestObj.hdrIndex);}}},touchSelectBegin:function(touch){if(touch.evt.ctrlKey){this.touchMultiBegin(touch);return ;}if(this.infowindowOn){this.touchSelectWithIfw=true;this.handleTouchSelectWithIfw(touch.pageX,touch.pageY);}else{this.handleTouchSelectNoIfw(touch.pageX,touch.pageY);}},touchSelectMove:function(touch){if(touch.evt.ctrlKey){this.touchMultiMove(touch);return ;}if(this.touchSelectWithIfw){this.handleTouchSelectWithIfw(touch.pageX,touch.pageY);}else{this.handleTouchSelectNoIfw(touch.pageX,touch.pageY);}},touchSelectEnd:function(touch){if(touch.evt.ctrlKey){this.touchMultiEnd(touch);}this.touchSelectWithIfw=false;return ;},touchSwipeBegin:function touchSwipeBegin(touch){this.hideTooltip();if(this._super){this._super(touch);}},applyTransform:function(transform,duration,callback){var scl=this._scroller;if(duration===undefined){duration=0;}scl.scrollEl.style.webkitTransformOrigin="left top";scl.transform="scale("+transform.scale+","+transform.scale+")";var scrollX,scrollY;if(transform.offset){scrollX=transform.offset.x;scrollY=transform.offset.y;}else{var scaleBack=transform.scaleBack||1;scrollX=this._scroller.origin.x/scaleBack;scrollY=this._scroller.origin.y/scaleBack;}var scrollerOffsetScale=this.scaleFactor*this.relScaleFactor-1,vOffsetEnd=this.getHeight()*scrollerOffsetScale,hOffsetEnd=this.getWidth()*scrollerOffsetScale;if(scrollerOffsetScale<0){scl.offset={y:{start:vOffsetEnd,end:0},x:{start:hOffsetEnd,end:0}};}else{scl.offset={y:{start:0,end:vOffsetEnd},x:{start:0,end:hOffsetEnd}};}this._scroller.scrollTo(scrollX,scrollY,duration);if(callback){var that=this;setTimeout(function(){callback.apply(that);that=null;},duration);}},pointCanBeSelected:function pointCanBeSelected(touchObj){var me=this,m=me.model,gts=m.gts,colHeaders=gts.col,colHL=colHeaders.length,rowHeaders=gts.row,rowHL=rowHeaders.length,i;for(i=0;i<rowHL;i++){var rowH=rowHeaders[i];if(rowH.sc&&rowH.sc.tks){return true;}if(rowH.lm&&rowH.lm[0]&&rowH.lm[0].links&&rowH.lm[0].hasOwnProperty("di")){return true;}}return false;},getModelK:function getModelK(){var k=this.model&&this.model.k;return k;},getActionObj:function getActionObj(touchedObj,selectedAll,sameAsCurrSelectedPoint){var scObjList=[],actionType=0,actionObjList=[],linkDrillNode=null;var me=this,model=me.model,gts=model.gts,rowH=gts.row[0];if(rowH.sc&&rowH.sc.tks&&(!touchedObj||touchedObj.hdrIndex>=0)){if(selectedAll&&(rowH.sc.all==="false"||rowH.sc.all===false)){return null;}var scObj={};scObj.sc=rowH.sc;if(touchedObj&&touchedObj>=0){scObj.es=rowH.es[touchedObj.hdrIndex].n;}else{scObj.es=null;}scObj.eid=selectedAll?"OA:(All)":rowH.es[touchedObj.hdrIndex].id;scObjList.push(scObj);actionType=rowH.at||0;}if(rowH.lm&&rowH.lm[0]&&rowH.lm[0].links&&!linkDrillNode&&touchedObj&&touchedObj.hdrIndex>=0){linkDrillNode={};linkDrillNode.titleInfo=rowH;linkDrillNode._e=rowH.es[touchedObj.hdrIndex];}var colH=gts.col&&gts.col.length>0&&gts.col[0];if(scObjList.length>0){actionType=actionType|SELECTOR_ACTION;if(touchedObj&&touchedObj.hdrIndex>=0){if(!sameAsCurrSelectedPoint){if(this.hasIfwTarget){this.getAnchorStyle(touchedObj);this.model.infowindowOn=true;return{at:actionType,k:this.getModelK(),scObjList:scObjList,anchor:this.infowindowAnchor};}else{return{at:actionType,k:this.getModelK(),scObjList:scObjList};}}else{return{at:actionType,k:this.getModelK(),scObjList:scObjList};}}else{if(touchedObj&&touchedObj.hdrIndex<0){return{at:actionType,k:this.getModelK(),scObjList:scObjList};}else{if(!touchedObj){return{at:actionType,k:this.getModelK(),scObjList:scObjList};}}}}if(!linkDrillNode&&touchedObj&&touchedObj.hdrIndex>=0){var metricH=colH,metricHL=metricH&&metricH.es&&metricH.es.length,i;if(metricH&&metricHL>0){for(i=metricHL-1;i>=0;i--){var metric=metricH.es[i],lm=metricH.lm[i];if(lm&&lm.links){linkDrillNode={};linkDrillNode.titleInfo=metricH;linkDrillNode.mix=i;var currNode=linkDrillNode,nodeLP={};nodeLP.titleInfo=rowH;nodeLP._e=rowH.es[touchedObj.hdrIndex];currNode._lp=nodeLP;currNode.axis=ROW_AXIS;}}}}if(linkDrillNode){actionType=actionType|HYPERLINK_ACTION;return{at:actionType,k:this.getModelK(),node:linkDrillNode};}return null;},getAnchorStyle:function getAnchorStyle(touchedObj){if(!touchedObj){return ;}var touchVal=touchedObj.touchVal,me=this,model=me.model,coords=model.coords,i,j,k;me.infowindowAnchor.style.left=(touchedObj.point.x-9)+"px";me.infowindowAnchor.style.top=(touchedObj.point.y-9)+"px";if(me.displayMode===DISPLAY_MODE_AREA){var minX=Number.POSITIVE_INFINITY,maxX=0,minY=Number.POSITIVE_INFINITY,maxY=0;if(coords.hasOwnProperty(touchVal)){var rgn=coords[touchVal];for(i in rgn){if(!rgn.hasOwnProperty(i)){continue;}var c=rgn[i];for(j=0;j<c.length;j++){if(minX>c[j]){minX=c[j];}if(maxX<c[j]){maxX=c[j];}j++;if(minY>c[j]){minY=c[j];}if(maxY<c[j]){maxY=c[j];}}}me.infowindowAnchor.style.left=(minX+me.leftOffset-me._scroller.origin.x)+"px";me.infowindowAnchor.style.top=(minY+me.topOffset-me._scroller.origin.y)+"px";me.infowindowAnchor.style.width=(maxX-minX)+"px";me.infowindowAnchor.style.height=(maxY-minY)+"px";}}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){if(me.shapeFileType===SHAPE_FILE_POLYGON){coords=model.polygonCenters;}if(coords.hasOwnProperty(touchVal)){if(me.markerType===MARKER_BUBBLE){var ct=coords[touchVal][0],rd=me.getRadiusFromName(touchVal);me.infowindowAnchor.style.left=(ct[0]+me.leftOffset-rd-me._scroller.origin.x)+"px";me.infowindowAnchor.style.top=(ct[1]+me.topOffset-rd-me._scroller.origin.y)+"px";me.infowindowAnchor.style.width=(2*rd)+"px";me.infowindowAnchor.style.height=(2*rd)+"px";}else{if(me.markerType===MARKER_IMAGE){var ct=coords[touchVal][0],_image=model["imageIcon_"+touchVal],_width=0,_height=0;if(_image){_width=_image.width;_height=_image.height;}me.infowindowAnchor.style.left=(ct[0]+me.leftOffset-_width/2-me._scroller.origin.x)+"px";me.infowindowAnchor.style.top=(ct[1]+me.topOffset-_height/2-me._scroller.origin.y)+"px";me.infowindowAnchor.style.width=_width+"px";me.infowindowAnchor.style.height=_height+"px";}}}}}},getLastHighlightPoint:function gtLstHighlightPnt(){return this.currHoverObj||null;},getTouchedObj:function getTouchedObj(isTap,touchX,touchY){var me=this;if(me.displayMode==DISPLAY_MODE_AREA){return this.getAreaOrNearestBubble(isTap,touchX,touchY);}else{if(me.displayMode==DISPLAY_MODE_BUBBLE){var touchedObj=this.getLastHighlightPoint(),touchPointOnWidget=me.utils.getTouchXYOnWidget(touchX,touchY,me);var touchPointInHighlightArea=false,tx=0,ty=0,twx=0,twy=0;if(touchedObj&&touchPointOnWidget){tx=touchedObj.point.x;ty=touchedObj.point.y;twx=touchPointOnWidget.touchX;twy=touchPointOnWidget.touchY;touchPointInHighLightArea=this.tooltipOn&&(tx-twx)*(tx-twx)+(ty-twy)*(ty-twy)<=this.bias*this.bias;}if(touchPointInHighlightArea){me.hideTooltip();touchedObj=this.getLastHighlightPoint();}else{touchedObj=this.getAreaOrNearestBubble(isTap,touchX,touchY);}return touchedObj;}}return null;},closeInfowindow:function closeInfowindow(){var me=this;me.getFirstInfowindow();if(me.model.infowindowOn&&me.infowindow){me.model.infowindowOn=false;me.infowindow.close();if(me.infowindow._tchHandler){mstrmojo.touchManager.detachEventListener(me.infowindow._tchHandler);delete me.infowindow._tchHandler;}}},getFirstInfowindow:function getFirstInfowindow(){var me=this,model=me.model,xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel),row=model&&model.gts&&model.gts.row,tks=null;if(row&&row.length>0){tks=row[0]&&row[0].sc&&row[0].sc.tks;}if(docModel&&tks){var ifws=docModel.getTargetInfoWin(tks);if(ifws&&ifws.length>0){var ifwunit=docModel.infoWinByKey[ifws[0]],id=ifwunit&&(ifwunit.id+"_ifw");me.infowindow=mstrmojo.all[id];}}},hasNoninfowindowTarget:function hasNoninfowindowTarget(actionObj){var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){var layouts=docModel.defn&&docModel.defn.layouts,layout=null,i;if(layouts){for(i in layouts){if(layouts.hasOwnProperty(i)){if(layouts[i].loaded){layout=layouts[i];break;}}}}var units=layout&&layout.units;if(units){for(i=0;i<actionObj.scObjList.length;i++){var scObj=actionObj.scObjList[i];var tksList=scObj.sc.tks.split("\x1E"),j;for(j=0;j<tksList.length;j++){var unit=units[tksList[j]];if(unit){if(!unit.ifw){return true;}}}}}}return false;},hasInfowindowTarget:function hasInfowindowTarget(actionObj){var xtabModel=this.xtabModel,docModel=(xtabModel&&xtabModel.docModel);if(docModel){var layouts=docModel.defn&&docModel.defn.layouts,layout=null,i;if(layouts){for(i in layouts){if(layouts.hasOwnProperty(i)&&layouts[i].loaded){layout=layouts[i];break;}}}var units=layout&&layout.units;if(units){for(i=0;i<actionObj.scObjList.length;i++){var scObj=actionObj.scObjList[i];var tksList=scObj.sc.tks.split("\x1E"),j;for(j=0;j<tksList.length;j++){var unit=units[tksList[j]];if(unit){if(unit.ifw){return true;}}}}}}return false;},touchTap:function touchTap(touch){var me=this;if(touch.count==2){me.hideTooltip();me.relScaleFactor=1/me.scaleFactor;me.applyTransform({scale:me.relScaleFactor},500,me.postScale);}else{if(touch.count==1){var actionObj;if(me.tooltipOn){var item=mstrmojo.dom.findAncestorByAttr(touch.target,"clk",true,this.domNode)||null;if(item){var value=item.value;if(value==="clk"){me.hideTooltip();return ;}}}var touchedObj=this.getTouchedObj(true,touch.pageX,touch.pageY);if(touchedObj&&touchedObj.hdrIndex>=0){var canBeSelected=me.pointCanBeSelected(touchedObj),sameAsCurrSelectedPoint=me.currSelectedObjBackup&&(touchedObj.touchVal==me.currSelectedObjBackup.touchVal),sameAsLastHighlight;if(canBeSelected){if(!sameAsCurrSelectedPoint){me.defaultSelectedObjs={};me.hideTooltip();actionObj=this.getActionObj(touchedObj);if(actionObj&&actionObj.scObjList){me.currSelectedObj=touchedObj;if(!me.hasOwnProperty("hasNonifwTarget")||!me.hasOwnProperty("hasIfwTarget")){me.hasNonifwTarget=me.hasNoninfowindowTarget(actionObj);me.hasIfwTarget=me.hasInfowindowTarget(actionObj);actionObj=this.getActionObj(touchedObj);}me.highlightPoint();me.performAction([actionObj]);}else{if(actionObj&&actionObj.node){me.currLinkObj=touchedObj;me.highlightPoint();me.performAction([actionObj]);me.currLinkObj=null;}}}else{if(this.currHoverObj&&this.currSelectedObj&&this.currHoverObj.touchVal===this.currSelectedObj.touchVal){}else{if(me.hasNonifwTarget){actionObj=me.getActionObj(touchedObj,true,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightPoint();}else{me.getFirstInfowindow();if(!me.infowindowOn&&me.infowindow){me.model.infowindowOn=true;me.infowindow.open();}}}}me.hideTooltip();}}else{sameAsLastHighlight=me.currHoverObj&&(touchedObj.touchVal==me.currHoverObj.touchVal);if(!sameAsLastHighlight){me.currHoverObj=touchedObj;me.highlightPoint();}else{me.hideTooltip();}}}else{if(touchedObj&&touchedObj.hdrIndex<0){sameAsLastHighlight=me.currHoverObj&&(touchedObj.touchVal==me.currHoverObj.touchVal);if(!sameAsLastHighlight){me.currHoverObj=touchedObj;me.highlightPoint();}else{me.hideTooltip();}}else{if(!touchedObj){me.hideTooltip();if(me.currSelectedObjBackup&&me.hasNonifwTarget){actionObj=this.getActionObj(touchedObj,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightPoint();}}}}}}}},showInfowindow:function showInfowindow(touchedObj){var me=this,actionObj;if(touchedObj&&touchedObj.hdrIndex>=0){var canBeSelected=me.pointCanBeSelected(touchedObj),sameAsCurrSelectedPoint=me.currSelectedObj&&(touchedObj.touchVal==me.currSelectedObj.touchVal);if(canBeSelected){if(!sameAsCurrSelectedPoint){me.hideTooltip();actionObj=me.getActionObj(touchedObj);if(actionObj&&actionObj.scObjList){me.currSelectedObj=touchedObj;}me.highlightPoint();me.performAction([actionObj]);}else{if(this.currHoverObj&&this.currSelectedObj&&this.currHoverObj.touchVal===this.currSelectedObj.touchVal){me.hideTooltip();}else{me.hideTooltip();actionObj=this.getActionObj(touchedObj,true,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightPoint();}}}}else{}}else{if((touchedObj&&touchedObj.hdrIndex<0)||!touchedObj){me.hideTooltip();if(me.currSelectedObj){actionObj=me.getActionObj(touchedObj,true);if(actionObj){me.performAction([actionObj]);me.currSelectedObj=null;me.highlightPoint();}}}}},postScale:function(){delete this._scroller.transform;this._scroller.scrollTo(this._scroller.origin.x,this._scroller.origin.y,0);this.scaleFactor*=this.relScaleFactor;this.refreshWidget();},refreshWidget:function(){this.drawMap();this.highlightPoint();},getAttrIndices:function getAttrIndices(){var me=this,model=me.model,rows=model&&model.gts&&model.gts.row,i,j;if(rows){var attrIndices=[],idx=0;for(i=0;i<rows.length;i++){var fs=rows[i]&&rows[i].fs;attrIndices.push(new Array());if(fs){for(j=0;j<fs.length;j++){attrIndices[i].push(idx++);}}}return attrIndices;}else{return null;}},createTooltipTable:function createTooltipTable(){var me=this,model=me.model,table=me.tooltip.childNodes[0],rows=model&&model.gts&&model.gts.row,cols=model&&model.gts&&model.gts.col&&model.gts.col[0]&&model.gts.col[0].es,i;if(table.childNodes.length===0&&rows&&rows.length>0){var trNum=rows.length+(cols?cols.length:0);for(i=0;i<trNum;i++){var tr=document.createElement("tr");var tdLeft=document.createElement("td");tdLeft.align="right";tdLeft.style.color="#545462";tr.appendChild(tdLeft);var tdRight=document.createElement("td");tdRight.align="left";tdRight.style.color="#000000";tr.appendChild(tdRight);table.appendChild(tr);}}},localTakeScreenshot:function localTakeScreenshot(_time){var me=this;window.setTimeout(function(){var ctrlID=me.controller.id;var ctrl=mstrmojo.all[ctrlID];if(ctrl&&ctrl.rootCtrl.getCurrent()===ctrl){ctrl.takeScreenShot();}},_time);},getDefaultSelectedObjs:function getDefaultSelectedObjs(){var me=this,model=me.model,idxs=model&&model.ghs&&model.ghs.rhs&&model.ghs.rhs.items,gts_rows=model&&model.gts&&model.gts.row,i,name,idx,item;if(me.haveGotDftSltObjs){return ;}else{me.haveGotDftSltObjs=true;}me.defaultSelectedObjs={};if(idxs&&gts_rows&&gts_rows.length>0){for(i in idxs){if(idxs.hasOwnProperty(i)){item=idxs[i].items[0];if(item&&item.hasOwnProperty("cet")){idx=item.idx;name=gts_rows[0].es[idx].n;if(!(me.defaultSelectedObjs.hasOwnProperty(name))){me.defaultSelectedObjs[name]=idx;}}}}}},renderErrorMessage:function renderErrorMessage(errorMessage){var me=this,msgDiv=me.errorMessage,newErrorMessage=errorMessage.replace(/-/g,"<br />-");msgDiv.innerHTML=newErrorMessage;msgDiv.style.width=me.getWidth()+"px";msgDiv.style.fontSize=me.errMsgFontSize+"px";msgDiv.style.fontFamily="Tahoma";msgDiv.style.color=ERROR_MSG_FONT_COLOR_DARK_THEME;msgDiv.style.backgroundColor="RGBA(0,0,0,0)";var bgColor=DEFAULT_BG_COLOR;if(me.model.hasOwnProperty("vp")&&me.model.vp.hasOwnProperty("bc")&&me.model.vp.bc!==""){bgColor="#"+me.model.vp.bc;}else{bgColor=me.utils.getAncestorBgColor(me)||DEFAULT_BG_COLOR;}me.domNode.style.backgroundColor=bgColor;me.model.themeMode=getThemeMode(bgColor);if(me.model.themeMode===THEME_LIGHT){msgDiv.style.color=ERROR_MSG_FONT_COLOR_LIGHT_THEME;}},setFontByDPI:function setFontByDPI(){if(this.setFontByDPIFlag){return ;}var me=this;me.setFontByDPIFlag=true;me.hoverBubbleRadiusLarger=5;me.bubbleStrokeWidth=2;me.baseMaxBubbleSizeAuto=12;me.baseMaxBubbleSizeManual=24;me.polygonStrokeWidth=1;me.highlightPolygonStrokeWidth=2;me.borderSpace=5;me.tooltipFontSize=12;me.tooltipBorderWidth=1;me.tooltipBorderRadius=5;me.errMsgFontSize=16;me.bias=30;me.tooltipRightShadowWidth=4;var xtabModel=me.xtabModel,docModel=(xtabModel&&xtabModel.docModel),fitToPage=false,microApp=false;if(docModel){fitToPage=docModel.zt&&(docModel.zt==2);var layouts=docModel.defn&&docModel.defn.layouts,layout,i;for(i in layouts){if(layouts.hasOwnProperty(i)&&layouts[i]&&layouts[i].loaded){layout=layouts[i];break;}}if(layout&&layout.hasOwnProperty("fch")){microApp=layout.fch;}}if(fitToPage&&microApp){var devicedpi=mstrMobileApp.getDeviceDPIX();var baseDpi=149;var ratio=1;if(devicedpi>0){ratio=devicedpi/baseDpi;}if(ratio>1){me.hoverBubbleRadiusLarger*=ratio;me.bubbleStrokeWidth*=ratio;me.baseMaxBubbleSizeAuto*=ratio;me.baseMaxBubbleSizeManual*=ratio;me.polygonStrokeWidth*=ratio;me.highlightPolygonStrokeWidth*=ratio;me.borderSpace*=ratio;me.tooltipFontSize*=ratio;me.tooltipBorderWidth*=ratio;me.tooltipBorderRadius*=ratio;me.errMsgFontSize*=ratio;me.bias*=ratio;me.tooltipRightShadowWidth*=ratio;var tooltip=me.tooltip,table=tooltip.childNodes[0];tooltip.style.fontSize=me.tooltipFontSize+"px";tooltip.style.borderWidth=me.tooltipBorderWidth+"px";tooltip.style.borderRadius=me.tooltipBorderRadius+"px";tooltip.style.boxShadow=3*ratio+"px "+3*ratio+"px "+4*ratio+"px RGBA(0,0,0,0.45)";table.style.margin=5*ratio+"px "+7*ratio+"px";}}},initScroller:function initScroller(scroller){scroller.vScroll=true;scroller.hScroll=true;this._super(scroller);},getIndexFromHdrindex:function getIndexFromHdrIndex(hdrIndex){var me=this,idxs=me.model.ghs.rhs.items;if(idxs){var i,curRow,nextRow;for(i=0;i<idxs.length;i++){curRow=idxs[i].items;if(curRow.length>0&&curRow[0].idx==hdrIndex){if(i===idxs.length-1){return i;}else{nextRow=idxs[i+1].items;if(nextRow.length>0&&nextRow[0].idx!=hdrIndex){return i;}else{continue;}}}else{continue;}}}return 0;},drawMap:function drawMap(){var me=this,model=me.model;me.animationCanvas.width=me.animationCanvas.width;me.highlightCanvas.width=me.highlightCanvas.width;if(!me.hasOwnProperty("displayMode")){me.displayMode=DISPLAY_MODE_AUTOMATIC;}if(!me.hasOwnProperty("markerType")){me.markerType=MARKER_UNDEFINED;}if(!me.hasOwnProperty("shapeFileType")){me.shapeFileType=SHAPE_FILE_UNDEFINED;}if(!me.hasOwnProperty("colorByIndex")){me.colorByIndex=-1;}if(!me.hasOwnProperty("sizeByIndex")){me.sizeByIndex=-1;}if(!me.hasOwnProperty("drawBgImageFlag")){me.drawBgImageFlag=false;}if(!me.hasOwnProperty("thresholdType")){me.thresholdType=THRESHOLD_UNDEFINED;}if(!me.hasOwnProperty("curPolygonOpacity")){me.curPolygonOpacity=POLY_NORMAL_OPACITY;}if(!model.hasOwnProperty("infowindowOn")){model.infowindowOn=false;}if(!me.hasOwnProperty("touchSelectWithIfw")){me.touchSelectWithIfw=false;}if(me.model.hasOwnProperty("vp")){var bgColor=DEFAULT_BG_COLOR;if(me.model.vp.hasOwnProperty("bc")&&me.model.vp.bc!==""){bgColor="#"+me.model.vp.bc;}else{bgColor=me.utils.getAncestorBgColor(me)||DEFAULT_BG_COLOR;}me.domNode.style.backgroundColor=bgColor;me.model.themeMode=getThemeMode(bgColor);me.model.bgColor=bgColor;me.tooltip.style.top="0px";me.setDisplayParas();if(me.displayMode===DISPLAY_MODE_AREA){me.drawAreaMap();}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){me.drawBubbleMap();}}}},getIndexById:function getIndexById(id){var me=this,model=me.model,gtsCol=model.gts&&model.gts.col,gtsColEle=null,i;if(gtsCol&&gtsCol.length>0&&gtsCol[0].hasOwnProperty("es")){gtsColEle=gtsCol[0].es;for(i=0;i<gtsColEle.length;i++){if(gtsColEle[i].oid===id){return i;}}}return -1;},setDisplayParas:function setDisplayParas(){var me=this,model=me.model;if(!me.hasOwnProperty("setDisplayParasFlag")){me.setDisplayParasFlag=true;}else{return ;}me.shapeFileType=getShapeFileType(model.coords);var colCount=0;if(model.hasOwnProperty("gvs")&&model.gvs.hasOwnProperty("items")&&model.gvs.items.length>0&&model.gvs.items[0].hasOwnProperty("items")&&model.gvs.items[0].items.length>0){colCount=model.gvs.items[0].items.length;}me.displayMode=model.vp.mt;if(me.displayMode===DISPLAY_MODE_AREA){if(colCount>0){if(model.vp.hasOwnProperty("ColorBy")){me.colorByIndex=me.getIndexById(model.vp.ColorBy);if(me.colorByIndex<0){me.colorByIndex=0;}}else{me.colorByIndex=0;}me.thresholdType=me.getThresholdType(me.colorByIndex);}else{}}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){if(colCount>0){this.setBubbleModeParasWithData(colCount);}else{me.markerType=MARKER_BUBBLE;}}else{if(me.displayMode===DISPLAY_MODE_AUTOMATIC){if(colCount>0){me.displayMode=DISPLAY_MODE_BUBBLE;this.setBubbleModeParasWithData(colCount);}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.displayMode=DISPLAY_MODE_AREA;}else{if(me.shapeFileType===SHAPE_FILE_POINT){me.displayMode=DISPLAY_MODE_BUBBLE;me.markerType=MARKER_BUBBLE;}}}}else{if(!me.displayMode){if(colCount>0){me.displayMode=DISPLAY_MODE_BUBBLE;this.setBubbleModeParasWithData(colCount);}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.displayMode=DISPLAY_MODE_AREA;}else{if(me.shapeFileType===SHAPE_FILE_POINT){me.displayMode=DISPLAY_MODE_BUBBLE;me.markerType=MARKER_BUBBLE;}}}}}}}},setBubbleModeParasWithData:function setBubbleModeParasWithData(colCount){var me=this,model=me.model;if(model.vp.hasOwnProperty("SizeBy")){me.sizeByIndex=this.getIndexById(model.vp.SizeBy);if(me.sizeByIndex<0){me.sizeByIndex=0;}}else{me.sizeByIndex=0;}if(model.vp.hasOwnProperty("ColorBy")){me.colorByIndex=this.getIndexById(model.vp.ColorBy);if(me.colorByIndex<0){me.colorByIndex=0;}me.thresholdType=me.getThresholdType(me.colorByIndex);if(me.thresholdType===THRESHOLD_IMAGE){me.markerType=MARKER_IMAGE;}else{me.markerType=MARKER_BUBBLE;}}else{if(colCount===1){me.colorByIndex=0;me.thresholdType=this.getThresholdType(0);if(me.thresholdType===THRESHOLD_IMAGE){me.markerType=MARKER_IMAGE;}else{me.markerType=MARKER_BUBBLE;}}else{if(colCount>1){var firstThresholdType=this.getThresholdType(0);if(firstThresholdType===THRESHOLD_IMAGE){me.colorByIndex=0;me.thresholdType=firstThresholdType;me.markerType=MARKER_IMAGE;}else{me.colorByIndex=1;me.thresholdType=this.getThresholdType(1);if(me.thresholdType===THRESHOLD_IMAGE){me.markerType=MARKER_IMAGE;}else{me.markerType=MARKER_BUBBLE;}}}}}},getThresholdType:function getThresholdType(colIndex){var me=this,th=me.model&&me.model.th,subTh=th&&th[colIndex],gvs=me.model&&me.model.gvs,gts_es=me.model.gts.row[0].es,elem,i,cellData;if(subTh&&gvs.items.length>0){if(colIndex>=gvs.items[0].items.length||colIndex<0||subTh.length===0){return THRESHOLD_UNDEFINED;}for(i in gts_es){if(gts_es.hasOwnProperty(i)){cellData=gvs.items[me.getIndexFromHdrindex(i)].items[colIndex];if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===4){return THRESHOLD_IMAGE;}}}var isImgReg=/(jpg|jpeg|png|gif|tiff|bmp)$/i;for(elem in subTh){if(subTh.hasOwnProperty(elem)&&isImgReg.test(subTh[elem].n)){return THRESHOLD_IMAGE;}}for(i in gts_es){if(gts_es.hasOwnProperty(i)){cellData=gvs.items[me.getIndexFromHdrindex(i)].items[colIndex];if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===2){return THRESHOLD_COLOR;}}}return THRESHOLD_UNDEFINED;}else{return THRESHOLD_UNDEFINED;}},scalePolygonCoords:function scalePolygonCoords(){var me=this,model=me.model,coords=model.coords;var maxX=0,maxY=0,rgn,c,i,j,k;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];for(k=0;k<c.length;k++){if(c[k]>maxX){maxX=c[k];}k++;if(c[k]>maxY){maxY=c[k];}}}}}}var xRatio=maxX/((this.getWidth()-10)*this.scaleFactor),yRatio=maxY/((this.getHeight()-10)*this.scaleFactor),ratio=Math.max(yRatio,xRatio);this.topOffset=(this.getHeight()*this.scaleFactor-maxY/ratio)/2;this.leftOffset=(this.getWidth()*this.scaleFactor-maxX/ratio)/2;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(c[k]/ratio,10);}}}}}},getBubbleColorFromName:function getBubbleColorFromName(elem){if(this.allBubblesColor&&this.allBubblesColor.hasOwnProperty(elem)){return this.allBubblesColor[elem];}else{return null;}},getBgColorFromCSS:function getBgColorFromCSS(cellData){var cssDiv=this.cssDiv,csss=null,th=null,cni,cssStyle;if(this.model.hasOwnProperty("css")){csss=this.model.css;}if(this.model.hasOwnProperty("th")){th=this.model.th&&this.model.th[this.colorByIndex];}if(csss&&th&&cellData&&cellData.hasOwnProperty("ty")){if((parseInt(cellData.ty,10)===2||parseInt(cellData.ty,10)===4)&&cellData.hasOwnProperty("ti")&&th.length>cellData.ti&&th[cellData.ti].udbg===1){cni=th[cellData.ti].cni;cssDiv.className=cni&&csss[cni]&&csss[cni].n;cssStyle=mstrmojo.css.getComputedStyle(cssDiv);if(cssStyle.hasOwnProperty("backgroundColor")){return cssStyle.backgroundColor;}}}return null;},drawPolygonInMap:function drawPolygonInMap(opacity){var me=this,model=me.model,coords=model.coords,context=this.animationContext,elem;me.animationCanvas.width=me.animationCanvas.width;if(me.drawBgImageFlag&&model.bgImg){var xRatio=me.oriBgImageWidth/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=me.oriBgImageHeight/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;context.drawImage(model.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);}me.curPolygonOpacity=opacity;var noAltColor=POLY_COLOR_NO_ALT_DARK_THEME,noColorByColor=POLY_COLOR_NO_COLORBY_DARK_THEME,strokeColor=POLY_STROKE_COLOR_DARK_THEME;if(model.themeMode===THEME_LIGHT){noAltColor=POLY_COLOR_NO_ALT_LIGHT_THEME;noColorByColor=POLY_COLOR_NO_COLORBY_LIGHT_THEME;strokeColor=POLY_STROKE_COLOR_LIGHT_THEME;}if(model.vp&&model.vp.npc){noAltColor=getOpacityColor("#"+model.vp.npc,POLY_NORMAL_OPACITY);}for(elem in coords){if(!coords.hasOwnProperty(elem)){continue;}if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var clr=noAltColor;if(me.displayMode===DISPLAY_MODE_AREA){var hdrIndex=this.getHeaderIndex(elem);if(hdrIndex>=0){if(me.colorByIndex>=0){var mv=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex];clr=me.getBgColorFromCSS(mv);if(!clr){clr=noColorByColor;}if(me.drawBgImageFlag){clr=getOpacityColor(clr,POLY_ABOVE_BG_OPACITY);}else{clr=getOpacityColor(clr,POLY_NORMAL_OPACITY);}}else{clr=noColorByColor;}}else{clr=noAltColor;}}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){clr=noAltColor;}}}clr=getOpacityColor(clr,opacity);drawPoly(context,coords[elem],{x:this.leftOffset,y:this.topOffset},strokeColor,me.polygonStrokeWidth,clr);}},getRadiusFromName:function getRadiusFromName(name){var me=this,model=me.model;if(model.coords.hasOwnProperty(name)){if(me.model.hasOwnProperty("oriBubbleSize")){return me.model.oriBubbleSize[name]*me.scaleFactor;}else{if(me.model.hasOwnProperty("maxBubbleRadius")){return me.model.maxBubbleRadius*me.scaleFactor;}else{return 2;}}}else{return -1;}},drawBubblesInMap:function drawBubblesInMap(){var me=this,model=me.model,coords=model.coords,elem;if(model.hasOwnProperty("polygonCenters")){coords=model.polygonCenters;}me.highlightCanvas.width=me.highlightCanvas.width;var defBubbleColor=BUBBLE_COLOR_NO_COLORBY_DARK_THEME,strokeColor=BUBBLE_STROKE_COLOR_DARK_THEME;if(model.themeMode===THEME_LIGHT){defBubbleColor=BUBBLE_COLOR_NO_COLORBY_LIGHT_THEME;strokeColor=BUBBLE_STROKE_COLOR_LIGHT_THEME;}var defRadius=Math.max(2,Math.min(12,MAX_SIZE_DEFAULT_RATIO_FOR_SCATTER*0.15*Math.min(me.getWidth(),me.getHeight())));defRadius=defRadius*me.scaleFactor;var th=model.th&&model.th[me.colorByIndex];if(me.markerType===MARKER_IMAGE){var notFoundImageIconPath=me.getFullPath("images/image_not_found.jpg");defaultImageIconPath=me.getFullPath("images/roundedpp.png");for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var propName="imageIcon_"+elem;if(model.hasOwnProperty(propName)){var _image=model[propName];if(_image&&_image.width&&_image.height&&_image.width<me.getWidth()*me.scaleFactor&&_image.height<me.getHeight()*me.scaleFactor){var xOffset=coords[elem][0][0]-_image.width/2+me.leftOffset,yOffset=coords[elem][0][1]-_image.height/2+me.topOffset;me.animationContext.drawImage(_image,xOffset,yOffset);}continue;}var hdrIndex=me.getHeaderIndex(elem);if(th&&hdrIndex>=0&&me.colorByIndex>=0&&me.thresholdType===THRESHOLD_IMAGE){var cellData=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex];if(cellData.hasOwnProperty("ty")&&parseInt(cellData.ty,10)===4){var iconPath=th.length>cellData.ti&&th[cellData.ti].n;if(iconPath){var fullIconPath=me.getFullPath(iconPath);model[propName]=new Image();model[propName].src=fullIconPath;model[propName].id=elem;model[propName].onload=function(){if(this.width<me.getWidth()*me.scaleFactor&&this.height<me.getHeight()*me.scaleFactor){var xOffset=coords[this.id][0][0]-this.width/2+me.leftOffset,yOffset=coords[this.id][0][1]-this.height/2+me.topOffset;me.animationContext.drawImage(this,xOffset,yOffset);if(me.defaultSelectedObjs.hasOwnProperty(this.id)){me.highlightCanvas.width=me.highlightCanvas.width;for(var dftSltObj in me.defaultSelectedObjs){if(me.defaultSelectedObjs.hasOwnProperty(dftSltObj)){me.highlightImageIcon(me.highlightContext,coords,dftSltObj,0);}}}}};model[propName].onerror=function(){model["imageIcon_"+this.id].src=notFoundImageIconPath;};}}else{model[propName]=new Image();model[propName].src=defaultImageIconPath;model[propName].id=elem;model[propName].onload=function(){if(this.width<me.getWidth()*me.scaleFactor&&this.height<me.getHeight()*me.scaleFactor){var xOffset=coords[this.id][0][0]-this.width/2+me.leftOffset,yOffset=coords[this.id][0][1]-this.height/2+me.topOffset;me.animationContext.drawImage(this,xOffset,yOffset);if(me.defaultSelectedObjs.hasOwnProperty(this.id)){me.highlightImageIcon(me.highlightContext,coords,this.id,0);}}};model[propName].onerror=function(){model["imageIcon_"+this.id].src=notFoundImageIconPath;};}}else{delete coords[elem];}}}if(!me.imageIconScreenshotTaken){me.imageIconScreenshotTaken=true;}}else{if(me.markerType===MARKER_BUBBLE){for(elem in coords){if(!coords.hasOwnProperty(elem)){continue;}if(elem==="bgImage"||elem===(me.currHoverObj&&me.currHoverObj.touchVal)||elem===(me.currSelectedObj&&me.currSelectedObj.touchVal)||elem===(me.currLinkObj&&me.currLinkObj.touchVal)||(!isOwnEmpty(me.defaultSelectedObjs)&&me.defaultSelectedObjs.hasOwnProperty(elem))){continue;}var bubbleColor=defBubbleColor,bubbleRadius=defRadius,hdrIndex=me.getHeaderIndex(elem);if(hdrIndex>=0){if(me.sizeByIndex>=0){bubbleRadius=me.getRadiusFromName(elem);}if(me.colorByIndex>=0&&me.thresholdType===THRESHOLD_COLOR){bubbleColor=me.getBubbleColorFromName(elem);if(!bubbleColor){bubbleColor=defBubbleColor;}else{bubbleColor=getOpacityColor(bubbleColor,BUBBLE_NORMAL_OPACITY);}}var offset={x:me.leftOffset,y:me.topOffset};drawBubble(me.highlightContext,coords[elem][0],offset,bubbleColor,bubbleRadius);drawStroke(me.highlightContext,coords[elem][0],offset,strokeColor,bubbleRadius,me.bubbleStrokeWidth);}else{delete coords[elem];}}}}},getOriPolygonCoords:function getOriPolygonCoords(){var me=this,model=me.model,coords=model.coords,i,j,k,rgn,c;if(!model.hasOwnProperty("oriPolyCoords")){model.oriPolyCoords={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var arr2=[];rgn=coords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];var arr1=[];for(k=0;k<c.length;k++){arr1.push(c[k]);}arr2.push(arr1);}}model.oriPolyCoords[i]=arr2;}}}},getAllBubblesColor:function getAllBubblesColor(){var me=this,model=me.model,coords=model.coords,elem;if(me.haveAllBubblesColor){return ;}else{me.allBubblesColor={};}var defBubbleColor=BUBBLE_COLOR_NO_COLORBY_DARK_THEME;if(model.themeMode===THEME_LIGHT){defBubbleColor=BUBBLE_COLOR_NO_COLORBY_LIGHT_THEME;}if(me.markerType===MARKER_BUBBLE&&me.colorByIndex>=0&&me.thresholdType===THRESHOLD_COLOR){for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var hdrIndex=me.getHeaderIndex(elem);if(hdrIndex>=0){var colorByCellData=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex],bubbleColor=me.getBgColorFromCSS(colorByCellData);if(!bubbleColor){bubbleColor=defBubbleColor;}me.allBubblesColor[elem]=bubbleColor;}else{}}}}},getOriBubbleSize:function getOriBubbleSize(){var me=this,model=me.model,gvs=model.gvs,idxs=model.ghs.rhs.items,gts_es=model.gts.row[0].es,elem,i,j,k,pt,maxRadius=0;var ratio=1;if(model.vp.ty==="0"){if(me.sizeByIndex<0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_SCATTER;}else{if(me.sizeByIndex>=0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_AUTOMATIC;}}}else{if(model.vp.ty==="1"){if(model.vp.hasOwnProperty("val")&&model.vp.val!==null&&model.vp.val!==""){ratio=parseFloat(model.vp.val);if(ratio>MAX_RATIO_UP_LIMIT){ratio=MAX_RATIO_UP_LIMIT;}if(ratio<MAX_RATIO_LOW_LIMIT){ratio=MAX_RATIO_LOW_LIMIT;}}else{if(me.sizeByIndex<0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_SCATTER;}else{if(me.sizeByIndex>=0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_MANUAL;}}}}else{if(me.sizeByIndex<0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_SCATTER*2;}else{if(me.sizeByIndex>=0){ratio=MAX_SIZE_DEFAULT_RATIO_FOR_MANUAL*2;}}}}var maxMaxSize=me.baseMaxBubbleSizeAuto;if(me.sizeByIndex>=0){maxMaxSize=me.baseMaxBubbleSizeManual;}var baseSize=0.15*Math.min(me.getWidth(),me.getHeight());if(model.vp.ty==="0"){maxRadius=Math.min(ratio*baseSize,maxMaxSize);}else{if(model.vp.ty==="1"){maxRadius=ratio*baseSize;}else{maxRadius=ratio*baseSize;}}if(maxRadius<=2){maxRadius=3;}me.model.maxBubbleRadius=maxRadius;if(me.sizeByIndex>=0){var idx=me.sizeByIndex,maxValue=Math.abs(parseFloat(gvs.items[0].items[idx].rv)),minValue=Math.abs(parseFloat(gvs.items[0].items[idx].rv));for(i in gts_es){if(gts_es.hasOwnProperty(i)){var gvsIndex=me.getIndexFromHdrindex(i),tempVal=Math.abs(parseFloat(gvs.items[gvsIndex].items[idx].rv));if(maxValue<tempVal){maxValue=tempVal;}if(minValue>tempVal){minValue=tempVal;}}}var oriBubbleSize={};if(maxValue>minValue){var minRadius=maxRadius*minValue/maxValue;if(minRadius<2){minRadius=2;}var step=(maxRadius-minRadius)/(maxValue-minValue),radius;for(i in gts_es){if(gts_es.hasOwnProperty(i)){radius=(Math.abs(parseFloat(gvs.items[me.getIndexFromHdrindex(i)].items[idx].rv))-minValue)*step+minRadius;oriBubbleSize[gts_es[i].n]=radius;}}}else{for(i=0;i<gts_es.length;i++){oriBubbleSize[gts_es[i].n]=maxRadius;}}me.model.oriBubbleSize=oriBubbleSize;}},storeOriPoints:function storeOriPoints(){var coords=this.model.coords,oriCoords={},point,newPoint,elem;for(elem in coords){if(coords.hasOwnProperty(elem)){point=coords[elem][0];newPoint=[point[0],point[1]];oriCoords[elem]=newPoint;}}return oriCoords;},drawBubbleMap:function drawBubbleMap(){var me=this,model=me.model,context=this.animationContext,coords=model.coords,elem,i,j,k,pt;me.getAllBubblesColor();me.getOriBubbleSize();if(model.hasOwnProperty("bgImg")&&model.bgImg.hasOwnProperty("src")&&model.bgImg.src!=""&&model.bgImg.src!=null){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=model.bgImg.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=model.bgImg.height;}if(!me.hasOwnProperty("oriCoords")){me.oriCoords=me.storeOriPoints();}var xRatio=model.bgImg.width/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=model.bgImg.height/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;context.drawImage(model.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);if(me.shapeFileType===SHAPE_FILE_POLYGON){var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;polygonCenters[i][0][0]/=ratio;polygonCenters[i][0][1]/=ratio;}}model.polygonCenters=polygonCenters;}else{var oriCoords=me.oriCoords;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}pt=coords[i][0];pt[0]=parseInt(oriCoords[i][0]/ratio,10);pt[1]=parseInt(oriCoords[i][1]/ratio,10);}}}me.drawBubblesInMap();}else{model.bgImg=new Image();model.bgImg.onerror=function(){var errorMessage="The backgrond Image cannot be found.";me.renderErrorMessage(mstrmojo.desc(9856,errorMessage));return ;};model.bgImg.onload=function(){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}if(!me.hasOwnProperty("oriCoords")){me.oriCoords=me.storeOriPoints();}var xRatio=this.width/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=this.height/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;me.animationCanvas.width=me.animationCanvas.width;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);if(me.shapeFileType===SHAPE_FILE_POLYGON){var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;polygonCenters[i][0][0]/=ratio;polygonCenters[i][0][1]/=ratio;}}model.polygonCenters=polygonCenters;}else{var oriCoords=me.oriCoords;for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}pt=coords[i][0];pt[0]=parseInt(oriCoords[i][0]/ratio,10);pt[1]=parseInt(oriCoords[i][1]/ratio,10);}}}me.drawBubblesInMap();if(!me.bgImageScreenshotTaken){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(RENDERING_TIME);}};}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(!model.hasOwnProperty("bgImg")||!model.bgImg.hasOwnProperty("src")||model.bgImg.src==""||model.bgImg.src==null){var bgImgPath=coords.bgImage;model.bgImg.src=me.getFullPath(bgImgPath);}}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.drawBgImageFlag=false;me.scalePolygonCoords();me.drawPolygonInMap(POLY_UNDER_BUBBLE_OPACITY);var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;}}model.polygonCenters=polygonCenters;me.drawBubblesInMap();}}},drawAreaMap:function drawAreaMap(){var me=this,model=me.model,context=this.animationContext,coords=model.coords,elem,i,j,k,rgn,oriRng,c,oriC,pt;if(!model.hasOwnProperty("oriPolyCoords")){me.getOriPolygonCoords();}var oriCoords=model.oriPolyCoords;context.save();context.lineWidth=2;context.strokeStyle="#AAAAAA";if(model.hasOwnProperty("bgImg")&&model.bgImg.hasOwnProperty("src")&&model.bgImg.src!=""&&model.bgImg.src!=null){if(me.shapeFileType===SHAPE_FILE_POINT){me.drawBgImageFlag=false;}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=model.bgImg.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=model.bgImg.height;}var xRatio=model.bgImg.width/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=model.bgImg.height/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;context.drawImage(model.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;}}model.polygonCenters=polygonCenters;me.drawPolygonInMap(POLY_ABOVE_BG_OPACITY);}}}else{model.bgImg=new Image();model.bgImg.onerror=function(){var errorMessage="The backgrond Image cannot be found.";me.renderErrorMessage(mstrmojo.desc(9856,errorMessage));return ;};model.bgImg.onload=function(){if(me.shapeFileType===SHAPE_FILE_POINT){me.drawBgImageFlag=false;}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.drawBgImageFlag=true;if(!me.hasOwnProperty("oriBgImageWidth")){me.oriBgImageWidth=this.width;}if(!me.hasOwnProperty("oriBgImageHeight")){me.oriBgImageHeight=this.height;}var xRatio=this.width/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=this.height/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;context.drawImage(this,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}rgn=coords[i];oriRgn=oriCoords[i];for(j in rgn){if(rgn.hasOwnProperty(j)){c=rgn[j];oriC=oriRgn[j];for(k=0;k<c.length;k++){c[k]=parseInt(oriC[k]/ratio,10);}}}}}var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;}}model.polygonCenters=polygonCenters;me.drawPolygonInMap(POLY_ABOVE_BG_OPACITY);}}if(!me.bgImageScreenshotTaken){me.bgImageScreenshotTaken=true;me.localTakeScreenshot(RENDERING_TIME);}};}if(coords.hasOwnProperty("bgImage")&&coords.bgImage!==""){if(!model.bgImg.hasOwnProperty("src")||model.bgImg.src==""||model.bgImg.src==null){model.bgImg.src=me.getFullPath(coords.bgImage);}}else{if(me.shapeFileType===SHAPE_FILE_POLYGON){me.drawBgImageFlag=false;this.scalePolygonCoords();var polygonCenters={};for(i in coords){if(coords.hasOwnProperty(i)){if(i==="bgImage"){continue;}var center=getCentroidOfPolygon(coords[i][0]);polygonCenters[i]=center;}}model.polygonCenters=polygonCenters;this.drawPolygonInMap(POLY_NORMAL_OPACITY);}}context.restore();},getHeaderIndex:function getHeaderIndex(headerName){var hdrIndex=-1,hdrs=this.model.gts.row[0].es,i;if(headerName){headerName=headerName.toLowerCase();for(i=0;i<hdrs.length;i++){var name=hdrs[i].n;if(name&&name.toLowerCase()===headerName){hdrIndex=i;break;}}}return hdrIndex;},getNewColorForOpacityChange:function getNewColorForOpacityChange(bgColor,haveBgImage,curColor,curOpacity,destOpacity){if(curOpacity>1||curOpacity<0||destOpacity>1||destOpacity<0){return curColor;}var eps=0.0001,newBgColor=bgColor;if(!bgColor||haveBgImage){newBgColor="#FFFFFF";}if(destOpacity>=curOpacity){if(curOpacity+eps>1){return curColor;}else{return getOpacityColor(curColor,(destOpacity-curOpacity)/(1-curOpacity));}}else{if(destOpacity<curOpacity){if(curOpacity-eps<0){return getOpacityColor(curColor,0);}else{return getOpacityColor(newBgColor,(curOpacity-destOpacity)/curOpacity);}}}},drawPartOpacityBG:function drawPartOpacityBG(ctx,coordsArray,bgOpacity){ctx.save();var me=this,model=me.model,offsetX=me.leftOffset?me.leftOffset:0,offsetY=me.topOffset?me.topOffset:0;var getPointAt=function(j){var offset=j%2?offsetY:offsetX;return pointsArray[j]+offset;};ctx.beginPath();var i,j;for(i=0;i<coordsArray.length;i++){var pointsArray=coordsArray[i],minX=getPointAt(0),minY=getPointAt(1),maxY=getPointAt(1),x,y;ctx.moveTo(getPointAt(0),getPointAt(1));for(j=2;j<pointsArray.length-1;j=j+2){x=getPointAt(j);y=getPointAt(j+1);ctx.lineTo(x,y);maxY=Math.max(y,maxY);minY=Math.min(y,minY);minX=Math.min(x,minX);}x=getPointAt(0);y=getPointAt(1);ctx.lineTo(x,y);}ctx.clip();ctx.globalAlpha=bgOpacity;var xRatio=me.oriBgImageWidth/((me.getWidth()-me.borderSpace*2)*me.scaleFactor),yRatio=me.oriBgImageHeight/((me.getHeight()-me.borderSpace*2)*me.scaleFactor),ratio=Math.max(yRatio,xRatio);me.topOffset=(me.getHeight()*me.scaleFactor-me.oriBgImageHeight/ratio)/2;me.leftOffset=(me.getWidth()*me.scaleFactor-me.oriBgImageWidth/ratio)/2;ctx.drawImage(model.bgImg,me.leftOffset,me.topOffset,me.oriBgImageWidth/ratio,me.oriBgImageHeight/ratio);ctx.restore();},highlightImageIcon:function highlightImageIcon(hlContext,coords,touchVal,radiusLarget){var me=this,model=me.model,fillColor="RGBA(255,255,255,0.5)",iconName="imageIcon_"+touchVal;if(model.hasOwnProperty(iconName)){var imgIcon=model[iconName],width=imgIcon.width+radiusLarget*2,height=imgIcon.height+radiusLarget*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}},highlightPoint:function highlightPoint(){var me=this,model=me.model,hlContext=me.highlightContext,hdrIndex;me.highlightCanvas.width=me.highlightCanvas.width;if(me.currSelectedObj===null&&isOwnEmpty(me.defaultSelectedObjs)&&me.displayMode===DISPLAY_MODE_AREA){if(me.drawBgImageFlag){if(me.curPolygonOpacity!==POLY_ABOVE_BG_OPACITY){me.drawPolygonInMap(POLY_ABOVE_BG_OPACITY);}}else{if(me.curPolygonOpacity!==POLY_NORMAL_OPACITY){me.drawPolygonInMap(POLY_NORMAL_OPACITY);}}}if(me.displayMode===DISPLAY_MODE_AREA){var bgColor=model.bgColor,selectedStrokeColor=POLY_STROKE_COLOR_SELECTED_DARK_THEME,hoverStrokeColor=POLY_STROKE_COLOR_HOVER_DARK_THEME,selectedHoverStrokeColor=POLY_STROKE_COLOR_SELECTED_HOVER_DARK_THEME,noAltColor=POLY_COLOR_NO_ALT_DARK_THEME,noColorByColor=POLY_COLOR_NO_COLORBY_DARK_THEME;if(model.themeMode===THEME_LIGHT){selectedStrokeColor=POLY_STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=POLY_STROKE_COLOR_HOVER_LIGHT_THEME;selectedHoverStrokeColor=POLY_STROKE_COLOR_SELECTED_HOVER_LIGHT_THEME;noAltColor=POLY_COLOR_NO_ALT_LIGHT_THEME;noColorByColor=POLY_COLOR_NO_COLORBY_LIGHT_THEME;}if(model.vp&&model.vp.npc){noAltColor=getOpacityColor("#"+model.vp.npc,POLY_NORMAL_OPACITY);}var fillColor=noAltColor;var dftSltObjs=me.defaultSelectedObjs;if(!isOwnEmpty(dftSltObjs)){if(me.curPolygonOpacity!==POLY_UNSELECTED_OPACITY){me.drawPolygonInMap(POLY_UNSELECTED_OPACITY);}var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)){if(me.currHoverObj!==null&&me.currHoverObj.hasOwnProperty("touchVal")&&me.currHoverObj.touchVal!==""&&me.currHoverObj.touchVal!==null&&me.currHoverObj.touchVal===i){continue;}else{var hIndex=me.defaultSelectedObjs[i];if(hIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===THRESHOLD_COLOR){var colorByCellData=model.gvs.items[me.getIndexFromHdrindex(hIndex)].items[me.colorByIndex];fillColor=me.getBgColorFromCSS(colorByCellData);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_OPACITY_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_OPACITY_WITHOUT_BG);}drawPoly(hlContext,model.coords[i],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}}}fillColor=noAltColor;}else{if(me.currSelectedObj!==null&&me.currSelectedObj.hasOwnProperty("touchVal")&&me.currSelectedObj.touchVal!==""&&me.currSelectedObj.touchVal!==null){if(me.curPolygonOpacity!==POLY_UNSELECTED_OPACITY){me.drawPolygonInMap(POLY_UNSELECTED_OPACITY);}if(me.currHoverObj!==null&&me.currHoverObj.hasOwnProperty("touchVal")&&me.currHoverObj.touchVal!==""&&me.currHoverObj.touchVal!==null&&me.currHoverObj.touchVal===me.currSelectedObj.touchVal){}else{if(me.currSelectedObj.hasOwnProperty("hdrIndex")){hdrIndex=me.currSelectedObj.hdrIndex;}else{hdrIndex=me.getHeaderIndex(me.currSelectedObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===THRESHOLD_COLOR){var colorByCellData=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex];fillColor=me.getBgColorFromCSS(colorByCellData);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_OPACITY_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_OPACITY_WITHOUT_BG);}drawPoly(hlContext,model.coords[me.currSelectedObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}}else{if(me.currLinkObj!==null&&me.currLinkObj.hasOwnProperty("touchVal")&&me.currLinkObj.touchVal!==""&&me.currLinkObj.touchVal!==null){if(me.currLinkObj.hasOwnProperty("hdrIndex")){hdrIndex=me.currLinkObj.hdrIndex;}else{hdrIndex=me.getHeaderIndex(me.currLinkObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===THRESHOLD_COLOR){var colorByCellData=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex];fillColor=me.getBgColorFromCSS(colorByCellData);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_ABOVE_BG_OPACITY,POLY_LINKDRILL_OPACITY);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_NORMAL_OPACITY,POLY_LINKDRILL_OPACITY);}drawPoly(hlContext,model.coords[me.currLinkObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}}}if(me.currHoverObj!==null&&me.currHoverObj.hasOwnProperty("touchVal")&&me.currHoverObj.touchVal!==""&&me.currHoverObj.touchVal!==null){var hvObj=me.currHoverObj;if(hvObj.hasOwnProperty("hdrIndex")){hdrIndex=hvObj.hdrIndex;}else{hdrIndex=me.getHeaderIndex(hvObj.touchVal);}if(hdrIndex>=0){if(me.colorByIndex>=0){if(me.thresholdType===THRESHOLD_COLOR){var colorByCellData=model.gvs.items[me.getIndexFromHdrindex(hdrIndex)].items[me.colorByIndex];fillColor=me.getBgColorFromCSS(colorByCellData);if(!fillColor){fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noColorByColor;}}else{fillColor=noAltColor;}if(me.currSelectedObj!==null||!isOwnEmpty(me.defaultSelectedObjs)){if(me.drawBgImageFlag){fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_HOVER_OPACITY_WITH_BG);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_UNSELECTED_OPACITY,POLY_SELECTED_HOVER_OPACITY_WITHOUT_BG);}drawPoly(hlContext,model.coords[me.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},selectedHoverStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}else{if(me.drawBgImageFlag){var bgOpacity=(POLY_ABOVE_BG_OPACITY-POLY_HOVER_OPACITY)/POLY_ABOVE_BG_OPACITY;this.drawPartOpacityBG(hlContext,model.coords[me.currHoverObj.touchVal],bgOpacity);fillColor="RGBA(0,0,0,0)";drawPoly(hlContext,model.coords[me.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}else{fillColor=this.getNewColorForOpacityChange(bgColor,me.drawBgImageFlag,fillColor,POLY_NORMAL_OPACITY,POLY_HOVER_OPACITY);drawPoly(hlContext,model.coords[me.currHoverObj.touchVal],{x:me.leftOffset,y:me.topOffset},hoverStrokeColor,me.highlightPolygonStrokeWidth,fillColor);}}if(me.newRenderFlag){me.newRenderFlag=false;var polygonCenter=me.model.polygonCenters&&me.model.polygonCenters[me.currHoverObj.touchVal]&&me.model.polygonCenters[me.currHoverObj.touchVal][0];if(polygonCenter){var xOnWidget=polygonCenter[0]+me.leftOffset-me._scroller.origin.x;var yOnWidget=polygonCenter[1]+me.topOffset-me._scroller.origin.y;me.renderTooltip(this.currHoverObj.touchVal,xOnWidget,yOnWidget,this.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.currHoverObj.touchVal,this.currHoverObj.point.x,this.currHoverObj.point.y,this.currHoverObj.hdrIndex);}}}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){var selectedStrokeColor=BUBBLE_STROKE_COLOR_SELECTED_DARK_THEME,hoverStrokeColor=BUBBLE_STROKE_COLOR_HOVER_DARK_THEME,linkdrillStrokColor=BUBBLE_STROKE_COLOR_LINKDRILL_DARK_THEME,highlightStrokeColor=BUBBLE_HIGHLIGHT_STROKE_COLOR_DARK_THEME,noColorByColor=BUBBLE_COLOR_NO_COLORBY_DARK_THEME;if(model.themeMode===THEME_LIGHT){selectedStrokeColor=BUBBLE_STROKE_COLOR_SELECTED_LIGHT_THEME;hoverStrokeColor=BUBBLE_STROKE_COLOR_HOVER_LIGHT_THEME;linkdrillStrokColor=BUBBLE_STROKE_COLOR_LINKDRILL_LIGHT_THEME;highlightStrokeColor=BUBBLE_HIGHLIGHT_STROKE_COLOR_LIGHT_THEME;noColorByColor=BUBBLE_COLOR_NO_COLORBY_LIGHT_THEME;}if(me.markerType===MARKER_BUBBLE){me.drawBubblesInMap();var dftSltObjs=me.defaultSelectedObjs;if(!isOwnEmpty(dftSltObjs)){var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)){var sltBubbleRadius=me.getRadiusFromName(i);fillColor=me.getBubbleColorFromName(i);if(!fillColor){continue;}fillColor=getOpacityColor(fillColor,BUBBLE_SELECTED_OPACITY);if(me.shapeFileType===SHAPE_FILE_POLYGON){if(model.hasOwnProperty("polygonCenters")){sltCoord=model.polygonCenters[i][0];}}else{if(me.shapeFileType===SHAPE_FILE_POINT){sltCoord=model.coords[i][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.bubbleStrokeWidth);}}fillColor=noAltColor;}else{if(me.currSelectedObj!==null&&me.currSelectedObj.hasOwnProperty("touchVal")&&me.currSelectedObj.touchVal!==""&&me.currSelectedObj.touchVal!==null){var fillColor=noColorByColor,sltCoord,sltBubbleRadius;sltBubbleRadius=me.getRadiusFromName(me.currSelectedObj.touchVal);fillColor=me.getBubbleColorFromName(me.currSelectedObj.touchVal);if(!fillColor){fillColor=noColorByColor;}fillColor=getOpacityColor(fillColor,BUBBLE_SELECTED_OPACITY);if(me.shapeFileType===SHAPE_FILE_POLYGON){if(model.hasOwnProperty("polygonCenters")){sltCoord=model.polygonCenters[me.currSelectedObj.touchVal][0];}}else{if(me.shapeFileType===SHAPE_FILE_POINT){sltCoord=model.coords[me.currSelectedObj.touchVal][0];}}drawBubble(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},fillColor,sltBubbleRadius);drawStroke(hlContext,sltCoord,{x:me.leftOffset,y:me.topOffset},selectedStrokeColor,sltBubbleRadius,me.bubbleStrokeWidth);}else{if(me.currLinkObj!==null&&me.currLinkObj.hasOwnProperty("touchVal")&&me.currLinkObj.touchVal!==""&&me.currLinkObj.touchVal!==null){var linkCoord,linkBubbleRadius;linkBubbleRadius=me.getRadiusFromName(me.currLinkObj.touchVal);fillColor=me.getBubbleColorFromName(me.currLinkObj.touchVal);if(!fillColor){fillColor=noColorByColor;}fillColor=getOpacityColor(fillColor,BUBBLE_LINKDRILL_OPACITY);if(me.shapeFileType===SHAPE_FILE_POLYGON){if(model.hasOwnProperty("polygonCenters")){linkCoord=model.polygonCenters[me.currLinkObj.touchVal][0];}}else{if(me.shapeFileType===SHAPE_FILE_POINT){linkCoord=model.coords[me.currLinkObj.touchVal][0];}}drawBubble(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},fillColor,linkBubbleRadius);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},linkdrillStrokColor,linkBubbleRadius,me.bubbleStrokeWidth);drawStroke(hlContext,linkCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,linkBubbleRadius+me.hoverBubbleRadiusLarger,me.bubbleStrokeWidth);}}}if(me.currHoverObj!==null&&me.currHoverObj.hasOwnProperty("touchVal")&&me.currHoverObj.touchVal!==""&&me.currHoverObj.touchVal!==null){var hoverCoord,hoverBubbleRadius,hoverTouchVal=me.currHoverObj.touchVal;hoverBubbleRadius=me.getRadiusFromName(hoverTouchVal);fillColor=me.getBubbleColorFromName(hoverTouchVal);if(!fillColor){fillColor=noColorByColor;}var nodeStrokeColor=hoverStrokeColor;if((me.currSelectedObj&&me.currSelectedObj.touchVal===hoverTouchVal)||(!isOwnEmpty(me.defaultSelectedObjs)&&me.defaultSelectedObjs.hasOwnProperty(hoverTouchVal))){fillColor=getOpacityColor(fillColor,BUBBLE_SELECTED_OPACITY);nodeStrokeColor=selectedStrokeColor;}else{fillColor=getOpacityColor(fillColor,BUBBLE_HOVER_OPACITY);}if(me.shapeFileType===SHAPE_FILE_POLYGON){if(model.hasOwnProperty("polygonCenters")){hoverCoord=model.polygonCenters[me.currHoverObj.touchVal][0];}}else{if(me.shapeFileType===SHAPE_FILE_POINT){hoverCoord=model.coords[me.currHoverObj.touchVal][0];}}drawBubble(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},fillColor,hoverBubbleRadius);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},nodeStrokeColor,hoverBubbleRadius,me.bubbleStrokeWidth);drawStroke(hlContext,hoverCoord,{x:me.leftOffset,y:me.topOffset},highlightStrokeColor,hoverBubbleRadius+me.hoverBubbleRadiusLarger,me.bubbleStrokeWidth);if(me.newRenderFlag){me.newRenderFlag=false;var _center;if(me.shapeFileType===SHAPE_FILE_POLYGON){_center=me.model.polygonCenters&&me.model.polygonCenters[me.currHoverObj.touchVal]&&me.model.polygonCenters[me.currHoverObj.touchVal][0];}else{if(me.shapeFileType===SHAPE_FILE_POINT){_center=me.model.coords&&me.model.coords[me.currHoverObj.touchVal]&&me.model.coords[me.currHoverObj.touchVal][0];}}if(_center){var xOnWidget=_center[0]+me.leftOffset-me._scroller.origin.x;var yOnWidget=_center[1]+me.topOffset-me._scroller.origin.y;me.renderTooltip(this.currHoverObj.touchVal,xOnWidget,yOnWidget,this.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.currHoverObj.touchVal,this.currHoverObj.point.x,this.currHoverObj.point.y,this.currHoverObj.hdrIndex);}}}else{if(me.markerType===MARKER_IMAGE){var coords=model.coords;if(model.hasOwnProperty("polygonCenters")){coords=model.polygonCenters;}var dftSltObjs=me.defaultSelectedObjs;if(!isOwnEmpty(dftSltObjs)){var i;for(i in dftSltObjs){if(dftSltObjs.hasOwnProperty(i)){me.highlightImageIcon(hlContext,coords,i,0);}}}else{if(me.currSelectedObj!==null&&me.currSelectedObj.hasOwnProperty("touchVal")&&me.currSelectedObj.touchVal!==""&&me.currSelectedObj.touchVal!==null){var touchVal=me.currSelectedObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,0);}else{if(me.currLinkObj!==null&&me.currLinkObj.hasOwnProperty("touchVal")&&me.currLinkObj.touchVal!==""&&me.currLinkObj.touchVal!==null){var touchVal=me.currLinkObj.touchVal;me.highlightImageIcon(hlContext,coords,touchVal,me.hoverBubbleRadiusLarger);}}}if(me.currHoverObj!==null&&me.currHoverObj.hasOwnProperty("touchVal")&&me.currHoverObj.touchVal!==""&&me.currHoverObj.touchVal!==null){var touchVal=me.currHoverObj.touchVal,fillColor="RGBA(255,255,255,0.5)";var iconName="imageIcon_"+touchVal;if(model.hasOwnProperty(iconName)){var imgIcon=model[iconName],width=imgIcon.width+me.hoverBubbleRadiusLarger*2,height=imgIcon.height+me.hoverBubbleRadiusLarger*2,xOffset=coords[touchVal][0][0]-width/2+me.leftOffset,yOffset=coords[touchVal][0][1]-height/2+me.topOffset;hlContext.fillStyle=fillColor;hlContext.fillRect(xOffset,yOffset,width,height);var sltObj=me.currSelectedObj,hvTouchVal=me.currHoverObj.touchVal;if((sltObj!==null&&sltObj.hasOwnProperty("hdrIndex")&&sltObj.hdrIndex>=0&&sltObj.touchVal===hvTouchVal)||(!isOwnEmpty(me.defaultSelectedObjs)&&me.defaultSelectedObjs.hasOwnProperty(hvTouchVal))){}else{drawWhiteRectCorner(hlContext,xOffset,yOffset,width,height);}}if(me.newRenderFlag){me.newRenderFlag=false;var _center;if(me.shapeFileType===SHAPE_FILE_POLYGON){_center=me.model.polygonCenters&&me.model.polygonCenters[me.currHoverObj.touchVal]&&me.model.polygonCenters[me.currHoverObj.touchVal][0];}else{if(me.shapeFileType===SHAPE_FILE_POINT){_center=me.model.coords&&me.model.coords[me.currHoverObj.touchVal]&&me.model.coords[me.currHoverObj.touchVal][0];}}if(_center){var xOnWidget=_center[0]+me.leftOffset-me._scroller.origin.x;var yOnWidget=_center[1]+me.topOffset-me._scroller.origin.y;me.renderTooltip(this.currHoverObj.touchVal,xOnWidget,yOnWidget,this.currHoverObj.hdrIndex);}}else{me.renderTooltip(this.currHoverObj.touchVal,this.currHoverObj.point.x,this.currHoverObj.point.y,this.currHoverObj.hdrIndex);}}}}}}},getTouchValue:function getTouchValue(x,y){var me=this,model=this.model,coords=model.coords,elem,i;if(me.displayMode===DISPLAY_MODE_AREA){if(me.shapeFileType===SHAPE_FILE_POLYGON){for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coordsArray=coords[elem],l=coordsArray.length;for(i=0;i<l;i++){if(inPoly(coordsArray[i],x,y)){return elem;}}}}}}else{if(me.displayMode===DISPLAY_MODE_BUBBLE){if(me.shapeFileType===SHAPE_FILE_POLYGON&&model.hasOwnProperty("polygonCenters")){coords=model.polygonCenters;}var minDistance=Number.MAX_VALUE,touchName="";for(elem in coords){if(coords.hasOwnProperty(elem)){if(elem==="bgImage"){continue;}var coord=coords[elem][0],distance=Math.sqrt((x-coord[0])*(x-coord[0])+(y-coord[1])*(y-coord[1]));if(distance<minDistance){minDistance=distance;touchName=elem;}}}if(minDistance<this.bias){return touchName;}}}return null;},getAreaOrNearestBubble:function(isTap,touchX,touchY){var me=this,model=me.model,coords=model.coords;var touchPointOnWidget=me.utils.getTouchXYOnWidget(touchX,touchY,me);touchX=touchPointOnWidget.touchX;touchY=touchPointOnWidget.touchY;var x=touchX+me._scroller.origin.x-me.leftOffset,y=touchY+me._scroller.origin.y-me.topOffset,touchVal;if(isTap&&me.tooltipOn&&me.currHoverObj!==null){var crHP=null;if(me.shapeFileType===SHAPE_FILE_POLYGON){crHP=model.polygonCenters&&model.polygonCenters[me.currHoverObj.touchVal]&&model.polygonCenters[me.currHoverObj.touchVal][0];}else{if(me.shapeFileType===SHAPE_FILE_POINT){crHP=coords[me.currHoverObj.touchVal]&&coords[me.currHoverObj.touchVal][0];}}if(crHP){var dis=Math.sqrt((x-crHP[0])*(x-crHP[0])+(y-crHP[1])*(y-crHP[1]));if(dis<me.bias){touchVal=me.currHoverObj.touchVal;}else{touchVal=me.getTouchValue(x,y);}}}else{touchVal=me.getTouchValue(x,y);}if(!touchVal){return null;}var hdrIndex=me.getHeaderIndex(touchVal);return{touchVal:touchVal,hdrIndex:hdrIndex,point:{x:touchX,y:touchY}};},renderTooltip:function renderTooltip(touchVal,touchX,touchY,hdrIndex){var me=this,tooltip=this.tooltip,model=this.model,table=this.tooltip.childNodes[0],tooltipIndex=0,i,j,tr,tdLeft,tdRight;if(table){for(i=0;i<table.childNodes.length;i++){tr=table.childNodes[i];if(tr){tr.childNodes[0].innerHTML="";tr.childNodes[1].innerHTML="";}}}this.tooltip.style.visibility="visible";if(!me.tooltipOn){me.tooltipOn=true;var touchManager=mstrmojo.touchManager;me.tooltipListener=touchManager.attachEventListener("touchesBegin",me.id,function(evt){if(!me.isTouchedOnWidget(evt.touch)){me.hideTooltip();}});}var gts=model.gts,leftHtml,rightHtml;if(hdrIndex>=0){var rows=gts.row,idxs=model.ghs.rhs.items,idx;tr=tooltipIndex<table.childNodes.length&&table.childNodes[tooltipIndex++];if(tr){tr.childNodes[0].style.display="table-cell";tr.childNodes[1].style.align="left";tr.childNodes[0].style.paddingRight="5px";leftHtml=rows[0].n+":";tr.childNodes[0].innerHTML=leftHtml;rightHtml=rows[0].es[hdrIndex].n;tr.childNodes[1].innerHTML=rightHtml;}var ghsIndex=me.getIndexFromHdrindex(hdrIndex);for(i=1;i<rows.length;i++){tr=tooltipIndex<table.childNodes.length&&table.childNodes[tooltipIndex++];if(tr){tr.childNodes[0].style.paddingRight="5px";leftHtml=rows[i].n+":";tr.childNodes[0].innerHTML=leftHtml;rightHtml="";var _indices=me.attrIndices[i];if(_indices){for(j=0;j<_indices.length;j++){idx=idxs[ghsIndex].items[_indices[j]].idx;rightHtml+=rows[i].es[idx].n;if(j!==_indices.length-1){rightHtml+=" ";}}}tr.childNodes[1].innerHTML=rightHtml;}}var gtsCol=gts.col;if(gtsCol&&gtsCol.length>0){var units=gtsCol[0].es,values=model.gvs.items[ghsIndex].items;for(i=0;i<units.length;i++){tr=tooltipIndex<table.childNodes.length&&table.childNodes[tooltipIndex++];if(tr){tr.childNodes[0].style.paddingRight="5px";var mv=values[i],v=mv.v;if(mv&&mv.hasOwnProperty("ty")&&mv.ty!=4&&mv.ty!=10&&mv.ty!=3&&mv.hasOwnProperty("ti")){var th=model.th&&model.th[i];v=(th&&th[mv.ti]&&th[mv.ti].n)?th[mv.ti].n:mv.v;}leftHtml=units[i].n+":";tr.childNodes[0].innerHTML=leftHtml;rightHtml=""+v;tr.childNodes[1].innerHTML=rightHtml;}}}else{}}else{if(hdrIndex<0){rightHtml=touchVal;tr=tooltipIndex<table.childNodes.length&&table.childNodes[tooltipIndex++];if(tr){tr.childNodes[1].innerHTML=rightHtml;tr.childNodes[0].style.display="none";tr.childNodes[1].style.align="center";}}}var TLx=touchX+this.bias,TLy=touchY-this.bias-tooltip.offsetHeight,RightX=this.getWidth()-tooltip.offsetWidth-this.tooltipRightShadowWidth,RightY=this.getHeight()-tooltip.offsetHeight;if(TLx>RightX){if(TLy<0){TLy=0;TLx=Math.max(touchX-this.bias-tooltip.offsetWidth,0);}else{if(TLy>=0){TLx=RightX;}}}else{if(TLx<=RightX){if(TLy<0){TLy=0;}else{if(TLy>=0){}}}}positionTooltip(tooltip,TLx,TLy);},hideTooltip:function hideTooltip(){if(this.tooltipOn){this.tooltipOn=false;this.currHoverObj=null;this.highlightPoint();this.tooltip.style.visibility="hidden";if(this.tooltipListener){mstrmojo.touchManager.detachEventListener(this.tooltipListener);delete this.tooltipListener;}}},isTouchedOnWidget:function isTouchedOnWidget(touch){if(!touch){return false;}var me=this,touchPointOnWidget=me.utils.getTouchXYOnWidget(touch.pageX,touch.pageY,me),x=touchPointOnWidget.touchX,y=touchPointOnWidget.touchY;if((x>0&&x<me.getWidth())&&(y>0&&y<me.getHeight())){return true;}return false;},unrender:function unrender(ignoreDom){var me=this,model=me.model;if(this._super){this._super(ignoreDom);}if(me.docModelListener){if(me.xtabModel&&me.xtabModel.docModel){me.xtabModel.docModel.detachEventListener(me.docModelListener);}delete me.docModelListener;}if(me.fullScreenListener){mstrmojo.touchManager.detachEventListener(me.fullScreenListener);delete me.fullScreenListener;}if(me.tooltipListener){mstrmojo.touchManager.detachEventListener(me.tooltipListener);delete me.tooltipListener;}if(me.highlightContext){delete me.highlightContext;}if(me.animationContext){delete me.animationContext;}if(me._tn){delete me._tn;}},destroy:function destroy(){if(this._super){this._super();}}});}());