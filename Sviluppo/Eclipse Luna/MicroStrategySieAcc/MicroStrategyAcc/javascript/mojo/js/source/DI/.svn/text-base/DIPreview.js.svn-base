(function(){mstrmojo.requiresCls("mstrmojo.qb.QBPreview","mstrmojo._HasPopup","mstrmojo.SaveAsEditor","mstrmojo.WaitIcon","mstrmojo.form","mstrmojo.MenuButton","mstrmojo._HasLayout","mstrmojo.DI.DIConstants","mstrmojo.qb.MissingColumnWarning","mstrmojo.DI.DISharedViewer","mstrmojo.Editor","mstrmojo.Container");mstrmojo.requiresDescs(9120,9121,1442,221,9117,9118,9119);var constants=mstrmojo.DI.DIConstants;var shared=mstrmojo.DI.DISharedViewer;var refreshOptions=new mstrmojo.Editor({cssText:"background: white; width:270px;border: 10px solid rgba(0, 0, 0, 0.3); border-radius:5px; -moz-border-radius:5px;-webkit-border-radius:10px;",showTitle:false,zIndex:10,model:mstrmojo.all.DIModel,onOpen:function(){var st=this.curtainNode.style;st.background="black";st.opacity=0.5;st.filter="alpha(opacity=50)";},children:[{scriptClass:"mstrmojo.Label",cssText:"padding:10px 10px 10px 20px;",text:mstrmojo.desc(9120,"Options - Data Refresh")},{scriptClass:"mstrmojo.Label",cssText:"padding:0px 10px 20px 20px; color: blue;",text:mstrmojo.desc(9121,"Choose data refresh policy")},{scriptClass:"mstrmojo.RadioList",alias:"radiolist",cssText:"padding-left:25px;",itemCssClass:"mstrmojo-qb-radiolist-item",items:[{did:"1",n:mstrmojo.desc(9117,"Replace existing data")},{did:"4",n:mstrmojo.desc(9118,"Update existing data and add new data")},{did:"2",n:mstrmojo.desc(9119,"Keep existing data and add new data")}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width: 46px; float:right;",text:mstrmojo.desc(1442,"OK"),onclick:function(evt){var e=this.parent.parent;e.model.refresh_opt=e.radiolist.selectedItem.did;if(e.onOK){e.onOK();}e.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}]});mstrmojo.DI.DIPreview=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.DI.DIPreview",model:null,markupString:'<div id="{@id}" class="mstrmojo-di-datapreview {@cssClass}" style="overflow-y: hidden; {@cssText}"><div style="height: 50px"></div><div id="mstr_PreviewNode" style="overflow-x:auto;overflow-y:auto;border:1px solid lightGrey;margin:0px 1px 20px 0px"></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},sheetsNode:function(){return this.domNode.children[0];},previewNode:function(){return this.domNode.children[1];},footerNode:function(){return this.domNode.children[2];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";if(this.visible){if(this.height){var h=parseInt(this.height.substring(0,this.height.length-2),10);document.getElementById("mstr_PreviewNode").style.height=(h-139)+"px";}if(this.width){var w=parseInt(this.width.substring(0,this.width.length-2),10);document.getElementById("mstr_PreviewNode").style.width=(w-2)+"px";}}}},onNextButtonClick:function(){var p=this;var m=p.model;var missings=m.currentSource.getMissingColumns();var callback={success:function(res){m.hideWaitPage();p.publish();},failure:function(res){m.hideWaitPage();mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};if(missings){var dialog=mstrmojo.insert({scriptClass:"mstrmojo.qb.MissingColumnWarning",mappings:missings,title:m.applicationName(),warning:"The following previously uploaded columns are missing",details:"If you publish without these columns, existing reports, documents and analyses based on this cube might be affected. Do you still want to continue?",onOK:function(){p.model.changeMappings(callback);return true;}});dialog.open();}else{p.model.changeMappings(callback);}},publish:function publish(){var p=this;var m=p.model;var callback={success:function(res){m.cubeID=res.objectId;p.pollPublish();},failure:function(res){shared.publishErrorHandler(res,m);}};var params={taskId:"saveAndPublishCube",msgID:m.msgid,sessionState:mstrApp.sessionState};if(m.operationMode===constants.operationMode.create){p.openPopup("saveasRef",{zIndex:20,folderLinksContextId:1,name:"File",saveParams:params,saveAsCallback:function(){return callback;}});}else{params.folderID=m.folderID;params.objName=m.cubeName;params.saveAsOverwrite=true;m.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,callback,params);}},pollPublish:function pollPublish(){var m=this.model;var paramsPoll={taskId:"pollStatus",resultSetType:3,pollingFrequency:500,maxWait:60000,taskEnv:"xhr",taskConRtentType:"json",msgID:m.msgid,sessionState:mstrApp.sessionState};var cb={success:function(res){if(res.status==="1"){var url=shared.getRedirectURL(m.redirect,m.cubeID);mstrmojo.form.send(url,mstrApp.name,"POST",null,null,false);}else{mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,m.restructCB(this),pollParams);}},failure:function(res){shared.publishErrorHandler(res,m);}};m.showWaitPage();mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,m.restructCB(cb),paramsPoll);},saveasRef:{scriptClass:"mstrmojo.SaveAsEditor",typeDesc:"Cube",browsableTypes:"776",saveAs:function(overwrite){var panel=this.contPanel;this.name=panel.name.value;this.desc=panel.desc.value;if(!this.name){mstrmojo.confirm(mstrmojo.desc(8114),[mstrmojo.Button.newInteractiveButton("*enter a valid name*",null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})]);return ;}var params=this.saveParams||{};params.folderID=this.ob.currentFolder.did;params.objDesc=this.desc||"";params.objName=this.name||"";params.saveAsOverwrite=!!overwrite;var cb=this.saveAsCallback();cb.parent=this;mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,params);}},children:[{slot:"previewNode",scriptClass:"mstrmojo.qb.QBPreview",alias:"preGrid",columns:[],postCreate:function(){var m=mstrmojo.all.DIModel;m.attachEventListener("PreviewFetched",this.id,"initPreview");m.attachEventListener("MappingsFetched",this.id,"initPreview");},initPreview:function(){var diModel=this.parent.model;if(!diModel.currentSource){return ;}var model={mappings:diModel.currentSource.currentMapping,dataset:diModel.currentSource.currentPreview.data,supportTimeGeo:true,renameMapped:function(did,cIndex,v,callbacks){var mdl=this,mp=mdl.mappings,found=false;for(var i=0,len=mp.length;i<len;i++){if(i!=cIndex){if(v===mp[i].alias&&mp[cIndex].tp==mp[i].tp){found=true;break;}}}if(found){var msg="The name ## has been used by another column. Please give a new name.";mstrmojo.alert(msg.replace("##",v),null,mdl.alertTitle);return ;}mdl.mappings[cIndex].alias=v;mstrmojo.all.DIModel.raiseEvent({name:"MappingsFetched"});}};this.model=model;if(!model.mappings){return ;}this.populatePreview();}},{scriptClass:"mstrmojo.ImageCheckBox",slot:"sheetsNode",cssText:"float:left",alias:"newCH",label:"Insert New Column Headers",postBuildRendering:function(){var model=mstrmojo.all.DIModel;model.attachEventListener("PreviewFetched",this.id,"insertHdrs");},insertHdrs:function(){var p=this.parent.model.currentSource.currentPreview;this.set("checked",p.hasNewHeaders);},onclick:function(){var m=this.parent.model;var preview=m.currentSource.currentPreview;var preGrid=this.parent.preGrid;var i;var colHeadersXml="<chs>";if(this.checked){for(i=1;i<=preview.chs.length;i++){colHeadersXml=colHeadersXml+"<ch>Column "+i+"</ch>";}preview.data.splice(0,0,preview.chs);preview.set("hasNewHeaders",true);}else{preview.data.splice(0,1);preview.set("hasNewHeaders",false);}colHeadersXml=colHeadersXml+"</chs>";var cb1={success:function(res){m.set("msgid",res.msg_id);var cb2={success:function(res){if(res.datap){m.populate(res,constants.requestFlag.mapping,constants.requestFlag.mapping);}}};m.loadRptData(constants.requestFlag.mapping,m.currentSource.currentIndex,cb2);}};m.editCube(m.cubeID?m.cubeID:null,m.currentSource.currentIndex,colHeadersXml,cb1);}},{scriptClass:"mstrmojo.Button",slot:"sheetsNode",alias:"refreshbtn",cssText:"float:right;padding-right:10px;",iconClass:"mstrmojo-QBToolbarIcon refreshOption",visible:true,title:mstrmojo.desc(9136,"Data Refresh Options"),onclick:function(evt){var opt=this.parent.model.refresh_opt,idx;switch(opt){case"1":idx=0;break;case"4":idx=1;break;case"2":idx=2;break;default:idx=0;}refreshOptions.model=this.parent.model;refreshOptions.radiolist.set("selectedIndex",idx);refreshOptions.open();}},{scriptClass:"mstrmojo.HBox",slot:"sheetsNode",cssText:"float:right;padding-right:10px;",visible:false,postCreate:function(){this.model=mstrmojo.all.DIModel;this.model.attachEventListener("SheetsFetched",this.id,"makeVisible");},makeVisible:function(){var sheets=this.parent.model.currentSource.sheets;if(sheets!==null){if(sheets.length>1){this.set("visible",true);return ;}}this.set("visible",false);},children:[{scriptClass:"mstrmojo.Label",text:"Sheet Name:"},{scriptClass:"mstrmojo.Pulldown",alias:"preShtsPD",items:[],postCreate:function(){this.model=mstrmojo.all.DIModel;this.model.attachEventListener("SheetsFetched",this.id,"populateSheets");},populateSheets:function(){var sheets=this.parent.parent.model.currentSource.sheets;var items=[];var i;if(sheets){for(i=0;i<sheets.length;i++){items.push({dssid:sheets[i].index,n:sheets[i].name});}this.set("items",items);}},onitemsChange:function(evt){if(evt.value){this.set("value",-1);this.set("value",0);}},onvalueChange:function(evt){var m=this.parent.parent.model;if(this.selectedIndex>=0){this.loadData();}},loadData:function(){var m=this.parent.parent.model,preGrid=this.parent.parent.preGrid,index=this.items[this.selectedIndex].dssid;if(!m.currentSource.hasFetchedPreview(index)){var cb1={success:function(res){m.set("msgid",res.msg_id);var flags=constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.sourceInfo;var cb2={success:function(res){if(res.datap){m.populate(res,flags,flags);}}};m.loadRptData(flags,index,cb2);}};m.editCube(m.cubeID?m.cubeID:null,index,null,cb1);}else{m.currentSource.selectSheet(index);this.parent.parent.newCH.insertHdrs();preGrid.initPreview();}}}]}],resize:function(w,h){if(document.getElementById("mstr_PreviewNode")){document.getElementById("mstr_PreviewNode").style.height=(h-139+68)+"px";document.getElementById("mstr_PreviewNode").style.width=(w-2)+"px";}}});})();