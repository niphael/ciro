(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.Model","mstrmojo._CanProxyCallback","mstrmojo.EnumRWUnitType","mstrmojo.DocDataService","mstrmojo.StringBuffer","mstrmojo.EnumReadystate");var $RWTYPES=mstrmojo.EnumRWUnitType,$RS=mstrmojo.EnumReadystate,$HFE=mstrmojo.hash.forEach,$WRAP=mstrmojo.func.wrapMethods,$A=mstrmojo.array;var observables={isObservable:function(defn){var t=defn&&defn.t;if(!t||!(t in this)||defn.scriptClass){return false;}return(t!==$RWTYPES.SUBSECTION||!defn.dt);},makeObservable:function(defn){defn.audibles=this[defn.t]||{};if("readyState" in defn.audibles){defn.readyState=$RS.IDLE;}return new mstrmojo.Model(defn);}};observables[$RWTYPES.PANELSTACK]={"*":false,selKey:true,readyState:true};observables[$RWTYPES.GRID]={"*":false,readyState:true,ds:true};observables[$RWTYPES.GRAPH]={"*":false,readyState:true,ds:true};observables[$RWTYPES.GRIDGRAPH]={"*":false,qsm:true,ds:true};observables[$RWTYPES.SUBSECTION]={"*":false,resize:true,adjustSize:true};observables[$RWTYPES.VISUALIZATION]={"*":false,ds:true};observables[$RWTYPES.SELECTOR]={"*":false,cek:true,ds:true};observables[$RWTYPES.MOJOVISUALIZATION]={"*":false,ds:true};function getLayout(node,lytKey){var lyt=node.layoutMap&&node.layoutMap[lytKey];if(lyt){return lyt;}var lyts=node.layouts,cnt=(lyts&&lyts.length)||0,i=0;for(i=0;i<cnt;i++){if(lyts[i].k==lytKey){return lyts[i];}}return null;}function lookupDefn(defn,lytKey,key){var lyt=getLayout(defn,lytKey);if(key==lytKey){lyt._lkz=lytKey;return lyt;}else{if(lyt){var unit=lyt.units[key];if(unit){if(unit.t==$RWTYPES.GRIDGRAPH){if(!lyt.units[key+"_0"]){lyt.units[key+"_0"]={ck:unit.ck,fmts:unit.fmts.gd,txi:unit.txi,t:$RWTYPES.GRID};lyt.units[key+"_1"]={ck:unit.ck,fmts:unit.fmts.gp,t:$RWTYPES.GRAPH};}}if(observables.isObservable(unit)){unit=lyt.units[key]=observables.makeObservable(unit);}unit._lkz=lytKey;}}}return lyt&&lyt.units[key];}function filterSectionsByTypes(node,isPartial,types,include){var children=this.getChildren(node,isPartial,0);return(mstrApp.isMobile?(mstrmojo.array.filter(children,function(sec){var idx=types&&types.indexOf(sec.defn.t),dk=sec.defn.dk;return include?(idx>-1&&dk===-1):(idx<0||dk!==-1);})):(include?[]:children));}var fnBuildId=function(data,lk){var id=new mstrmojo.StringBuffer();if(lk){id.append("*l"+lk);}id.append("*k"+data.k);if("wid" in data){id.append("*x"+data.wid);}id.append("*t"+this.buildTime);return id.toString();};function getTxUpdates(t){var i,w,d=this.delta,pu=this.pendingUpdate,updates=[];if(!pu){pu=this.pendingUpdate={};}if(!mstrmojo.hash.isEmpty(d)){updates.push("<updates>");for(i in d){if(d.hasOwnProperty(i)){w=d[i];updates.push(w.getUpdates());}}pu[t]=d;this.delta={};updates.push("</updates>");}return updates.join("");}function fnGetTargetDefn(keys,delim){var defs;if(keys){keys=keys.split(delim||"\u001E");for(var i=0,cnt=keys.length;i<cnt;i++){defs=defs||{};defs[keys[i]]=lookupDefn.call(this,this.defn,this.currlaykey,keys[i]);}}return defs;}function unloadAffectedLayouts(me,data){var ulkeys=data.ulkeys,view=me.controller.view;if(view&&view.unloadLayouts&&ulkeys&&ulkeys.length){view.unloadLayouts(ulkeys);}}function isInfoWindowPS(key,layoutKey){var defn=this.getLayoutUnitDefn(key,layoutKey);return(defn&&defn.t===$RWTYPES.PANELSTACK&&defn.ifw);}function isCurrentSlice(node,sid){return !sid||(node.wid==sid);}function hasAllSelectedInGB(){var lyts=this.data&&this.data.layouts,lyt=lyts[$A.find(lyts,"k",this.getCurrentLayoutKey())],gbs=lyt&&lyt.gbys&&lyt.gbys.groupbys,isAllSelected=false;$A.forEach(gbs,function(gb){if(gb.unit&&gb.unit.elms&&gb.unit.elms[gb.unit.idx].v==="u;"){isAllSelected=true;return false;}});return isAllSelected;}mstrmojo.DocModel=mstrmojo.declare(mstrmojo.Model,[mstrmojo._CanProxyCallback],{scriptClass:"mstrmojo.DocModel",audibles:{"*":false,data:true},features:null,dataCache:null,controller:null,sdp:null,init:function init(props){this._super(props);if(!this.features){this.features=new mstrmojo.Model();this.disposables.push(this.features);}this.ondefnChange();this.buildTime=mstrmojo.now();},makeObservable:function makeObservable(defn){return observables.makeObservable(defn);},getTargetDefn:function(keys){return fnGetTargetDefn.call(this,keys);},getTargetInfoWin:function(keys){var ret=[],tgtDefs=fnGetTargetDefn.call(this,keys);if(tgtDefs){var tgt;for(tgt in tgtDefs){if(tgtDefs[tgt]&&tgtDefs[tgt].ifw){ret.push(tgt);}}}return ret;},getUnitDefinitions:function(keys,delim){return fnGetTargetDefn.call(this,keys,delim);},hasFeatures:function rsFts(featList){var fs=this.features;if(!fs){return false;}var arr=featList.split(",");for(var i=0,len=arr.length;i<len;i++){var s=arr[i],neg=s.match(/^\!/);if(neg){s=s.replace("!","");}if(neg?this.features[s]:!this.features[s]){return false;}}return true;},ondefnChange:function ondefnChg(){var defn=this.defn,lyts=defn&&defn.layouts,lytMap={};if(defn){defn.layoutMap=lytMap;for(var i=0,cnt=lyts&&lyts.length||0;i<cnt;i++){var lyt=lyts[i];lytMap[lyt.k]=lyt;}}},formatResolver:{getFormat:function getFormats(defn,thresholdId){var fmts=((defn&&defn.fmts)||null);if(thresholdId){var ts=defn.thresholds,tFmts=ts&&ts[thresholdId];if(tFmts){var fx={},p;for(p in fmts){fx[p]=tFmts[p]||fmts[p];}for(p in tFmts){var formatValue=tFmts[p];fx[p]=(typeof (formatValue)==="string")?(formatValue+" !important"):formatValue;}fmts=fx;}}return fmts;}},getSelectedXtabStyles:function getSelectedGridStyles(k){var sk=k||this.currlaykey;var ss={};var lyts=this.data&&this.data.layouts;for(var i in lyts){if(lyts[i].k===sk){ss=lyts[i].xtabStyles;break;}}return ss;},getChildren:function getCh(node,isPartial,start,count,includeTotal){var layoutKey=this.currlaykey;if(node){var defn=node.defn;layoutKey=(defn&&defn._lkz)||node.k;}var dc=this.getLayoutDataCache(layoutKey),useCache=(!isPartial&&!mstrmojo.hash.isEmpty(dc)),lookin;if(!node){lookin=this.data;}else{var src=node.data||node;if(useCache){lookin=dc[fnBuildId.call(this,src,layoutKey)];lookin=(lookin&&lookin.data)||lookin||src;}else{lookin=src;}}var arr=lookin?(lookin.sections||lookin.subsections||lookin.objects||lookin.panels||lookin.layouts||lookin.children):[],ch=[];var len=(arr&&arr.length)||0;if(len){var defn=this.defn,traversingLayouts=!node,ck=node?layoutKey:null,type=(node&&((node.defn)?node.defn.t:lookupDefn.call(this,defn,ck,node.k).t));var isGridGraph=(type===$RWTYPES.GRIDGRAPH),isDetails=(type===$RWTYPES.DETAILS);for(var i=start||0,stop=(isNaN(count))?len:i+count;i<stop;i++){var item=arr[i];if(isGridGraph){item.k=node.k;item.wid=node.data.wid;}var key=item.k,id=fnBuildId.call(this,item,ck),df;if(!traversingLayouts&&!isPartial&&isInfoWindowPS.call(this,key,ck)){var unitDef=this.getLayoutUnitDefn(key),unit={data:item,defn:unitDef,id:id,k:key,p:lookin};dc[id]=unit;if(!this.infoWinByKey||!this.infoWinByKey[key]){var infoWindows=this.infoWindows=this.infoWindows||{};var infoWinByKey=this.infoWinByKey=this.infoWinByKey||{};infoWindows[unitDef.n]=infoWinByKey[key]=unit;}continue;}if(isGridGraph){id+="_"+i;df=lookupDefn.call(this,defn,ck,item.k+"_"+i);}else{df=lookupDefn.call(this,defn,ck||item.k,item.k);}if(isDetails){df.dt=true;}ch.push({k:item.k,id:id,defn:df,data:useCache?(dc[id]&&dc[id].data)||item:item});}}return includeTotal?{nodes:ch,total:len}:ch;},getInfoWindow:function getInfoWindow(name){var infoWindows=this.infoWindows;return infoWindows&&infoWindows[name];},getFixedHeaders:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RWTYPES.PAGEHEADER],true);},getFixedFooters:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RWTYPES.PAGEFOOTER],true);},getNonFixedSections:function(node,isPartial){return filterSectionsByTypes.call(this,node,isPartial,[$RWTYPES.PAGEHEADER,$RWTYPES.PAGEFOOTER],false);},getLayoutUnitDefn:function getLayoutUnitDefn(key,layoutKey){return lookupDefn.call(this,this.defn,layoutKey||this.currlaykey,key);},getUnitInstance:function getUnitInstance(key,widgetID){return mstrmojo.all[fnBuildId.call(this,{k:key,wid:widgetID},this.currlaykey)];},getFirstUnitInstanceByName:function getFirstUnitInstanceByName(name){var lyt=getLayout(this.defn,this.currlaykey);if(lyt){var units=lyt.units;for(u in units){var unit=units[u];if(unit.n===name){return this.getUnitInstance(u,1);}}}return null;},getSelectedKey:function getSelK(node){return(!node&&this.currlaykey)||null;},getCurrentLayoutKey:function getCurrentLayoutKey(){return this.currlaykey;},getCurrentLayoutDef:function getCurrentLayoutDef(){var layouts=this.defn&&this.defn.layouts;return layouts&&layouts[$A.find(layouts,"k",this.currlaykey)];},replaceLayout:function replaceLayout(key,node){var dc=this.dataCache;if(dc&&dc[key]){dc[key]={};}var lyts=(this.data&&this.data.layouts)||(this.defn&&this.defn.layouts);for(var i=(lyts&&lyts.length-1)||0;i>=0;i--){if(lyts[i].k===key){break;}}this.bs=node.bs;this.zf=node.zf;if(node.data){this.data.layouts[i]=node.data.layouts[i];this.data.elems=node.data.elems;}if(node.defn){this.defn.layouts[i]=node.defn.layouts[i];this.ondefnChange();}},loadLayout:function loadLayout(layoutJSON,unloadCache,restoreIW){this.replaceLayout(layoutJSON.currlaykey,layoutJSON);this.raiseEvent({name:"rebuildLayout",unloadCache:!!unloadCache,restoreIW:!!restoreIW});},getTransactionUpdates:function getTransactionUpdates(t){return this.txDiscardTargets?"":getTxUpdates.call(this,t);},clearTransactionUpdates:function clearTransactionUpdates(t){this.clearTxDeltaUpdate(t);},resetTransactionUpdates:function resetTransactionUpdates(t){var pu=this.pendingUpdate,d=this.delta;if(pu&&pu[t]){$HFE(pu[t],function(v,i){if(d&&!d[i]){d[i]=v;}});delete pu[t];}},getDataService:function getDataService(){var dataService=this.dataService,me=this;if(!dataService){var params={rwb:this.bs,msgId:this.mid,model:this};if(mstrApp.modelFactory){dataService=mstrApp.modelFactory.newDataService("Document",params);}else{dataService=mstrApp.viewFactory.newDocDataService(params);}this.dataService=dataService;this.disposables.push(dataService);}return dataService;},partialUpdate:function partialUpdate(data,targetDefinitions){var updatedDataCache=this.updateDataCache(data,targetDefinitions);this.raiseEvent({name:"partialUpdate",tree:data,ids:updatedDataCache});return updatedDataCache;},transactionUpdate:function(res,evt){if(!res.data){return ;}var me=this,tgtDefs;if(evt&&evt.tks){tgtDefs=fnGetTargetDefn.call(this,evt.tks);}if(res.pukeys){tgtDefs=fnGetTargetDefn.call(this,res.pukeys);var tgt;for(tgt in tgtDefs){if(tgtDefs[tgt]&&tgtDefs[tgt].cek){tgtDefs[tgt].cek=null;}}}if(res.txrcd){this.txrcd=res.txrcd;}else{delete this.txrcd;}var ids=this.updateDataCache(res.data,tgtDefs,evt&&evt.sid),ue={name:"partialUpdate",tree:res.data,ids:ids};if(!mstrmojo.hash.isEmpty(ids.ifws)){if(evt&&evt.type===$RWTYPES.GRID){ue.anchor=evt.anchor;}else{ids.ifws={};}}this.raiseEvent(ue);return ids;},deltaUpdate:function dltUdt(w){var d=this.delta;if(!d){d=this.delta={};}d[w.id]=w;},clearTxDeltaUpdate:function clrDltUdt(t){var widgetsToClearTx=this.txDiscardTargets,clearAll=!widgetsToClearTx,pu=this.pendingUpdate,me=this,id;if(!clearAll){$HFE(widgetsToClearTx,function(v,id){if(me.delta&&me.delta[id]){me.delta[id].clear();delete me.delta[id];}});}if(pu&&pu[t]){$HFE(pu[t],function(w){w.clear();});delete this.pendingUpdate[t];}},sendTransactionActions:function sendTransactionActions(ck,at,callbacks){var me=this,params;if(!callbacks){callbacks={success:function(res){me.transactionUpdate(res);}};}me.getDataService().sendTransactionActions({keyContext:ck,actions:at,txrcd:this.txrcd},callbacks);},addSDP:function addSDP(sdpKey,primaryWidgetInfo){if(!sdpKey||!primaryWidgetInfo){return ;}if(!this.sdp){this.sdp={};}this.sdp[sdpKey]={k:primaryWidgetInfo.k,visName:primaryWidgetInfo.visName};},removeSDP:function removeSDP(sdpKey){if(!sdpKey||!this.sdp[sdpKey]){return ;}delete this.sdp[sdpKey];},slice:function slice(evt){try{if(!evt||(!mstrmojo.dom.isAndroid&&!evt.tks&&!evt.multiSelect&&(evt.type===3||(evt.type===$RWTYPES.GRAPH&&evt.tty!=1)))){return ;}var dataCacheUpdate=null,me=this,dataService=this.getDataService(),tgtDefs=evt.tks?fnGetTargetDefn.call(this,evt.tks):null,orignalTargetDefs=tgtDefs,fnSetReadyState=function(v){$HFE(orignalTargetDefs,function(targetDef,key){if(targetDef&&targetDef.set){targetDef.set("readyState",v);}});},fnGetWidget=function(k,wid){return mstrmojo.all[fnBuildId.call(me,{k:k,wid:wid},me.currlaykey)];},callback=this.newCallback({method:"slice",submission:function(){fnSetReadyState($RS.WAITING);},success:function(res){if(evt.disablePU){me.loadLayout(res,evt.isUConDS,evt.restoreIW);return ;}if(res.pukeys){tgtDefs=fnGetTargetDefn.call(me,res.pukeys);}unloadAffectedLayouts(me,res);dataCacheUpdate=me.updateDataCache(res.data,tgtDefs,evt&&evt.sid);if(typeof (res)=="object"){mstrmojo.hash.copyProps(["bs","exopt","dty"],res,me);}var ue={name:"partialUpdate",tree:res.data,ids:dataCacheUpdate};if(!mstrmojo.hash.isEmpty(ue.ids.ifws)){if(evt&&!evt.suppressIW&&(evt.type===$RWTYPES.GRID||evt.type===$RWTYPES.GRAPH)){ue.anchor=evt.anchor;}else{ue.ids.ifws={};}}me.raiseEvent(ue);},complete:function(){fnSetReadyState($RS.IDLE);}});if(evt.type==3){var panelStackKey=evt.tks,panelKey=evt.eid;if(!panelStackKey){return ;}var pnlDef=lookupDefn(this.defn,this.currlaykey,panelKey);if(!pnlDef){return ;}var dirtyKeys=panelKey,panelStackDefn=tgtDefs[panelStackKey],fnActivatePanel=function(){panelStackDefn.set("selKey",panelKey);},fnPanelState;panelStackDefn.newSelKey=panelKey;if(pnlDef.l){var dk=pnlDef.dirtyKeys;if(!!dk){dirtyKeys=mstrmojo.hash.keyarray(dk).join(",");orignalTargetDefs=tgtDefs=fnGetTargetDefn.call(this,dirtyKeys,",");fnPanelState=function(){fnActivatePanel();$HFE(dataCacheUpdate.upd,function(v,updatedId){var updatedWidget=mstrmojo.all[updatedId];if(updatedWidget&&updatedWidget.setDirty){updatedWidget.setDirty(false);}});};}else{dataService.setCurrentPanel(panelKey,evt.tks,evt.ck,this.newCallback({method:"slice",success:fnActivatePanel}));return ;}}else{fnPanelState=function(){fnActivatePanel();pnlDef.l=true;};}var fnSuccess=callback.success;callback.success=function(res){var lyt=getLayout(res.defn,me.currlaykey),oldLyt=getLayout(me.defn,me.currlaykey),fnAppendNewProps=function(oldObj,newObj){for(var u in newObj){if(oldObj[u]===undefined){oldObj[u]=newObj[u];}}},newUnits=lyt&&lyt.units,oldUnits=oldLyt&&oldLyt.units,newCGBMap=lyt&&lyt.cgbMap,oldCGBMap=oldLyt&&oldLyt.cgbMap;if(newUnits){fnAppendNewProps(oldUnits,newUnits);}if(newCGBMap){fnAppendNewProps(oldCGBMap,newCGBMap);me.raiseEvent({name:"CGBMapChange",cgbMap:oldCGBMap});}fnSuccess(res);fnPanelState();var panelStack=fnGetWidget(evt.tks,0);if(panelStack){panelStack.clearDirtyChild(panelKey);}};dataService.requestNewPanel(panelKey,evt.tks,evt.ck,dirtyKeys,!evt.hasLoader,callback);}else{callback=$WRAP(callback,{success:function(res){$HFE(orignalTargetDefs,function(def,targetKey){var targetWidget=fnGetWidget(targetKey,1);if(!targetWidget){if(!!me.sdp&&!!me.sdp[targetKey]){var sdpData=me.getLayoutDataCache(me.getCurrentLayoutKey());var sdpId=fnBuildId.call(me,{k:targetKey,wid:1},me.currlaykey);me.raiseEvent({name:"secondaryDataSliced",key:targetKey,data:sdpData[sdpId].data});}return ;}if(dataCacheUpdate&&!(targetKey in dataCacheUpdate.def)){if(targetWidget.setDirty){targetWidget.setDirty(true);}}else{if(def.t==$RWTYPES.PANELSTACK){targetWidget.setDirtyChildren();}}});}});var args,methodName;if(evt.type==$RWTYPES.GRAPH){methodName="applyGraphSelectorAction";args=[evt.ck,evt.cks,evt.sid,evt.x,evt.y,callback,me.zf];}else{if(evt.isMultipleEvents){methodName="RWEventsTask";params={messageID:this.mid,styleName:"RWDocumentMojoStyle",events:evt.events};args=[params,callback];}else{if("eid" in evt){methodName=evt.isDocVis?"setDocVisSelectorElements":"setDocSelectorElements";args=[evt.ck,evt.eid,evt.ctlKey,evt.include,callback,me.zf];var hasAllInGB=hasAllSelectedInGB.call(this);if(evt.isUConDS||hasAllInGB){evt.disablePU=true;args=args.concat([null,0,null,true]);}if(hasAllInGB){evt.restoreIW=true;}if(me.sdp){var sdpreqKeys={};$HFE(me.sdp,function(obj,key){if(me.sdp[key]){sdpreqKeys[key]=obj.visName;}});args[7]=JSON.stringify(sdpreqKeys);}args[8]=evt.tks;}else{if(evt.multiSelect){if(evt.selectorObjects.length>0){methodName="setMultiDocSelectorElements";args=[evt.selectorObjects,evt.multiSelect,callback,me.zf];}}else{if("srct" in evt&&evt.srct==4){if(evt.onlyInclude){methodName="setDocSelectorInclude";args=[evt.ckey,evt.include,callback,evt.srcid,evt.srct,me.zf];}else{methodName="setDocSelectorExpression";args=[evt.ck,evt.ckey,evt.srcid,evt.srct,evt.f,evt.ft,evt.include,evt.cs,5,callback,me.zf];if(!evt.cs){args[7]=null;args[8]=null;if(evt.changeQual){dataService.setRWUnitProperties(evt.ckey,evt.ckey+"\u001FFormattingSelector\u001FMetricConditionType\u001F"+evt.qt,1,false,null);args.push(evt.unset);}}}}else{if(evt.unset){methodName="setDocUnsetSelector";args=[evt.ck,evt.ckey,callback,me.zf];}else{methodName="setDocSelectorInclude";args=[evt.ckey,evt.include,callback,null,null,me.zf];}}}}}}if(methodName){dataService[methodName].apply(dataService,args);}}}catch(ex){mstrmojo.err(ex);}},getLayoutDataCache:function getLayoutDataCache(key){if(!key){return null;}var dc=this.dataCache;if(!dc){dc=this.dataCache={};}if(!dc[key]){dc[key]={};}return dc[key];},updateDataCache:function updDC(tree,tks,sid){var me=this,dc=this.getLayoutDataCache(this.getCurrentLayoutKey()),_result={ifws:{},upd:{},tgts:{},def:{},secs:{}};function findTgtDescendants(node,wasInst,activeKey){var isInst=false,chnodes=me.getChildren(node,true),w;if(!chnodes.length){return ;}if(wasInst){w=mstrmojo.all[node.id];isInst=!node.id||!!w;}var nodeDefn=node.defn,nodeData=node.data,selectedPanelKey;if(nodeDefn&&nodeDefn.t===$RWTYPES.PANELSTACK&&nodeDefn.od){selectedPanelKey=nodeData.selKey;}for(var cnt in chnodes){var ch=chnodes[cnt],childKey=ch.k,id=ch.id,localActiveKey=null;if(mstrmojo.all[id]){isInst=true;}if(childKey in tks){if(isInfoWindowPS.call(me,childKey)&&isCurrentSlice(ch.data,sid)){dc[id]=ch;if(!activeKey){_result.ifws[childKey]=me.infoWinByKey[childKey].id;}}localActiveKey=childKey;if(isInst){if(selectedPanelKey&&selectedPanelKey!==childKey){continue;}if(!activeKey){_result.tgts[id]=true;}var secDef=w&&w.defn,ty=secDef&&secDef.t,ck=secDef&&secDef.ck;if(ty===$RWTYPES.SUBSECTION&&(ck&&(childKey in ck))){_result.secs[w.id]=true;}}}if((activeKey||localActiveKey)&&(!selectedPanelKey||selectedPanelKey===childKey)){dc[id]=ch;_result.def[childKey]=true;if(isInst){_result.upd[id]=true;}}findTgtDescendants(ch,isInst,activeKey||localActiveKey);}}if(tree&&tree.layouts&&tks){findTgtDescendants(mstrmojo.array.filter(tree.layouts,function(l){return(l.loaded);},{max:1})[0],true);}return _result;},getCGBMap:function getCGBMap(){var lyt=getLayout(this.defn,this.currlaykey);return lyt&&lyt.cgbMap;},executeLink:function executeLink(url,target,src){if(url.indexOf("prevMsgID")>0){var replacement="prevMsgID="+this.mid;url=url.replace(/prevMsgID=0($|&)/g,function(match,cap){if(cap=="&"){return replacement+="&";}else{return replacement;}});if(mstrmojo.dom.isIE){url+="&cb"+mstrmojo.now()+"=1";}}url=mstrmojo.addCSRFTokenToURL(url);this.controller.onLink(this,{url:url,target:target,src:src||null});},showInfoWin:function showInfoWin(key,anchor,orientation,invalidate,anchorPosition){var ifwunit=this.infoWinByKey&&this.infoWinByKey[key];if(ifwunit===undefined){return ;}this.raiseEvent({name:"showInfoWin",psId:ifwunit.id,psKey:ifwunit.k,anchor:anchor,anchorOrientation:orientation,anchorPosition:anchorPosition,invalidate:invalidate});},downloadGridData:function downloadGridData(params){var me=this,widgetID=params.xtabId,memo=params.memo,w=mstrmojo.all[widgetID],dataService=this.getDataService();var callback=this.newCallback({success:function(res){function findWidgetData(node,wID){var chnodes=me.getChildren(node,true);for(var cnt in chnodes){var ch=chnodes[cnt];if(wID==ch.id){return ch;}var w=findWidgetData(ch,wID);if(w){return w;}}return null;}var tree=res.data,newGridData=null,nodeDef,lyt=tree&&getLayout(tree,me.currlaykey);if(lyt){newGridData=findWidgetData(lyt,widgetID);}if(newGridData&&w){w.dataDownloaded(newGridData,memo);}if(lyt&&lyt.xtabStyles){me.raiseEvent({name:"updateStyles",key:lyt.k,updatedStyles:lyt.xtabStyles});}nodeDef=lookupDefn.call(me,me.defn,me.currlaykey,params.nodeKey);if(nodeDef&&nodeDef.t===$RWTYPES.GRIDGRAPH&&memo.recalculating){var gg=w.parent,gp=gg&&gg.getGraphWidget();if(gg&&gp&&gg.updateGraph){gg.updateGraph(findWidgetData(lyt,gp.id));}}},failure:function(){if(w.dataDownloadErr){w.dataDownloadErr();}}});dataService.downloadGridData(params,callback);},saveRWProps:function saveRWProps(nodeKey,props,type,loadData,callback){var data=[],d="\u001F";$HFE(props,function(o,key){$HFE(o,function(v,p){data.push(key+d+p+d+v);});});if(!data.length){return ;}if(loadData){var g=lookupDefn.call(this,this.defn,this.currlaykey,nodeKey),fnReadyState=function(rs){g.set("readyState",rs);};callback=$WRAP(callback,{submission:function(){fnReadyState($RS.WAITING);},complete:function(){fnReadyState($RS.IDLE);}});}this.getDataService().setRWUnitProperties(nodeKey,data.join("\u001E"),type||1,loadData,callback);},loadPartialData:function loadPartialData(data,nodeKey){var tgtDef={};tgtDef[nodeKey]=lookupDefn.call(this,this.defn,this.currlaykey,nodeKey);var ids=this.updateDataCache(data,tgtDef),dc=this.getLayoutDataCache(this.getCurrentLayoutKey()),me=this;mstrmojo.array.forEach(data.layouts,function(l){if(l&&l.xtabStyles){me.raiseEvent({name:"updateStyles",key:l.k,updatedStyles:l.xtabStyles});}});$HFE(ids,function(col,meth){if(meth==="upd"){$HFE(col,function(v,id){var w=mstrmojo.all[id];if(w&&w.update){w.update(dc[id]);}});}});},addAutoWidthID:function addAutoWidthID(id){var aws=this.aws||{},units=aws[this.currlaykey]||[];units.push(id);aws[this.currlaykey]=units;this.aws=aws;},getAutoWidthIDs:function getAutoWidthIDs(){var aws=this.aws,l=this.currlaykey;var ids=aws&&aws[l];if(ids){delete aws[l];}return ids;}});})();