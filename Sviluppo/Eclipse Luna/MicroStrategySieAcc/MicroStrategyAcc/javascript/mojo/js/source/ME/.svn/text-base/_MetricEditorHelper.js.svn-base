(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo._FormatDefinition","mstrmojo.ME.MetricDataService","mstrmojo.ME.MetricEditBox");mstrmojo.requiresDescs(218,219,221,628,1442,2102,2116,2154,2213,2919,4596,5298,5728,5891,7924,7984,7987);var _FD=mstrmojo._FormatDefinition,_S=mstrmojo.string,_VSTATUS=mstrmojo.ME.MetricEditBox.VALIDATION_STATUS,EDIT_TYPE={advanced:65536,simple:131072,func:196608};var _mapErrorCode=function(code){if(!code){return _VSTATUS.VALID;}return{"-2147214845":_VSTATUS.ERROR,"-2147214846":_VSTATUS.AMBIGUITY}[code]||_VSTATUS.ERROR;},_saveTaskParams=function(oi,saveAs){var params={taskId:"saveMetricDefinition",tokenStreamXML:_getTokenStreamXML(oi),localSymbolFolderXML:_getLocalSymbolFolderXML(oi),metricXML:_getMetricPropsXML(oi),metricId:oi.did||"",outputFlags:327695,description:oi.desc||"",name:oi.n||"",saveAs:saveAs,sessionState:mstrApp.sessionState};if(_S.isEmpty(oi.metricId)){params.isNew=true;}return params;},_saveAsCallback=function(me){var scb=function(res){var p=this.parent;var message=mstrmojo.desc(7987,"The ## '###' has been saved successfully.").replace("##","Object").replace("'###'","");if(p){p.ob.refreshContent();p.onObjectSaved({name:p.name,did:res.did,desc:p.desc});message=mstrmojo.desc(7987,"The ## '###' has been saved successfully.").replace("##",p.typeDesc||"Object").replace("###",p.name);}mstrmojo.confirm(message,[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(1442,"OK"),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})],mstrmojo.desc(7984,"Object Saved"));if(p){p.close();}me.dirty=false;},cb={success:scb,failure:mstrmojo.SaveAsEditor.SAVEAS_CALLBACK.failure};return cb;},_validateSyntaxAndSave=function(me,saveFlag){var btn=this;_wait(btn,true);var oi=mstrmojo.ME._MetricEditorHelper.oi=me.oi,tksXML=_getTokenStreamXML(oi),lsfXML=_getLocalSymbolFolderXML(oi),mtrXML=_getMetricPropsXML(oi,true),success=function(res){if(res&&res.tks){var tks=res.tks;_preprocessTokenStram(tks);oi.tks=tks;if(!tks.rjec){oi.mps=res.mps;}tks.vs=_mapErrorCode(tks.rjec);me.set("vStatus",tks.vs);me.set("iStatus",tks.rjed||"");me.handleValidation&&me.handleValidation(tks);if(saveFlag&&tks.vs===_VSTATUS.VALID){var params=_saveTaskParams(oi,false);if(saveFlag==="save"&&oi.did){mstrmojo.xhr.request("POST",mstrConfig.taskURL,_saveAsCallback(me),params);}else{if(saveFlag==="save"&&mstrmojo.string.isEmpty(oi.did)||saveFlag==="saveAs"){params.saveAs=true;me.openPopup("saveasRef",{zIndex:me.zIndex+10,folderLinksContextId:17,name:mstrmojo.desc(2213,"New Metric"),saveParams:params,saveAsCallback:function(){return _saveAsCallback(me);}});}else{if(saveFlag==="switch"){if(me.cbSwtichEditor){me.cbSwtichEditor(me);}}}}}else{if(saveFlag&&tks.vs===_VSTATUS.ERROR){mstrmojo.confirm(mstrmojo.desc(9826,"The metric definition has an error. Please correct before proceeding."),[mstrmojo.Button.newInteractiveButton(mstrmojo.desc(1442,"OK"),null,null,{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",cssText:"width:72px;"})],mstrmojo.desc(9571,"Syntax Error!"));}}}},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));},complete=function(res){_wait(btn,false);};mstrmojo.ME.MetricDataService.validateMetric({tokenStreamXML:tksXML,localSymbolFolderXML:lsfXML,metricXML:mtrXML,metricId:oi.did,isNew:_S.isEmpty(oi.did)},{success:success,failure:failure,complete:complete});},_clearTokenSection=function(me,meb){var empty=[];me.oi.tks.items=empty;meb.clearTokens(empty);},_getMetricPropsXML=function(oi,onlyMps){var res=[];res.push("<mt>");if(oi.fmt&&!onlyMps){var fmtCtg={getArrItemName:function(n,v,i){return n.substr(0,n.length-1);},isSerializable:function(nodeName,jsons,index){if(mstrmojo.array.indexOf(["header_format","grid_format"],nodeName)>-1){var format=jsons[index][nodeName];if(!format){return{};}var xml="<"+nodeName+">";for(var prs in format){xml+="<prs n='"+prs+"'>";var prsv=format[prs];for(var pr in prsv){var prv=prsv[pr];xml+="<pr n='"+pr+"' v='"+(prv=="pru"?"":prv)+"'";xml+=prv=="pru"?' pru="1"':"";xml+="/>";}xml+="</prs>";}xml+="</"+nodeName+">";return{child:xml};}return true;},skipNull:true};res.push(_S.json2xml("fmt",oi.fmt,fmtCtg));}if(oi.prss&&!onlyMps){var prssCtg={getArrItemName:function(n,v,i){return n.substr(0,n.length-1);},isSerializable:function(nodeName,jsons,index){if(mstrmojo.array.indexOf(["AnalyticalEngineProperties","DatamartProperties","VLDBSelect","VLDBFunction","VLDBReport"],nodeName)>-1){var json=jsons[index][nodeName];if(!json){return{};}var xml=[],innerXml=[];xml.push("<prs n='"+nodeName+"' ");for(var pr in json){var prv=json[pr];if(prv!=null){if(typeof (prv)=="object"){innerXml.push(_S.json2xml("pr",prv,{skipNull:true,convertBoolean:true,isSerializable:function(n,jsons,idx){return true;}}));}else{xml.push(pr+"='"+prv+"' ");}}}xml.push(">");xml.push(innerXml.join(""));xml.push("</prs>");return{child:xml.join("")};}return true;},skipNull:true};res.push(_S.json2xml("prss",oi.prss,prssCtg));}if(oi.mps){res.push(_S.json2xml("mps",oi.mps,{skipNull:true,convertBoolean:true,isSerializable:function(n,jsons,idx){return true;}}));}if(oi.datp&&!onlyMps){res.push(_S.json2xml("datp",oi.datp,{skipNull:true,convertBoolean:true,isSerializable:function(n,jsons,idx){return true;}}));}if(oi.sbs&&!onlyMps){var sbsCtg={getArrItemName:function(n,v,i){if(n=="avs"){return"sb";}else{return n.substr(0,n.length-1);}},isSerializable:function(nodeName,jsons,index){return true;},skipNull:true};res.push(_S.json2xml("sbs",oi.sbs,sbsCtg));}res.push("</mt>");return res.join("");},_getTokenStreamXML=function(oi){var tks=_postprocessTokenStram(oi.tks);var xml="",props={items:true,v:true,tp:true,lv:true,exv:true,extp:true,oi:true,n:true,did:true,t:true,st:true,exv:true,extp:true,asc:true},config={getArrItemName:function(n,v,i){return"tkn";},isSerializable:function(nodeName,jsons,index){return(props[nodeName])?true:false;}};xml=_S.json2xml("tknstrm",tks,config);return xml;},_preprocessTokenStram=function(tks){var its=tks.items,len=its.length,last=its[its.length-1];if(last&&last.tp===-1){its.pop();}if(its[0]&&its[0].tp===38){its.splice(0,1);}},_postprocessTokenStram=function(tks){var its=tks.items,len=its.length,last=its[its.length-1],i,it,newItems=[],newV="";if(its[0]&&its[0].tp!==38){newItems.push({v:"&",tp:38,lv:4,sta:2});}for(i=0,len=its.length;i<len;i++){it=its[i];if(it.isNew&&!it.oi){newV+=it.v;}else{if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}newItems.push(it);}}if(!_S.isEmpty(newV)){newItems.push({v:newV,tp:2,lv:1});newV="";}if(last&&last.tp!==-1){newItems.push({v:"",tp:-1,lv:4,sta:2});}return{items:newItems};},_getLocalSymbolFolderXML=function(oi){return"";},_wait=function(btn,v){btn.set("enabled",!v);btn.set("iconClass",btn.iconClass.replace(/mstrmojo-InlineWaitIcon/,"")+" "+(v?"mstrmojo-InlineWaitIcon":""));},_openFormatPopup=function(btn,editor){var me=editor,m=me.oi.fmt,MAP=_FD.MetricFormatTarget;_wait(btn,true);window.setTimeout(function(){if(!m){m=me.oi.fmt={};for(var i=0;i<MAP.length;i++){m[MAP[i].p]={};}}var pos=mstrmojo.dom.position(btn.domNode,true);me.openPopup("formatPopupRef",{zIndex:me.zIndex+10,model:m,left:pos.x+"px",top:Math.max(0,(pos.y-(me.formatPopupRef.height||350)))+"px"});_wait(btn,false);},50);},_openOptionPopup=function(btn,editor){var me=editor,m=me.oi,open=function(){var pos=mstrmojo.dom.position(btn.domNode,true);me.openPopup(mstrmojo.all.mstrMEOptionsDialog||"optionPopupRef",{zIndex:me.zIndex+10,model:m,funcs:me.funcs,left:pos.x+"px",top:Math.max(0,(pos.y-(me.optionPopupRef.height||350)))+"px"});};if(!me.funcs){_wait(btn,true);mstrmojo.ME.MetricDataService.getSubtotalFunctions(null,{success:function(res){if(res.items){me.funcs=res.items;open();_wait(btn,false);}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));_wait(btn,false);}});}else{open();}};mstrmojo.ME._MetricEditorHelper=mstrmojo.provide("mstrmojo.ME._MetricEditorHelper",{noCache:true,useKeyDelay:true,saveasRef:{scriptClass:"mstrmojo.SaveAsEditor",typeDesc:"Metric",browsableTypes:"4,8",onObjectSaved:function(o){var p=this.opener,oi=p&&p.oi;if(p&&oi){oi.did=o.did;oi.n=o.name;oi.desc=o.desc;p.set("title",mstrmojo.desc(2154,"Metric:")+" "+o.name);}}},optionPopupRef:{id:"mstrMEOptionsDialog",scriptClass:"mstrmojo.ME.OptionDialog",title:mstrmojo.desc(9572,"Advanced Metric Options"),help:"Advanced_Metric_Options_dialog_box.htm",height:340},formatPopupRef:{scriptClass:"mstrmojo.ME.MetricFormatEditor",contentNodeCssClass:"mstrmojo-balloon",alias:"formatEditor",title:mstrmojo.desc(2116,"Format"),left:"100px",top:"100px",useAnimate:false,height:360,help:"Format_Metric_dialog_box.htm",locksHover:true},functionSelector:{scriptClass:"mstrmojo.ME.FunctionSelector",insertMode:true},wizard:{scriptClass:"mstrmojo.ME.FunctionWizard"},simpleMetricRef:{scriptClass:"mstrmojo.ME.SimpleMetricEditor"},metricEditorRef:{scriptClass:"mstrmojo.ME.MetricEditor"},ob:{scriptClass:"mstrmojo.Editor",title:mstrmojo.desc(5298,"Select an Object"),help:"Select_Objects_dialog_box_.htm",children:[{scriptClass:"mstrmojo.ObjectBrowser",alias:"browser",cssText:"width:200px;",fishEyeVisible:false,closeable:false,closeOnSelect:false}]},switchRef:{scriptClass:"mstrmojo.Button",alias:"switchToMetricEdtior",cssClass:"mstrmojo-ME-switch",text:mstrmojo.desc(9563,"Switch to Formula Editor"),bindings:{visible:function(){return !this.parent.insertMode;}},getEditor:function(){return this.parent;},onclick:function(){var editor=this.getEditor();editor.oi.tks.items=editor.getMetricDefAsTokens();var cfg={vStatus:mstrmojo.ME.MetricEditBox.VALIDATION_STATUS.UNKNOWN,candidates:editor.candidates,oi:editor.oi,did:editor.oi.did,functions:editor.functions};if(editor.dirty){cfg.dirty=editor.dirty;}editor.openPopup("metricEditorRef",cfg);editor.close();}},buttonBarRef:{scriptClass:"mstrmojo.HBox",alias:"buttonBar",slot:"buttonNode",cssClass:"mstrmojo-ME-buttonBox",cellCssClass:"subBox",children:[{scriptClass:"mstrmojo.HBox",cssClass:"left",cssText:"width:70px;",bindings:{visible:function(){return !this.parent.parent.insertMode;}},children:[{scriptClass:"mstrmojo.Button",iconClass:"tbFormat",alias:"formatButton",title:mstrmojo.desc(4596,"Format..."),text:"",onclick:function(){_openFormatPopup(this,this.parent.parent.parent);}},{scriptClass:"mstrmojo.Button",iconClass:"tbAdvOptions",alias:"optButton",title:mstrmojo.desc(7924,"Options..."),text:"",onclick:function(){_openOptionPopup(this,this.parent.parent.parent);}}]},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",alias:"saveokButton",text:"",bindings:{text:function(){return(this.parent.parent.insertMode)?mstrmojo.desc(2919,"Insert"):mstrmojo.desc(5891,"Save");}},onclick:function(){var e=this.parent.parent;if(e.insertMode){e.insertOnFinish(e.getMetricDefAsTokens());e.close();}else{if(e.getMetricDefAsTokens){e.oi.tks.items=e.getMetricDefAsTokens();}e.tbValidate=this;_validateSyntaxAndSave.call(this,e,"save");}}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",alias:"btnSaveAs",text:mstrmojo.desc(628,"Save As"),bindings:{visible:function(){return !this.parent.parent.insertMode;}},onclick:function(){var e=this.parent.parent;if(e.getMetricDefAsTokens){e.oi.tks.items=e.getMetricDefAsTokens();}e.tbValidate=this;_validateSyntaxAndSave.call(this,this.parent.parent,"saveAs");}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(2102,"Close"),onclick:function(){var e=this.parent.parent;if(e.onPreClose()){e.close();}}}]},validateSyntax:function(btn){_validateSyntaxAndSave.call(btn,this);},validateSyntaxAndSwitch:function(btn){_validateSyntaxAndSave.call(btn,this,"switch");},preprocessTokenStram:function(tks){_preprocessTokenStram(tks);},isDirty:function(){if(this.insertMode){return false;}return this.dirty;},onmetricModify:function(){this.dirty=true;},save:function(){this.buttonBar.btnSaveAs.onclick();},prompt2saveRef:{scriptClass:"mstrmojo.Editor",cssText:"width:350px;",title:mstrmojo.desc(5728,"Confirm save"),children:[{scriptClass:"mstrmojo.Label",cssText:"margin:5px 5px 20px;",bindings:{text:function(){return mstrmojo.desc(9573,"Do you want to save changes made to #?").replace("#","<b>"+this.parent.opener.oi.n+"</b>");}}},{scriptClass:"mstrmojo.HBox",alias:"buttonBar",slot:"buttonNode",cssClass:"mstrmojo-ME-buttonBox",cellCssClass:"subBox",children:[{scriptClass:"mstrmojo.HBox",cssClass:"left",cssText:"width:10px;"},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(219,"Yes"),onclick:function(){var me=this.parent.parent;me.opener.save();me.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(218,"No"),onclick:function(){var me=this.parent.parent;me.opener.close();me.close();}},{scriptClass:"mstrmojo.HTMLButton",cssClass:"mstrmojo-Editor-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var me=this.parent.parent;me.close();}}]}]},prompt2save:function(){if(this.getMetricDefAsTokens){this.oi.tks.items=this.getMetricDefAsTokens();}this.openPopup("prompt2saveRef",{zIndex:this.zIndex+1});},onPreClose:function(){var e=this;if(e.isDirty&&e.isDirty()){e.prompt2save();return false;}return true;},onClose:function(){this.dirty=false;},init:function(props){var app=mstrApp,useQuickSearch=app&&app.useQuickSearch&&app.useQuickSearch(),delay=useQuickSearch?(app&&app.searchAutoCompleteDelay&&app.searchAutoCompleteDelay()||0):0;this.suggestDelay=delay||200;this.noCache=this.noCache&&useQuickSearch;this.ob.children[0].quickSearch=useQuickSearch;mstrmojo.ME.MetricDataService.suggestDelay=this.suggestDelay;mstrmojo.ME.MetricDataService.noCache=this.noCache;if(this._super){this._super(props);}},_setupCandidatesCache:function(tib){var me=this,MDS=mstrmojo.ME.MetricDataService,INITIAL_COUNT=500;ms=function(res){var its=res&&res.items||[],cds=me.candidates||[];cds.items=cds.items.concat(its);cds.isComplete=cds.isComplete&&(res.bc===-1||(res.bb+res.bc>res.sz));if(tib){tib.candidates=null;tib.set("candidates",cds);}me.candidates=null;me.set("candidates",cds);},success=function(res){if(res){var cds={items:res.items,isComplete:(res.bc===-1||(res.bb+res.bc>res.sz))};if(tib){tib.set("candidates",cds);}me.set("candidates",cds);}MDS.getMetrics({rootFolderType:MDS.rootFolderTypes.ALL,pattern:"*",blockBegin:1,blockCount:INITIAL_COUNT},{success:ms,failure:failure});},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));};if(!this.noCache&&!this.candidates){MDS.getMetricComponents({rootFolderType:MDS.rootFolderTypes.ALL,pattern:"*",blockBegin:1,blockCount:INITIAL_COUNT},{success:success,failure:failure});}}});})();