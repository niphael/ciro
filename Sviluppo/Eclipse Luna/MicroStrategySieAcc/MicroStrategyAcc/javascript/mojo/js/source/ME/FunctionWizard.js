(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo._HasPopup","mstrmojo.Label","mstrmojo.HTMLButton","mstrmojo.ObjectBrowser","mstrmojo.DataGrid","mstrmojo.Editor","mstrmojo.ME._MetricEditorHelper");var _setDirty=function(w){if(w.onmetricModify){w.onmetricModify();}};var _H=mstrmojo.hash,E=mstrmojo.expr,_brackets=mstrmojo.ME.MetricToken.brackets,_DTPBuilder=function(d){var w=null;if(d.isParam){w={scriptClass:"mstrmojo.Table",cssClass:"funcParam",layout:[{cells:[{cssText:"width: 338px"},{}]}],children:[{scriptClass:"mstrmojo.ObjectInputBox",alias:"paramInput",slot:"0,0",useKeyDelay:true,showDesc:true,showPath:true,item2textCss:function item2textCss(data){return mstrmojo.ObjectInputBox.prototype.item2textCss.call(this,data)||{4:"m",12:"a",13:"fc","-99":"br"}[data.t]||"";},hideEditButton:function(d){return d.state===mstrmojo.Enum_OIB_States.VALID;},browsableTypes:[E.TP.FOLDER,E.TP.FACT,E.TP.METRIC,E.TP.ATTR].join(","),browseItemVisible:true,folderLinksContextId:17,dynamicVerify:!!d.dynamicVerify,emptyText:"Type here to input a fact, metric or attribute ...",blockCount:mstrmojo.ME.MetricDataService.blockCount,suggestCount:mstrmojo.ME.MetricDataService.suggestCount,getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params.objectType="4,11,13";params.rootFolderType=39;params.blockCount=this.blockCount;mstrmojo.ME.MetricDataService.getMetricComponents(params,callbacks);},postCreate:function(refresh){var grid=this.parent.dataGrid,fw=grid&&grid.parent;this.noCache=fw.noCache;if(!this.noCache){this.candidates=fw.getCandidates(function(item){return item.t===4||item.t===12||item.t===13;});if(!refresh){grid.candidatesListener.push(this);}}this.set("items",d.items);},onitemchange:function(){_setDirty(this.parent.dataGrid.parent);}},{scriptClass:"mstrmojo.ToolBar",slot:"0,1",cssClass:"mstrmojo-oivmSprite grouped",children:[{scriptClass:"mstrmojo.Button",title:"Browse",iconClass:"tbBrowse",bindings:{enabled:"!this.parent.parent.paramInput.isFull"},onclick:function(){var editor=this.parent.parent.dataGrid.parent;editor.openPopup("ob",{zIndex:editor.zIndex+10});var ob=editor.ob.browser;ob.browse({folderLinksContextId:17,onSelectCB:[this.parent.parent,"onParamAdded"],browsableTypes:[E.TP.FACT,E.TP.METRIC,E.TP.ATTR,E.TP.FOLDER].join(",")});}}]}],onParamAdded:function(oi){var editor=this.dataGrid.parent,input=this.paramInput;editor.closePopup();oi.state=0;input.add([oi],input.items.length-1);_setDirty(editor);},getTokens:function(){var its=this.paramInput.getSelectedObjects(),len=its.length,i,tks=[],t;if(len>0){for(i=0;i<len;i++){if(its[i].state===mstrmojo.Enum_OIB_States.VALID){t={v:_brackets(its[i].n)};t.oi=its[i];}else{t={v:its[i].n};}tks.push(t);tks.push({v:",",isDelimiter:true});}tks.pop();}return tks;}};var piw=w.children[0];if(!d.isRepeated){piw.cssClass="mstrmojo-ObjectInputBox singleObject noVerify";piw.maxObjectCount=1;}else{piw.cssClass="mstrmojo-ObjectInputBox noVerify";}}else{switch(d&&d.dtp){case 11:w={scriptClass:"mstrmojo.Pulldown",cssClass:"mstrmojo-functionArgs-pulldown mstrmojo-Pulldown",items:[{n:"False",did:"0"},{n:"True",did:"-1"}],popupToBody:true,itemIdField:"did",postCreate:function(props){var d=this.data;this.value=!!d.v?(d.v=="False"?0:-1):(d.dfv||0);},getTokens:function(){var d=this.data;if(this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:this.value=="-1"?"True":"False"}];}else{return[];}},onvalueChange:function(){_setDirty(this.parent.dataGrid.parent);}};break;case -2:w={scriptClass:"mstrmojo.Table",cssClass:"breakBy",layout:[{cells:[{cssText:"width: 338px"},{cssClass:"mstrmojo-ME-toolbar"}]}],children:[{scriptClass:"mstrmojo.ObjectInputBox",slot:"0,0",alias:"breakByInput",useKeyDelay:true,showDesc:true,showPath:true,item2textCss:function item2textCss(data){return mstrmojo.ObjectInputBox.prototype.item2textCss.call(this,data)||{12:"a","-99":"br"}[data.t]||"";},emptyText:"Type here to input breakby attributes...",noEditButton:true,browseItemVisible:true,folderLinksContextId:16,browsableTypes:[E.TP.FOLDER,E.TP.ATTR].join(","),blockCount:mstrmojo.ME.MetricDataService.blockCount,suggestCount:mstrmojo.ME.MetricDataService.suggestCount,getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params.rootFolderType=39;params.blockCount=this.blockCount;mstrmojo.ME.MetricDataService.getAttributes(params,callbacks);},postCreate:function(refresh){var grid=this.parent.dataGrid,fw=grid&&grid.parent;this.noCache=fw.noCache;if(!this.noCache){this.candidates=fw.getCandidates(function(item){return item.t===12;});if(!refresh){grid.candidatesListener.push(this);}}this.set("items",d.items);},onitemchange:function(){_setDirty(this.parent.dataGrid.parent);}},{scriptClass:"mstrmojo.ToolBar",slot:"0,1",cssClass:"mstrmojo-oivmSprite grouped",children:[{scriptClass:"mstrmojo.Button",title:"Browse",iconClass:"tbBrowse",onclick:function(){var editor=this.parent.parent.dataGrid.parent;editor.openPopup("ob",{zIndex:editor.zIndex+10});var ob=editor.ob.browser;ob.browse({folderLinksContextId:16,onSelectCB:[this.parent.parent,"onBreakByAdded"],browsableTypes:[E.TP.ATTR,E.TP.FOLDER].join(",")});}}]}],onBreakByAdded:function(oi){var editor=this.dataGrid.parent,input=this.breakByInput;editor.closePopup();input.add([oi],input.items.length-1);_setDirty(editor);},getTokens:function(){var its=this.breakByInput.getSelectedObjects(),len=its.length,i,tks=[];if(len>0){tks.push({v:"BreakBy"});tks.push({v:"=",isDelimiter:true});tks.push({v:"{",isDelimiter:true});for(i=0;i<len;i++){tks.push({v:_brackets(its[i].n),oi:its[i]});if(i!==(len-1)){tks.push({v:",",isDelimiter:true});}}tks.push({v:"}",isDelimiter:true});}return tks;}};break;case -1:var _retrieveDssForms=function(sortByGrid,oi){switch(oi.t){case 12:var success=function(res){if(res){var ctr=res.container;if(ctr&&ctr.dssforms){oi.dssforms=ctr.dssforms;sortByGrid.add([oi]);}}},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));};mstrmojo.ME.MetricDataService.getAttributeForms({attributeID:oi.did,displayedForms:0},{success:success,failure:failure});break;case 4:oi.dssforms=[{n:"Value"}];default:sortByGrid.add([oi]);}};w={scriptClass:"mstrmojo.Table",cssClass:"sortBy",layout:[{cells:[{cssText:"width: 330px"},{cssClass:"mstrmojo-ME-toolbar"}]}],getTokens:function(){var its=this.sortByGrid.items,len=its.length,i,tks=[];if(len>0){tks.push({v:"SortBy"});tks.push({v:"=",isDelimiter:true});tks.push({v:"(",isDelimiter:true});for(i=0;i<len;i++){var it=its[i],sit=it.selFrm||(it.dssforms&&it.dssforms[0]),tk={v:_brackets(it.n),oi:it};if(sit&&it.t==12){_H.copy({v:_brackets(it.n)+"@"+_brackets(sit.n),exv:sit.dssid,extp:8},tk);}tks.push(tk);if(!!it.asc){tks.push({v:"Desc"});}if(i!==(len-1)){tks.push({v:",",isDelimiter:true});}}tks.push({v:")",isDelimiter:true});}return tks;},children:[{scriptClass:"mstrmojo.DataGrid",slot:"0,0",cssClass:"mstrmojo-functionArgs-sort",alias:"sortByGrid",renderOnScroll:false,resizableColumns:true,makeObservable:true,itemDisplayField:"n",columns:[{headerText:"Name",dataField:"n",colCss:"nmCol"},{headerText:"Field",dataField:"field",colCss:"spcCol",dataWidget:{scriptClass:"mstrmojo.Pulldown",bindings:{items:function(){var d=this.data;if(d){this.set("value",d.selFrm);return d.dssforms;}return null;}},popupToBody:true,popupZIndex:100,onvalueChange:function(evt){this.data.selFrm=this.selectedItem;if(this.hasRendered){_setDirty(this.dataGrid.parent.parent.dataGrid.parent);}}}},{headerText:"Order",dataField:"order",colCss:"ordCol",dataWidget:{scriptClass:"mstrmojo.Pulldown",items:[{n:"Ascending",v:0},{n:"Descending",v:1}],itemIdField:"v",popupToBody:true,popupZIndex:100,bindings:{value:function(){return this.data.asc;}},onvalueChange:function(){this.data.asc=this.value;if(this.hasRendered){_setDirty(this.dataGrid.parent.parent.dataGrid.parent);}}}},{dataWidget:{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-ACLEditor-delete",text:"&nbsp",title:mstrmojo.desc(629,"Delete"),onclick:function(evt){this.dataGrid.remove(this.data);_setDirty(this.dataGrid.parent.parent.dataGrid.parent);}},headerText:"&nbsp",colCss:"actionsCol"}],postCreate:function(){var items=d.items;if(items){for(var i=0,len=items.length;i<len;i++){_retrieveDssForms(this,items[i]);}}}},{scriptClass:"mstrmojo.ToolBar",slot:"0,1",cssClass:"mstrmojo-oivmSprite grouped",children:[{scriptClass:"mstrmojo.Button",title:"Browse",iconClass:"tbBrowse",onclick:function(){var editor=this.parent.parent.dataGrid.parent;editor.openPopup("ob",{zIndex:editor.zIndex+10});var ob=editor.ob.browser;ob.browse({folderLinksContextId:16,onSelectCB:[this.parent.parent,"onSortByAdded"],browsableTypes:[E.TP.ATTR,E.TP.METRIC,E.TP.FOLDER].join(",")});}}]}],onSortByAdded:function(oi){var editor=this.dataGrid.parent,sbg=this.sortByGrid;editor.closePopup();if(oi){switch(oi.t){case 12:var success=function(res){if(res){var ctr=res.container;if(ctr&&ctr.dssforms){oi.dssforms=ctr.dssforms;sbg.add([oi]);}}},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));};mstrmojo.ME.MetricDataService.getAttributeForms({attributeID:oi.did,displayedForms:0},{success:success,failure:failure});break;case 4:oi.dssforms=[{n:"Value"}];default:sbg.add([oi]);}}_setDirty(editor);}};break;default:w={scriptClass:"mstrmojo.TextBox",cssClass:"mstrmojo-functionArgs-textInput",postCreate:function(props){var d=this.data;this.value=d.v||((d.dfv||d.dfv===0)?d.dfv:"");},getTokens:function(){var d=this.data;if(!mstrmojo.string.isEmpty(this.value)&&this.value!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:this.value}];}return[];},onvalueChange:function(){_setDirty(this.parent.dataGrid.parent);}};break;}}w.alias="inputWidget";return w;},_PROPFunction=function(d,idx,dataGrid){return'<div class="mstrmojo-DataRow-text"title="'+(d.desc||"")+'">'+d.n+(d.isParam?"*":"")+":</div>";};var _findFunctionDef=function(allFuncsList,funcName){for(var idx=0,len=allFuncsList.length;idx<len;idx++){var fidx=mstrmojo.array.find(allFuncsList[idx].fns,"n",funcName);if(fidx>-1){return _H.clone(allFuncsList[idx].fns[fidx]);}}return null;};var _assignFunctionParsValues=function(pars,parItems){var i=0,len=parItems.length,parCnt=pars&&pars.length;for(;i<parCnt-1;i++){pars[i].items=[parItems[i]];pars[i].dynamicVerify=true;}pars[parCnt-1].items=[];for(i=parCnt-1;i<len;i++){pars[parCnt-1].items.push(parItems[i]);pars[parCnt-1].dynamicVerify=true;}return pars;};var _getBreakbySortby=function(i,tks,tp){var o={items:[]},endChar={301:"}",302:")"}[tp];tk=tks[++i];while(tk){if(tk.oi){if(tp==302){tk.oi.selFrm=tk.exv;tk.oi.asc=tk.asc;}o.items.push(tk.oi);}if((tk=tks[++i])["v"]==endChar){break;}}return o;};mstrmojo.ME.FunctionWizard=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ME._MetricEditorHelper],{scriptClass:"mstrmojo.ME.FunctionWizard",cssClass:"mstrmojo-Editor-me mstrmojo-FunctionWidzard",title:mstrmojo.desc(9582,"Function Editor:"),help:"Function_Arguments_dialog_box.htm",fctOi:null,fctArgs:null,fctSyntax:"",fctDesc:"",bindings:{candidates:"this.opener.candidates"},getCandidates:function getCandidates(f){var cs=this.candidates,its;if(cs){its=mstrmojo.array.filter(cs.items,f);return{items:its,isComplete:cs.isComplete};}return null;},_set_candidates:function(n,v){this.candidates=v;if(this.hasRendered&&this.visible){var grid=this.argsGrid,listeners=grid.candidatesListener,len=listeners.length,i;for(i=0;i<len;i++){listeners[i].postCreate(true);}}return true;},onOpen:function(){this._setupCandidatesCache();var args=this.getArgsFromTokens();var me=this,res=args||this.fctOi;var ps=[],i,len,p,syntax=[];syntax.push(res.n);syntax.push("(");len=res.pars&&res.pars.length||0;for(i=0;i<len;i++){p=_H.copy(res.pars[i]);p.isParam=true;ps.push(p);syntax.push(res.pars[i].n);if(i!=(len-1)){syntax.push(", ");}}syntax.push(")");if(res.rpc>0){p.isRepeated=true;}len=res.pros&&res.pros.length||0;for(i=0;i<len;i++){ps.push(_H.copy(res.pros[i]||{n:"pars",v:"test"}));}if(res.ios){ps.push({n:"Sort By",dtp:-1,desc:"Sort By is a parameter representing the sort by levels for this function.",items:res.sb&&res.sb.items});}if(res.sqt===5){ps.push({n:"Break By",dtp:-2,desc:"Break By is a parameter representing the break by levels for this function.",items:res.bb&&res.bb.items});}me.set("fctArgs",ps);me.set("fctSyntax",syntax.join(""));me.set("fctDesc",res.n+": "+this.fctOi.desc+"  "+mstrmojo.ME.MetricDataService.getFunctionHelpTopic(res.h));me.set("title",this.insertMode?res.n:mstrmojo.desc(9582,"Function Editor:")+" "+this.oi.n);},getArgsFromTokens:function getArgsFromTokens(){if(!this.oi||this.oi.tks.items.length==0){return null;}var args={},tks=this.oi.tks.items,len=tks.length,pars=[],pros=[],proCnt=0,parItems=[];for(var i=0;i<len;i++){var tk=tks[i],tp=tk.tp,sctt=tk.sctt;if(mstrmojo.ME.MetricToken.isDelimiter(tk.v)||tk.v=="&gt;"||tk.v=="&lt;"){continue;}switch(sctt){case 65536:args.n=tk.oi?tk.oi.n:tk.v;var func=this.fctOi=_findFunctionDef(this.functions,args.n);pars=func.pars;pros=func.pros;args.rpc=func.rpc;args.sqt=func.sqt;args.ios=func.ios;break;case 196608:if(tp>=264&&tp<=274){parItems.push(tk.oi);}else{parItems.push({n:tk.v,v:tk.v});}break;case 131072:if(tp==301){var bb={};tk=tks[++i];while(tk){if(tk.tp!=282){if(tk.oi){bb.items=bb.items||[];bb.items.push(tk.oi);}}if((tk=tks[++i])["v"]=="}"){break;}}args.bb=bb;}else{if(tp==302){var sb={};tk=tks[++i];while(tk){if(tk.tp!=282){if(tk.oi){tk.oi.selFrm=tk.exv;var tkOrder=tks[i+1];if(tkOrder.v==="Desc"&&tkOrder.tp==259){tk.oi.asc=1;i++;}sb.items=sb.items||[];sb.items.push(tk.oi);}}if((tk=tks[++i])["v"]==")"){break;}}args.sb=sb;}else{if(tp==259){pros[proCnt++].v=tks[i+2].v;}}}break;}}args.pars=_assignFunctionParsValues(pars,parItems);args.pros=pros;return args;},getTokens:function getTokens(){var rs=this.argsGrid.ctxtBuilder.itemWidgets,len=rs.length,i,w,props=[],params=[],tks=[],a,j,l,anyProp,oi=this.fctOi;for(i=0;i<len;i++){w=rs[i].inputWidget;if(w.data.isParam){params.push(w.getTokens());}else{props.push(w.getTokens());}}tks.push({v:oi.n,oi:oi});len=props.length;if(len>0){anyProp=false;tks.push({v:"<",isDelimiter:true});for(i=0;i<len;i++){a=props[i];l=a.length;if(l===0){continue;}anyProp=true;for(j=0;j<l;j++){tks.push(a[j]);}tks.push({v:",",isDelimiter:true});}tks.pop();if(anyProp){tks.push({v:">",isDelimiter:true});}}len=params.length;tks.push({v:"(",isDelimiter:true});anyProp=false;for(i=0;i<len;i++){a=params[i];l=a.length;if(l===0){continue;}anyProp=true;for(j=0;j<l;j++){tks.push(a[j]);}tks.push({v:",",isDelimiter:true});}if(anyProp){tks.pop();}tks.push({v:")",isDelimiter:true});for(i=0,len=tks.length;i<len;i++){tks[i].isNew=true;}return tks;},getMetricDefAsTokens:function(){return this.getTokens();},handleValidation:function handleValidation(r){var isAmbiguity=r&&r.rjec==="-2147214846";if(isAmbiguity){var its=r.items,ei=mstrmojo.array.find(its,"sta",-1),ambiguousName=its[ei].v;mstrmojo.alert('More than one object with the name "#" found. Browse to select the object or retype to select it from the search autocomplete list.'.replace("#",ambiguousName));}else{mstrmojo.alert(r&&r.rjed);}},children:[{scriptClass:"mstrmojo.HBox",cssText:"color: #999",children:[{scriptClass:"mstrmojo.Label",cssText:"width:100px; padding:5px; text-align:right;",text:mstrmojo.desc(5424,"Function:")},{scriptClass:"mstrmojo.Label",cssText:"margin-left:5px;",bindings:{text:"this.parent.parent.fctSyntax"}}]},{scriptClass:"mstrmojo.DataGrid",alias:"argsGrid",cssClass:"functionArgs",makeObservable:true,banding:false,columns:[{headerText:"Property Name",dataFunction:_PROPFunction,colCss:"name"},{headerText:"Property Type",dataWidgetBuilder:_DTPBuilder,colCss:"dtp"}],postCreate:function(){this.candidatesListener=[];},bindings:{items:function(){return this.parent.fctArgs;}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-FE-functionDesc",slot:"editorNode",text:"",bindings:{text:function(){return this.parent.fctDesc;var title=this.parent.title;var v="",oi=this.parent.fctOi;if(oi&&oi.desc){v=oi.n+": "+oi.desc+"  "+mstrmojo.ME.MetricDataService.getFunctionHelpTopic(oi.h);}return v;}}},mstrmojo.ME._MetricEditorHelper.switchRef,mstrmojo.ME._MetricEditorHelper.buttonBarRef]});})();