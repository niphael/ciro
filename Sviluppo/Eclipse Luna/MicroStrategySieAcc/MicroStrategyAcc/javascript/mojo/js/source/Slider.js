(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.registry","mstrmojo.tooltip");var $D=mstrmojo.dom;var $R=mstrmojo.all;mstrmojo._HasDnD={postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var id=this.id;this.dnd=new mstrmojo._DnDComponent({target:this});this.__mouseDownEvt=function(e){$R[id].dnd.onmousedown(e);return true;};$D.attachEvent(this.dndNode,"mousedown",this.__mouseDownEvt);},unrender:function unrender(){if(this.__mouseDownEvt&&this.dndNode){$D.detachEvent(this.dndNode,"mousedown",this.__mouseDownEvt);}this.min=0;this.max=(this.items&&this.items.length-1)||0;this.dnd&&this.dnd.clearListeners();this._super();}};mstrmojo._DnDComponent=mstrmojo.declare(null,null,{scriptClass:"mstrmojo._DnDComponent",isDragging:null,initD:null,startE:null,afterDragStart:null,duringDrag:null,afterDragEnd:null,target:null,mousemoveBuffer:1,_mousemoveCounter:0,init:function init_DnDComp(props){mstrmojo.hash.copy(props,this);},onmousedown:function onmousedown(e){if(e&&e.preventDefault){e.preventDefault();}if(this.dragging){return true;}var id=this.target.id;if(!this._mousemoveCallback){this._mousemoveCallback=function(e){$R[id].dnd.onmousemove(e);return true;};}this._mousemoveCounter=0;this.startE=mstrmojo.hash.copy(e);$D.attachEvent(document.body,"mousemove",this._mousemoveCallback);if(!this._cancelCallback){this._cancelCallback=function(e){$R[id].dnd.ondragcancel(e);return true;};}$D.attachEvent(document.body,"mouseup",this._cancelCallback);},ondragcancel:function ondragcancel(e){$D.detachEvent(document.body,"mousemove",this._mousemoveCallback);$D.detachEvent(document.body,"mouseup",this._cancelCallback);if(this.afterDragCancel){this.afterDragCancel.apply(this.target,[e]);}},onmousemove:function onmousemove(e){if(this.dragging){return ;}this._mousemoveCounter++;if(this._mousemoveCounter>this.mousemoveBuffer){$D.detachEvent(document.body,"mousemove",this._mousemoveCallback);$D.detachEvent(document.body,"mouseup",this._cancelCallback);this.initDrag(e);}},initDrag:function initDrag(e){this.dragging=true;var id=this.target.id;if(!this._dragCallback){this._dragCallback=function(e){$R[id].dnd.ondrag(e);return true;};}$D.attachEvent(document.body,"mousemove",this._dragCallback);if(!this._dragEndCallback){this._dragEndCallback=function(e){$R[id].dnd.ondragend(e);return true;};}$D.attachEvent(document.body,"mouseup",this._dragEndCallback);if(this.afterDragStart){this.afterDragStart.apply(this.target,[e]);}this._dragCallback(e);},ondrag:function ondrag(e){if(this.duringDrag){this.duringDrag.apply(this.target,[e]);}},ondragend:function ondragend(e){this.dragging=false;$D.detachEvent(document.body,"mousemove",this._dragCallback);$D.detachEvent(document.body,"mouseup",this._dragEndCallback);if(this.afterDragEnd){this.afterDragEnd.apply(this.target,[e]);}},clearListeners:function clearListeners(){if(this._mousemoveCallback){$D.detachEvent(document.body,"mousemove",this._mousemoveCallback);delete this._mousemoveCallback;}if(this._cancelCallback){$D.detachEvent(document.body,"mouseup",this._cancelCallback);delete this._cancelCallback;}if(this._dragCallback){$D.detachEvent(document.body,"mousemove",this._dragCallback);delete this._dragCallback;}if(this._dragEndCallback){$D.detachEvent(document.body,"mouseup",this._dragEndCallback);delete this._dragEndCallback;}}});mstrmojo.requiresCls("mstrmojo.Widget","mstrmojo._HasDnD","mstrmojo._ListSelections");function SingleSlider(sl){this.getUnit=function getUnit(){return sl._effLen/(sl.items.length-1)||1;};this.calcMinMax=function(pxMin,pxMax){var p=Math.round((pxMin/sl.unit+pxMax/sl.unit)/2);return{min:p,max:p};};this.preUpdateThumb=function(){sl.start=Math.min(sl.min*sl.unit,sl._effLen)+"px";sl.sdCssText+=sl.orCfg.posCssP+":"+sl.start+";";};this.updateThumb=function(){sl.containerNode.style[sl.orCfg.posCssP]=sl.start=Math.min(sl.min*sl.unit,sl._effLen)+"px";};}function MultiSlider(sl){this.getUnit=function(){return sl._effLen/sl.items.length;};this.calcMinMax=function(pxMin,pxMax){return{min:Math.floor(pxMin/sl.unit+0.5),max:Math.floor(pxMax/sl.unit-0.5)};};this.preUpdateThumb=function(){sl.start=(sl.min*sl.unit)+"px";sl.length=Math.max(Math.round((sl.max-sl.min+1)*sl.unit-sl.gap),0)+"px";sl.sdCssText+=sl.orCfg.posCssP+":"+sl.start+";"+sl.orCfg.lenCssP+":"+sl.length+";";};this.updateThumb=function(){sl.start=sl.min*sl.unit+"px";sl.containerNode.style[sl.orCfg.posCssP]=(sl.min*sl.unit)+"px";sl.length=Math.max(Math.round((sl.max-sl.min+1)*sl.unit-sl.gap),1)+"px";sl.containerNode.style[sl.orCfg.lenCssP]=sl.length;};}var _tooltipMarkup="<span>{@content}</span>";mstrmojo.Slider=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasDnD,mstrmojo._ListSelections],{scriptClass:"mstrmojo.Slider",markupString:'<div class="mstrmojo-Slider {@cssClass} {@clsType} {@clsOrientation}" style="{@cssText}" ><div class="cont"><div class="bk" style="{@bkCssText}"></div><div class="sdc" style="position:absolute;{@sdcCssText}"><div class="sd" style="{@sdCssText}"><div class="t1"></div><div class="t2"></div><div class="t3"></div></div></div></div></div>',sdCssText:"",cssClass:"sc",clsType:"sc2",clsOrientation:"sc-v",orCfg:null,typeHelper:null,_tooltip_pos:0,useRichTooltip:true,init:function init(p){this._super(p);if(p.isHoriz){this.orCfg={posCssP:"left",marginCssP:"marginLeft",lenCssP:"width",lenP:"clientWidth",opPosCssP:"top",thickP:"clientHeight",offsetP:"x"};this.clsOrientation=" sc-h";this._tooltip_pos=mstrmojo.tooltip.POS_BOTTOMLEFT;}else{this.orCfg={posCssP:"top",marginCssP:"marginTop",lenCssP:"height",lenP:"clientHeight",opPosCssP:"left",thickP:"clientWidth",offsetP:"y"};this._tooltip_pos=mstrmojo.tooltip.POS_TOPRIGHT;}this._exRoom=this.thumbWidth;if(this.multiSelect){this._exRoom*=2;}if(p.multiSelect){this.typeHelper=new MultiSlider(this);}else{this.clsType="sc1";this.typeHelper=new SingleSlider(this);}},markupSlots:{dndNode:function(){return this.domNode.childNodes[0];},bgNode:function(){return this.domNode.childNodes[0].childNodes[0];},sdcNode:function(){return this.domNode.childNodes[0].childNodes[1];},containerNode:function(){return this.domNode.childNodes[0].childNodes[1].childNodes[0];},frontNode:function(){return this.domNode.childNodes[0].childNodes[1].childNodes[0].childNodes[0];},thumbNode:function(){return this.domNode.childNodes[0].childNodes[1].childNodes[0].childNodes[1];},endNode:function(){return this.domNode.childNodes[0].childNodes[1].childNodes[0].childNodes[2];},tooltipNode:function(){return this.domNode.childNodes[0].childNodes[1];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},start:"50px",length:"30px",min:0,max:0,gap:1,ghost:null,thumbWidth:11,cssBkBW:1,preBuildRendering:function preBuildRendering(){var d=this.orCfg.lenCssP,v=this[d],len=parseInt(v);this._effLen=isNaN(len)?0:(len-this._exRoom);if(v){this.bkCssText=d+":"+Math.max(parseInt(v,10)-(2*this.cssBkBW),0)+"px;";this.sdcCssText=d+":"+this._effLen+";"+this.orCfg.posCssP+":"+this._exRoom/2+"px;"+this.orCfg.opPosCssP+":0px;";}var idx=this.selectedIndices;if(!mstrmojo.hash.isEmpty(idx)){this.min=this.items.length-1;this.max=0;for(var i in idx){if(idx[i]){this.min=Math.min(this.min,i);this.max=Math.max(this.max,i);}}}this.unit=this.typeHelper.getUnit();this.typeHelper.preUpdateThumb();},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.items.length>1&&this.dnd){this.dnd.afterDragStart=this.initDrag;this.dnd.duringDrag=this.ondrag;this.dnd.afterDragEnd=this.ondrop;this.dnd.afterDragCancel=this.cancelDrag;}},_initGhost:function _initGhost(){if(!this.ghost){var cn=this.containerNode.cloneNode(true);mstrmojo.css.addClass(cn,["gh"]);this.ghost={containerNode:cn,frontNode:cn.childNodes[0],thumbNode:cn.childNodes[1],endNode:cn.childNodes[2]};this.sdcNode.appendChild(cn);}var gSty=this.ghost.containerNode.style,cnSty=this.containerNode.style,oc=this.orCfg;gSty[oc.posCssP]=cnSty[oc.posCssP];gSty[oc.lenCssP]=cnSty[oc.lenCssP];gSty.display="block";return this.ghost;},initDrag:function initDrag(e,hWin){hWin=hWin||window;var g=this._initGhost(),oc=this.orCfg;this.dnd.initD={tP:parseInt(this.start,10),sL:this._effLen,contL:g.containerNode[oc.lenP],offset:$D.getMousePosition(this.dnd.startE,hWin)[oc.offsetP]};this.dnd.initD.td=$D.eventTarget(hWin,this.dnd.startE);},ondrag:function ondrag(e,hWin){hWin=hWin||window;var initD=this.dnd.initD,g=this.ghost,cn=g.containerNode,minPx,maxPx,lenPx,min=this.min,max=this.max,oc=this.orCfg;var diff=$D.getMousePosition(e,hWin)[oc.offsetP]-initD.offset;switch(initD.td){case this.thumbNode:minPx=Math.max(Math.min(initD.tP+diff,initD.sL-initD.contL),0);maxPx=minPx+initD.contL;cn.style[oc.posCssP]=minPx+"px";var minmax=this.typeHelper.calcMinMax(minPx,maxPx);min=minmax.min;max=minmax.max;break;case this.frontNode:minPx=Math.max(Math.min(initD.tP+diff,initD.tP+initD.contL),0);lenPx=Math.max(Math.min(initD.contL-diff,initD.tP+initD.contL),0);cn.style[oc.posCssP]=minPx+"px";cn.style[oc.lenCssP]=lenPx+"px";min=Math.min(Math.floor(minPx/this.unit+0.5),this.max);break;case this.endNode:lenPx=Math.max(Math.min(initD.contL+diff,initD.sL-initD.tP),0);maxPx=initD.tP+lenPx;cn.style[oc.lenCssP]=lenPx+"px";max=Math.max(Math.floor(maxPx/this.unit-0.5),this.min);break;default:return ;}if(min!==this.min||max!==this.max){this.min=min;this.max=max;this.typeHelper.updateThumb();}this._updateTooltip();},ondrop:function ondrop(e){this.typeHelper.updateThumb();if(this.ghost){this.ghost.containerNode.style.display="none";}this.hideTooltip();if(this.items&&this.items.length){var sel=[];for(var i=this.min;i<=this.max;i++){sel.push(i);}this.select(sel);}this.dnd.initD=null;},cancelDrag:function cancelDrag(e,hWin){if(this.makeSelection){hWin=hWin||window;var td=$D.eventTarget(hWin,this.dnd.startE);this.makeSelection({selItem:td});}},showTooltip:function showTooltip(e,win){this._updateTooltip();this._super(e,win);},hideTooltip:function hideTooltip(e,win){if(this.dnd&&this.dnd.dragging){return ;}this._super(e,win);},_updateTooltip:function _updateTooltip(){var oc=this.orCfg,tt={contentNodeCssClass:"sc-tooltip",refNode:this.domNode,posType:this._tooltip_pos},ref=(this.ghost)?this.ghost.containerNode:this.containerNode;tt[oc.opPosCssP]=0;tt[oc.posCssP]=ref.style[oc.posCssP];if(this.items&&this.items.length){var min=this.getItemTooltip(this.items[this.min]);var txt;if(this.min===this.max){txt=min;}else{txt=mstrmojo.desc(146,"From:")+" '"+min+"' "+mstrmojo.desc(147,"To:")+" '"+this.getItemTooltip(this.items[this.max])+"'";}tt.content=_tooltipMarkup.replace(/\{@content\}/g,txt);}else{tt.content="";}this.set("richTooltip",tt);},getItemTooltip:function(item){return"'"+(item?item.n:"")+"'";},unrender:function unrender(ignoreDOM){this.ghost=null;this.dnd&&(this.dnd.dragging=false);this.hideTooltip();this._super(ignoreDOM);},onselectionChange:function onselChg(evt){if(this.onchange){this.onchange();}if(this.makeSelection&&this.dnd&&this.dnd.initD){this.makeSelection({selItem:this.dnd.initD.td});}}});mstrmojo.Slider.SINGLE_HANDLE_WIDTH=11;mstrmojo.Slider.SCROLLHANDLEWIDTH=11;})();