(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo._CanSupportTransaction","mstrmojo.Box","mstrmojo._Formattable","mstrmojo.PageNavigationPanel","mstrmojo.Label","mstrmojo.Table");var MESSAGE=0,FREEFORM=1,ESSAY=2,RADIO=3,CHECKBOX=4,DROPDOWN=5,SCALE=6,IMAGE_SINGLE_SELECTION=7,IMAGE_MULTI_SELECTION=8,RANKING=9,RATING=10,GROUP=11;var COLOR_SCHEME={1:"gray",2:"black"};var OPTIONAL=0,MANDATORY=1,SOFT_REQUIRED=2;var REGULAR_STYLE=1,CONTINUESSUM_STYLE=2,TABLE_STYLE=3;var $H=mstrmojo.hash,$A=mstrmojo.array,$C=mstrmojo.css;var ATTRIBUTE=1,METRICS=2;function mapVPColumns(dp,vp){var ttls=dp.getRowTitles(),cols=dp.getColHeaders(0),i,len,ttl,uid,cfg={};for(i=0,len=ttls.size();i<len;i++){ttl=ttls.getTitle(i);uid=ttl&&ttl.getUnitId();$H.forEach(vp,function(v,k){if(uid===v){cfg[k]=i;if(k==="sel"){cfg.fid=ttl.getFormId();}return false;}});}if(vp.sel){for(i=0,len=cols.size();i<len;i++){uid=cols.getHeader(i).getObjectId(i);if(uid===vp.sel){cfg.sel=i;cfg.aoa=METRICS;break;}}}return cfg;}function createVls(a,m){var vls=[],i,len;if(a.length===1&&m){for(i=1;i<=m;i++){vls.push({n:i,v:i,o:a[0].o});}}else{for(i=0,len=a.length;i<len;i++){if(a[i]){vls.push({n:a[i].title,v:a[i].value,o:a[i].o});}}}return vls.sort(function(a,b){return a.o-b.o;});}function getExtraProps(q){if(q.type===1){return{placeholderText:(q.required===MANDATORY)?mstrmojo.desc(661,"Required"):""};}else{if(q.type===2){return{placeholderText:mstrmojo.desc(10001,"Click to edit")};}else{if(q.type===6){var ans=q.answers[q.gai||0].sort(function(a,b){return a.value-b.value;});if(ans.length>0){return{mint:ans[0].title,maxt:ans[ans.length-1].title};}}}}return{};}function createAnswers(q){var slot=[],widget=this;$H.forEach(q.answers,function(a,k){var t=q.type,gai=k||0,k=q.id+"."+(k||0),vls=createVls(a),o={2:{t:8,dm:1,vls:vls||[],ipt:1},3:{t:3,dm:1,st:1,stl:1,vls:vls||[],ipr:1,ipt:1,ms:1},4:{t:3,dm:1,st:2,stl:3,vls:vls||[],ipr:1,ipt:1,ms:1},5:{t:3,dm:1,vls:vls||[],ipt:1,ms:1},6:{t:14,dm:1,stl:2,vls:vls||[],ipr:0,ipt:1,ms:1},9:{t:11,dm:1,vls:vls||[],ipt:1,ms:1},10:{t:10,dm:1,vls:createVls(a,5)}}[t]||{t:1,dm:1,wm:0,w:12,ml:256,dt:10},dic=mstrmojo.DICFactory.createDIC($H.copy(getExtraProps(q),{dic:o,k:k,dv:"",value:q.dftAns[gai]||""})),w={scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Answers",children:[dic]};slot.push(w);dic.owner=widget;widget.dics.push({k:k,w:dic,s:q.sid,r:q.required});widget.ko[k]={vls:vls,qtp:t};});return slot;}function createQuestions(q,ignoreNum){var i,j,k,len,size,num,w,qj,row=0,chd=[],ws=[],qw=[],gcols=0;if(!q){return chd;}for(i=0,len=q.length;i<len;i++){var qi=q[i],qTitle=(ignoreNum?"  "+qi.title:(this.qId++)+". "+qi.title),titleConfig={scriptClass:"mstrmojo.Box",children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-QuestionTitle",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SurveyVis-QuestionTitleText",cssDisplay:"inline",text:qTitle},{scriptClass:"mstrmojo.Label",cssClass:"required",cssDisplay:"inline",text:"*",visible:qi.required===MANDATORY}]},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SurveyVis-Description",text:qi.description||""}]};if(qi.type===GROUP){if(qi.groupStyle===TABLE_STYLE){ws=[];gcols=qi.answers[qi.gai].length||0;for(j=0,size=gcols;j<size;j++){ws.push({scriptClass:"mstrmojo.Label",cssClass:"colHeader",slot:"0,"+(j+1),text:qi.answers[qi.gai][j].title});}qw=createQuestions.call(this,qi.group,true);for(j=0,size=qw.length;j<size;j++){qj=qw[j];if(qj&&qj.cssClass==="groupBreak"){continue;}if(qj&&qj.children&&qj.children.length){for(k=0,num=qj.children.length;k<num;k++){w=qj.children[k];w.slot=(j+1)+","+k;if(j==0){w.cssClass+=" topRow";}ws.push(w);}row++;}}chd.push({scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Question",children:[titleConfig].concat({scriptClass:"mstrmojo.Table",cssClass:"mstrmojo-SurveyVis-Group Table",rows:row+1,cols:gcols+1,children:[{scriptClass:"mstrmojo.Label",text:"",slot:"0,0"}].concat(ws)})});}else{chd.push({scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Group Regular",children:[titleConfig].concat(createQuestions.call(this,qi.group,true).concat([{scriptClass:"mstrmojo.Box",cssClass:"groupBreak"}]))});}}else{chd.push({scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Question",children:qi.type===MESSAGE?[titleConfig]:[titleConfig].concat(createAnswers.call(this,qi))});}if(qi.groupBreak){chd.push({scriptClass:"mstrmojo.Box",cssClass:"groupBreak"});}}return chd;}function createSections(s){var subs=s.sections,i,len,chd=[];if(!subs){return chd;}for(i=0,len=subs.length;i<len;i++){chd.push(mstrmojo.insert({scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Section",title:subs[i].title,children:createQuestions.call(this,subs[i].questions)}));}return chd;}function answerSelected(v){return parseInt(v,10)>0||!!v;}function convertToSurveyJSON(dp,scfg){var s={},sec=-1,seco,qgrp,parent_qgrp,qst=-1,qsto,ans=-1,anso,qn=0,last_qn=0,gai=0,i,len,n,nq=true,rhs,rh,cell;for(i=0,len=dp.getTotalRows();i<len;i++){rhs=dp.getRowHeaders(i);if(scfg.t&&scfg.t!==-1&&!s.title){s.title=rhs.getHeader(scfg.t).getName();}else{if(s.title===undefined){s.title="";}}if(scfg.sid&&scfg.sid!==-1){if(!s.sections){s.sections=[];}n=parseInt(rhs.getHeader(scfg.sid).getName(),10);if(sec!==n){sec=n;seco={questions:[]};s.sections.push(seco);if(scfg.st&&scfg.st!==-1){seco.title=rhs.getHeader(scfg.st).getName();}qgrp=seco.questions;parent_qgrp=null;}}else{if(!s.questions){qgrp=s.questions=[];}}if(scfg.qid&&scfg.qid!==-1&&qgrp){if(scfg.qn&&scfg.qn!==-1){qn=parseInt(rhs.getHeader(scfg.qn).getName(),10);}else{qn++;}n=parseInt(rhs.getHeader(scfg.qid).getName(),10);if(qst!==n){nq=true;qst=n;qsto={required:0,type:1,answers:{},sid:sec};qsto.id=n;if(scfg.qt&&scfg.qt!=-1){qsto.title=rhs.getHeader(scfg.qt).getName();}else{if(qsto.title===undefined){qsto.title="";}}if(scfg.qd&&scfg.qd!=-1){qsto.description=rhs.getHeader(scfg.qd).getName();}else{if(qsto.description===undefined){qsto.description="";}}if(scfg.rq&&scfg.rq!=-1){qsto.required=parseInt(rhs.getHeader(scfg.rq).getName(),10)||0;}if(scfg.ran&&scfg.ran!=-1){qsto.randomize=rhs.getHeader(scfg.ran).getName();}if(scfg.qtp&&scfg.qtp!=-1){qsto.type=parseInt(rhs.getHeader(scfg.qtp).getName(),10)||0;}qsto.qn=qn;if(scfg.gai&&scfg.gai!=-1){qsto.gai=parseInt(rhs.getHeader(scfg.gai).getName(),10)||0;}if(scfg.gb&&scfg.gb!==-1){qsto.groupBreak=parseInt(rhs.getHeader(scfg.gb).getName(),10)||0;}if(last_qn!==qn){if(parent_qgrp){qgrp=parent_qgrp;parent_qgrp=null;}qgrp.push(qsto);if(qsto.type===GROUP){qsto.group=[];if(scfg.gs&&scfg.gs!==-1){qsto.groupStyle=parseInt(rhs.getHeader(scfg.gs).getName(),10);}parent_qgrp=qgrp;qgrp=qsto.group;}last_qn=qn;}else{qgrp.push(qsto);}}else{nq=false;}}if(scfg.aid&&scfg.aid!=-1&&qsto){if(scfg.gai&&scfg.gai!=-1){gai=parseInt(rhs.getHeader(scfg.gai).getName(),10)||0;}n=parseInt(rhs.getHeader(scfg.aid).getName(),10);if(ans!==n||gai!==qsto.gai||nq){var a={};ans=n;if(scfg.aid&&scfg.aid!==-1){a.id=parseInt(rhs.getHeader(scfg.aid).getName(),10)||0;}if(scfg.at&&scfg.at!==-1){a.title=rhs.getHeader(scfg.at).getName();}else{if(a.title===undefined){a.title="";}}if(scfg.av&&scfg.av!==-1){a.value=rhs.getHeader(scfg.av).getName();}if(scfg.ao&&scfg.ao!==-1){a.order=parseInt(rhs.getHeader(scfg.ao).getName(),10)||0;}a.o=i;if(!qsto.answers[gai]){qsto.answers[gai]=[];}if(!qsto.dftAns){qsto.dftAns={};}if(scfg.sel>-1&&scfg.aoa===METRICS){var mv=dp.getMetricValue(i,scfg.sel),dftv=mv&&mv.getValue(),ansSel=answerSelected(dftv);if(qsto.type===FREEFORM||qsto.type===ESSAY){qsto.dftAns[gai]=dftv;}else{if((qsto.type===RADIO||qsto.type===DROPDOWN||qsto.type===SCALE||qsto.type===RATING)&&ansSel){qsto.dftAns[gai]=a.value;}else{if(qsto.type===CHECKBOX&&ansSel){qsto.dftAns[gai]=!qsto.dftAns[gai]?a.value:qsto.dftAns[gai]+","+a.value;}}}}qsto.answers[gai].push(a);}}}return s;}function getCellChange(ci,o,v){var change;if(ci.isMetrics){change='<cli cordinal="'+ci.writeBackCol+'" metric_id="'+ci.writeBackId+'"><updt types="2" rordinal="'+o+'" value="'+mstrmojo.string.encodeXMLAttribute(String(v))+'" dt="9"/></cli>';}else{change='<cli ax="1" attribute_id="'+ci.writeBackId+'" form_id="'+ci.writeBackFid+'"><updt types="1" ordinal="'+o+'" value="'+mstrmojo.string.encodeXMLAttribute(String(v))+'" dt="9"/></cli>';}return change;}mstrmojo.SurveyVis=mstrmojo.declare(mstrmojo.Vis,[mstrmojo._Formattable,mstrmojo._CanSupportTransaction],{scriptClass:"mstrmojo.SurveyVis",markupString:'<div class="{@className} mstrmojo-SurveyVis" style="{@domNodeCssText}"><div class="body"></div></div>',markupSlots:{containerNode:function(){return this.domNode.lastChild;}},formatHandlers:{domNode:["RW"]},ko:null,dics:null,qId:1,update:function update(node){this._super(node);var dp=this.getDataParser(),vp=this.model.vp,scfg=mapVPColumns(dp,vp),d=convertToSurveyJSON(dp,scfg);this.ko={};this.dics=[];this.sec=parseInt(vp.sec,10)>0;this.qId=1;this.stv=parseInt(vp.suvt,10)>0;if(this.sec){this.set("children",[{scriptClass:"mstrmojo.PageNavigationPanel",title:d.title,cssClass:"compact "+(COLOR_SCHEME[vp.cs]||""),headerVisible:this.stv,alias:"pageNav",prevText:"",nextText:"",panels:createSections.call(this,d)}]);}else{if(this.stv){this.set("children",[{scriptClass:"mstrmojo.Box",alias:"pageNav",cssClass:"mstrmojo-PageNavPanel compact "+(COLOR_SCHEME[vp.cs]||""),onheightChange:function(){if(this.height){this.content.domNode.style.height=(parseInt(this.height,10)-this.header.domNode.offsetHeight)+"px";}},children:[{scriptClass:"mstrmojo.Box",cssClass:"header",alias:"header",children:[{scriptClass:"mstrmojo.Label",cssClass:"title",text:d.title}]},{scriptClass:"mstrmojo.Box",cssClass:"content end",alias:"content",children:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SurveyVis-Section",children:createQuestions.call(this,d.questions)}]}]}]);}else{this.set("children",createQuestions.call(this,d.questions));}}this.cellInfo={writeBackId:vp.sel,writeBackCol:scfg.sel,writeBackFid:scfg.fid,isMetrics:!!scfg.aoa};},setModel:function setModel(model){this.set("model",model);this.txModel=model&&model.docModel;},getKeyContext:function getKeyContext(k){return this.ko[k];},getUpdateObject:function getUpdateObject(){},postBuildRendering:function postBuildRendering(){this._super();if(this.height){if(this.pageNav){this.pageNav.set("height",this.height);}else{this.containerNode.style.maxHeight=this.height||"";this.containerNode.style.overflow="auto";}}},checkRequiredObjects:function checkRequiredObjects(){var dks=this.dics,valid=true;$A.forEach(dks,function(dico){if(dico.r===MANDATORY&&dico.mdf!==1){valid=false;$C.addClass(dico.w.domNode,"required");}});return valid;},updateValue:function updateValue(k,vo){if(this._super){this._super(k,vo);}var dks=this.dics,idx=$A.find(dks,"k",k);if(idx>-1){dks[idx].mdf=1;$C.removeClass(dks[idx].w.domNode,"required");}},editNext:function editNext(k){var dks=this.dics,idx,wo,w,sid;idx=$A.find(dks,"k",k);wo=this.dics[idx];sid=wo&&wo.s;if(idx!==-1&&idx<dks.length-1){wo=this.dics[idx+1];w=wo&&wo.w;if(wo&&(wo.s===sid)&&w&&w.focus){w.focus();}}},getUpdates:function getUpdates(){var eg=[],mr=[],w=this,vs,ord=0,idx,o,i,j,udt=false,udvs=this.getUpdatedValues(),udv,ci=this.cellInfo;eg.push('<gr rw_tree_type="'+this.defn.tt+'" rw_node_key="'+w.k+'" slice_id="'+(w.sid||0)+'">');for(j in udvs){if(udvs.hasOwnProperty(j)){udv=udvs[j];if(udv.qtp===FREEFORM||udv.qtp===ESSAY||(udv.qtp===RATING&&udv.vls.length===1)){o=udv.vls[0].o;eg.push(getCellChange(ci,o,udv.v));mr.push('<mark rordinal="'+o+'" types="4"/>');}else{if(udv.qtp===RANKING){vs=udv.v.split(",");ord=0;$A.forEach(vs,function(v){idx=$A.find(udv.vls,"v",v)||0;o=udv.vls[idx].o;ord++;eg.push(getCellChange(ci,o,ord));mr.push('<mark rordinal="'+o+'" types="4"/>');});}else{if(udv.qtp===CHECKBOX){vs=udv.v.split(",");$A.forEach(vs,function(v){idx=$A.find(udv.vls,"v",v)||0;o=udv.vls[idx].o;eg.push(getCellChange(ci,o,v));mr.push('<mark rordinal="'+o+'" types="4"/>');});}else{idx=$A.find(udv.vls,"v",udv.v)||0;o=udv.vls[idx].o;eg.push(getCellChange(ci,o,udv.v));mr.push('<mark rordinal="'+o+'" types="4"/>');}}}udt=true;}}eg.push(mr.join(""));eg.push("</gr>");if(!udt){eg=[];}return eg.join("");}});}());