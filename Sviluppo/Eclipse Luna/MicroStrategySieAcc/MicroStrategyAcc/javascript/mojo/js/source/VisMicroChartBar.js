(function(){mstrmojo.requiresCls("mstrmojo.VisChart");var DEFAULT_DARK_THEME=1;var DEFAULT_LIGHT_THEME=2;var CUSTOM_DARK_THEME=3;var CUSTOM_LIGHT_THEME=4;mstrmojo.VisMicroChartBar=mstrmojo.declare(mstrmojo.VisChart,null,{scriptClass:"mstrmojo.VisMicroChartBar",isDrawAxis:false,margin:{t:0,r:1,b:0,l:1},showHighlightLine:false,themeColor:"#FFFFFF",noBackground:true,isAnimateLines:false,toolTipMain:null,labelLen:0,mainWidth:0,mainLeftPos:0,markupString:'<div id="{@id}" class="mstrmojo-Chart {@cssClass}" style="width:{@width};height:{@height};top:{@top};left:{@left};position:relative;"  mstrAttach:mousedown,mouseup,mousemove,click ><canvas width="{@width}" height="{@height}"></canvas><canvas style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas><canvas style="position:absolute;left:0;top:0" width="{@width}" height="{@height}"></canvas><div style="position:absolute;left:0px;top:0px;padding-left:1px;padding-top:1px;text-align:left;-webkit-text-size-adjust: none"></div><div style="position:absolute;left:0px;bottom:0px;padding-left:1px;padding-bottom:1px;text-align:left;-webkit-text-size-adjust: none"></div></div>',markupSlots:{canvas:function(){return this.domNode.firstChild;},animationCanvas:function(){return this.domNode.childNodes[1];},highlightCanvas:function(){return this.domNode.childNodes[2];},minLabel:function(){return this.domNode.childNodes[3];},maxLabel:function(){return this.domNode.childNodes[4];}},postBuildRendering:function postBR(){if(this._super){this._super();}this.windowSize=this.model.series[0].rv.length;if(this.windowSize===1){this.plot();}},getTouchValue:function gtvlindx(touchX){var series=this.model.series[0];var ind=0;for(var i=0;i<series.v.length;i++){if(touchX<this.hightLightPos[i].x){if(i===0){ind=i;}else{ind=(this.hightLightPos[i].x+this.hightLightPos[i-1].x)/2>touchX?(i-1):i;}break;}}if(i!==series.v.length){}else{ind=i-1;}return ind;},isTouchPointInGraphRange:function tpInGR(touchX,touchY){if(touchX<=this.labelLen+1||touchX>=this.getWidth()-1){return false;}return true;},showTooltip:function rndrttp(pageX,pageY){if(!this.config.mbShowTooltip||this.noDataToShowTtp){return false;}var m=this.model,series=m.series[0];if(series.rv.length<=1){return false;}var pos=mstrmojo.dom.position(this.domNode,true);var touchX=pageX-pos.x;var touchY=pageY-pos.y;if(!this.isTouchPointInGraphRange(touchX,touchY)){return false;}var touchVal=this.getTouchValue(touchX,touchY);var x=this.hightLightPos[touchVal].x;if(this.widget.enableSmoothScroll){if(this.domNode.offsetLeft+x<this.widget._scroller.origin.x){return false;}}this.prevHighlight=this.currentHighlight;this.currentHighlight=touchVal;if(!this.widget.tooltipShow||this.prevHighlight!=this.currentHighlight){touchX=Math.round(this.hightLightPos[touchVal].x);touchY=Math.round(this.hightLightPos[touchVal].y);var vl=series.rv[touchVal]*1;var tColor=this.posBarColor;if(vl<0){tColor=this.negBarColor;}if(series.thClr&&series.thClr[touchVal]){tColor=series.thClr[touchVal];}this.renderTooltip(touchVal,x,touchY,tColor);this.highlightPoint(touchX,touchY,tColor);}return true;},renderTooltip:function rndrttp(valIndex,touchX,touchY,tColor){var model=this.model;var barProps=this.config;var series=model.series[0],categories=model.categories.items,width=this.getWidth();var metrics=model.mtrcs;metrics=metrics.items;var ttp=this.toolTipMain;var line1=model.categories.tn+": "+categories[valIndex];if(isNaN(this.kpiOffset)){this.kpiOffset=0;}if(
/*this.widget.isKPI && */
this.widget.sparklineProps.mstrAssMetric){line2=this.widget.sparklineProps.mstrAssMetric+": "+series.v[valIndex];}else{line2=metrics[this.kpiOffset]+": "+series.v[valIndex];}var maxLength=this.widget.getTextWidthByCanvas(line1,ttp);var leng2=this.widget.getTextWidthByCanvas(line2,ttp);if(leng2>maxLength){maxLength=leng2;}var domHtml=line1+"<br/>"+line2;if(this.refv&&this.refv.length>1&&this.config.mbRefLine){domHtml+="<br/>";var line3=metrics[this.kpiOffset+1]+": "+this.refv[1].v;var leng3=this.widget.getTextWidthByCanvas(line3,ttp);if(leng3>maxLength){maxLength=leng3;}domHtml+=line3;}ttp.innerHTML='<div style="margin-left:5px;margin-bottom:4px;margin-top:5px;">'+domHtml+"</div>";var pos=mstrmojo.dom.position(this.domNode,true);var posWdt=mstrmojo.dom.position(this.widget.domNode,true);var oft={left:pos.x-posWdt.x,top:pos.y-posWdt.y};var maxWidth=maxLength+10;ttp.style.display="block";ttp.style.borderColor=tColor;ttp.style.width=maxWidth+"px";var topOff=(touchY+pos.y-posWdt.y-ttp.offsetHeight-29);if(topOff<0){topOff=0;}var leftOff=(oft.left+touchX+maxWidth+20);if(leftOff>this.widget.getWidth()){leftOff=(touchX+oft.left-maxWidth-20);if(leftOff<0){leftOff=0;}}else{leftOff-=maxWidth;}ttp.style.display="none";ttp.style.top=(topOff)+"px";ttp.style.left=(leftOff)+"px";ttp.style.display="block";},highlightPoint:function highlightPoint(touchX,touchY,tColor){var ctx=this.highlightContext,width=this.getWidth(),height=this.getHeight(),utils=this.utils;ctx.clearRect(0,0,width,height);ctx.globalAlpha=1;touchX=touchX>5?touchX:5;if(touchX>width-5){touchX=width-5;}touchY=touchY>5?touchY:5;if(touchY>height-5){touchY=height-5;}ctx.globalAlpha=0.8;ctx.strokeStyle="FFFFFF";ctx.fillStyle=ctx.strokeStyle;utils.drawArc(this,touchX,touchY,5,0,Math.PI*2,true,true,ctx);ctx.strokeStyle=tColor;ctx.fillStyle=ctx.strokeStyle;ctx.globalAlpha=1;utils.drawArc(this,touchX,touchY,5,0,Math.PI*2,true,false,ctx);utils.drawArc(this,touchX,touchY,2.5,0,Math.PI*2,true,true,ctx);this.highlightCanvas.id="highLightCav"+this.widget.domNode.id;},textLen:function txtLn(str){var len=0;for(var i=0;i<str.length;i++){if(str.charCodeAt(i)>255||str.charCodeAt(i<0)){len+=2;}else{len++;}}return len;},handleTouchMove:function(){},reDrawChart:function reDrwchart(){var context=this.context,canvas=this.canvas,wd=canvas.width,ht=canvas.height;context.clearRect(0,0,wd,ht);this.data.processLinearData(this);this.windowSize=this.model.series[0].rv.length;this.utils.fillBackground(this);if(this.windowSize<1){return ;}this.drawChart();},setColorByTheme:function setColorByTheme(){var barProps=this.config;if(this.theme==DEFAULT_DARK_THEME||this.theme==DEFAULT_LIGHT_THEME){this.posBarColor="#598200";this.negBarColor="#CC3A06";this.xAxisLineWidth=1;this.xAxisLineColor="#7F7F7F";this.refLineWidth=1;this.refLineColor="#00A6EF";}else{this.posBarColor=barProps.mwPosCol;this.negBarColor=barProps.mwNegCol;this.xAxisLineWidth=1;this.xAxisLineColor="#000000";this.refLineWidth=1;this.refLineColor=barProps.mwRefLineCol;}},drawChart:function drwchrt(){var model=this.model;var barProps=this.config;if(model.err){this.noDataToShowTtp=true;return ;}this.setColorByTheme();var context=this.context,values=model.series,height=this.getHeight(),width=this.getWidth(),me=this,utils=this.utils;var barOffset=0;var barPadLeft=this.margin.l;var barPadRight=this.margin.r;var min=0,max=0,minLabel=maxLabel="",series=model.series[0];for(var i=0;i<series.v.length;i++){var vl=parseFloat(series.rv[i]);if(i===0){max=min=vl;minLabel=maxLabel=series.v[i];}else{if(vl>max){max=vl;maxLabel=series.v[i];}else{if(vl<min){min=vl;minLabel=series.v[i];}}}}if(isNaN(min)&&isNaN(max)){this.minLabel.innerHTML="";this.maxLabel.innerHTML="";this.noDataToShowTtp=true;return ;}this.noDataToShowTtp=false;if(barProps.mbShowLegend){var fontSize=Math.ceil(Math.min(12,(height/2)*0.7));var mintxt="Min:"+minLabel.replace(/[ ]/g,"");var maxtxt="Max:"+maxLabel.replace(/[ ]/g,"");this.minLabel.innerHTML=mintxt;this.maxLabel.innerHTML=maxtxt;var maxBarOffset=width-10;if(maxBarOffset>width*0.5){maxBarOffset=Math.floor(width*0.5);}do{this.minLabel.style.fontSize=fontSize+"px";this.maxLabel.style.fontSize=fontSize+"px";var fontFamily="Arial";var minTxtLen=this.widget.getTextWidth(mintxt,"",fontFamily,fontSize,"px",this.isTextBold);var maxTxtLen=this.widget.getTextWidth(maxtxt,"",fontFamily,fontSize,"px",this.isTextBold);var txtLen=minTxtLen>maxTxtLen?minTxtLen:maxTxtLen;barOffset=txtLen+barPadLeft;fontSize-=1;}while(barOffset>maxBarOffset&&fontSize>5);fontSize+=1;}else{barOffset=barPadLeft;}this.labelLen=barOffset;if(this.refv&&this.refv.length>1&&barProps.mbRefLine){var refValue=this.refv[1].rv*1;if(refValue<min){min=refValue;}if(refValue>max){max=refValue;}}var ts=max-min;var baseY=0;var barPadTop=5;var barPadBottom=5;var rangeRatio=height-barPadTop-barPadBottom;if(ts==0){if(min==0){baseY=height/2;rangeRatio=0;}else{rangeRatio/=Math.abs(max);if(max<0){baseY=barPadTop;}else{baseY=height-barPadBottom;}}}else{if(max<0){baseY=barPadTop;rangeRatio/=Math.abs(min);}else{if(min<0){baseY=max/ts*rangeRatio+barPadTop;rangeRatio/=ts;}else{baseY=height-barPadBottom;rangeRatio/=max;}}}var barTotalWidth=width-barOffset-barPadRight;var barCount=series.v.length;var barSpaceWidth=barTotalWidth*0.4/barCount;barSpaceWidth=barSpaceWidth>=1?barSpaceWidth:1;var barWidth=barTotalWidth/barCount-barSpaceWidth;this.hightLightPos=[];for(var i=0;i<barCount;i++){this.hightLightPos[i]={};var vl=series.rv[i]*1;var direct=true;if(vl<0){vl=0-vl;direct=false;}var hgt=vl*rangeRatio;var cw=(width-barOffset)/series.v.length;this.drawBar(barOffset+(barWidth+barSpaceWidth)*i+barSpaceWidth/2,baseY,barWidth,hgt,context,series.thClr&&series.thClr[i],direct,this.hightLightPos[i]);}context.strokeStyle=this.xAxisLineColor;context.lineWidth=this.xAxisLineWidth;if(context.lineWidth%2===1){baseY=Math.round(baseY+0.5)-0.5;}context.beginPath();context.moveTo(barOffset,baseY);context.lineTo(width-barPadRight,baseY);context.stroke();if(this.refv&&this.refv.length>1&&barProps.mbRefLine){var refValue=this.refv[1].rv*1;var refH=baseY-refValue*rangeRatio;if(context.lineWidth%2===1){refH=Math.round(refH+0.5)-0.5;}context.beginPath();context.moveTo(barOffset,refH);context.lineTo(width-barPadRight,refH);context.strokeStyle=this.refLineColor;context.stroke();}},drawBar:function drwBr(x,y,width,height,context,color,direct,posStore){if(width>=3){x=Math.round(x);y=Math.round(y);width=Math.round(width);}if(height!=0){height=Math.round(height);if(height<1){height=1;}}if(direct){context.fillStyle=color?color:this.posBarColor;context.fillRect(x,y-height,width,height);posStore.x=x+Math.round(width/2);posStore.y=y-height;}else{context.fillStyle=color?color:this.negBarColor;context.fillRect(x,y,width,height);posStore.x=x+Math.round(width/2);posStore.y=y+height;}}});})();