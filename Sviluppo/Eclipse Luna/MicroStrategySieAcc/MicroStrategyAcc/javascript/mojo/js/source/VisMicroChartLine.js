(function(){mstrmojo.requiresCls("mstrmojo.VisChart");var DEFAULT_DARK_THEME=1;var DEFAULT_LIGHT_THEME=2;var CUSTOM_DARK_THEME=3;var CUSTOM_LIGHT_THEME=4;mstrmojo.VisMicroChartLine=mstrmojo.declare(mstrmojo.VisChart,null,{scriptClass:"mstrmojo.VisMicroChartLine",isDrawAxis:false,margin:{t:5,r:2,b:1,l:2},showHighlightLine:false,themeColor:"#FFFFFF",isDrawRefArea:true,noBackground:true,isAnimateLines:false,toolTipMain:null,mainWidth:0,mainLeftPos:0,reDrawChart:function reDrwchart(){var context=this.context,canvas=this.canvas,wd=canvas.width,ht=canvas.height;context.clearRect(0,0,wd,ht);this.data.processLinearData(this);this.windowSize=this.model.series[0].rv.length;this.utils.fillBackground(this);if(this.windowSize<=1){return ;}this.drawChart();},setColorByTheme:function setColorByTheme(){var lineProps=this.config;if(this.theme===DEFAULT_DARK_THEME||this.theme===DEFAULT_LIGHT_THEME){this.startPointColor="#50B5D8";this.endPointColor="#50B5D8";this.otherPointColor="#50B5D8";this.isDrawRefArea=false;this.sparkLineColor="#50B5D8";this.refLineColor="#FF781D";}else{this.startPointColor="#000000";this.endPointColor="#FF0000";this.otherPointColor="#663300";this.isDrawRefArea=lineProps.mbRefArea;this.sparkLineColor=lineProps.mwSeriesLineCol;this.refLineColor=lineProps.mwRefLineCol;}var dpi=mstrMobileApp.getDeviceDPI();this.sparkLineWidth=dpi>160?2:1;this.refLineWidth=1;this.startEndPointRadius=dpi>=320?4:dpi>=240?3:2;},drawChart:function drwchrt(){this.setColorByTheme();var lineProps=this.config;var context=this.context;var model=this.model;var values=model.series;var mvalues=model.mvalues;var margin=this.margin;var height=this.getHeight();var width=this.getWidth();var utils=this.utils;var maxVR=mvalues[mvalues.length-1];var minVR=mvalues[0];var maxYValue=mvalues[mvalues.length-1];var minYValue=mvalues[0];if(this.refv&&this.refv.length>1&&lineProps.mbRefLine){var refValue=parseFloat(this.refv[1].rv);if(isNaN(refValue)){}else{if(refValue>maxVR){maxVR=refValue;if(mvalues.length===1){mvalues[1]=maxVR;}else{mvalues[mvalues.length-1]=maxVR;}}if(refValue<minVR){minVR=refValue;if(mvalues.length===1){mvalues[1]=mvalues[0];mvalues[0]=maxVR;}else{mvalues[0]=minVR;}}}}this.themeColor=lineProps.mwRefAreaCol;this.isDrawStartEndPoints=lineProps.mbAllPoints?7:(lineProps.mbEndPoints?3:0);if(this.isDrawStartEndPoints&1&&margin.l<this.startEndPointRadius){margin.l=this.startEndPointRadius;}if(this.isDrawStartEndPoints&2&&margin.r<this.startEndPointRadius){margin.r=this.startEndPointRadius-1;}if(model.err){return ;}if(!values){return ;}if(maxVR!==minVR){this.RTY=(height-margin.t-margin.b-4)/(maxVR-minVR);}else{this.RTY=0;}if(this.windowSize!==1){this.RTX=(width-margin.l-margin.r-1)/(this.windowSize-1);}else{this.RTX=0;}var lines=[];var k=0;for(var i=0;i<this.windowSize;i++){var val=values[0].rv[i];if(val.length===0){continue;}var x=(i*this.RTX)+margin.l;var y=utils.getYValue(this,val);lines[k]={x:x,y:y};k++;}if(lines.length===0){return ;}maxYValue=utils.getYValue(this,maxYValue);minYValue=utils.getYValue(this,minYValue);if(maxYValue===undefined||minYValue===undefined){maxYValue=height-4-margin.b;minYValue=margin.t;}if(this.isDrawRefArea){context.fillStyle=this.themeColor;context.fillRect(margin.l,minYValue,width-margin.r-margin.l,(maxYValue-minYValue));}context.lineCap="round";context.lineWidth=this.sparkLineWidth;context.lineJoin="round";context.strokeStyle=this.sparkLineColor;utils.drawLineSet(this,lines,false,context);if(this.isDrawStartEndPoints){utils.drawStartEndPoints(this,lines,context,this.isDrawStartEndPoints);}if(this.refv&&this.refv.length>1&&lineProps.mbRefLine){var refValue=this.refv[1].rv*1;var y=this.utils.getYValue(this,refValue);if(isNaN(y)){y=height-5;}if(context.lineWidth%2===1){y=Math.round(y+0.5)-0.5;}context.beginPath();context.moveTo(margin.l,y);context.lineTo(width-margin.r,y);context.lineWidth=this.refLineWidth;context.strokeStyle=this.refLineColor;context.stroke();}},highlightPoint:function hghlghtpnt(x,touchY){var me=this,ctx=me.highlightContext,height=me.getHeight(),width=me.getWidth(),margin=me.margin,model=me.model,utils=me.utils;ctx.clearRect(0,0,width,height);if(x<0){return ;}var xcoord=(x*me.RTX)+margin.l;ctx.globalAlpha=1;ctx.strokeStyle=this.sparkLineColor;ctx.fillStyle=ctx.strokeStyle;var y=utils.getYValue(me,model.series[0].rv[x]);if(xcoord<5){xcoord=5;}if(xcoord>width-5){xcoord=width-5;}if(y<5){y=5;}if(y>height-5){y=height-5;}ctx.strokeStyle="FFFFFF";ctx.fillStyle=ctx.strokeStyle;ctx.globalAlpha=0.8;utils.drawArc(this,xcoord,y,5,0,Math.PI*2,true,true,ctx);ctx.strokeStyle=this.sparkLineColor;ctx.fillStyle=ctx.strokeStyle;ctx.globalAlpha=1;utils.drawArc(me,xcoord,y,5,0,Math.PI*2,true,false,ctx);utils.drawArc(me,xcoord,y,2.5,0,Math.PI*2,true,true,ctx);this.highlightCanvas.id="highLightCav"+this.widget.domNode.id;},renderTooltip:function rndrttp(valIndex,touchX,touchY){if(valIndex<0){this.toolTipMain.style.display="none";return ;}var highLightCav=document.getElementById("highLightCav"+this.widget.domNode.id);if(highLightCav){var highlightCt=highLightCav.getContext("2d");highLightCav.id="";highlightCt.clearRect(0,0,1000,1000);}var m=this.model,s=m.series,utils=this.utils,l=s.length,si=this.seriesIndex,ch=m.colHeaders,rh=this.baseModel.rowHeaders,ttp=this.toolTipMain;var me=this,ctx=me.highlightContext,height=me.getHeight(),width=me.getWidth(),margin=me.margin,utils=me.utils;var metrics=m.mtrcs;metrics=metrics.items;if(isNaN(this.kpiOffset)){this.kpiOffset=0;}var sn="";var line1=m.categories.tn+": "+m.categories.items[valIndex];var line2;if(
/*this.widget.isKPI &&*/
this.widget.sparklineProps.mstrAssMetric){line2=this.widget.sparklineProps.mstrAssMetric+": "+s[0].v[valIndex];}else{line2=metrics[this.kpiOffset]+": "+s[0].v[valIndex];}var relx=(valIndex*me.RTX)+margin.l;var rely=utils.getYValue(me,s[0].rv[valIndex]);var leng1=this.widget.getTextWidthByCanvas(line1,ttp);var leng2=this.widget.getTextWidthByCanvas(line2,ttp);var domHtml=line1+"<br/>"+line2;var leng3=0;if(this.refv&&this.refv.length>1&&this.config.mbRefLine){domHtml+="<br/>";var line3=metrics[this.kpiOffset+1]+": "+this.refv[1].v;leng3=this.widget.getTextWidthByCanvas(line3,ttp);domHtml+=line3;}ttp.innerHTML='<div style="margin-left:5px;margin-bottom:4px;margin-top:5px;">'+domHtml+"</div>";var maxLength=Math.max(leng1,leng2,leng3);var oft=mstrmojo.boxmodel.offset(this.domNode,this.widget.domNode);var pos=mstrmojo.dom.position(this.domNode,true);var posWdt=mstrmojo.dom.position(this.widget.domNode,true);var maxWidth=maxLength+10;ttp.style.display="block";ttp.style.borderColor=this.sparkLineColor;ttp.style.width=maxWidth+"px";var topOff=(rely+pos.y-posWdt.y-ttp.offsetHeight-29);if(topOff<0){topOff=0;}var leftOff=(oft.left+relx+maxWidth+20);if(leftOff>this.widget.getWidth()){leftOff=(relx+oft.left-maxWidth-20);if(leftOff<0){leftOff=0;}}else{leftOff-=maxWidth;}ttp.style.top=topOff+"px";ttp.style.left=leftOff+"px";var yadjust=this.mainOffsetTop===0?ttp.offsetHeight+20:(2*ttp.offsetHeight)+30;var yPos=utils.getYValue(this,s[si].rv[valIndex])-yadjust+this.offsetTop;if(yPos<0){yPos=0;}if(this.mainWidth>0){var xposr=touchX+ttp.offsetWidth+this.offsetLeft-this.mainLeftPos;if(xposr>this.mainWidth){touchX-=(xposr-this.mainWidth);}}},isTouchPointInGraphRange:function tpInGR(touchX,touchY){var margin=this.margin;if(touchX<margin.l||touchY<margin.t||touchY>this.canvas.height-margin.b){return false;}return true;},showTooltip:function handleTouchMove(touchX,touchY){if(!this.config.mbShowTooltip){return false;}var me=this,m=me.model;if(m.series[0].rv.length<=1){return false;}var pos=mstrmojo.dom.position(this.domNode,true);touchX=touchX-pos.x;touchY=touchY-pos.y;if(!this.isTouchPointInGraphRange(touchX,touchY)){return false;}var touchVal=me.getTouchValue(touchX,touchY);var margin=this.margin;if(touchVal!==null){var x=(touchVal*me.RTX)+margin.l;if(me.widget.enableSmoothScroll){if(this.domNode.offsetLeft+x<this.widget._scroller.origin.x){return false;}}var rns=(m.rne-m.rns>1)?m.rns:m.rns-1;if(me.seriesIndex===-1||me.switchSeriesOnTouch){me.seriesIndex=me.utils.getSeriesIndexAndYValue(me,rns+touchVal,touchY).si;}if(m.series[me.seriesIndex].rv[rns+touchVal]===""){return false;}me.prevHighlight=me.currentHighlight;me.currentHighlight=touchVal;if(!me.widget.tooltipShow||me.prevHighlight!=me.currentHighlight){me.renderTooltip(touchVal,x,touchY);me.highlightPoint(touchVal,touchY);}return true;}}});})();