(function(){mstrmojo.requiresCls("mstrmojo._FillsBrowser","mstrmojo._HasPopup","mstrmojo.Box","mstrmojo.Table","mstrmojo.Button","mstrmojo.QB.SplitPanel","mstrmojo.QB.VSplitPanel","mstrmojo.Architect.ArchitectModel","mstrmojo.Architect.WHTablePanel","mstrmojo.ObjectInputBox","mstrmojo.Architect.LogicalTableSelector","mstrmojo.Architect.MultiTableView","mstrmojo.Architect.ExpressionEditor","mstrmojo.WH.WHPanel");mstrmojo.requiresDescs(218,219,221,1154,1442,2211,8116,6189,1143,334,521,401,279,773,172,9117,9118,9119,9111,9120,9121,9136,9112,9113,9116,9114,9115,8132);var _C=mstrmojo.css;var _model=mstrmojo.all.ArchModel;if(!_model){_model=new mstrmojo.Architect.ArchitectModel({});}var content=new mstrmojo.QB.SplitPanel({slot:"layout",alias:"main",children:[new mstrmojo.WH.WHPanel({slot:"leftItem",onDBRoleSelection:function(evt){var model=mstrmojo.all.ArchModel;model.SelDBRoleID=evt.value;model.dbrs=this.getDBRoles();},allowdragstart:function(ctxt){},onTabledblclick:function(evt){var mdl=mstrmojo.all.ArchModel,srcw=evt.src;mdl.addTable(srcw.data.tag);}}),new mstrmojo.QB.SplitPanel({slot:"rightItem",cssText:"padding: 2px;border:2px solid #CCC;background-color:#E5E5E5;border-radius:6px; -moz-border-radius:6px; -webkit-border-radius:6px;",borderoffset:2,children:[{scriptClass:"mstrmojo.Architect.LogicalTableSelector",slot:"leftItem"},{scriptClass:"mstrmojo.Architect.MultiTableView",slot:"rightItem"}]})]});mstrmojo.Architect.ArchitectPage=mstrmojo.declare(mstrmojo.Container,[mstrmojo._FillsBrowser,mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.Architect.ArchitectPage",markupString:'<div id="{@id}" class="mstrmojo-qb {@cssClass}" style="{@cssText}"><div class="mstrmojo-qb-toolbar"></div><div></div><div class="mstrmojo-qb-layout" style="width:100%;"></div><div class="mstrmojo-qb-footer" style="width:100%;"></div></div>',markupSlots:{toolbar:function(){return this.domNode.firstChild;},search:function(){return this.domNode.children[1];},layout:function(){return this.domNode.children[2];},footer:function(){return this.domNode.lastChild;}},height:null,width:null,id:"ArchPage",onError:function(err){d=err.detail,app=mstrmojo.App,c=err.code;},renderPageLoadError:function(){var err=this.error;this.onError(err);if(!err.btns||!err.btns.length){mstrmojo.alert(err.message,null,err.title);}else{mstrmojo.confirm(err.message,err.btns,err.title);}},render:function(){if(this.error){this.renderPageLoadError();}else{this._super();}},children:[new mstrmojo.Table({slot:"toolbar",rows:1,cols:5,cssText:"width:100%",layout:[{cells:[{cssText:"left-padding:2px; width:28px;"},{cssText:"width:28px;"},{cssText:"width:28px;"},{cssText:"width:28px"},{cssText:"float:right;"}]}],children:[{scriptClass:"mstrmojo.Button",slot:"0,0",active:true,iconClass:"mstrmojo-ArchitectToolbarIcon databaseview on",title:mstrmojo.desc(9111,"Database View"),onclick:function toggle(evt){this.active=!this.active;content.set("leftItemVisible",this.active);_C.toggleClass(this.domNode,"on",this.active);}},{scriptClass:"mstrmojo.Button",slot:"0,1",active:true,iconClass:"mstrmojo-ArchitectToolbarIcon ptableview on",title:"Project Table View",onclick:function toggle(evt){this.active=!this.active;content.children[1].set("leftItemVisible",this.active);_C.toggleClass(this.domNode,"on",this.active);}},{scriptClass:"mstrmojo.Button",slot:"0,2",iconClass:"mstrmojo-ArchitectToolbarIcon update",title:"Save and Update Schema",onclick:function(evt){_C.toggleClass(this.domNode,"on",true);var me=this;var cb={success:function(){_C.toggleClass(me.domNode,"on",false);alert("Project saved and Schema updated");}};mstrmojo.all.ArchModel.saveAndUpdate(cb);}},{scriptClass:"mstrmojo.Button",slot:"0,3",iconClass:"mstrmojo-ArchitectToolbarIcon save",title:"Save Schema",active:false,onclick:function(evt){_C.toggleClass(this.domNode,"on",true);var me=this;var cb={success:function(){_C.toggleClass(me.domNode,"on",false);alert("Project saved and Schema updated");}};mstrmojo.all.ArchModel.saveProject(cb);}},{scriptClass:"mstrmojo.Button",slot:"0,4",iconClass:"mstrmojo-ArchitectToolbarIcon help",title:mstrmojo.desc(1143,"Help")}]}),new mstrmojo.Table({slot:"search",rows:1,cols:2,cssText:"width:100%",layout:[{cells:[{cssText:"left-padding:10px; width:80%;"},{cssText:"width:50px;"}]}],children:[{scriptClass:"mstrmojo.ObjectInputBox",alias:"SearchBox",slot:"0,0",cssText:"margin-left:10px; height:25px;",item2textCss:function item2textCss(data){return{12:" mstrmojo-ArchitectListIconSuggest t12",13:" mstrmojo-ArchitectListIconSuggest t13"}[data.t]||"";},hideEditButton:function(d){return false;},browseItemVisible:false,dynamicVerify:false,emptyText:"Type here to input attribute or metric ...",postCreate:function(){var me=this;var cb={success:function(res){me.candidates={items:res.items,isComplete:(res.bc===-1||(res.bb+res.bc>res.sz))};}};_model.getProjectObjects("12,13",cb);}},{scriptClass:"mstrmojo.Button",slot:"0,1",iconClass:"mstrmojo-Architect-SearchBox-search",title:"Search",onclick:function(){var its=this.parent.SearchBox.getSelectedObjects(),len=its.length,mdl=mstrmojo.all.ArchModel,tr=mstrmojo.all.ProjTableTree;if(len===0){tr.load();}else{var pair=[],cb1={success:function(res){var oi=res.mi.es.oi,oi=oi.length?oi:[oi];for(var i=0,len=oi.length;i<len;i++){var o=oi[i];if(o.tp===12&&!mdl.attrs[o.did]){var e=o.def.fms.fm_c.e,e=e.length?e:[e],fms={};for(var j=0,len2=e.length;j<len2;j++){var bfm=e[j],cid=bfm.fm.did,n=mdl.frms[cid]?mdl.frms[cid].n:"";fms[bfm.bfi]={baseFrmID:bfm.bfi,fmcatid:cid,n:n};}mdl.attrs[o.did]={id:o.did,name:its[i].n,tbls:[],Forms:fms};}if(o.tp===13&&!mdl.fcts[o.did]){mdl.fcts[o.did]={id:o.did,name:its[i].n,tbls:o.ts,Sum:true,Count:false,Max:false,Min:false,Variance:false,Average:false};}}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},cb2={success:function(res){for(var i=0,len2=res.length;i<len2;i++){var tbl=res[i];res[i]={n:tbl.n,did:tbl.did,t:tbl.tp,isNew:false,prid:"",pdbr:{},secdbrs:{},relations:[],items:[],clns:[],FactInfos:{},AttrInfos:{}};mdl.tbls[tbl.did]=res[i];}tr.set("items",res);}};for(var i=0;i<len;i++){pair.push(its[i].did+","+its[i].t);}mdl.getObjectInBulk(pair,cb1);mdl.getTbl4Obj(pair,cb2);}}}]}),content],layoutConfig:{h:{toolbar:"30px",layout:"100%"},w:{layout:"100%"}},loadDbrs:function(){content.children[0].load();_model.createSchemaInstance();},browserResized:function browserResized(size){var nw=parseInt(size.w)-15+"px";var nh=parseInt(size.h)-100+"px";if(this.height&&nh!==this.height){this.set("height",nh);}else{this.height=nh;}if(this.width&&nw!==this.width){this.set("width",nw);}else{this.width=nw;}return true;}});})();