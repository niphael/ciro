(function(){mstrmojo.requiresCls("mstrmojo.Button","mstrmojo.HBox","mstrmojo.Box","mstrmojo.WH.MenuButton","mstrmojo.Architect.NameEditor","mstrmojo.Architect.ProjectTableTree");var $C=mstrmojo.css,$D=mstrmojo.dom,$H=mstrmojo.hash;var _tables=[];var _menuItems=[{did:"Delete",n:"Delete"},{did:"Rename",n:"Rename"},{did:"Automap",n:"AutoMapping"},{did:"UpStruct",n:"Update Structure"},{did:"AddAttr",n:"Add as Attribute"},{did:"AddFact",n:"Add as Metric"},{did:"-1",n:"-"},{did:"CreateAL",n:"Create Alias"},{did:"PSource",n:"Primary Source",fns:[{did:"",n:"1"}],onContextMenuOpen:function(){var row=this.wgt;if(row){var d=row.data,pdbrs=[d.pdbr].concat(d.secdbrs);}if(this._subMenu){var sm=this._subMenu;sm.set("items",pdbrs);}}},{did:"2Source",n:"Secondry Source",fns:[{did:"1",n:"1"}],onContextMenuOpen:function(){var row=this.wgt;if(row){sdbrs=row.data.secdbrs;}if(this._subMenu){var sm=this._subMenu;sm.set("items",sdbrs);}}}];function _openCxtMenu(domSrc,wgt){var id="mstr-arch-tableCM",e=mstrmojo.all[id];if(!e){e=new mstrmojo.MenuButton({id:id,cmCssClass:"mstrmojo-CXM",cm:_menuItems,domSrc:domSrc,data:wgt.data,wgt:wgt,dynamicUpdate:true,getMenuPosition:function getMenuPosition(){var pos=mstrmojo.dom.position(this.domSrc,true);return{x:Math.round(pos.x),y:Math.round(pos.y+pos.h)};},queryChecked:function queryChecked(item){if(this.data.pdbr){return item.did===this.data.pdbr.did;}},queryVisible:function(item){var d=this.data;switch(item.did){case"Delete":case"Rename":case"Automap":case"UpStruct":case"CreateAL":case"PSource":case"2Source":return d.t===15;case"AddAttr":case"AddFact":return d.t===26;default:return true;}},executeCommand:function(item){var tlist=[],item,mdl=mstrmojo.all.ArchModel,row=this.wgt;this.cssText="position:relative;visibility:hidden;";this.render();switch(item.did){case"Delete":var cb={success:function(res){_remove(row);var mdl=mstrmojo.all.ArchModel,did=mdl.SelDBRoleID,d=row.data,pdbr=d.pdbr,sdbrs=d.secdbrs,dbts=mdl.dbtbls,flag;if(dbts[pdbr.did]){dbts[pdbr.did][pdbr.dbt.did]=pdbr.dbt;}if(pdbr.did===did){flag=pdbr.dbt;}for(var i=0,len=sdbrs.length;i<len;i++){if(dbts[sdbrs[i].did]){dbts[sdbrs[i].did][sdbrs[i].dbt.did]=sdbrs[i].dbt;}if(sdbrs[i].did===did){flag=sdbrs[i].dbt;}}if(flag){mstrmojo.all.DBTableTree.add([flag],0);}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.deleteObject(15,row.data.did,cb);break;case"Automap":var cb={success:function(res){var c=mstrmojo.all.tablePanel.tablesection.tlist.children,idx=mstrmojo.array.find(c,"title",row.data.n);if(idx>-1){c[idx].renderTable();}}};mdl.autoRecog(row.data.did,cb);break;case"AddAttr":mstrmojo.all.aflist.processAction({name:"AddAttribute",cln:row.data.cln,cmid:row.data.cmid});break;case"AddFact":mstrmojo.all.aflist.processAction({name:"AddFact",cln:row.data.cln,cmid:row.data.cmid});break;case"Rename":var _tnEditor=new mstrmojo.Architect.NameEditor({title:"Rename Project Table",onOpen:function(){if(this.txtbox.domNode){this.txtbox.value=row.text;this.txtbox.domNode.focus();this.txtbox.domNode.select();}},onOK:function(){var n=mstrmojo.string.trim(this.txtbox.value),me=this,tid=row.data.did;if(n===row.text){this.close();return ;}var cb={success:function(res){row.data.n=n;row.set("text",n);mdl.pts[row.data.prid][tid].n=n;if(tid===mdl.SelTableID){mstrmojo.all.tableTitle.set("text",n);}me.close();},failure:function(res){me.error.set("text",res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};mdl.renameObject(tid,15,n,false,cb);}});_tnEditor.open();break;default:break;}}});e.render();}else{e.set("domSrc",domSrc);e.set("data",wgt.data);e.set("wgt",wgt);}e.showContextMenu();}function _find(arr,n,v){var i;for(i=0,len=arr&&arr.length||0;i<len;i++){var obj=arr[i];if(obj&&obj.data[n]==v){return{idx:i,w:arr[i]};}}return null;}function _findTbl(tree,tid){for(var i=0,len=tree.items.length;i<len;i++){var ts=tree.items[i].items;for(var j=0,len1=ts.length;j<len1;j++){var t=ts[j];if(tid===t.did){return{w:tree.ctxtBuilder.itemWidgets[i].ctxtBuilder.itemWidgets[j],it:t};}}}}function _remove(w){var p=w.parent,its=p.items,d=w.data,dbr=d.t===29,idx=mstrmojo.array.find(its,dbr?"prid":"did",dbr?d.prid:d.did);its.splice(idx,1);if(its.length===0&&!dbr){_remove(p);}else{p.render();}}mstrmojo.Architect.LogicalTableSelector=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.Architect.LogicalTableSelector",cssText:"width:100%;height:100%;",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},children:[{scriptClass:"mstrmojo.HBox",alias:"header",cssText:"width:100%",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Architect-Panel-header subheader",text:"Project Tables"}]},{scriptClass:"mstrmojo.Table",alias:"Toolbox",rows:1,cols:3,sIdx:0,layout:[{cells:[{cssText:"margin-left:5px;width:20px;height:20px;"},{cssText:"width:20px;"},{cssText:"height: 20px;"}]}],children:[{scriptClass:"mstrmojo.Button",slot:"0,0",iconClass:"mstrmojo-ArchitectToolbarIcon full on",title:mstrmojo.desc(9111,"Database View"),onclick:function toggle(evt){var p=this.parent;if(p.sIdx===0){return ;}$C.toggleClass(this.domNode,"on",true);$C.toggleClass(p.children[p.sIdx].domNode,"on",false);p.sIdx=0;p.parent.ProjTableTree.set("viewtp",p.sIdx);}},{scriptClass:"mstrmojo.Button",slot:"0,1",iconClass:"mstrmojo-ArchitectToolbarIcon grid",title:mstrmojo.desc(9111,"Database View"),onclick:function toggle(evt){var p=this.parent;if(p.sIdx===1){return ;}$C.toggleClass(this.domNode,"on",true);$C.toggleClass(p.children[p.sIdx].domNode,"on",false);p.sIdx=1;p.parent.ProjTableTree.set("viewtp",p.sIdx);}},{scriptClass:"mstrmojo.Widget",slot:"0,2",alias:"SearchBox",cssClass:"mstrmojo-charcoalbox mstrmojo-dxsprite",cssText:"-webkit-border-radius:10px;-moz-border-radius:10px;border-radius:10px;margin: 5px 0;",markupString:'<table id={@id} cellspacing=0 cellpadding=0 class="mstrmojo-SearchBox-Wrapper {@cssClass}" style="{@cssText};"><tr><td ><div class="mstrmojo-SearchBox" mstrAttach:click ><input class="mstrmojo-SearchBox-input" type="text" style="width:{@width};" mstrAttach:keyup,blur /></div></td><td><div class="mstrmojo-SearchBox-bg"><div class="mstrmojo-Architect-SearchBox-search" id="{@id}sbClear" mstrAttach:click ></div></div></td></tr></table>',markupSlots:{inputNode:function(){return this.domNode.rows[0].cells[0].firstChild.firstChild;},clearNode:function(){return this.domNode.rows[0].cells[1].firstChild.firstChild;}},enableMatchCase:false,onwidthChange:function(evt){this.inputNode.style.width=evt.value;},onclick:function(evt){var hWin=evt.hWin,e=evt.e||hWin.event,tgt=e.target||e.srcElement,id=tgt&&tgt.id;switch(id.replace(this.id,"")){case"sbSearch":if(this.onEnter&&e.keyCode===13){this.onEnter();}this._onsearch();break;case"sbClear":this.clearSearch();break;}},clearSearch:function(){this.inputNode.value="";$C.removeClass(this.clearNode,["show"]);this._onsearch(true);},onkeyup:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event;var input=mstrmojo.string.trim(this.inputNode.value);if(this.clearNode){$C.toggleClass(this.clearNode,["show"],input.length>0);}this._onsearch();},_onsearch:function(toRoot){var mdl=mstrmojo.all.ArchModel;var ptr=this.parent.parent.ProjTableTree,r=[],ps=mdl.pt_items,idx=0,idx2,its,pj,items;var input=mstrmojo.string.trim(this.inputNode.value).toUpperCase();if(input.length>0){for(var j=0,len1=ps.length;j<len1;j++){pj=ps[j];its=pj.items;idx2=0;items=[];for(var k=0,len2=its.length;k<len2;k++){if(its[k].n.toUpperCase().indexOf(input)>-1){items[idx2++]=$H.clone(its[k]);}}if(idx2>0){r[idx]={n:pj.n,st:pj.st,t:pj.t,items:items};idx++;}}}else{r=ps;}this.parent.parent.ProjTableTree.set("items",r);}}],onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";var h=parseInt(this.parent.ProjTableTree.height),_H=31;if(h>0){h=this.visible?h-_H:h+_H;this.parent.ProjTableTree.set("height",h+"px");}}},{alias:"ProjTableTree",id:"ProjTableTree",viewtp:0,scriptClass:"mstrmojo.Architect.ProjectTableTree",cssClass:"mstrmojo-Architect-LogicalTablesTree",cssText:"border:solid 2px #CCC; background-color:white;",tableChange:function tableChange(evt){var tables=evt.tbls,mdl=mstrmojo.all.ArchModel,rid=mdl.PrjTblDbr,isPrm=(rid==="00000000000000000000000000000000"),r=_find(this.ctxtBuilder.itemWidgets,"prid",rid);if(!r){var dbr=tables[0].pdbr;var d={n:dbr.n+(isPrm?"(Primary)":""),prid:rid,st:dbr.stp,t:dbr.tp,items:tables,isPrm:isPrm,dbr:dbr};this.add([d]);}else{var idx=r.idx,w=r.w,len=w.items.length;w.add(tables);w.parent.items[idx].items=w.items;}mdl.p_tables=this.items;},attrfctChange:function(evt){if(this.viewtp===0){return ;}var n=evt.value,id=evt.did,tp=evt.tp,toRefresh=false;for(var i=0,len=this.items.length;i<len;i++){var tbls=this.items[i].items;for(var j=0,len1=tbls.length;j<len1;j++){var af=tbls[j].items;for(var k=0,len2=af.length;k<len2;k++){var obj=af[k];if(obj.t===tp&&obj.did===id){if(n===null){delete af[k];}else{af[k].name=n;af[k].n=n;}toRefresh=true;break;}}if(toRefresh){toRefresh=false;var w=this.ctxtBuilder.itemWidgets[i].ctxtBuilder.itemWidgets[j];w.set("items",[]);w.set("items",af);break;}}}},tableNameChange:function(evt){var n=evt.value,tid=evt.did,toRefresh=false;for(var i=0,len=this.items.length;i<len;i++){var ts=this.items[i].items;for(var j=0,len1=ts.length;j<len1;j++){var t=ts[j];if(tid===t.did){if(n===null){delete ts[j];this.ctxtBuilder.itemWidgets[i].set("items",ts);}else{t.n=n;var w=this.ctxtBuilder.itemWidgets[i].ctxtBuilder.itemWidgets[j];w.set("text",n);}}}}},refreshTable:function(evt){if(this.viewtp===0){return ;}var me=this,tid=evt.did,cb={success:function(res){var tbl=_findTbl(me,tid);tbl.it.items=res.items;tbl.w.set("items",[]);tbl.w.set("items",res.items);},failure:function(res){}};mstrmojo.all.ArchModel.getAttributesFactsInTable(evt,me.viewtp,cb);},msChange:function(evt){var tbl=_findTbl(this,evt.tid);w=tbl.w;w.data.t=30;w.tp="Proj t30";w.data.secdbrs.push(evt.dbr);w.textCssClass="mstrmojo-ArchitectListIcon t30";w.render();},layerChange:function(evt){var tr=mstrmojo.all.ProjTableTree;tr.clearTreeSelect();},oncxtmenuPopup:function(srcDom,row){_openCxtMenu(srcDom,row);}}],onheightChange:function changeheight(evt){var tn=this.ProjTableTree.domNode,h=parseInt(evt.value,10)-59;this.ProjTableTree.height=h+"px";if(tn){tn.style.height=h+"px";}},onwidthChange:function(e){if(this.domNode){this.Toolbox.SearchBox.set("width",parseInt(e.value)-85+"px");}},postBuildRendering:function postBR(){if(this._super){this._super();}this.ProjTableTree.domNode.style.height=parseInt(this.height,10)-59+"px";this.Toolbox.SearchBox.set("width",parseInt(this.width,10)-85+"px");var mdl=mstrmojo.all.ArchModel,id=this.ProjTableTree.id;mdl.attachEventListener("tblsChange",id,"tableChange");mdl.attachEventListener("TableContentChange",id,"refreshTable");mdl.attachEventListener("AttrFctChange",id,"attrfctChange");mdl.attachEventListener("msChange",id,"msChange");mdl.attachEventListener("msChange",id,"layerChange");}});})();