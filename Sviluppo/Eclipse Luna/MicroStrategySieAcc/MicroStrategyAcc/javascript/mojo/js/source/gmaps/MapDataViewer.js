(function(){var DRILLING_ACTION=1;var SELECTOR_ACTION=2;var HYPERLINK_ACTION=4;var SORT_ACTION=8;mstrmojo.requiresCls("mstrmojo.gmaps.MapManipulation");mstrmojo.gmaps.MapDataViewer=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.gmaps.MapDataViewer",beanPath:null,command:null,currentSelections:null,data:null,DEFAULT_COLOR:"#FE766A",defaultInfoWindowHTML:"",gridParams:null,highlightedGraphics:null,idMarkerMap:null,infoWindowHTML:"",isPrimary:false,key:null,layerIndex:0,maxRadius:60,maxValue:-Infinity,minMaxMap:null,minRadius:3.5,msgID:null,parent:null,selectedMetricIndex:0,selectedRowIndices:null,widgetProps:null,_xTabModel:null,visible:true,validBubble:false,init:function init(props){this._super(props);this.initMetricSelectorIndex(this.widgetProps.cmt);this.command=new mstrmojo.gmaps.MapManipulation({viewerLayer:this,_key:this.key});},handleMetricSelectionChange:function handleMetricSelectionChange(){},performDrill:function performDrill(columnIndex){var selected=this.getSelectedRowIndices(columnIndex);if(selected===undefined||!selected instanceof Array||selected.length===0){return ;}var actionType=this.data.ghs.rhs.items[selected[0]].items[columnIndex].at;if(actionType===undefined||isNaN(actionType)){return ;}if((actionType&HYPERLINK_ACTION)>0){this.command.execHL(null,null,columnIndex);}},getCurrentSelections:function getCurrentSelection(columnIndex){if(!this.currentSelections){this.currentSelections={};}if(!this.currentSelections.hasOwnProperty(columnIndex)){this.currentSelections[columnIndex]=[];}return this.currentSelections[columnIndex];},getDocModel:function getDocModel(){return this._xTabModel&&this._xTabModel.docModel;},getDrillStatus:function getDrillStatus(){var results=false;if(this.enablePolygon){results|=this.getDrillStatusByColumnIndex(this.geoPosition);}if(this.enableMarker){results|=this.getDrillStatusByColumnIndex(this.latIndex);}return results;},getDrillStatusByColumnIndex:function getDrillStatusByColumnIndex(index){var selected=this.getSelectedRowIndices(index);if(selected===undefined||!selected instanceof Array||selected.length===0){return false;}var actionType=this.data.ghs.rhs.items[selected[0]].items[index].at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}if(this.data.gts.row[index].dp){return true;}return false;},getGeoColumnIndex:function getGeoColumnIndex(){return -1;},getHighlightedGraphics:function getHighlightedGraphics(columnIndex){if(!this.highlightedGraphics){this.highlightedGraphics={};}if(!this.highlightedGraphics.hasOwnProperty(columnIndex)){this.highlightedGraphics[columnIndex]=[];}return this.highlightedGraphics[columnIndex];},getInfoWindowHTML:function getInfoWindowHTML(){return this.infoWindowHTML;},getLinkDetails:function getLinkDetails(){var colInd=this.getGeoColumnIndex();return this.data.gts.row[colInd].lm[0];},getMetricSelectorIndex:function getMetricSelectorIndex(){return this.selectedMetricIndex;},getPrimaryGridViewer:function getPrimaryGridViewer(){return this.parent.getPrimaryGridViewer();},getLayerGridName:function getLayerGridName(){return this.data&&this.data.n;},getRowAxisAttributeIndex:function getRowAxisAttributeIndex(columnIndex){var titles=this.data.gts.row;var i;if(typeof (columnIndex)=="undefined"||columnIndex>=titles.length){return -1;}var attributeIndex=-1;var attributeLookup={};for(i=0;i<=columnIndex;i++){if(typeof (attributeLookup[titles[i].id])=="undefined"){attributeLookup[titles[i].id]=1;attributeIndex++;}}return attributeIndex;},getSelectedRowIndices:function getSelectedRowIndices(columnIndex){if(!this.selectedRowIndices){this.selectedRowIndices={};}if(!this.selectedRowIndices.hasOwnProperty(columnIndex)){this.selectedRowIndices[columnIndex]=[];}return this.selectedRowIndices[columnIndex];},getXTabModel:function getXTabModel(){return this._xTabModel;},getWidgetProps:function getWidgetProps(){return this.widgetProps;},initMapProperty:function initMapProperty(){var geoName;for(geoName in this.columnIndices){if(this.columnIndices.hasOwnProperty(geoName)){this.columnIndices[geoName]=-1;}}this.geoPosition=-1;},initMetricSelectorIndex:function initMetricSelectorIndex(metricId){if(this.data.eg||!metricId){return ;}var cols=this.data.gts.col,col;var metricsString=mstrmojo.desc(1158,"Metrics");for(var i=0;i<cols.length;i++){col=cols[i];if(col.n==metricsString){var es=col.es;for(var j=0;j<es.length;j++){if(this.justMetricId(metricId)==this.justMetricId(es[j].id)){this.selectedMetricIndex=j;break;}}}}},isAffinityLinesEnabled:function isAffinityLinesEnabled(){return false;},isPrimaryGrid:function isPrimaryGrid(){return this.isPrimary;},isViewerDrillable:function isViewerDrillable(){if(this.data.eg){return false;}var index=this.getGeoColumnIndex();var actionType=this.data.ghs.rhs.items[0].items[index].at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&HYPERLINK_ACTION)>0){return true;}return false;},isViewerSliceable:function isViewerSliceable(){var index=this.getGeoColumnIndex();var actionType=this.data.ghs.rhs.items[0].items[index].at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&SELECTOR_ACTION)>0){return true;}return false;},justMetricId:function justMetricId(id){if(id.indexOf("CD:")!=0){return id;}var endIndex=id.indexOf(":",3);return(endIndex>=0)?id.substring(3,endIndex):id.substring(3);},populateBubbleVariables:function populateBubbleVariables(){if(!this.bubbleMode){return ;}this.populateMinMax(this.selectedMetricIndex);var minMaxObject=this.minMaxMap[this.selectedMetricIndex];this.maxValue=minMaxObject.max;this.validBubble=(this.maxValue!=Infinity);},resetData:function resetData(data){this.data=data;},setInfoWindowHTML:function setInfoWindowHTML(value){this.infoWindowHTML=value;this.widgetProps.iwd=escape(this.replaceInfoWindowHTMLMacros());},parseInfoWindowHTML:function parseInfoWindowHTML(){var input=this.infoWindowHTML,result="",baseIndex=0,startIndex=input.indexOf("${",baseIndex),endIndex=input.indexOf("}",startIndex+1),macroName,transformedMacroName,dataIDNameTable={},rows=this.data.gts.row,cols=this.data.gts.col,index,row,col,es,colElement,j,metricsString=mstrmojo.desc(1158,"Metrics");for(index=0;index<rows.length;index++){row=rows[index];dataIDNameTable[row.id+"|"+row.fid]=row.n;dataIDNameTable[row.fid]=row.n;}for(index=0;index<cols.length;index++){col=cols[index];if(col.n===metricsString){es=col.es;for(j=0;j<es.length;j++){colElement=es[j];dataIDNameTable[colElement.id]=colElement.n;}break;}}while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);if(dataIDNameTable.hasOwnProperty(macroName)){result+=input.substring(baseIndex,startIndex+2)+dataIDNameTable[macroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex);this.infoWindowHTML=result;},replaceInfoWindowHTMLMacros:function replaceInfoWindowHTMLMacros(){var input=this.infoWindowHTML,result="",baseIndex=0,startIndex=input.indexOf("${",baseIndex),endIndex=input.indexOf("}",startIndex+1),macroName,transformedMacroName,dataNameIDTable={},rows=this.data.gts.row,cols=this.data.gts.col,row,col,index,es,colElement,j,metricsString=mstrmojo.desc(1158,"Metrics");for(index=0;index<rows.length;index++){row=rows[index];dataNameIDTable[this.parent.replaceSpace(row.n)]=row.id+"|"+row.fid;}for(index=0;index<cols.length;index++){col=cols[index];if(col.n===metricsString){es=col.es;for(j=0;j<es.length;j++){colElement=es[j];dataNameIDTable[this.parent.replaceSpace(colElement.n)]=colElement.id;}break;}}while(startIndex>=0&&endIndex>startIndex){macroName=input.substring(startIndex+2,endIndex);var colonIndex=macroName.indexOf(":");if(colonIndex>=0){macroName=macroName.substring(0,colonIndex)+" "+macroName.substring(colonIndex+1);}macroName=this.parent.replaceSpace(macroName);if(dataNameIDTable.hasOwnProperty(macroName)){result+=input.substring(baseIndex,startIndex+2)+dataNameIDTable[macroName];}else{result+=input.substring(baseIndex,endIndex);}baseIndex=endIndex;startIndex=input.indexOf("${",baseIndex);endIndex=input.indexOf("}",startIndex+1);}result+=input.substring(baseIndex);return result;},selectedMetricIndexChange:function selectedMetricIndexChange(metricIndex,metricId){this.selectedMetricIndex=metricIndex;this.handleMetricSelectionChange();this.widgetProps.cmt=metricId;},setXTabModel:function setXTabModel(val){this._xTabModel=val;},unrender:function unrender(){}});})();