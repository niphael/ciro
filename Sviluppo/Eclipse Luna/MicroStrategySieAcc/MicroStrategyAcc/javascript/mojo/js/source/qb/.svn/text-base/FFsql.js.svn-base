(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.expr","mstrmojo.range","mstrmojo.array","mstrmojo.WidgetListMapper","mstrmojo._HasSuggestion","mstrmojo.qb.FFsqlToken");var _D=mstrmojo.dom,$ARR=mstrmojo.array,$H=mstrmojo.hash,_C=mstrmojo.css,KEYS=mstrmojo.Enum_Keys,_R=mstrmojo.range,EDGE=_R.EDGE,E=mstrmojo.expr,isDelimiter=mstrmojo.qb.FFsqlToken.isDelimiter,IME_KEY=229;function getCharacter(e){var k=(_D.isIE&&!_D.isIE9)?e.keyCode:e.charCode;return(k>0)?String.fromCharCode(k):null;}var SQL_TOKENS,SQL_TOKEN_TYPE=100,SQL_SPACING={" ":true,"\t":true,"\n":true};SQL_KEYWORD_ACTION=["select","update","insert","delete","create","drop","alter","set","exec"],SQL_KEYWORD=SQL_KEYWORD_ACTION.concat(["from","where","having","in","group","by","order","into","on","values","table","case","then","else","join","as"]),currentDBTableHash={};function getSQLTokens(){if(!SQL_TOKENS){SQL_TOKENS=[];$ARR.forEach(SQL_KEYWORD,function(keyword){SQL_TOKENS.push({n:keyword,sta:SQL_TOKEN_TYPE,t:SQL_TOKEN_TYPE});});}return SQL_TOKENS;}mstrmojo.qb.FFsql=mstrmojo.declare(mstrmojo.ME.TokenInputBox,null,{scriptClass:"mstrmojo.qb.FFsql",renderBlockSize:50000,itemFunction:function itemFunction(item,idx,w){return new mstrmojo.qb.FFsqlToken({data:item});},item2textCss:function item2textCss(data){return{11:" mstrmojo-ArchitectListIconSuggest t11 ",15:" mstrmojo-ArchitectListIconSuggest t15 ",26:" mstrmojo-ArchitectListIconSuggest t26 "}[data.t]||"";},itemIdField:"did",itemCount:0,ostack:[],sqlTokens:getSQLTokens(),browseItemVisible:false,customFunctionVisible:false,getSQLstmt:function(){if(!this.items){return"";}var sa=[],i,len,its=this.items;for(i=0,len=its.length;i<len;i++){sa[i]=its[i].v;}return sa.join("");},handlekeydown:function handlekeydown(e){if(this.editNode.contentEditable=="false"){return true;}e=e||window.event;var k=e.keyCode||e.charCode,noDefault=false,rInfo=_R.getRangeInfo(),isFirefoxIMEMode=_D.isFF&&(k===0);if(isFirefoxIMEMode&&!this.doubleByte){this.doubleByte=true;this.prev_rInfo=rInfo;this.prev_items=this.items;return true;}if(this.doubleByte&&k!=IME_KEY&&!isFirefoxIMEMode){this.doubleByte=false;var prevInfo=this.prev_rInfo,data=rInfo.startContainer.data,startOffset=prevInfo.startOffset;if(data){_D.isFF&&(startOffset=Math.max(startOffset-1,0));this.widgetHandleImeInput(prevInfo,data.slice(startOffset,rInfo.startOffset));}}switch(k){case KEYS.DELETE:if(!this.doubleByte){try{this.widgetHandleDelete(rInfo);this.startTokenSuggestion();this.raiseChangeEvent({type:"delete"});this.updatepasses();}catch(ex1){}noDefault=true;}break;case KEYS.BACKSPACE:if(!this.doubleByte){try{this.widgetHandleBackspace(rInfo);this.raiseChangeEvent({type:"backspace"});this.startTokenSuggestion();}catch(ex2){}noDefault=true;}break;case KEYS.ENTER:if(this.suggestionShown){var s=this.getSelected();if(s){this.handleSuggestionItemSelect(s);if(this.candidates.isCol){this.set("candidates",{items:mstrmojo.all.QBuilderModel.FFsqlComp,isComplete:true});}}this.hideSuggestion();}else{var edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=_D.findWidget(rInfo.startContainer),idx=this.itemIndex(ew.data),itws=this.ctxtBuilder.itemWidgets,isEnter=itws[idx].data.v==="\n",t={v:"\n",isDelimiter:true,isNew:true,did:this.itemCount++};em={v:" ",isDelimiter:true,isNew:true,did:this.itemCount++};if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset,this.itemCount++);this.remove(idx);this.add([ts[0],t,ts[1]],idx);idx=idx+1;}else{if(edge===EDGE.EDGE_BEGIN){this.add([t],idx);}else{idx=idx+1;if((_D.isFF||_D.isIE)&&isEnter){this.add([em,t],idx);}else{this.add([t,em],idx);}}}if(_D.isFF||_D.isIE){ew=itws[isEnter?idx:idx+1];this._delaySetCaretPos(ew.domNode,true);}else{ew=itws[idx];this._delaySetCaretPos(ew.domNode,false);}this.updatepasses();}noDefault=true;break;case KEYS.TAB:if(this.suggestionShown){var s=this.getSelected();if(s){this.handleSuggestionItemSelect(s);if(this.candidates.isCol){this.set("candidates",{items:mstrmojo.all.QBuilderModel.FFsqlComp,isComplete:true});}}}else{this.startTokenSuggestion();}noDefault=true;break;case KEYS.ESCAPE:this.endTokenSuggestion();noDefault=true;break;case 67:if(e.ctrlKey||e.metaKey){this.ctrx=false;noDefault=false;}break;case 86:if(e.ctrlKey||e.metaKey){this._saveRangeInfo=_R.getRangeInfo();if(this.ctrx){this.handlepaste(this.cutstr);noDefault=true;this.ctrx=false;}else{this.clipboardNode.focus();noDefault=false;}this.updatepasses();}break;case 88:if(e.ctrlKey||e.metaKey){try{this.cutstr=rInfo.range.cloneContents().textContent;this.widgetHandleDelete(rInfo);this.startTokenSuggestion();this.ctrx=true;this.raiseChangeEvent({type:"cut"});}catch(ex2){}noDefault=true;}break;case 90:if(e.ctrlKey||e.metaKey){try{var stk=this.ostack,len=stk.length;if(len>1){stk.pop();this.set("items",stk[len-2].its);this.updatepasses();this.focus();}}catch(ex2){}noDefault=true;}break;case IME_KEY:if(!this.doubleByte){this.doubleByte=true;this.prev_rInfo=rInfo;this.prev_items=this.items;}break;default:}if(noDefault){_D.stopPropogation(window,e);_D.preventDefault(window,e);return false;}else{return true;}},handlekeypress:function handlekeypress(e){if(this.editNode.contentEditable=="false"){return true;}e=e||window.event;var c=getCharacter(e),k=e.keyCode||e.charCode,noDefault=false,ew;if(c&&!((c==="c"||c==="x"||c==="v"||c==="z")&&e.ctrlKey)){try{this.widgetHandleInput(_R.getRangeInfo(),c);this.raiseChangeEvent({type:"input",characeter:c});var sat=this._saveActiveToken;if(!isDelimiter(c)){if(!sat){w=this.findObjectToken();if(w&&!w.isDelimiter()){this._saveActiveToken=sat=w;}}if(sat&&c==="."){var dbtable=currentDBTableHash[sat.data.v.toLowerCase().slice(0,-1)];if(dbtable){if(dbtable.columns){this.startTokenSuggestion();}else{var me=this;mstrApp.getRootController().getColumnsForDBTable({data:dbtable},{success:function success(res){var its=res.items,columns=[],prefix=sat.data.v;dbtable.columns=its;$ARR.forEach(its,function(item){columns.push({n:prefix+item.n,sta:2,t:26});});me.set("candidates",{items:me.candidates.items.concat(columns),isComplete:true});me.startTokenSuggestion();}});}}else{sat.isCol=false;sat.col=null;this.startTokenSuggestion();}}else{this.startTokenSuggestion();}}else{this.endTokenSuggestion();}}catch(ex){}noDefault=true;}if(noDefault){_D.stopPropogation(window,e);_D.preventDefault(window,e);return false;}else{return true;}},markFailureLabel:function markFailureLabel(failPassNumber){this.pnum=failPassNumber;this.updatepasses();},updatepasses:function updatepasses(markFailure){var yCoordinates=[],its=this.ctxtBuilder.itemWidgets,isNewPass=true,baseHeight=_D.position(this.domNode).y,data,value;$ARR.forEach(its,function(item){data=item.data;value=data.v;if(isNewPass&&!SQL_SPACING[value]){if(value&&$ARR.indexOf(SQL_KEYWORD_ACTION,value.toString().toLowerCase())>-1){yCoordinates.push(_D.position(item.domNode).y-baseHeight);}isNewPass=false;}else{if(value===";"){isNewPass=true;}}});if(yCoordinates.length===1){yCoordinates=[];}var btns=[],parent=this.parent,passlabel=parent.passlabel,parentHeight=parent.domNode.clientHeight,config={scriptClass:"mstrmojo.Button"};$ARR.forEach(yCoordinates,function(yCoord,index){if(yCoord>=0&&yCoord<=parentHeight){btns.push($H.copy(config,{cssText:["top:",yCoord,"px;"].join(""),cssClass:(this.pnum===index?"error":"")}));}});passlabel.removeChildren(null,true);passlabel.addChildren(btns,0,true);},widgetHandleBackspace:function widgetHandleBackspace(rInfo){if(rInfo.collapsed){var sat=this._saveActiveToken;if(sat&&sat.data){s=sat.data.v;if(s&&s[s.length-1]==="."&&sat.isCol){this.set("candidates",{items:mstrmojo.all.QBuilderModel.FFsqlComp,isComplete:true});sat.isCol=false;sat.col=null;}}var edge,ew,idx,so=rInfo.startOffset,itws=this.ctxtBuilder.itemWidgets;if(!_D.contains(this.editNode,rInfo.startContainer,false,document.body)){if(rInfo.startOffset>0&&_D.isFF){ew=itws[this.items.length-1];_R.collapseOnNode(ew.domNode,false);rInfo=_R.getRangeInfo();edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);}else{_R.collapseOnNode(this.editNode,true);return ;}}edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=_D.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);if(edge===EDGE.EDGE_BEGIN){idx--;ew=itws[idx];so=ew.length();}if(!ew){_R.collapseOnNode(this.editNode,true);return ;}if(ew.length()===1){this.remove(idx);if(ew.data.v===";"||ew.data.v==="\n"){this.updatepasses();}ew=itws[idx-1];if(ew){_R.collapseOnNode(ew.domNode,false);this.checkMergeTwoTokens(idx-1,idx);ew=itws[idx-1];}else{_R.collapseOnNode(this.editNode,true);}}else{ew.spliceContent(so-1,1);if(ew.isCol){this.set("candidates",{items:ew.col,isComplete:true,isCol:true});}_R.collapseOnTextNode(ew.domNode,so-1);}}else{this.widgetDeleteTokens(rInfo);this.updatepasses();}},handlepaste:function handlepaste(s){if(typeof s!=="string"){var v=this.clipboardNode.value;}else{var v=s;}this.clipboardNode.value="";var ts=[],len=v&&v.length,i,t="",c;if(len>0){for(i=0;i<len;i++){c=v.charAt(i);if(isDelimiter(c)){if(!mstrmojo.string.isEmpty(t)){ts.push({v:t,isNew:true,did:this.itemCount++});t="";}ts.push({v:c,isDelimiter:true,isNew:true,did:this.itemCount++});}else{t=t+c;}}if(!mstrmojo.string.isEmpty(t)){ts.push({v:t,isNew:true,did:this.itemCount++});t="";}this.insertTokens(ts);}},insertTokens:function insertTokens(tokens){var rInfo=this._saveRangeInfo;if(!rInfo||!_D.contains(this.editNode,rInfo.startContainer,false,document.body)){this.add(tokens);var its=this.ctxtBuilder.itemWidgets,ew=its[its.length-1];this._delaySetCaretPos(ew.domNode,false);this.raiseChangeEvent({type:"insert"});return ;}var edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset),ew=_D.findWidget(rInfo.startContainer),idx=this.itemIndex(ew.data);if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset,this.itemCount++);this.remove(idx);tokens.unshift(ts[0]);tokens.push(ts[1]);this.add(tokens,idx);}else{idx=(edge===EDGE.EDGE_BEGIN?idx:idx+1);this.add(tokens,idx);}idx=idx+tokens.length-1;ew=this.ctxtBuilder.itemWidgets[idx];this._delaySetCaretPos(ew.domNode,false);this.raiseChangeEvent({type:"insert"});},widgetHandleInput:function widgetHandleInput(rInfo,c){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=_R.getRangeInfo();}var edge,ew,idx,t,aw,so,itws=this.ctxtBuilder.itemWidgets;if(!_D.contains(this.editNode,rInfo.startContainer,false,document.body)){this.add([{v:c,isDelimiter:isDelimiter(c),isNew:true,did:this.itemCount++}],0);ew=itws[0];_R.collapseOnTextNode(ew.domNode,1);return ;}edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=_D.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);if(isDelimiter(c)){if(this.candidates.isCol){this.set("candidates",{items:mstrmojo.all.QBuilderModel.FFsqlComp,isComplete:true});}t={v:c,isDelimiter:true,isNew:true,did:this.itemCount++};if(edge===EDGE.EDGE_MIDDLE){var ts=ew.split2Tokens(rInfo.startOffset,this.itemCount++);this.remove(idx);this.add([ts[0],t,ts[1]],idx);idx=idx+1;}else{idx=(edge===EDGE.EDGE_BEGIN)?idx:idx+1;this.add([t],idx);}ew=itws[idx];_R.collapseOnNode(ew.domNode,false);if(c===";"){this.updatepasses();}}else{so=rInfo.startOffset;if(ew.isDelimiter()){aw=itws[(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1];if(aw&&!aw.isDelimiter()){ew=aw;so=(edge===EDGE.EDGE_BEGIN)?ew.length():0;}this.add([{v:c,isNew:true,did:this.itemCount++}],(edge===EDGE.EDGE_BEGIN)?idx:idx+1);ew=itws[(edge===EDGE.EDGE_BEGIN)?idx:idx+1];_R.collapseOnNode(ew.domNode,false);this.updatepasses();}else{ew.spliceContent(so,0,c);_R.collapseOnTextNode(ew.domNode,so+1);}}},widgetHandleImeInput:function widgetHandleInput(rInfo,c){if(!rInfo.collapsed){this.widgetDeleteTokens(rInfo);rInfo=_R.getRangeInfo();}var edge,ew,idx,t,aw,so,itws=this.ctxtBuilder.itemWidgets;if(!_D.contains(this.editNode,rInfo.startContainer,false,document.body)){this.clearTokens();this.add([{v:c,isDelimiter:this.isDelimiter(c),isNew:true,did:this.itemCount++}],0);itws=this.ctxtBuilder.itemWidgets;ew=itws[0];_R.collapseOnTextNode(ew.domNode,ew.data.v.length||1);this._delaySetCaretPos(ew.domNode,false);return ;}edge=_R.getEdgeInfo(rInfo.startContainer,rInfo.startOffset);ew=_D.findWidget(rInfo.startContainer);idx=this.itemIndex(ew.data);so=rInfo.startOffset;if(ew.isDelimiter()){this.clearTokens();this.set("items",this.prev_items);itws=this.ctxtBuilder.itemWidgets;aw=itws[(edge===EDGE.EDGE_BEGIN)?idx-1:idx+1];if(aw&&!aw.isDelimiter()){ew=aw;so=(edge===EDGE.EDGE_BEGIN)?ew.length():0;}}if(!ew.isDelimiter()){ew.spliceContent(so,0,c);this._delaySetTextCaretPos(ew.domNode,so+c.length);}else{this.add([{v:c,isNew:true,did:this.itemCount++}],(edge===EDGE.EDGE_BEGIN)?idx:idx+1);ew=itws[(edge===EDGE.EDGE_BEGIN)?idx:idx+1];this._delaySetCaretPos(ew.domNode,false);}this.startTokenSuggestion();return ew;},getSearchPattern:function getSearchPattern(){var at=this._saveActiveToken;if(at.isCol){var s=at.data.v;pattern=s.slice(s.lastIndexOf(".")+1,s.length);}else{pattern=at&&at.data.v;}len=pattern&&pattern.length;if(len>2){if(pattern.charAt(0)==="["){pattern=pattern.substring(1);}if(pattern.charAt(pattern.length-1)==="]"){pattern=pattern.substring(0,pattern.length-1);}}return pattern;},getSuggestionPos:function getSuggestionPos(){var at=this._saveActiveToken,sp=null,p,colp=0;if(at.isCol){colp=at.domNode.offsetWidth;}if(at){p=mstrmojo.dom.position(at.domNode,true);var t=Math.round(p.y+p.h),sh=this.suggestionItems.length*19,ph=parseInt(mstrmojo.all.QBuilderPage.height),ex=ph>t-40+sh;sp={left:Math.round(p.x)+colp+"px",top:ex?t+"px":p.y-sh+"px",zIndex:100};}return sp;},onSuggestionItemSelect:function onSuggestionItemSelect(it){var ow=this._saveActiveToken;this.endTokenSuggestion();if(it.t==-98){var items=this.items;this.clearTokens();for(var k=0;k<items.length;k++){items[k].did=this.itemCount++;}this.customFunctionMode=true;var items=[{v:"{",isDelimiter:true,sta:1,isNew:true,did:this.itemCount++}].concat(items).concat([{v:"}",isDelimiter:true,sta:1,isNew:true,did:this.itemCount++}]);this.set("items",items);var idx=this.itemIndex({did:this.itemCount-1}),ew=this.ctxtBuilder.itemWidgets[idx-1];this._delaySetCaretPos(ew.domNode,false);}else{if(ow){if(ow.isCol){var s=ow.data.v,c={};mstrmojo.hash.copy(it,c);c.n=s.slice(0,s.lastIndexOf(".")+1)+it.n;ow.setItemInfo(c);}else{ow.setItemInfo(it);}this._delaySetCaretPos(ow.domNode,false);}}},ontokensModify:function(evt){this.ostack.push({its:mstrmojo.hash.cloneArray(this.items)});this.pnum=-1;this.updatepasses();},dropZone:true,allowDrop:function allowDrop(ctxt){return this.dropZone&&mstrApp.isFFSQLMode;},ondragover:function ondragover(ctxt){var w=ctxt.tgt.widget,x=ctxt.tgt.pos.x,y=ctxt.tgt.pos.y;var ws=w.ctxtBuilder.itemWidgets,len=ws.length;if(len===0){return ;}var n=ws[len-1].domNode,pos=_D.position(n);if(y>pos.y+n.clientHeight){w._delaySetCaretPos(n,false);}else{for(var i=len-1;i>-1;i--){if(ws[i].data.v=="\n"||ws[i].data.v=="\t"){continue;}var node=ws[i].domNode,wy=_D.position(node).y;if(wy<y&&!(wy+14<y)){w._delaySetCaretPos(node,false);break;}}}},ondrop:function(e){var ns=e.src.data.ns,tks=[];if(!ns){return ;}for(var i=0,len=ns.length;i<len;i++){tks.push({isNew:true,v:ns[i],oi:e.src.data,did:this.itemCount++});if(i<len-1){tks.push({isNew:true,v:",",isDelimiter:true,did:this.itemCount++});}}this.insertTokens(tks);},onscroll:function(){mstrmojo.all[this.parentNode.id].updatepasses();},onRender:function onR(){if(this.hasRendered){mstrmojo.dom.attachEvent(this.editNode,"scroll",this.onscroll);this.itemsContainerNode.style.height="100%";}},addCandidateTables:function addCandidateTables(evt){var items=[],name,tables=evt.value;currentDBTableHash={};$ARR.forEach(tables,function(table){name=table.ns?table.ns+"."+table.n:table.n;items.push({n:name,sta:2,t:15});currentDBTableHash[name.toLowerCase()]=table;});this.set("candidates",{items:this.sqlTokens.concat(items).concat(mstrApp.getRootController().getSuggestionItems(true)),isComplete:true});}});})();