(function(){mstrmojo.requiresCls("mstrmojo.Table","mstrmojo.Label","mstrmojo.Box","mstrmojo.TreeBrowser","mstrmojo.fx","mstrmojo.array","mstrmojo.hash");var STR_SUGGEST=mstrmojo.desc(8953,"Suggestions"),STR_NOMATCH=mstrmojo.desc(9135,"No match found"),_D=mstrmojo.dom,_C=mstrmojo.css,_H=mstrmojo.hash,OFFSET_WIDTH=16,cachedSearchPattern,cachedSearchResult;function _getAttributeForms(data,callbacks){var aid=data.did,an=data.n;var cb={success:function(res){if(res.container){var fms=res.container.dssforms;fms=fms?fms:[];for(var i=0,len=fms.length;i<len;i++){fms[i].aid=aid;fms[i].an=an;fms[i].did=aid+fms[i].dssid;fms[i].idf=fms[0].dssid;}if(callbacks&&callbacks.success){callbacks.success({items:fms});}}},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}};var param={taskId:"getAttributeForms",attributeID:aid,displayedForms:0};mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,cb,param);}mstrmojo.qb.AttributeMapping=mstrmojo.declare(mstrmojo.Container,[mstrmojo._IsPopup],{scriptClass:"mstrmojo.qb.AttributeMapping",markupString:'<div id="{@id}"  class="mstrmojo-Editor {@cssClass}" style="top:{@top};left:{@left};"><div style="z-index:{@zIndex};{@cssText}" mstrAttach:mousedown><div class="mstrmojo-qb-mapping-searchbox" mstrAttach:click ><input class="mstrmojo-SearchBox-input mstrmojo-qb-mapping-searchinput" type="text"  mstrAttach:keyup,blur/><span class="mstrmojo-qb-mapping-spinnerbox" style="width:20px;"><span class="mstrmojo-SearchBox2-spinner" id="{@id}sbSpinner"></span></span></div><div class="mstrmojo-qb-mapping-search-status"></div><div class="mstrmojo-qb-mapping-search-content"></div><div class="mstrmojo-qb-mapping-buttons"></div></div><div class="mstrmojo-Editor-curtain"></div></div>',markupSlots:{contentNode:function(){return this.domNode.firstChild.childNodes[2];},inputNode:function(){return this.domNode.firstChild.firstChild.firstChild;},spinnerNode:function(){return this.domNode.firstChild.firstChild.lastChild.lastChild;},buttonNode:function(){return this.domNode.firstChild.childNodes[3];},statusNode:function(){return this.domNode.firstChild.childNodes[1];},curtainNode:function(){return this.domNode.lastChild;}},blockCount:50,cssClass:"mstrmojo-qb-mapping-editor",children:[{scriptClass:"mstrmojo.TreeBrowser",slot:"contentNode",alias:"tree",noCheckBox:false,itemIdField:"did",cssClass:"mstrmojo-qb-mapping-tree",items:[],isBranch:function isBranch(data){return data.items;},item2textCss:function item2textCss(data){return("mstrmojo-ArchitectListIcon "+(data.items?"t12":"t21"));},selectionAcrossBranch:false,listSelector:mstrmojo.ListSelector,multiSelect:false,getContentThroughTaskCall:function getContentThroughTaskCall(params,callbacks){var me=this;if(params.isRoot){callbacks.success(me.items);}else{_getAttributeForms(params.data,callbacks);}}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-qb-mapping-status",slot:"statusNode",alias:"status",text:STR_SUGGEST},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-qb-mapping-buttonbox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-qb-attributelink-button",cssText:"float: right",text:mstrmojo.desc(1442,"OK"),onclick:function(evt){var mp=this.parent.parent;var sls=mp.children[0].getTotalSelections();if(sls&&sls.length>0){var model=mstrmojo.all.QBuilderModel,mappings=model.mappings,idx=mstrmojo.array.find(mappings,"did",mp.did),obj=mappings[idx];var cb={success:function(){mp.close();obj.alias=sls[0].an;obj.ipa=1;obj.fmn=sls[0].n;obj.tp=12;obj.oid=sls[0].aid;obj.nochange=true;obj.georole=0;obj.der=0;mp.target.parent.dataGrid.populatePreview();},failure:function(res){mp._displayError(res);}};model.mapAttribute(mp.did,sls[0].aid,sls[0].dssid,sls[0].idf,cb,obj.oid);}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-qb-attributelink-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(evt){var mp=this.parent.parent;mp.close();}}]}],_displayError:function _displayError(msg){var bar=this.status;bar.set("text",msg);bar.set("title",msg);_C.addClass(bar.domNode,"error");this.adjustPosition();},onEnter:function(){this._onsearch();},onEsc:function(){if(this.onCancel){this.onCancel();}this.close();},close:function(){_D.detachEvent(document.body,"mousedown",this._close_handler);if(this.target){_C.toggleClass(this.target.domNode,"highlight",false);}this.buttonNode.style.display="none";this.statusNode.style.display="none";this.slideProp(false,this.contentNode,95);this.slideProp(false,this.inputNode,16);var node=this.domNode;self.setTimeout(function(){document.body.removeChild(node);},510);},onkeyup:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event;if(this.onEnter&&e.keyCode===13){this.onEnter();return ;}if(this.onEsc&&e.keyCode===27){this.onEsc();return ;}if(microstrategy.enableQuickSearch){if(this._autoSearchTimer){self.clearTimeout(this._autoSearchTimer);}var searchAutoCompleteDelay=microstrategy.searchAutoCompleteDelay,me=this;if(searchAutoCompleteDelay){this._autoSearchTimer=self.setTimeout(function(){me._onsearch();},searchAutoCompleteDelay);}else{this._onsearch();}}},slideProp:function(show,node,h){var props={target:node,props:{height:{start:(show?0:h),stop:(show?h:0),suffix:"px"}}};var fx=new mstrmojo.fx.AnimateProp(props);fx.play();},onshowContentChange:function onshowContentChange(){if(this.showContent){this.contentNode.style.display="block";this.slideProp(true,this.contentNode,95);this.buttonNode.style.display="block";}else{this.contentNode.style.display="none";this.buttonNode.style.display="none";}},_onsearch:function(){var input=mstrmojo.string.trim(this.inputNode.value),me=this;if(!input){return ;}var callback={success:function success(res){var itms=[],hasMatch;cachedSearchPattern=cachedSearchPattern.toLowerCase();mstrmojo.array.forEach(res.items,function(item){if(item.n.toString().toLowerCase().indexOf(cachedSearchPattern)===0){itms.push(_H.copy({items:[],st:-5},item));}});cachedSearchResult=itms;hasMatch=itms.length>0;me.status.set("text",hasMatch?STR_SUGGEST:STR_NOMATCH);me.statusNode.style.display="block";me.set("showContent",hasMatch);_C.removeClass(me.status.domNode,"error");me.children[0].set("items",itms);},failure:function failure(res){if(me.showTaskError){mstrmojo.alert(mstrmojo.desc(8117,"Data request failed:")+" \n"+res.getResponseHeader("X-MSTR-TaskFailureMsg").replace(/com\.microstrategy\.(.*): \((.*)\)/,"$2"));}},complete:function complete(res){if(me.spinnerNode){me.spinnerNode.style.display="none";}if(me.postFetch){me.postFetch();}}};var qs=microstrategy.useQuickSearch();if(cachedSearchPattern&&input.indexOf(cachedSearchPattern)===0&&cachedSearchResult.length<this.blockCount){cachedSearchPattern=input;callback.success({items:cachedSearchResult});return ;}cachedSearchPattern=input;if(this.spinnerNode){this.spinnerNode.style.display="block";}var taskParams={taskId:"searchMetadata",styleName:"MojoFolderStyle",nameWildcards:qs?16:1,blockBegin:this.blockBegin||1,blockCount:this.blockCount,recursive:true,includeAncestorInfo:true,objectType:"12",quickSearch:qs};taskParams.searchPattern=qs?input:input+"*";mstrmojo.xhr.request("POST",mstrmojo.App.taskURL,callback,taskParams);},attachMousedownEvent:function attachMousedownEvent(){var me=this;if(!this._close_handler){this._close_handler=function(){if(!me.isOnMe(_D.eventTarget(self,arguments[0]))){me.close();}};}_D.attachEvent(document.body,"mousedown",this._close_handler);},isOnMe:function isOnMe(t){return _D.contains(this.domNode.firstChild,t,true,document.body);},adjustPosition:function adjustPosition(){var root=this.domNode,box=root.firstChild,h=box.offsetHeight,w=box.offsetWidth,wDim=_D.windowDim(),pos=_D.position(box,false);if((pos.x+w+OFFSET_WIDTH)>wDim.w){box.style.left=wDim.w-w-OFFSET_WIDTH+"px";}if((pos.y+h+OFFSET_WIDTH)>wDim.h){box.style.top=wDim.h-h-OFFSET_WIDTH+"px";}},onOpen:function onOpen(){var inputNode=this.inputNode;this.tree.set("items",[]);inputNode.value="";this.set("showContent",false);this.statusNode.style.display="none";if(!mstrmojo.dom.isWK){this.slideProp(true,inputNode,16);}inputNode.focus();this.attachMousedownEvent();}});})();