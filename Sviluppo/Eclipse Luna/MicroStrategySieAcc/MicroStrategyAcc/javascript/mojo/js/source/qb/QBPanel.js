(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.css","mstrmojo.string","mstrmojo.qb.QBTableView","mstrmojo.qb.FFsql","mstrmojo.Label","mstrmojo.Table","mstrmojo.Button");var $S=mstrmojo.string,$CSS=mstrmojo.css,CSS_CLASS_ON="on";var ENUM_EDITOR_MODE_QB=1,ENUM_EDITOR_MODE_FFSQL=2;var FFSQLEmptyPrompt=mstrmojo.desc(9215,"Type multi-pass SQL or double-click a table name");mstrmojo.qb.QBPanel=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.qb.QBPanel",markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},cssText:"position:relative;",mode:ENUM_EDITOR_MODE_QB,children:[{scriptClass:"mstrmojo.Box",alias:"header",cssClass:"mstrmojo-qb-tableview-toolbar",children:[{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon play",text:mstrmojo.desc(9130,"Execute SQL"),onclick:function(){var controller=mstrApp.getRootController(),panel=this.parent.parent;if(panel.mode===ENUM_EDITOR_MODE_QB){controller.autoMap();}else{var ffsqleditor=panel.SQL.ffsql,currentSQL=ffsqleditor.getSQLstmt();if(currentSQL===ffsqleditor.txt){if($S.trim(currentSQL)!==""){controller.autoMap();}}else{controller.editSQL(currentSQL,{success:function success(){if($S.trim(currentSQL)!==""){ffsqleditor.txt=currentSQL;controller.autoMap();}}});}}}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon erase",text:mstrmojo.desc(2827,"Clear"),bindings:{visible:function(){return this.parent.parent.mode===ENUM_EDITOR_MODE_FFSQL;}},onclick:function onclick(){var ffsqleditor=this.parent.parent.SQL.ffsql;ffsqleditor.clearTokens();ffsqleditor.updatepasses();}},{scriptClass:"mstrmojo.Button",markupString:'<div id="{@id}" class="mstrmojo-Button {@cssClass} {@iconClass}" title="{@title}" style="{@cssText}" mstrAttach:touchstart,click,mousedown,mouseup,mouseover><div class="mstrmojo-Button-text mstrmojo-qb-sqlpreview-tooltip"></div></div>',bindings:{visible:function(){var isQB=(this.parent.parent.mode===ENUM_EDITOR_MODE_QB);this.set("iconClass","mstrmojo-qb-tableview-toolbarIcon "+(isQB?"toFFSQL":"toQB"));this.hasRendered&&this.render();return !mstrApp.isFFSQL;}},onclick:function(){mstrApp.getRootController().convertMode(this.parent.parent.mode===ENUM_EDITOR_MODE_QB);},onmouseover:function onmouseover(){var me=this;if(this.parent.parent.mode===ENUM_EDITOR_MODE_QB){mstrApp.getRootController().getSQLPreview({success:function success(sqlstmt){var tooltip=mstrmojo.desc(9137,"Edit SQL");me.set("text",(sqlstmt?"<div>"+tooltip+"<p>"+$S.encodeHtmlString(sqlstmt)+"<div>":tooltip));}});}else{me.set("text",mstrmojo.desc(9141,"Convert to QueryBuilder"));}}},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-qb-tableview-toolbarIcon refresh",text:mstrmojo.desc(9927,"Update Tables"),bindings:{visible:function(){return(this.parent.parent.mode===ENUM_EDITOR_MODE_QB);}},onclick:function(){mstrApp.getRootController().updateTableStructure();}}]},{scriptClass:"mstrmojo.qb.QBTableView",cssClass:"mstrmojo-qb-tableview on",alias:"tables",bindings:{visible:function(){return(this.parent.mode===ENUM_EDITOR_MODE_QB);}}},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-qb-ffsqlview",alias:"SQL",bindings:{visible:function(){return(this.parent.mode===ENUM_EDITOR_MODE_FFSQL);}},onwidthChange:function onwidthChange(evt){var ffsqleditor=this.ffsql,node=ffsqleditor.domNode,width=Math.max(parseInt(evt.value,10)-10,0)+"px";ffsqleditor.set("width",width);node&&(node.style.width=width);},children:[{scriptClass:"mstrmojo.Box",alias:"passlabel",cssClass:"mstrmojo-qb-ffsqlview-passlabel"},{scriptClass:"mstrmojo.qb.FFsql",alias:"ffsql",cssClass:"mstrmojo-qb-ffsqlview-editnode",id:"FFsql",txt:"",dropZone:true,onwidthChange:function onwidthChange(){this.hasRendered&&this.updatepasses();},onheightChange:function onheightChange(){this.hasRendered&&this.updatepasses();},updateSQL:function(evt){if(!this.candidates){this.set("candidates",{items:this.sqlTokens.concat(mstrApp.getRootController().getSuggestionItems(true)),isComplete:true});}this.clearTokens();this.clipboardNode.value=this.txt=evt.value;this.handlepaste();this.oriSQL=this.getSQLstmt();}}]}],enterMode:function enterMode(evt){var mode=evt.mode;this.set("mode",mode);var isFFSQLMode=(mode===ENUM_EDITOR_MODE_FFSQL);this.tables.set("visible",!isFFSQLMode);$CSS.toggleClass(this.tables.domNode,CSS_CLASS_ON,!isFFSQLMode);$CSS.toggleClass(this.SQL.domNode,CSS_CLASS_ON,isFFSQLMode);this.SQL.set("visible",isFFSQLMode);if(isFFSQLMode){var ffsqleditor=this.SQL.ffsql;ffsqleditor.updateSQL(evt);}else{this.tables.scrollBox.linker.drawLinks();}},onheightChange:function(e){if(this.domNode&&this.header.domNode){this.tables.set("height",parseInt(e.value,10)-this.header.domNode.clientHeight+"px");this.SQL.set("height",this.tables.height);}},onwidthChange:function onwidthChange(evt){this.tables.set("width",this.width);this.SQL.set("width",this.width);},postBuildRendering:function postBR(){if(this._super){this._super();}var controller=mstrApp.getRootController();controller.attachEventListener("reportModeChange",this.id,this.enterMode);controller.attachEventListener("addCandidateTables",this.SQL.ffsql.id,"addCandidateTables");}});})();